shadow$provide.module$node_modules$$firebase$firestore$dist$index_cjs=function(global,process,require,module,exports,shadow$shims){function getLogLevel(){return logClient.logLevel===logger.LogLevel.DEBUG?LogLevel$jscomp$0.DEBUG:logClient.logLevel===logger.LogLevel.SILENT?LogLevel$jscomp$0.SILENT:LogLevel$jscomp$0.ERROR}function setLogLevel(newLevel){switch(newLevel){case LogLevel$jscomp$0.DEBUG:logClient.logLevel=logger.LogLevel.DEBUG;break;case LogLevel$jscomp$0.ERROR:logClient.logLevel=logger.LogLevel.ERROR;
break;case LogLevel$jscomp$0.SILENT:logClient.logLevel=logger.LogLevel.SILENT;break;default:logClient.error("Firestore ("+SDK_VERSION+"): Invalid value passed to `setLogLevel`")}}function debug(tag,msg){for(var obj=[],_i=2;_i<arguments.length;_i++)obj[_i-2]=arguments[_i];logClient.logLevel<=logger.LogLevel.DEBUG&&(obj=obj.map(argToString),logClient.debug.apply(logClient,["Firestore ("+SDK_VERSION+") ["+tag+"]: "+msg].concat(obj)))}function error$jscomp$0(msg){for(var obj=[],_i=1;_i<arguments.length;_i++)obj[_i-
1]=arguments[_i];logClient.logLevel<=logger.LogLevel.ERROR&&(obj=obj.map(argToString),logClient.error.apply(logClient,["Firestore ("+SDK_VERSION+"): "+msg].concat(obj)))}function argToString(obj){if("string"===typeof obj)return obj;var platform=PlatformSupport.getPlatform();try{return platform.formatJSON(obj)}catch(e){return obj}}function fail(failure){failure="FIRESTORE ("+SDK_VERSION+") INTERNAL ASSERTION FAILED: "+failure;error$jscomp$0(failure);throw Error(failure);}function assert(assertion,
message){assertion||fail(message)}function emptyByteString(){return PlatformSupport.getPlatform().emptyByteString}function makeConstructorPrivate(cls,optionalMessage){function PublicConstructor(){var error="This constructor is private.";optionalMessage&&(error=error+" "+optionalMessage);throw new FirestoreError(Code.INVALID_ARGUMENT,error);}PublicConstructor.prototype=cls.prototype;for(var staticProperty in cls)cls.hasOwnProperty(staticProperty)&&(PublicConstructor[staticProperty]=cls[staticProperty]);
return PublicConstructor}function defaulted(value,defaultValue){return void 0!==value?value:defaultValue}function forEachNumber(obj,fn){for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var num=Number(key);isNaN(num)||fn(num,obj[key])}}function values$jscomp$0(obj){var vs=[];forEach(obj,function(_,v){return vs.push(v)});return vs}function forEach(obj,fn){for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&fn(key,obj[key])}function isEmpty(obj){assert(null!=obj&&"object"===
typeof obj,"isEmpty() expects object parameter.");for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key))return!1;return!0}function shallowCopy(obj){assert(obj&&"object"===typeof obj,"shallowCopy() expects object parameter.");var result={},key;for(key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(result[key]=obj[key]);return result}function validateNoArgs(functionName,args){if(0!==args.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() does not support arguments, but was called with "+
formatPlural(args.length,"argument")+".");}function validateExactNumberOfArgs(functionName,args,numberOfArgs){if(args.length!==numberOfArgs)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires "+formatPlural(numberOfArgs,"argument")+", but was called with "+formatPlural(args.length,"argument")+".");}function validateAtLeastNumberOfArgs(functionName,args,minNumberOfArgs){if(args.length<minNumberOfArgs)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+
"() requires at least "+formatPlural(minNumberOfArgs,"argument")+", but was called with "+formatPlural(args.length,"argument")+".");}function validateBetweenNumberOfArgs(functionName,args,minNumberOfArgs,maxNumberOfArgs){if(args.length<minNumberOfArgs||args.length>maxNumberOfArgs)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires between "+minNumberOfArgs+" and "+(maxNumberOfArgs+" arguments, but was called with ")+formatPlural(args.length,"argument")+".");}function validateArgType(functionName,
type,position,argument){validateType(functionName,type,ordinal(position)+" argument",argument)}function validateOptionalArgType(functionName,type,position,argument){void 0!==argument&&validateArgType(functionName,type,position,argument)}function validateNamedOptionalType(functionName,type,optionName,argument){void 0!==argument&&validateType(functionName,type,optionName+" option",argument)}function validateOptionalArrayElements(functionName,optionName,typeDescription,argument,validator){if(void 0!==
argument){if(!(argument instanceof Array))throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+optionName+" "+("option to be an array, but it was: "+valueDescription(argument)));for(var i=0;i<argument.length;++i)if(!validator(argument[i]))throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires all "+optionName+" "+("elements to be "+typeDescription+", but the value at index "+i+" ")+("was: "+valueDescription(argument[i])));}}function validateNamedPropertyEquals(functionName,
inputName,optionName,input,expected){inputName=[];for(var _i=0;_i<expected.length;_i++){var val=expected[_i];if(val===input)return;inputName.push(valueDescription(val))}input=valueDescription(input);throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid value "+input+" provided to function "+functionName+"() for option "+('"'+optionName+'". Acceptable values: '+inputName.join(", ")));}function validateType(functionName,type,inputName,input){if("object"===type?!isPlainObject(input):"non-empty string"===
type?"string"!==typeof input||""===input:typeof input!==type)throw input=valueDescription(input),new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+inputName+" "+("to be of type "+type+", but it was: "+input));}function isPlainObject(input){return"object"===typeof input&&null!==input&&(Object.getPrototypeOf(input)===Object.prototype||null===Object.getPrototypeOf(input))}function valueDescription(input){if(void 0===input)return"undefined";if(null===input)return"null";
if("string"===typeof input)return 20<input.length&&(input=input.substring(0,20)+"..."),JSON.stringify(input);if("number"===typeof input||"boolean"===typeof input)return""+input;if("object"===typeof input){if(input instanceof Array)return"an array";a:{if(input.constructor&&(input=/function\s+([^\s(]+)\s*\(/.exec(input.constructor.toString()))&&1<input.length){input=input[1];break a}input=null}return input?"a custom "+input+" object":"an object"}return"function"===typeof input?"a function":fail("Unknown wrong type: "+
typeof input)}function validateDefined(functionName,position,argument){if(void 0===argument)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires a valid "+ordinal(position)+" argument, but it was undefined.");}function validateOptionNames(functionName,options,optionNames){forEach(options,function(key,_){if(0>optionNames.indexOf(key))throw new FirestoreError(Code.INVALID_ARGUMENT,"Unknown option '"+key+"' passed to function "+functionName+"(). Available options: "+optionNames.join(", "));
})}function invalidClassError(functionName,type,position,argument){argument=valueDescription(argument);return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+ordinal(position)+" "+("argument to be a "+type+", but it was: "+argument))}function ordinal(num){switch(num){case 1:return"first";case 2:return"second";case 3:return"third";default:return num+"th"}}function formatPlural(num,str){return num+" "+str+(1===num?"":"s")}function primitiveComparator(left,right){return left<
right?-1:left>right?1:0}function arrayEquals(left,right){if(left.length!==right.length)return!1;for(var i=0;i<left.length;i++)if(!left[i].isEqual(right[i]))return!1;return!0}function assertUint8ArrayAvailable(){if("undefined"===typeof Uint8Array)throw new FirestoreError(Code.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.");}function assertBase64Available(){if(!PlatformSupport.getPlatform().base64Available)throw new FirestoreError(Code.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.");
}function numericEquals(left,right){return left===right?0!==left||1/left===1/right:left!==left&&right!==right}function isNullOrUndefined(value){return null===value||void 0===value}function isSafeInteger(value){return isInteger(value)&&value<=MAX_SAFE_INTEGER&&value>=MIN_SAFE_INTEGER}function isPermanentError(code){switch(code){case Code.OK:return fail("Treated status OK as error");case Code.CANCELLED:case Code.UNKNOWN:case Code.DEADLINE_EXCEEDED:case Code.RESOURCE_EXHAUSTED:case Code.INTERNAL:case Code.UNAVAILABLE:case Code.UNAUTHENTICATED:return!1;
case Code.INVALID_ARGUMENT:case Code.NOT_FOUND:case Code.ALREADY_EXISTS:case Code.PERMISSION_DENIED:case Code.FAILED_PRECONDITION:case Code.ABORTED:case Code.OUT_OF_RANGE:case Code.UNIMPLEMENTED:case Code.DATA_LOSS:return!0;default:return fail("Unknown status code: "+code)}}function isPermanentWriteError(code){return isPermanentError(code)&&code!==Code.ABORTED}function mapCodeFromRpcCode(code){if(void 0===code)return error$jscomp$0("GRPC error has no .code"),Code.UNKNOWN;switch(code){case RpcCode.OK:return Code.OK;
case RpcCode.CANCELLED:return Code.CANCELLED;case RpcCode.UNKNOWN:return Code.UNKNOWN;case RpcCode.DEADLINE_EXCEEDED:return Code.DEADLINE_EXCEEDED;case RpcCode.RESOURCE_EXHAUSTED:return Code.RESOURCE_EXHAUSTED;case RpcCode.INTERNAL:return Code.INTERNAL;case RpcCode.UNAVAILABLE:return Code.UNAVAILABLE;case RpcCode.UNAUTHENTICATED:return Code.UNAUTHENTICATED;case RpcCode.INVALID_ARGUMENT:return Code.INVALID_ARGUMENT;case RpcCode.NOT_FOUND:return Code.NOT_FOUND;case RpcCode.ALREADY_EXISTS:return Code.ALREADY_EXISTS;
case RpcCode.PERMISSION_DENIED:return Code.PERMISSION_DENIED;case RpcCode.FAILED_PRECONDITION:return Code.FAILED_PRECONDITION;case RpcCode.ABORTED:return Code.ABORTED;case RpcCode.OUT_OF_RANGE:return Code.OUT_OF_RANGE;case RpcCode.UNIMPLEMENTED:return Code.UNIMPLEMENTED;case RpcCode.DATA_LOSS:return Code.DATA_LOSS;default:return fail("Unknown status code: "+code)}}function mapRpcCodeFromCode(code){if(void 0===code)return RpcCode.OK;switch(code){case Code.OK:return RpcCode.OK;case Code.CANCELLED:return RpcCode.CANCELLED;
case Code.UNKNOWN:return RpcCode.UNKNOWN;case Code.DEADLINE_EXCEEDED:return RpcCode.DEADLINE_EXCEEDED;case Code.RESOURCE_EXHAUSTED:return RpcCode.RESOURCE_EXHAUSTED;case Code.INTERNAL:return RpcCode.INTERNAL;case Code.UNAVAILABLE:return RpcCode.UNAVAILABLE;case Code.UNAUTHENTICATED:return RpcCode.UNAUTHENTICATED;case Code.INVALID_ARGUMENT:return RpcCode.INVALID_ARGUMENT;case Code.NOT_FOUND:return RpcCode.NOT_FOUND;case Code.ALREADY_EXISTS:return RpcCode.ALREADY_EXISTS;case Code.PERMISSION_DENIED:return RpcCode.PERMISSION_DENIED;
case Code.FAILED_PRECONDITION:return RpcCode.FAILED_PRECONDITION;case Code.ABORTED:return RpcCode.ABORTED;case Code.OUT_OF_RANGE:return RpcCode.OUT_OF_RANGE;case Code.UNIMPLEMENTED:return RpcCode.UNIMPLEMENTED;case Code.DATA_LOSS:return RpcCode.DATA_LOSS;default:return fail("Unknown status code: "+code)}}function mapCodeFromHttpStatus(status){switch(status){case 200:return Code.OK;case 400:return Code.INVALID_ARGUMENT;case 401:return Code.UNAUTHENTICATED;case 403:return Code.PERMISSION_DENIED;case 404:return Code.NOT_FOUND;
case 409:return Code.ABORTED;case 416:return Code.OUT_OF_RANGE;case 429:return Code.RESOURCE_EXHAUSTED;case 499:return Code.CANCELLED;case 500:return Code.UNKNOWN;case 501:return Code.UNIMPLEMENTED;case 503:return Code.UNAVAILABLE;case 504:return Code.DEADLINE_EXCEEDED;default:return 200<=status&&300>status?Code.OK:400<=status&&500>status?Code.FAILED_PRECONDITION:500<=status&&600>status?Code.INTERNAL:Code.UNKNOWN}}function documentKeySet(){for(var keys=[],_i=0;_i<arguments.length;_i++)keys[_i]=arguments[_i];
_i=EMPTY_DOCUMENT_KEY_SET;for(var _a=0;_a<keys.length;_a++)_i=_i.add(keys[_a]);return _i}function assertPresent(value,description){assert(!isNullOrUndefined(value),description+" is missing")}function parseInt64(value){return"number"===typeof value?value:"string"===typeof value?Number(value):fail("can't parse "+value)}function hasTag(obj,type,tag){return type===tag||!type&&tag in obj}function encode(path){for(var result="",i=0;i<path.length;i++){0<result.length&&(result+="");for(var segment=path.get(i),
length=segment.length,i$jscomp$0=0;i$jscomp$0<length;i$jscomp$0++){var c=segment.charAt(i$jscomp$0);switch(c){case "\x00":result+="";break;case "":result+="";break;default:result+=c}}}return result+""}function decode(path){var length=path.length;assert(2<=length,"Invalid path "+path);if(2===length)return assert(""===path.charAt(0)&&""===path.charAt(1),"Non-empty path "+path+" had length 2"),ResourcePath.EMPTY_PATH;for(var lastReasonableEscapeIndex=length-2,segments=[],segmentBuilder="",start=
0;start<length;){var end=path.indexOf("",start);(0>end||end>lastReasonableEscapeIndex)&&fail('Invalid encoded resource path: "'+path+'"');switch(path.charAt(end+1)){case "":start=path.substring(start,end);0!==segmentBuilder.length&&(start=segmentBuilder+=start,segmentBuilder="");segments.push(start);break;case "":segmentBuilder+=path.substring(start,end);segmentBuilder+="\x00";break;case "":segmentBuilder+=path.substring(start,end+1);break;default:fail('Invalid encoded resource path: "'+path+
'"')}start=end+2}return new ResourcePath(segments)}function mutationQueueContainsKey(txn,userId,key$jscomp$0){key$jscomp$0=DbDocumentMutation.prefixForPath(userId,key$jscomp$0.path);var encodedPath=key$jscomp$0[1];key$jscomp$0=IDBKeyRange.lowerBound(key$jscomp$0);var containsKey=!1;return documentMutationsStore(txn).iterate({range:key$jscomp$0,keysOnly:!0},function(key,value,control){value=key[1];key[0]===userId&&value===encodedPath&&(containsKey=!0);control.done()}).next(function(){return containsKey})}
function mutationQueuesContainKey(txn,docKey){var found=!1;return IndexedDbPersistence.getStore(txn,DbMutationQueue.store).iterateSerial(function(userId){return mutationQueueContainsKey(txn,userId,docKey).next(function(containsKey){containsKey&&(found=!0);return PersistencePromise.resolve(!containsKey)})}).next(function(){return found})}function removeMutationBatch(txn,userId,batch){var mutationStore=txn.store(DbMutationBatch.store);txn=txn.store(DbDocumentMutation.store);var promises=[],range=IDBKeyRange.only(batch.batchId),
numDeleted=0;mutationStore=mutationStore.iterate({range:range},function(key,value,control){numDeleted++;return control.delete()});promises.push(mutationStore.next(function(){assert(1===numDeleted,"Dangling document-mutation reference found: Missing batch "+batch.batchId)}));var removedDocuments=[];mutationStore=0;for(range=batch.mutations;mutationStore<range.length;mutationStore++){var mutation=range[mutationStore],indexKey=DbDocumentMutation.key(userId,mutation.key.path,batch.batchId);promises.push(txn.delete(indexKey));
removedDocuments.push(mutation.key)}return PersistencePromise.waitFor(promises).next(function(){return removedDocuments})}function convertStreamToken(token){return token instanceof Uint8Array?(assert("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),token.toString()):token}function mutationsStore(txn){return IndexedDbPersistence.getStore(txn,DbMutationBatch.store)}function documentMutationsStore(txn){return IndexedDbPersistence.getStore(txn,
DbDocumentMutation.store)}function wrapRequest(request){return new PersistencePromise(function(resolve,reject){request.onsuccess=function(event){resolve(event.target.result)};request.onerror=function(event){reject(event.target.error)}})}function targetsStore(txn){return IndexedDbPersistence.getStore(txn,DbTarget.store)}function retrieveMetadata(txn){return SimpleDb.getStore(txn,DbTargetGlobal.store).get(DbTargetGlobal.key).next(function(metadata){assert(null!==metadata,"Missing metadata row.");return metadata})}
function getHighestListenSequenceNumber(txn){return retrieveMetadata(txn).next(function(targetGlobal){return targetGlobal.highestListenSequenceNumber})}function documentTargetStore(txn){return IndexedDbPersistence.getStore(txn,DbTargetDocument.store)}function remoteDocumentsStore(txn){return IndexedDbPersistence.getStore(txn,DbRemoteDocument.store)}function dbDocumentSize(doc){if(doc.document)doc=doc.document;else if(doc.unknownDocument)doc=doc.unknownDocument;else if(doc.noDocument)doc=doc.noDocument;
else throw fail("Unknown remote document type");return JSON.stringify(doc).length}function createMutationQueue(db){db.createObjectStore(DbMutationQueue.store,{keyPath:DbMutationQueue.keyPath});db.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath,autoIncrement:!0}).createIndex(DbMutationBatch.userMutationsIndex,DbMutationBatch.userMutationsKeyPath,{unique:!0});db.createObjectStore(DbDocumentMutation.store)}function upgradeMutationBatchSchemaAndMigrateData(db,txn){return txn.store(DbMutationBatch.store).loadAll().next(function(existingMutations){db.deleteObjectStore(DbMutationBatch.store);
db.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath,autoIncrement:!0}).createIndex(DbMutationBatch.userMutationsIndex,DbMutationBatch.userMutationsKeyPath,{unique:!0});var v3MutationsStore=txn.store(DbMutationBatch.store);existingMutations=existingMutations.map(function(mutation){return v3MutationsStore.put(mutation)});return PersistencePromise.waitFor(existingMutations)})}function createQueryCache(db){db.createObjectStore(DbTargetDocument.store,{keyPath:DbTargetDocument.keyPath}).createIndex(DbTargetDocument.documentTargetsIndex,
DbTargetDocument.documentTargetsKeyPath,{unique:!0});db.createObjectStore(DbTarget.store,{keyPath:DbTarget.keyPath}).createIndex(DbTarget.queryTargetsIndexName,DbTarget.queryTargetsKeyPath,{unique:!0});db.createObjectStore(DbTargetGlobal.store)}function dropQueryCache(db){db.deleteObjectStore(DbTargetDocument.store);db.deleteObjectStore(DbTarget.store);db.deleteObjectStore(DbTargetGlobal.store)}function bufferEntryComparator(_a,_b){var aIndex=_a[1],bIndex=_b[1];_a=primitiveComparator(_a[0],_b[0]);
return 0===_a?primitiveComparator(aIndex,bIndex):_a}function ignoreIfPrimaryLeaseLoss(err){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(err.code===Code.FAILED_PRECONDITION&&err.message===PRIMARY_LEASE_LOST_ERROR_MSG)debug(LOG_TAG$2,"Unexpectedly lost primary lease");else throw err;return[2]})})}function sentinelRow(key,sequenceNumber){return new DbTargetDocument(0,encode(key.path),sequenceNumber)}function writeSentinelKey(txn,key){return documentTargetStore(txn).put(sentinelRow(key,
txn.currentSequenceNumber))}function compareChangeType(c1,c2){var order=function(change){switch(change){case ChangeType.Added:return 1;case ChangeType.Modified:return 2;case ChangeType.Metadata:return 2;case ChangeType.Removed:return 0;default:return fail("Unknown ChangeType: "+change)}};return order(c1)-order(c2)}function isPartialObserver(obj){a:{if("object"===typeof obj&&null!==obj)for(var _i=0,methods_1=["next","error","complete"];_i<methods_1.length;_i++){var method=methods_1[_i];if(method in
obj&&"function"===typeof obj[method]){obj=!0;break a}}obj=!1}return obj}function isWrite(dataSource){switch(dataSource){case UserDataSource.Set:case UserDataSource.MergeSet:case UserDataSource.Update:return!0;case UserDataSource.Argument:return!1;default:throw fail("Unexpected case for UserDataSource: "+dataSource);}}function looksLikeJsonObject(input){return"object"===typeof input&&null!==input&&!(input instanceof Array)&&!(input instanceof Date)&&!(input instanceof Timestamp)&&!(input instanceof
GeoPoint)&&!(input instanceof Blob$jscomp$0)&&!(input instanceof DocumentKeyReference)&&!(input instanceof FieldValueImpl)}function validatePlainObject(message,context,input){if(!looksLikeJsonObject(input)||!isPlainObject(input)){input=valueDescription(input);if("an object"===input)throw context.createError(message+" a custom object");throw context.createError(message+" "+input);}}function fieldPathFromArgument(methodName,path){if(path instanceof FieldPath$1)return path._internalPath;if("string"===
typeof path)return fieldPathFromDotSeparatedString(methodName,path);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+methodName+"() called with invalid data. Field path arguments must be of type string or FieldPath.");}function fieldPathFromDotSeparatedString(methodName,path){try{if(0<=path.search(RESERVED))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not contain '~', '*', '/', '[', or ']'");try{var JSCompiler_inline_result=new (FieldPath$1.bind.apply(FieldPath$1,
[void 0].concat(path.split("."))))}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");}return JSCompiler_inline_result._internalPath}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+methodName+"() called with invalid data. "+(e instanceof Error?e.message:e.toString()));}}function validateSetOptions(methodName,options){if(void 0===options)return{merge:!1};validateOptionNames(methodName,
options,["merge","mergeFields"]);validateNamedOptionalType(methodName,"boolean","merge",options.merge);validateOptionalArrayElements(methodName,"mergeFields","a string or a FieldPath",options.mergeFields,function(element){return"string"===typeof element||element instanceof FieldPath$1});if(void 0!==options.mergeFields&&void 0!==options.merge)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid options passed to function "+methodName+'(): You cannot specify both "merge" and "mergeFields".');return options}
function validateSnapshotOptions(methodName,options){if(void 0===options)return{};validateOptionNames(methodName,options,["serverTimestamps"]);var input=options.serverTimestamps,expected=["estimate","previous","none"];void 0!==input&&validateNamedPropertyEquals(methodName,"options","serverTimestamps",input,expected);return options}function validateGetOptions(methodName,options){validateOptionalArgType(methodName,"object",1,options);if(options){validateOptionNames(methodName,options,["source"]);options=
options.source;var expected=["default","server","cache"];void 0!==options&&validateNamedPropertyEquals(methodName,"options","source",options,expected)}}function validateReference(methodName,documentRef,firestore){if(documentRef instanceof DocumentReference){if(documentRef.firestore!==firestore)throw new FirestoreError(Code.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return documentRef}throw invalidClassError(methodName,"DocumentReference",1,documentRef);
}function changesFromSnapshot(firestore,includeMetadataChanges,snapshot){if(snapshot.oldDocs.isEmpty()){var lastDoc_1,index_1=0;return snapshot.docChanges.map(function(change){var doc=new QueryDocumentSnapshot(firestore,change.doc.key,change.doc,snapshot.fromCache,snapshot.mutatedKeys.has(change.doc.key));assert(change.type===ChangeType.Added,"Invalid event type for first snapshot");assert(!lastDoc_1||0>snapshot.query.docComparator(lastDoc_1,change.doc),"Got added events in wrong order");lastDoc_1=
change.doc;return{type:"added",doc:doc,oldIndex:-1,newIndex:index_1++}})}var indexTracker_1=snapshot.oldDocs;return snapshot.docChanges.filter(function(change){return includeMetadataChanges||change.type!==ChangeType.Metadata}).map(function(change){var doc=new QueryDocumentSnapshot(firestore,change.doc.key,change.doc,snapshot.fromCache,snapshot.mutatedKeys.has(change.doc.key)),oldIndex=-1,newIndex=-1;change.type!==ChangeType.Added&&(oldIndex=indexTracker_1.indexOf(change.doc.key),assert(0<=oldIndex,
"Index for document not found"),indexTracker_1=indexTracker_1.delete(change.doc.key));change.type!==ChangeType.Removed&&(indexTracker_1=indexTracker_1.add(change.doc),newIndex=indexTracker_1.indexOf(change.doc.key));return{type:resultChangeType(change.type),doc:doc,oldIndex:oldIndex,newIndex:newIndex}})}function resultChangeType(type){switch(type){case ChangeType.Added:return"added";case ChangeType.Modified:case ChangeType.Metadata:return"modified";case ChangeType.Removed:return"removed";default:return fail("Unknown change type: "+
type)}}function configureForFirebase(firebase){firebase.INTERNAL.registerService("firestore",function(app){return new Firestore(app)},shallowCopy(firestoreNamespace))}Object.defineProperty(exports,"__esModule",{value:!0});var firebase$jscomp$0=function(ex){return ex&&"object"===typeof ex&&"default"in ex?ex["default"]:ex}(require("module$node_modules$$firebase$app$dist$index_cjs")),logger=require("module$node_modules$$firebase$logger$dist$index_cjs"),tslib_1=require("module$node_modules$tslib$tslib"),
webchannelWrapper=require("module$node_modules$$firebase$webchannel_wrapper$dist$index"),util=require("module$node_modules$$firebase$util$dist$index_cjs"),SDK_VERSION=firebase$jscomp$0.SDK_VERSION,logClient=new logger.Logger("@firebase/firestore"),LogLevel$jscomp$0;(function(LogLevel){LogLevel[LogLevel.DEBUG=0]="DEBUG";LogLevel[LogLevel.ERROR=1]="ERROR";LogLevel[LogLevel.SILENT=2]="SILENT"})(LogLevel$jscomp$0||(LogLevel$jscomp$0={}));var PlatformSupport=function(){function PlatformSupport(){}PlatformSupport.setPlatform=
function(platform){PlatformSupport.platform&&fail("Platform already defined");PlatformSupport.platform=platform};PlatformSupport.getPlatform=function(){PlatformSupport.platform||fail("Platform not set");return PlatformSupport.platform};return PlatformSupport}(),Code={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",
RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},FirestoreError=function(_super){function FirestoreError(code,message){var _this=_super.call(this,message)||this;_this.code=code;_this.message=message;_this.name="FirebaseError";_this.toString=function(){return _this.name+": [code\x3d"+_this.code+"]: "+_this.message};return _this}
tslib_1.__extends(FirestoreError,_super);return FirestoreError}(Error),AutoId=function(){function AutoId(){}AutoId.newId=function(){for(var autoId="",i=0;20>i;i++)autoId+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));assert(20===autoId.length,"Invalid auto ID: "+autoId);return autoId};return AutoId}(),Blob$jscomp$0=function(){function Blob(binaryString){assertBase64Available();this._binaryString=binaryString}Blob.fromBase64String=function(base64){validateExactNumberOfArgs("Blob.fromBase64String",
arguments,1);validateArgType("Blob.fromBase64String","string",1,base64);assertBase64Available();try{var binaryString=PlatformSupport.getPlatform().atob(base64);return new Blob(binaryString)}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+e);}};Blob.fromUint8Array=function(array){validateExactNumberOfArgs("Blob.fromUint8Array",arguments,1);assertUint8ArrayAvailable();if(!(array instanceof Uint8Array))throw invalidClassError("Blob.fromUint8Array",
"Uint8Array",1,array);var binaryString=Array.prototype.map.call(array,function(char){return String.fromCharCode(char)}).join("");return new Blob(binaryString)};Blob.prototype.toBase64=function(){validateExactNumberOfArgs("Blob.toBase64",arguments,0);assertBase64Available();return PlatformSupport.getPlatform().btoa(this._binaryString)};Blob.prototype.toUint8Array=function(){validateExactNumberOfArgs("Blob.toUint8Array",arguments,0);assertUint8ArrayAvailable();for(var buffer=new Uint8Array(this._binaryString.length),
i=0;i<this._binaryString.length;i++)buffer[i]=this._binaryString.charCodeAt(i);return buffer};Blob.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"};Blob.prototype.isEqual=function(other){return this._binaryString===other._binaryString};Blob.prototype._compareTo=function(other){return primitiveComparator(this._binaryString,other._binaryString)};return Blob}(),PublicBlob=makeConstructorPrivate(Blob$jscomp$0,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),GeoPoint=
function(){function GeoPoint(latitude,longitude){validateExactNumberOfArgs("GeoPoint",arguments,2);validateArgType("GeoPoint","number",1,latitude);validateArgType("GeoPoint","number",2,longitude);if(!isFinite(latitude)||-90>latitude||90<latitude)throw new FirestoreError(Code.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+latitude);if(!isFinite(longitude)||-180>longitude||180<longitude)throw new FirestoreError(Code.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+
longitude);this._lat=latitude;this._long=longitude}Object.defineProperty(GeoPoint.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0});Object.defineProperty(GeoPoint.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0});GeoPoint.prototype.isEqual=function(other){return this._lat===other._lat&&this._long===other._long};GeoPoint.prototype._compareTo=function(other){return primitiveComparator(this._lat,other._lat)||primitiveComparator(this._long,
other._long)};return GeoPoint}(),Timestamp=function(){function Timestamp(seconds,nanoseconds){this.seconds=seconds;this.nanoseconds=nanoseconds;if(0>nanoseconds)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+nanoseconds);if(1E9<=nanoseconds)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+nanoseconds);if(-62135596800>seconds)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp seconds out of range: "+seconds);if(253402300800<=
seconds)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp seconds out of range: "+seconds);}Timestamp.now=function(){return Timestamp.fromMillis(Date.now())};Timestamp.fromDate=function(date){return Timestamp.fromMillis(date.getTime())};Timestamp.fromMillis=function(milliseconds){var seconds=Math.floor(milliseconds/1E3);return new Timestamp(seconds,1E6*(milliseconds-1E3*seconds))};Timestamp.prototype.toDate=function(){return new Date(this.toMillis())};Timestamp.prototype.toMillis=function(){return 1E3*
this.seconds+this.nanoseconds/1E6};Timestamp.prototype._compareTo=function(other){return this.seconds===other.seconds?primitiveComparator(this.nanoseconds,other.nanoseconds):primitiveComparator(this.seconds,other.seconds)};Timestamp.prototype.isEqual=function(other){return other.seconds===this.seconds&&other.nanoseconds===this.nanoseconds};Timestamp.prototype.toString=function(){return"Timestamp(seconds\x3d"+this.seconds+", nanoseconds\x3d"+this.nanoseconds+")"};return Timestamp}(),DatabaseInfo=function(){return function(databaseId,
persistenceKey,host,ssl){this.databaseId=databaseId;this.persistenceKey=persistenceKey;this.host=host;this.ssl=ssl}}(),DatabaseId=function(){function DatabaseId(projectId,database){this.projectId=projectId;this.database=database?database:"(default)"}Object.defineProperty(DatabaseId.prototype,"isDefaultDatabase",{get:function(){return"(default)"===this.database},enumerable:!0,configurable:!0});DatabaseId.prototype.isEqual=function(other){return other instanceof DatabaseId&&other.projectId===this.projectId&&
other.database===this.database};DatabaseId.prototype.compareTo=function(other){return primitiveComparator(this.projectId,other.projectId)||primitiveComparator(this.database,other.database)};return DatabaseId}(),Path$jscomp$0=function(){function Path(segments,offset,length){this.init(segments,offset,length)}Path.prototype.init=function(segments,offset,length){void 0===offset?offset=0:offset>segments.length&&fail("offset "+offset+" out of range "+segments.length);void 0===length?length=segments.length-
offset:length>segments.length-offset&&fail("length "+length+" out of range "+(segments.length-offset));this.segments=segments;this.offset=offset;this.len=length};Path.prototype.construct=function(segments,offset,length){var path=Object.create(Object.getPrototypeOf(this));path.init(segments,offset,length);return path};Object.defineProperty(Path.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0});Path.prototype.isEqual=function(other){return 0===Path.comparator(this,
other)};Path.prototype.child=function(nameOrPath){var segments=this.segments.slice(this.offset,this.limit());nameOrPath instanceof Path?nameOrPath.forEach(function(segment){segments.push(segment)}):"string"===typeof nameOrPath?segments.push(nameOrPath):fail("Unknown parameter type for Path.child(): "+nameOrPath);return this.construct(segments)};Path.prototype.limit=function(){return this.offset+this.length};Path.prototype.popFirst=function(size){size=void 0===size?1:size;assert(this.length>=size,
"Can't call popFirst() with less segments");return this.construct(this.segments,this.offset+size,this.length-size)};Path.prototype.popLast=function(){assert(!this.isEmpty(),"Can't call popLast() on empty path");return this.construct(this.segments,this.offset,this.length-1)};Path.prototype.firstSegment=function(){assert(!this.isEmpty(),"Can't call firstSegment() on empty path");return this.segments[this.offset]};Path.prototype.lastSegment=function(){return this.get(this.length-1)};Path.prototype.get=
function(index){assert(index<this.length,"Index out of range");return this.segments[this.offset+index]};Path.prototype.isEmpty=function(){return 0===this.length};Path.prototype.isPrefixOf=function(other){if(other.length<this.length)return!1;for(var i=0;i<this.length;i++)if(this.get(i)!==other.get(i))return!1;return!0};Path.prototype.isImmediateParentOf=function(potentialChild){if(this.length+1!==potentialChild.length)return!1;for(var i=0;i<this.length;i++)if(this.get(i)!==potentialChild.get(i))return!1;
return!0};Path.prototype.forEach=function(fn){for(var i=this.offset,end=this.limit();i<end;i++)fn(this.segments[i])};Path.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())};Path.comparator=function(p1,p2){for(var len=Math.min(p1.length,p2.length),i=0;i<len;i++){var left=p1.get(i),right=p2.get(i);if(left<right)return-1;if(left>right)return 1}return p1.length<p2.length?-1:p1.length>p2.length?1:0};return Path}(),ResourcePath=function(_super){function ResourcePath(){return null!==
_super&&_super.apply(this,arguments)||this}tslib_1.__extends(ResourcePath,_super);ResourcePath.prototype.canonicalString=function(){return this.toArray().join("/")};ResourcePath.prototype.toString=function(){return this.canonicalString()};ResourcePath.fromString=function(path){if(0<=path.indexOf("//"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid path ("+path+"). Paths must not contain // in them.");path=path.split("/").filter(function(segment){return 0<segment.length});return new ResourcePath(path)};
ResourcePath.EMPTY_PATH=new ResourcePath([]);return ResourcePath}(Path$jscomp$0),identifierRegExp=/^[_a-zA-Z][_a-zA-Z0-9]*$/,FieldPath=function(_super){function FieldPath(){return null!==_super&&_super.apply(this,arguments)||this}tslib_1.__extends(FieldPath,_super);FieldPath.isValidIdentifier=function(segment){return identifierRegExp.test(segment)};FieldPath.prototype.canonicalString=function(){return this.toArray().map(function(str){str=str.replace("\\","\\\\").replace("`","\\`");FieldPath.isValidIdentifier(str)||
(str="`"+str+"`");return str}).join(".")};FieldPath.prototype.toString=function(){return this.canonicalString()};FieldPath.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)};FieldPath.keyField=function(){return new FieldPath(["__name__"])};FieldPath.fromServerFormat=function(path){for(var segments=[],current="",i=0,addCurrentSegment=function(){if(0===current.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");
segments.push(current);current=""},inBackticks=!1;i<path.length;){var c=path[i];if("\\"===c){if(i+1===path.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has trailing escape character: "+path);c=path[i+1];if("\\"!==c&&"."!==c&&"`"!==c)throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has invalid escape sequence: "+path);current+=c;i+=2}else"`"===c?inBackticks=!inBackticks:"."!==c||inBackticks?current+=c:addCurrentSegment(),i++}addCurrentSegment();if(inBackticks)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Unterminated ` in path: "+path);return new FieldPath(segments)};FieldPath.EMPTY_PATH=new FieldPath([]);return FieldPath}(Path$jscomp$0),DocumentKey=function(){function DocumentKey(path){this.path=path;assert(DocumentKey.isDocumentKey(path),"Invalid DocumentKey with an odd number of segments: "+path.toArray().join("/"))}DocumentKey.prototype.hasCollectionId=function(collectionId){return 2<=this.path.length&&this.path.get(this.path.length-2)===collectionId};DocumentKey.prototype.isEqual=function(other){return null!==
other&&0===ResourcePath.comparator(this.path,other.path)};DocumentKey.prototype.toString=function(){return this.path.toString()};DocumentKey.comparator=function(k1,k2){return ResourcePath.comparator(k1.path,k2.path)};DocumentKey.isDocumentKey=function(path){return 0===path.length%2};DocumentKey.fromSegments=function(segments){return new DocumentKey(new ResourcePath(segments.slice()))};DocumentKey.fromPathString=function(path){return new DocumentKey(ResourcePath.fromString(path))};DocumentKey.EMPTY=
new DocumentKey(new ResourcePath([]));return DocumentKey}(),MaybeDocument=function(){function MaybeDocument(key,version){this.key=key;this.version=version}MaybeDocument.compareByKey=function(d1,d2){return DocumentKey.comparator(d1.key,d2.key)};return MaybeDocument}(),Document$jscomp$0=function(_super){function Document(key,version,data,options,proto){key=_super.call(this,key,version)||this;key.data=data;key.proto=proto;key.hasLocalMutations=!!options.hasLocalMutations;key.hasCommittedMutations=!!options.hasCommittedMutations;
return key}tslib_1.__extends(Document,_super);Document.prototype.field=function(path){return this.data.field(path)};Document.prototype.fieldValue=function(path){return(path=this.field(path))?path.value():void 0};Document.prototype.value=function(){return this.data.value()};Document.prototype.isEqual=function(other){return other instanceof Document&&this.key.isEqual(other.key)&&this.version.isEqual(other.version)&&this.data.isEqual(other.data)&&this.hasLocalMutations===other.hasLocalMutations&&this.hasCommittedMutations===
other.hasCommittedMutations};Document.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", "+("{hasLocalMutations: "+this.hasLocalMutations+"}), ")+("{hasCommittedMutations: "+this.hasCommittedMutations+"})")};Object.defineProperty(Document.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0});Document.compareByField=function(field,d1,d2){d1=d1.field(field);field=d2.field(field);
return void 0!==d1&&void 0!==field?d1.compareTo(field):fail("Trying to compare documents on fields that don't exist")};return Document}(MaybeDocument),NoDocument=function(_super){function NoDocument(key,version,options){key=_super.call(this,key,version)||this;key.hasCommittedMutations=!(!options||!options.hasCommittedMutations);return key}tslib_1.__extends(NoDocument,_super);NoDocument.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"};Object.defineProperty(NoDocument.prototype,
"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0});NoDocument.prototype.isEqual=function(other){return other instanceof NoDocument&&other.hasCommittedMutations===this.hasCommittedMutations&&other.version.isEqual(this.version)&&other.key.isEqual(this.key)};return NoDocument}(MaybeDocument),UnknownDocument=function(_super){function UnknownDocument(key,version){return _super.call(this,key,version)||this}tslib_1.__extends(UnknownDocument,_super);UnknownDocument.prototype.toString=
function(){return"UnknownDocument("+this.key+", "+this.version+")"};Object.defineProperty(UnknownDocument.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0});UnknownDocument.prototype.isEqual=function(other){return other instanceof UnknownDocument&&other.version.isEqual(this.version)&&other.key.isEqual(this.key)};return UnknownDocument}(MaybeDocument),SortedMap$jscomp$0=function(){function SortedMap(comparator,root){this.comparator=comparator;this.root=root?root:
LLRBNode$jscomp$0.EMPTY}SortedMap.prototype.insert=function(key,value){return new SortedMap(this.comparator,this.root.insert(key,value,this.comparator).copy(null,null,LLRBNode$jscomp$0.BLACK,null,null))};SortedMap.prototype.remove=function(key){return new SortedMap(this.comparator,this.root.remove(key,this.comparator).copy(null,null,LLRBNode$jscomp$0.BLACK,null,null))};SortedMap.prototype.get=function(key){for(var node=this.root;!node.isEmpty();){var cmp=this.comparator(key,node.key);if(0===cmp)return node.value;
0>cmp?node=node.left:0<cmp&&(node=node.right)}return null};SortedMap.prototype.indexOf=function(key){for(var prunedNodes=0,node=this.root;!node.isEmpty();){var cmp=this.comparator(key,node.key);if(0===cmp)return prunedNodes+node.left.size;0>cmp?node=node.left:(prunedNodes+=node.left.size+1,node=node.right)}return-1};SortedMap.prototype.isEmpty=function(){return this.root.isEmpty()};Object.defineProperty(SortedMap.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0});
SortedMap.prototype.minKey=function(){return this.root.minKey()};SortedMap.prototype.maxKey=function(){return this.root.maxKey()};SortedMap.prototype.inorderTraversal=function(action){return this.root.inorderTraversal(action)};SortedMap.prototype.forEach=function(fn){this.inorderTraversal(function(k,v){fn(k,v);return!1})};SortedMap.prototype.reverseTraversal=function(action){return this.root.reverseTraversal(action)};SortedMap.prototype.getIterator=function(){return new SortedMapIterator$jscomp$0(this.root,
null,this.comparator,!1)};SortedMap.prototype.getIteratorFrom=function(key){return new SortedMapIterator$jscomp$0(this.root,key,this.comparator,!1)};SortedMap.prototype.getReverseIterator=function(){return new SortedMapIterator$jscomp$0(this.root,null,this.comparator,!0)};SortedMap.prototype.getReverseIteratorFrom=function(key){return new SortedMapIterator$jscomp$0(this.root,key,this.comparator,!0)};return SortedMap}(),SortedMapIterator$jscomp$0=function(){function SortedMapIterator(node,startKey,
comparator,isReverse){this.isReverse=isReverse;this.nodeStack=[];for(var cmp;!node.isEmpty();)if(cmp=startKey?comparator(node.key,startKey):1,isReverse&&(cmp*=-1),0>cmp)node=this.isReverse?node.left:node.right;else if(0===cmp){this.nodeStack.push(node);break}else this.nodeStack.push(node),node=this.isReverse?node.right:node.left}SortedMapIterator.prototype.getNext=function(){assert(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var node=this.nodeStack.pop(),result=
{key:node.key,value:node.value};if(this.isReverse)for(node=node.left;!node.isEmpty();)this.nodeStack.push(node),node=node.right;else for(node=node.right;!node.isEmpty();)this.nodeStack.push(node),node=node.left;return result};SortedMapIterator.prototype.hasNext=function(){return 0<this.nodeStack.length};SortedMapIterator.prototype.peek=function(){if(0===this.nodeStack.length)return null;var node=this.nodeStack[this.nodeStack.length-1];return{key:node.key,value:node.value}};return SortedMapIterator}(),
LLRBNode$jscomp$0=function(){function LLRBNode(key,value,color,left,right){this.key=key;this.value=value;this.color=null!=color?color:LLRBNode.RED;this.left=null!=left?left:LLRBNode.EMPTY;this.right=null!=right?right:LLRBNode.EMPTY;this.size=this.left.size+1+this.right.size}LLRBNode.prototype.copy=function(key,value,color,left,right){return new LLRBNode(null!=key?key:this.key,null!=value?value:this.value,null!=color?color:this.color,null!=left?left:this.left,null!=right?right:this.right)};LLRBNode.prototype.isEmpty=
function(){return!1};LLRBNode.prototype.inorderTraversal=function(action){return this.left.inorderTraversal(action)||action(this.key,this.value)||this.right.inorderTraversal(action)};LLRBNode.prototype.reverseTraversal=function(action){return this.right.reverseTraversal(action)||action(this.key,this.value)||this.left.reverseTraversal(action)};LLRBNode.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()};LLRBNode.prototype.minKey=function(){return this.min().key};LLRBNode.prototype.maxKey=
function(){return this.right.isEmpty()?this.key:this.right.maxKey()};LLRBNode.prototype.insert=function(key,value,comparator){var n=this,cmp=comparator(key,n.key);n=0>cmp?n.copy(null,null,null,n.left.insert(key,value,comparator),null):0===cmp?n.copy(null,value,null,null,null):n.copy(null,null,null,null,n.right.insert(key,value,comparator));return n.fixUp()};LLRBNode.prototype.removeMin=function(){if(this.left.isEmpty())return LLRBNode.EMPTY;var n=this;n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft());
n=n.copy(null,null,null,n.left.removeMin(),null);return n.fixUp()};LLRBNode.prototype.remove=function(key,comparator){var n=this;if(0>comparator(key,n.key))n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(key,comparator),null);else{n.left.isRed()&&(n=n.rotateRight());n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight());if(0===comparator(key,n.key)){if(n.right.isEmpty())return LLRBNode.EMPTY;var smallest=n.right.min();
n=n.copy(smallest.key,smallest.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(key,comparator))}return n.fixUp()};LLRBNode.prototype.isRed=function(){return this.color};LLRBNode.prototype.fixUp=function(){var n=this;n.right.isRed()&&!n.left.isRed()&&(n=n.rotateLeft());n.left.isRed()&&n.left.left.isRed()&&(n=n.rotateRight());n.left.isRed()&&n.right.isRed()&&(n=n.colorFlip());return n};LLRBNode.prototype.moveRedLeft=function(){var n=this.colorFlip();n.right.left.isRed()&&
(n=n.copy(null,null,null,null,n.right.rotateRight()),n=n.rotateLeft(),n=n.colorFlip());return n};LLRBNode.prototype.moveRedRight=function(){var n=this.colorFlip();n.left.left.isRed()&&(n=n.rotateRight(),n=n.colorFlip());return n};LLRBNode.prototype.rotateLeft=function(){var nl=this.copy(null,null,LLRBNode.RED,null,this.right.left);return this.right.copy(null,null,this.color,nl,null)};LLRBNode.prototype.rotateRight=function(){var nr=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,
null,this.color,null,nr)};LLRBNode.prototype.colorFlip=function(){var left=this.left.copy(null,null,!this.left.color,null,null),right=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,left,right)};LLRBNode.prototype.checkMaxDepth=function(){var blackDepth=this.check();return Math.pow(2,blackDepth)<=this.size+1?!0:!1};LLRBNode.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw fail("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw fail("Right child of ("+
this.key+","+this.value+") is red");var blackDepth=this.left.check();if(blackDepth!==this.right.check())throw fail("Black depths differ");return blackDepth+(this.isRed()?0:1)};LLRBNode.EMPTY=null;LLRBNode.RED=!0;LLRBNode.BLACK=!1;return LLRBNode}(),LLRBEmptyNode$jscomp$0=function(){function LLRBEmptyNode(){this.size=0}LLRBEmptyNode.prototype.copy=function(key,value,color,left,right){return this};LLRBEmptyNode.prototype.insert=function(key,value,comparator){return new LLRBNode$jscomp$0(key,value)};
LLRBEmptyNode.prototype.remove=function(key,comparator){return this};LLRBEmptyNode.prototype.isEmpty=function(){return!0};LLRBEmptyNode.prototype.inorderTraversal=function(action){return!1};LLRBEmptyNode.prototype.reverseTraversal=function(action){return!1};LLRBEmptyNode.prototype.minKey=function(){return null};LLRBEmptyNode.prototype.maxKey=function(){return null};LLRBEmptyNode.prototype.isRed=function(){return!1};LLRBEmptyNode.prototype.checkMaxDepth=function(){return!0};LLRBEmptyNode.prototype.check=
function(){return 0};return LLRBEmptyNode}();LLRBNode$jscomp$0.EMPTY=new LLRBEmptyNode$jscomp$0;var TypeOrder;(function(TypeOrder){TypeOrder[TypeOrder.NullValue=0]="NullValue";TypeOrder[TypeOrder.BooleanValue=1]="BooleanValue";TypeOrder[TypeOrder.NumberValue=2]="NumberValue";TypeOrder[TypeOrder.TimestampValue=3]="TimestampValue";TypeOrder[TypeOrder.StringValue=4]="StringValue";TypeOrder[TypeOrder.BlobValue=5]="BlobValue";TypeOrder[TypeOrder.RefValue=6]="RefValue";TypeOrder[TypeOrder.GeoPointValue=
7]="GeoPointValue";TypeOrder[TypeOrder.ArrayValue=8]="ArrayValue";TypeOrder[TypeOrder.ObjectValue=9]="ObjectValue"})(TypeOrder||(TypeOrder={}));var ServerTimestampBehavior;(function(ServerTimestampBehavior){ServerTimestampBehavior[ServerTimestampBehavior.Default=0]="Default";ServerTimestampBehavior[ServerTimestampBehavior.Estimate=1]="Estimate";ServerTimestampBehavior[ServerTimestampBehavior.Previous=2]="Previous"})(ServerTimestampBehavior||(ServerTimestampBehavior={}));var FieldValueOptions=function(){function FieldValueOptions(serverTimestampBehavior,
timestampsInSnapshots){this.serverTimestampBehavior=serverTimestampBehavior;this.timestampsInSnapshots=timestampsInSnapshots}FieldValueOptions.fromSnapshotOptions=function(options,timestampsInSnapshots){switch(options.serverTimestamps){case "estimate":return new FieldValueOptions(ServerTimestampBehavior.Estimate,timestampsInSnapshots);case "previous":return new FieldValueOptions(ServerTimestampBehavior.Previous,timestampsInSnapshots);case "none":case void 0:return new FieldValueOptions(ServerTimestampBehavior.Default,
timestampsInSnapshots);default:return fail("fromSnapshotOptions() called with invalid options.")}};return FieldValueOptions}(),FieldValue=function(){function FieldValue(){}FieldValue.prototype.toString=function(){var val=this.value();return null===val?"null":val.toString()};FieldValue.prototype.defaultCompareTo=function(other){assert(this.typeOrder!==other.typeOrder,"Default compareTo should not be used for values of same type.");return primitiveComparator(this.typeOrder,other.typeOrder)};return FieldValue}(),
NullValue=function(_super){function NullValue(){var _this=_super.call(this)||this;_this.typeOrder=TypeOrder.NullValue;_this.internalValue=null;return _this}tslib_1.__extends(NullValue,_super);NullValue.prototype.value=function(options){return null};NullValue.prototype.isEqual=function(other){return other instanceof NullValue};NullValue.prototype.compareTo=function(other){return other instanceof NullValue?0:this.defaultCompareTo(other)};NullValue.INSTANCE=new NullValue;return NullValue}(FieldValue),
BooleanValue=function(_super){function BooleanValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.BooleanValue;return _this}tslib_1.__extends(BooleanValue,_super);BooleanValue.prototype.value=function(options){return this.internalValue};BooleanValue.prototype.isEqual=function(other){return other instanceof BooleanValue&&this.internalValue===other.internalValue};BooleanValue.prototype.compareTo=function(other){return other instanceof BooleanValue?
primitiveComparator(this,other):this.defaultCompareTo(other)};BooleanValue.of=function(value){return value?BooleanValue.TRUE:BooleanValue.FALSE};BooleanValue.TRUE=new BooleanValue(!0);BooleanValue.FALSE=new BooleanValue(!1);return BooleanValue}(FieldValue),NumberValue=function(_super){function NumberValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.NumberValue;return _this}tslib_1.__extends(NumberValue,_super);NumberValue.prototype.value=
function(options){return this.internalValue};NumberValue.prototype.compareTo=function(other){if(other instanceof NumberValue){var JSCompiler_temp=this.internalValue;other=other.internalValue;JSCompiler_temp=JSCompiler_temp<other?-1:JSCompiler_temp>other?1:JSCompiler_temp===other?0:isNaN(JSCompiler_temp)?isNaN(other)?0:-1:1}else JSCompiler_temp=this.defaultCompareTo(other);return JSCompiler_temp};return NumberValue}(FieldValue),IntegerValue=function(_super){function IntegerValue(internalValue){return _super.call(this,
internalValue)||this}tslib_1.__extends(IntegerValue,_super);IntegerValue.prototype.isEqual=function(other){return other instanceof IntegerValue?numericEquals(this.internalValue,other.internalValue):!1};return IntegerValue}(NumberValue),DoubleValue=function(_super){function DoubleValue(internalValue){var _this=_super.call(this,internalValue)||this;_this.internalValue=internalValue;return _this}tslib_1.__extends(DoubleValue,_super);DoubleValue.prototype.isEqual=function(other){return other instanceof
DoubleValue?numericEquals(this.internalValue,other.internalValue):!1};DoubleValue.NAN=new DoubleValue(NaN);DoubleValue.POSITIVE_INFINITY=new DoubleValue(Infinity);DoubleValue.NEGATIVE_INFINITY=new DoubleValue(-Infinity);return DoubleValue}(NumberValue),StringValue=function(_super){function StringValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.StringValue;return _this}tslib_1.__extends(StringValue,_super);StringValue.prototype.value=
function(options){return this.internalValue};StringValue.prototype.isEqual=function(other){return other instanceof StringValue&&this.internalValue===other.internalValue};StringValue.prototype.compareTo=function(other){return other instanceof StringValue?primitiveComparator(this.internalValue,other.internalValue):this.defaultCompareTo(other)};return StringValue}(FieldValue),TimestampValue=function(_super){function TimestampValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=
internalValue;_this.typeOrder=TypeOrder.TimestampValue;return _this}tslib_1.__extends(TimestampValue,_super);TimestampValue.prototype.value=function(options){return!options||options.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()};TimestampValue.prototype.isEqual=function(other){return other instanceof TimestampValue&&this.internalValue.isEqual(other.internalValue)};TimestampValue.prototype.compareTo=function(other){return other instanceof TimestampValue?this.internalValue._compareTo(other.internalValue):
other instanceof ServerTimestampValue?-1:this.defaultCompareTo(other)};return TimestampValue}(FieldValue),ServerTimestampValue=function(_super){function ServerTimestampValue(localWriteTime,previousValue){var _this=_super.call(this)||this;_this.localWriteTime=localWriteTime;_this.previousValue=previousValue;_this.typeOrder=TypeOrder.TimestampValue;return _this}tslib_1.__extends(ServerTimestampValue,_super);ServerTimestampValue.prototype.value=function(options){return options&&options.serverTimestampBehavior===
ServerTimestampBehavior.Estimate?(new TimestampValue(this.localWriteTime)).value(options):options&&options.serverTimestampBehavior===ServerTimestampBehavior.Previous?this.previousValue?this.previousValue.value(options):null:null};ServerTimestampValue.prototype.isEqual=function(other){return other instanceof ServerTimestampValue&&this.localWriteTime.isEqual(other.localWriteTime)};ServerTimestampValue.prototype.compareTo=function(other){return other instanceof ServerTimestampValue?this.localWriteTime._compareTo(other.localWriteTime):
other instanceof TimestampValue?1:this.defaultCompareTo(other)};ServerTimestampValue.prototype.toString=function(){return"\x3cServerTimestamp localTime\x3d"+this.localWriteTime.toString()+"\x3e"};return ServerTimestampValue}(FieldValue),BlobValue=function(_super){function BlobValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.BlobValue;return _this}tslib_1.__extends(BlobValue,_super);BlobValue.prototype.value=function(options){return this.internalValue};
BlobValue.prototype.isEqual=function(other){return other instanceof BlobValue&&this.internalValue.isEqual(other.internalValue)};BlobValue.prototype.compareTo=function(other){return other instanceof BlobValue?this.internalValue._compareTo(other.internalValue):this.defaultCompareTo(other)};return BlobValue}(FieldValue),RefValue=function(_super){function RefValue(databaseId,key){var _this=_super.call(this)||this;_this.databaseId=databaseId;_this.key=key;_this.typeOrder=TypeOrder.RefValue;return _this}
tslib_1.__extends(RefValue,_super);RefValue.prototype.value=function(options){return this.key};RefValue.prototype.isEqual=function(other){return other instanceof RefValue?this.key.isEqual(other.key)&&this.databaseId.isEqual(other.databaseId):!1};RefValue.prototype.compareTo=function(other){if(other instanceof RefValue){var cmp=this.databaseId.compareTo(other.databaseId);return 0!==cmp?cmp:DocumentKey.comparator(this.key,other.key)}return this.defaultCompareTo(other)};return RefValue}(FieldValue),
GeoPointValue=function(_super){function GeoPointValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.GeoPointValue;return _this}tslib_1.__extends(GeoPointValue,_super);GeoPointValue.prototype.value=function(options){return this.internalValue};GeoPointValue.prototype.isEqual=function(other){return other instanceof GeoPointValue&&this.internalValue.isEqual(other.internalValue)};GeoPointValue.prototype.compareTo=function(other){return other instanceof
GeoPointValue?this.internalValue._compareTo(other.internalValue):this.defaultCompareTo(other)};return GeoPointValue}(FieldValue),ObjectValue=function(_super){function ObjectValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.ObjectValue;return _this}tslib_1.__extends(ObjectValue,_super);ObjectValue.prototype.value=function(options){var result={};this.internalValue.inorderTraversal(function(key,val){result[key]=val.value(options)});return result};
ObjectValue.prototype.forEach=function(action){this.internalValue.inorderTraversal(action)};ObjectValue.prototype.isEqual=function(other){if(other instanceof ObjectValue){var it1=this.internalValue.getIterator();for(other=other.internalValue.getIterator();it1.hasNext()&&other.hasNext();){var next1=it1.getNext(),next2=other.getNext();if(next1.key!==next2.key||!next1.value.isEqual(next2.value))return!1}return!it1.hasNext()&&!other.hasNext()}return!1};ObjectValue.prototype.compareTo=function(other){if(other instanceof
ObjectValue){var it1=this.internalValue.getIterator();for(other=other.internalValue.getIterator();it1.hasNext()&&other.hasNext();){var next1=it1.getNext(),next2=other.getNext();if(next1=primitiveComparator(next1.key,next2.key)||next1.value.compareTo(next2.value))return next1}return primitiveComparator(it1.hasNext(),other.hasNext())}return this.defaultCompareTo(other)};ObjectValue.prototype.set=function(path,to){assert(!path.isEmpty(),"Cannot set field for empty path on ObjectValue");if(1===path.length)return this.setChild(path.firstSegment(),
to);var child=this.child(path.firstSegment());child instanceof ObjectValue||(child=ObjectValue.EMPTY);to=child.set(path.popFirst(),to);return this.setChild(path.firstSegment(),to)};ObjectValue.prototype.delete=function(path){assert(!path.isEmpty(),"Cannot delete field for empty path on ObjectValue");if(1===path.length)return new ObjectValue(this.internalValue.remove(path.firstSegment()));var child=this.child(path.firstSegment());return child instanceof ObjectValue?(child=child.delete(path.popFirst()),
new ObjectValue(this.internalValue.insert(path.firstSegment(),child))):this};ObjectValue.prototype.contains=function(path){return void 0!==this.field(path)};ObjectValue.prototype.field=function(path){assert(!path.isEmpty(),"Can't get field of empty path");var field=this;path.forEach(function(pathSegment){field=field instanceof ObjectValue?field.internalValue.get(pathSegment)||void 0:void 0});return field};ObjectValue.prototype.toString=function(){return JSON.stringify(this.value())};ObjectValue.prototype.child=
function(childName){return this.internalValue.get(childName)||void 0};ObjectValue.prototype.setChild=function(childName,value){return new ObjectValue(this.internalValue.insert(childName,value))};ObjectValue.EMPTY=new ObjectValue(new SortedMap$jscomp$0(primitiveComparator));return ObjectValue}(FieldValue),ArrayValue=function(_super){function ArrayValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.ArrayValue;return _this}tslib_1.__extends(ArrayValue,
_super);ArrayValue.prototype.value=function(options){return this.internalValue.map(function(v){return v.value(options)})};ArrayValue.prototype.forEach=function(action){this.internalValue.forEach(action)};ArrayValue.prototype.isEqual=function(other){if(other instanceof ArrayValue){if(this.internalValue.length!==other.internalValue.length)return!1;for(var i=0;i<this.internalValue.length;i++)if(!this.internalValue[i].isEqual(other.internalValue[i]))return!1;return!0}return!1};ArrayValue.prototype.compareTo=
function(other){if(other instanceof ArrayValue){for(var minLength=Math.min(this.internalValue.length,other.internalValue.length),i=0;i<minLength;i++){var cmp=this.internalValue[i].compareTo(other.internalValue[i]);if(cmp)return cmp}return primitiveComparator(this.internalValue.length,other.internalValue.length)}return this.defaultCompareTo(other)};ArrayValue.prototype.toString=function(){return JSON.stringify(this.value())};return ArrayValue}(FieldValue),NumberAsAny=Number,MIN_SAFE_INTEGER=NumberAsAny.MIN_SAFE_INTEGER||
-(Math.pow(2,53)-1),MAX_SAFE_INTEGER=NumberAsAny.MAX_SAFE_INTEGER||Math.pow(2,53)-1,isInteger=NumberAsAny.isInteger||function(value){return"number"===typeof value&&isFinite(value)&&Math.floor(value)===value},Query$jscomp$0=function(){function Query(path,collectionGroup,explicitOrderBy,filters,limit,startAt,endAt){void 0===collectionGroup&&(collectionGroup=null);void 0===explicitOrderBy&&(explicitOrderBy=[]);void 0===filters&&(filters=[]);void 0===limit&&(limit=null);void 0===startAt&&(startAt=null);
void 0===endAt&&(endAt=null);this.path=path;this.collectionGroup=collectionGroup;this.explicitOrderBy=explicitOrderBy;this.filters=filters;this.limit=limit;this.startAt=startAt;this.endAt=endAt;this.memoizedOrderBy=this.memoizedCanonicalId=null;this.startAt&&this.assertValidBound(this.startAt);this.endAt&&this.assertValidBound(this.endAt)}Query.atPath=function(path){return new Query(path)};Object.defineProperty(Query.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var inequalityField=
this.getInequalityFilterField(),firstOrderByField=this.getFirstOrderByField();if(null!==inequalityField&&null===firstOrderByField)inequalityField.isKeyField()?this.memoizedOrderBy=[KEY_ORDERING_ASC]:this.memoizedOrderBy=[new OrderBy(inequalityField),KEY_ORDERING_ASC];else{assert(null===inequalityField||null!==firstOrderByField&&inequalityField.isEqual(firstOrderByField),"First orderBy should match inequality field.");this.memoizedOrderBy=[];inequalityField=!1;firstOrderByField=0;for(var _a=this.explicitOrderBy;firstOrderByField<
_a.length;firstOrderByField++){var orderBy=_a[firstOrderByField];this.memoizedOrderBy.push(orderBy);orderBy.field.isKeyField()&&(inequalityField=!0)}inequalityField||this.memoizedOrderBy.push((0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Direction.ASCENDING)===Direction.ASCENDING?KEY_ORDERING_ASC:KEY_ORDERING_DESC)}}return this.memoizedOrderBy},enumerable:!0,configurable:!0});Query.prototype.addFilter=function(filter){assert(null==this.getInequalityFilterField()||
!(filter instanceof RelationFilter)||!filter.isInequality()||filter.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field.");assert(!this.isDocumentQuery(),"No filtering allowed for document query");filter=this.filters.concat([filter]);return new Query(this.path,this.collectionGroup,this.explicitOrderBy.slice(),filter,this.limit,this.startAt,this.endAt)};Query.prototype.addOrderBy=function(orderBy){assert(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");
orderBy=this.explicitOrderBy.concat([orderBy]);return new Query(this.path,this.collectionGroup,orderBy,this.filters.slice(),this.limit,this.startAt,this.endAt)};Query.prototype.withLimit=function(limit){return new Query(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),limit,this.startAt,this.endAt)};Query.prototype.withStartAt=function(bound){return new Query(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,bound,this.endAt)};
Query.prototype.withEndAt=function(bound){return new Query(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,bound)};Query.prototype.asCollectionQueryAtPath=function(path){return new Query(path,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)};Query.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var canonicalId=this.path.canonicalString();this.isCollectionGroupQuery()&&(canonicalId+=
"|cg:"+this.collectionGroup);canonicalId+="|f:";for(var _i=0,_a=this.filters;_i<_a.length;_i++)canonicalId+=_a[_i].canonicalId(),canonicalId+=",";canonicalId+="|ob:";_i=0;for(_a=this.orderBy;_i<_a.length;_i++)canonicalId+=_a[_i].canonicalId(),canonicalId+=",";isNullOrUndefined(this.limit)||(canonicalId=canonicalId+"|l:"+this.limit);this.startAt&&(canonicalId=canonicalId+"|lb:"+this.startAt.canonicalId());this.endAt&&(canonicalId=canonicalId+"|ub:"+this.endAt.canonicalId());this.memoizedCanonicalId=
canonicalId}return this.memoizedCanonicalId};Query.prototype.toString=function(){var str="Query("+this.path.canonicalString();this.isCollectionGroupQuery()&&(str+=" collectionGroup\x3d"+this.collectionGroup);0<this.filters.length&&(str+=", filters: ["+this.filters.join(", ")+"]");isNullOrUndefined(this.limit)||(str+=", limit: "+this.limit);0<this.explicitOrderBy.length&&(str+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]");this.startAt&&(str+=", startAt: "+this.startAt.canonicalId());this.endAt&&
(str+=", endAt: "+this.endAt.canonicalId());return str+")"};Query.prototype.isEqual=function(other){if(this.limit!==other.limit||this.orderBy.length!==other.orderBy.length)return!1;for(var i=0;i<this.orderBy.length;i++)if(!this.orderBy[i].isEqual(other.orderBy[i]))return!1;if(this.filters.length!==other.filters.length)return!1;for(i=0;i<this.filters.length;i++)if(!this.filters[i].isEqual(other.filters[i]))return!1;return this.collectionGroup===other.collectionGroup&&this.path.isEqual(other.path)&&
(null!==this.startAt?this.startAt.isEqual(other.startAt):null===other.startAt)?null!==this.endAt?this.endAt.isEqual(other.endAt):null===other.endAt:!1};Query.prototype.docComparator=function(d1,d2){for(var comparedOnKeyField=!1,_i=0,_a=this.orderBy;_i<_a.length;_i++){var orderBy=_a[_i],comp=orderBy.compare(d1,d2);if(0!==comp)return comp;comparedOnKeyField=comparedOnKeyField||orderBy.field.isKeyField()}assert(comparedOnKeyField,"orderBy used that doesn't compare on key field");return 0};Query.prototype.matches=
function(doc){return this.matchesPathAndCollectionGroup(doc)&&this.matchesOrderBy(doc)&&this.matchesFilters(doc)&&this.matchesBounds(doc)};Query.prototype.hasLimit=function(){return!isNullOrUndefined(this.limit)};Query.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null};Query.prototype.getInequalityFilterField=function(){for(var _i=0,_a=this.filters;_i<_a.length;_i++){var filter=_a[_i];if(filter instanceof RelationFilter&&filter.isInequality())return filter.field}return null};
Query.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(filter){return filter instanceof RelationFilter&&filter.op===RelationOp.ARRAY_CONTAINS})};Query.prototype.isDocumentQuery=function(){return DocumentKey.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length};Query.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup};Query.prototype.matchesPathAndCollectionGroup=function(doc){var docPath=doc.key.path;return null!==
this.collectionGroup?doc.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(docPath):DocumentKey.isDocumentKey(this.path)?this.path.isEqual(docPath):this.path.isImmediateParentOf(docPath)};Query.prototype.matchesOrderBy=function(doc){for(var _i=0,_a=this.explicitOrderBy;_i<_a.length;_i++){var orderBy=_a[_i];if(!orderBy.field.isKeyField()&&void 0===doc.field(orderBy.field))return!1}return!0};Query.prototype.matchesFilters=function(doc){for(var _i=0,_a=this.filters;_i<_a.length;_i++)if(!_a[_i].matches(doc))return!1;
return!0};Query.prototype.matchesBounds=function(doc){return this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,doc)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,doc)?!1:!0};Query.prototype.assertValidBound=function(bound){assert(bound.position.length<=this.orderBy.length,"Bound is longer than orderBy")};return Query}(),Filter=function(){function Filter(){}Filter.create=function(field,op,value){if(value.isEqual(NullValue.INSTANCE)){if(op!==RelationOp.EQUAL)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Invalid query. You can only perform equals comparisons on null.");return new NullFilter(field)}if(value.isEqual(DoubleValue.NAN)){if(op!==RelationOp.EQUAL)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new NanFilter(field)}return new RelationFilter(field,op,value)};return Filter}(),RelationOp=function(){function RelationOp(name){this.name=name}RelationOp.fromString=function(op){switch(op){case "\x3c":return RelationOp.LESS_THAN;
case "\x3c\x3d":return RelationOp.LESS_THAN_OR_EQUAL;case "\x3d\x3d":return RelationOp.EQUAL;case "\x3e\x3d":return RelationOp.GREATER_THAN_OR_EQUAL;case "\x3e":return RelationOp.GREATER_THAN;case "array-contains":return RelationOp.ARRAY_CONTAINS;default:return fail("Unknown relation: "+op)}};RelationOp.prototype.toString=function(){return this.name};RelationOp.prototype.isEqual=function(other){return this.name===other.name};RelationOp.LESS_THAN=new RelationOp("\x3c");RelationOp.LESS_THAN_OR_EQUAL=
new RelationOp("\x3c\x3d");RelationOp.EQUAL=new RelationOp("\x3d\x3d");RelationOp.GREATER_THAN=new RelationOp("\x3e");RelationOp.GREATER_THAN_OR_EQUAL=new RelationOp("\x3e\x3d");RelationOp.ARRAY_CONTAINS=new RelationOp("array-contains");return RelationOp}(),RelationFilter=function(_super){function RelationFilter(field,op,value){var _this=_super.call(this)||this;_this.field=field;_this.op=op;_this.value=value;return _this}tslib_1.__extends(RelationFilter,_super);RelationFilter.prototype.matches=function(doc){if(this.field.isKeyField())return assert(this.value instanceof
RefValue,"Comparing on key, but filter value not a RefValue"),assert(this.op!==RelationOp.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys."),doc=DocumentKey.comparator(doc.key,this.value.key),this.matchesComparison(doc);doc=doc.field(this.field);return void 0!==doc&&this.matchesValue(doc)};RelationFilter.prototype.matchesValue=function(value){var _this=this;return this.op===RelationOp.ARRAY_CONTAINS?value instanceof ArrayValue&&void 0!==value.internalValue.find(function(element){return element.isEqual(_this.value)}):
this.value.typeOrder===value.typeOrder&&this.matchesComparison(value.compareTo(this.value))};RelationFilter.prototype.matchesComparison=function(comparison){switch(this.op){case RelationOp.LESS_THAN:return 0>comparison;case RelationOp.LESS_THAN_OR_EQUAL:return 0>=comparison;case RelationOp.EQUAL:return 0===comparison;case RelationOp.GREATER_THAN:return 0<comparison;case RelationOp.GREATER_THAN_OR_EQUAL:return 0<=comparison;default:return fail("Unknown relation op"+this.op)}};RelationFilter.prototype.isInequality=
function(){return this.op!==RelationOp.EQUAL&&this.op!==RelationOp.ARRAY_CONTAINS};RelationFilter.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()};RelationFilter.prototype.isEqual=function(other){return other instanceof RelationFilter?this.op.isEqual(other.op)&&this.field.isEqual(other.field)&&this.value.isEqual(other.value):!1};RelationFilter.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()};
return RelationFilter}(Filter),NullFilter=function(_super){function NullFilter(field){var _this=_super.call(this)||this;_this.field=field;return _this}tslib_1.__extends(NullFilter,_super);NullFilter.prototype.matches=function(doc){doc=doc.field(this.field);return void 0!==doc&&null===doc.value()};NullFilter.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"};NullFilter.prototype.toString=function(){return this.field.canonicalString()+" IS null"};NullFilter.prototype.isEqual=
function(other){return other instanceof NullFilter?this.field.isEqual(other.field):!1};return NullFilter}(Filter),NanFilter=function(_super){function NanFilter(field){var _this=_super.call(this)||this;_this.field=field;return _this}tslib_1.__extends(NanFilter,_super);NanFilter.prototype.matches=function(doc){doc=(doc=doc.field(this.field))&&doc.value();return"number"===typeof doc&&isNaN(doc)};NanFilter.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"};NanFilter.prototype.toString=
function(){return this.field.canonicalString()+" IS NaN"};NanFilter.prototype.isEqual=function(other){return other instanceof NanFilter?this.field.isEqual(other.field):!1};return NanFilter}(Filter),Direction=function(){function Direction(name){this.name=name}Direction.prototype.toString=function(){return this.name};Direction.ASCENDING=new Direction("asc");Direction.DESCENDING=new Direction("desc");return Direction}(),Bound=function(){function Bound(position,before){this.position=position;this.before=
before}Bound.prototype.canonicalId=function(){for(var canonicalId=this.before?"b:":"a:",_i=0,_a=this.position;_i<_a.length;_i++)canonicalId+=_a[_i].toString();return canonicalId};Bound.prototype.sortsBeforeDocument=function(orderBy,doc){assert(this.position.length<=orderBy.length,"Bound has more components than query's orderBy");for(var comparison=0,i=0;i<this.position.length;i++){var orderByComponent=orderBy[i];comparison=this.position[i];if(orderByComponent.field.isKeyField())assert(comparison instanceof
RefValue,"Bound has a non-key value where the key path is being used."),comparison=DocumentKey.comparator(comparison.key,doc.key);else{var docValue=doc.field(orderByComponent.field);assert(void 0!==docValue,"Field should exist since document matched the orderBy already.");comparison=comparison.compareTo(docValue)}orderByComponent.dir===Direction.DESCENDING&&(comparison*=-1);if(0!==comparison)break}return this.before?0>=comparison:0>comparison};Bound.prototype.isEqual=function(other){if(null===other||
this.before!==other.before||this.position.length!==other.position.length)return!1;for(;0<this.position.length;)return this.position[0].isEqual(other.position[0]);return!0};return Bound}(),OrderBy=function(){function OrderBy(field,dir){this.field=field;void 0===dir&&(dir=Direction.ASCENDING);this.dir=dir;this.isKeyOrderBy=field.isKeyField()}OrderBy.prototype.compare=function(d1,d2){d1=this.isKeyOrderBy?Document$jscomp$0.compareByKey(d1,d2):Document$jscomp$0.compareByField(this.field,d1,d2);switch(this.dir){case Direction.ASCENDING:return d1;
case Direction.DESCENDING:return-1*d1;default:return fail("Unknown direction: "+this.dir)}};OrderBy.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()};OrderBy.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"};OrderBy.prototype.isEqual=function(other){return this.dir===other.dir&&this.field.isEqual(other.field)};return OrderBy}(),KEY_ORDERING_ASC=new OrderBy(FieldPath.keyField(),Direction.ASCENDING),KEY_ORDERING_DESC=new OrderBy(FieldPath.keyField(),
Direction.DESCENDING),SnapshotVersion=function(){function SnapshotVersion(timestamp){this.timestamp=timestamp}SnapshotVersion.fromMicroseconds=function(value){return new SnapshotVersion(new Timestamp(Math.floor(value/1E6),value%1E6*1E3))};SnapshotVersion.fromTimestamp=function(value){return new SnapshotVersion(value)};SnapshotVersion.forDeletedDoc=function(){return SnapshotVersion.MIN};SnapshotVersion.prototype.compareTo=function(other){return this.timestamp._compareTo(other.timestamp)};SnapshotVersion.prototype.isEqual=
function(other){return this.timestamp.isEqual(other.timestamp)};SnapshotVersion.prototype.toMicroseconds=function(){return 1E6*this.timestamp.seconds+this.timestamp.nanoseconds/1E3};SnapshotVersion.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"};SnapshotVersion.prototype.toTimestamp=function(){return this.timestamp};SnapshotVersion.MIN=new SnapshotVersion(new Timestamp(0,0));return SnapshotVersion}(),QueryPurpose;(function(QueryPurpose){QueryPurpose[QueryPurpose.Listen=
0]="Listen";QueryPurpose[QueryPurpose.ExistenceFilterMismatch=1]="ExistenceFilterMismatch";QueryPurpose[QueryPurpose.LimboResolution=2]="LimboResolution"})(QueryPurpose||(QueryPurpose={}));var QueryData=function(){function QueryData(query,targetId,purpose,sequenceNumber,snapshotVersion,resumeToken){void 0===snapshotVersion&&(snapshotVersion=SnapshotVersion.MIN);void 0===resumeToken&&(resumeToken=emptyByteString());this.query=query;this.targetId=targetId;this.purpose=purpose;this.sequenceNumber=sequenceNumber;
this.snapshotVersion=snapshotVersion;this.resumeToken=resumeToken}QueryData.prototype.copy=function(overwrite){return new QueryData(this.query,this.targetId,this.purpose,void 0===overwrite.sequenceNumber?this.sequenceNumber:overwrite.sequenceNumber,void 0===overwrite.snapshotVersion?this.snapshotVersion:overwrite.snapshotVersion,void 0===overwrite.resumeToken?this.resumeToken:overwrite.resumeToken)};QueryData.prototype.isEqual=function(other){return this.targetId===other.targetId&&this.purpose===
other.purpose&&this.sequenceNumber===other.sequenceNumber&&this.snapshotVersion.isEqual(other.snapshotVersion)&&this.resumeToken===other.resumeToken&&this.query.isEqual(other.query)};return QueryData}(),SortedSet=function(){function SortedSet(comparator){this.comparator=comparator;this.data=new SortedMap$jscomp$0(this.comparator)}SortedSet.fromMapKeys=function(map){var keys=new SortedSet(map.comparator);map.forEach(function(key){keys=keys.add(key)});return keys};SortedSet.prototype.has=function(elem){return null!==
this.data.get(elem)};SortedSet.prototype.first=function(){return this.data.minKey()};SortedSet.prototype.last=function(){return this.data.maxKey()};Object.defineProperty(SortedSet.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0});SortedSet.prototype.indexOf=function(elem){return this.data.indexOf(elem)};SortedSet.prototype.forEach=function(cb){this.data.inorderTraversal(function(k,v){cb(k);return!1})};SortedSet.prototype.forEachInRange=function(range,cb){for(var iter=
this.data.getIteratorFrom(range[0]);iter.hasNext();){var elem=iter.getNext();if(0<=this.comparator(elem.key,range[1]))break;cb(elem.key)}};SortedSet.prototype.forEachWhile=function(cb,start){for(start=void 0!==start?this.data.getIteratorFrom(start):this.data.getIterator();start.hasNext();){var elem=start.getNext();if(!cb(elem.key))break}};SortedSet.prototype.firstAfterOrEqual=function(elem){elem=this.data.getIteratorFrom(elem);return elem.hasNext()?elem.getNext().key:null};SortedSet.prototype.getIterator=
function(){return new SortedSetIterator(this.data.getIterator())};SortedSet.prototype.getIteratorFrom=function(key){return new SortedSetIterator(this.data.getIteratorFrom(key))};SortedSet.prototype.add=function(elem){return this.copy(this.data.remove(elem).insert(elem,!0))};SortedSet.prototype.delete=function(elem){return this.has(elem)?this.copy(this.data.remove(elem)):this};SortedSet.prototype.isEmpty=function(){return this.data.isEmpty()};SortedSet.prototype.unionWith=function(other){var result=
this;other.forEach(function(elem){result=result.add(elem)});return result};SortedSet.prototype.isEqual=function(other){if(!(other instanceof SortedSet)||this.size!==other.size)return!1;var thisIt=this.data.getIterator();for(other=other.data.getIterator();thisIt.hasNext();){var thisElem=thisIt.getNext().key,otherElem=other.getNext().key;if(0!==this.comparator(thisElem,otherElem))return!1}return!0};SortedSet.prototype.toArray=function(){var res=[];this.forEach(function(targetId){res.push(targetId)});
return res};SortedSet.prototype.toString=function(){var result=[];this.forEach(function(elem){return result.push(elem)});return"SortedSet("+result.toString()+")"};SortedSet.prototype.copy=function(data){var result=new SortedSet(this.comparator);result.data=data;return result};return SortedSet}(),SortedSetIterator=function(){function SortedSetIterator(iter){this.iter=iter}SortedSetIterator.prototype.getNext=function(){return this.iter.getNext().key};SortedSetIterator.prototype.hasNext=function(){return this.iter.hasNext()};
return SortedSetIterator}(),FieldMask=function(){function FieldMask(fields){this.fields=fields}FieldMask.fromSet=function(fields){return new FieldMask(fields)};FieldMask.fromArray=function(fields){var fieldsAsSet=new SortedSet(FieldPath.comparator);fields.forEach(function(fieldPath){return fieldsAsSet=fieldsAsSet.add(fieldPath)});return new FieldMask(fieldsAsSet)};FieldMask.prototype.covers=function(fieldPath){var found=!1;this.fields.forEach(function(fieldMaskPath){fieldMaskPath.isPrefixOf(fieldPath)&&
(found=!0)});return found};FieldMask.prototype.applyTo=function(data){var filteredObject=ObjectValue.EMPTY;this.fields.forEach(function(fieldMaskPath){if(fieldMaskPath.isEmpty())return data;var newValue=data.field(fieldMaskPath);void 0!==newValue&&(filteredObject=filteredObject.set(fieldMaskPath,newValue))});return filteredObject};FieldMask.prototype.isEqual=function(other){return this.fields.isEqual(other.fields)};return FieldMask}(),FieldTransform=function(){function FieldTransform(field,transform){this.field=
field;this.transform=transform}Object.defineProperty(FieldTransform.prototype,"isIdempotent",{get:function(){return this.transform.isIdempotent},enumerable:!0,configurable:!0});FieldTransform.prototype.isEqual=function(other){return this.field.isEqual(other.field)&&this.transform.isEqual(other.transform)};return FieldTransform}(),MutationResult=function(){return function(version,transformResults){this.version=version;this.transformResults=transformResults}}(),MutationType;(function(MutationType){MutationType[MutationType.Set=
0]="Set";MutationType[MutationType.Patch=1]="Patch";MutationType[MutationType.Transform=2]="Transform";MutationType[MutationType.Delete=3]="Delete"})(MutationType||(MutationType={}));var Precondition=function(){function Precondition(updateTime,exists){this.updateTime=updateTime;this.exists=exists;assert(void 0===updateTime||void 0===exists,'Precondition can specify "exists" or "updateTime" but not both')}Precondition.exists=function(exists){return new Precondition(void 0,exists)};Precondition.updateTime=
function(version){return new Precondition(version)};Object.defineProperty(Precondition.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0});Precondition.prototype.isValidFor=function(maybeDoc){if(void 0!==this.updateTime)return maybeDoc instanceof Document$jscomp$0&&maybeDoc.version.isEqual(this.updateTime);if(void 0!==this.exists)return this.exists===maybeDoc instanceof Document$jscomp$0;assert(this.isNone,"Precondition should be empty");
return!0};Precondition.prototype.isEqual=function(other){var JSCompiler_inline_result=this.updateTime;var right=other.updateTime;JSCompiler_inline_result=null!==JSCompiler_inline_result&&void 0!==JSCompiler_inline_result?!(!right||!JSCompiler_inline_result.isEqual(right)):JSCompiler_inline_result===right;return JSCompiler_inline_result&&this.exists===other.exists};Precondition.NONE=new Precondition;return Precondition}(),Mutation=function(){function Mutation(){}Mutation.prototype.verifyKeyMatches=
function(maybeDoc){null!=maybeDoc&&assert(maybeDoc.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")};Mutation.getPostMutationVersion=function(maybeDoc){return maybeDoc instanceof Document$jscomp$0?maybeDoc.version:SnapshotVersion.MIN};return Mutation}(),SetMutation=function(_super){function SetMutation(key,value,precondition){var _this=_super.call(this)||this;_this.key=key;_this.value=value;_this.precondition=precondition;_this.type=MutationType.Set;return _this}
tslib_1.__extends(SetMutation,_super);SetMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(null==mutationResult.transformResults,"Transform results received by SetMutation.");return new Document$jscomp$0(this.key,mutationResult.version,this.value,{hasCommittedMutations:!0})};SetMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;
maybeDoc=Mutation.getPostMutationVersion(maybeDoc);return new Document$jscomp$0(this.key,maybeDoc,this.value,{hasLocalMutations:!0})};Object.defineProperty(SetMutation.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0});Object.defineProperty(SetMutation.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0});SetMutation.prototype.isEqual=function(other){return other instanceof SetMutation&&this.key.isEqual(other.key)&&this.value.isEqual(other.value)&&
this.precondition.isEqual(other.precondition)};return SetMutation}(Mutation),PatchMutation=function(_super){function PatchMutation(key,data,fieldMask,precondition){var _this=_super.call(this)||this;_this.key=key;_this.data=data;_this.fieldMask=fieldMask;_this.precondition=precondition;_this.type=MutationType.Patch;return _this}tslib_1.__extends(PatchMutation,_super);PatchMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(null==mutationResult.transformResults,
"Transform results received by PatchMutation.");if(!this.precondition.isValidFor(maybeDoc))return new UnknownDocument(this.key,mutationResult.version);maybeDoc=this.patchDocument(maybeDoc);return new Document$jscomp$0(this.key,mutationResult.version,maybeDoc,{hasCommittedMutations:!0})};PatchMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;baseDoc=Mutation.getPostMutationVersion(maybeDoc);
maybeDoc=this.patchDocument(maybeDoc);return new Document$jscomp$0(this.key,baseDoc,maybeDoc,{hasLocalMutations:!0})};Object.defineProperty(PatchMutation.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0});PatchMutation.prototype.isEqual=function(other){return other instanceof PatchMutation&&this.key.isEqual(other.key)&&this.fieldMask.isEqual(other.fieldMask)&&this.precondition.isEqual(other.precondition)};PatchMutation.prototype.patchDocument=function(maybeDoc){return this.patchObject(maybeDoc instanceof
Document$jscomp$0?maybeDoc.data:ObjectValue.EMPTY)};PatchMutation.prototype.patchObject=function(data){var _this=this;this.fieldMask.fields.forEach(function(fieldPath){if(!fieldPath.isEmpty()){var newValue=_this.data.field(fieldPath);data=void 0!==newValue?data.set(fieldPath,newValue):data.delete(fieldPath)}});return data};return PatchMutation}(Mutation),TransformMutation=function(_super){function TransformMutation(key,fieldTransforms){var _this=_super.call(this)||this;_this.key=key;_this.fieldTransforms=
fieldTransforms;_this.type=MutationType.Transform;_this.precondition=Precondition.exists(!0);return _this}tslib_1.__extends(TransformMutation,_super);TransformMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(null!=mutationResult.transformResults,"Transform results missing for TransformMutation.");if(!this.precondition.isValidFor(maybeDoc))return new UnknownDocument(this.key,mutationResult.version);var doc=this.requireDocument(maybeDoc);
maybeDoc=this.serverTransformResults(maybeDoc,mutationResult.transformResults);mutationResult=mutationResult.version;doc=this.transformObject(doc.data,maybeDoc);return new Document$jscomp$0(this.key,mutationResult,doc,{hasCommittedMutations:!0})};TransformMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;maybeDoc=this.requireDocument(maybeDoc);baseDoc=this.localTransformResults(localWriteTime,
baseDoc);baseDoc=this.transformObject(maybeDoc.data,baseDoc);return new Document$jscomp$0(this.key,maybeDoc.version,baseDoc,{hasLocalMutations:!0})};Object.defineProperty(TransformMutation.prototype,"isIdempotent",{get:function(){for(var _i=0,_a=this.fieldTransforms;_i<_a.length;_i++)if(!_a[_i].isIdempotent)return!1;return!0},enumerable:!0,configurable:!0});Object.defineProperty(TransformMutation.prototype,"fieldMask",{get:function(){var fieldMask=new SortedSet(FieldPath.comparator);this.fieldTransforms.forEach(function(transform){return fieldMask=
fieldMask.add(transform.field)});return new FieldMask(fieldMask)},enumerable:!0,configurable:!0});TransformMutation.prototype.isEqual=function(other){return other instanceof TransformMutation&&this.key.isEqual(other.key)&&arrayEquals(this.fieldTransforms,other.fieldTransforms)&&this.precondition.isEqual(other.precondition)};TransformMutation.prototype.requireDocument=function(maybeDoc){assert(maybeDoc instanceof Document$jscomp$0,"Unknown MaybeDocument type "+maybeDoc);assert(maybeDoc.key.isEqual(this.key),
"Can only transform a document with the same key");return maybeDoc};TransformMutation.prototype.serverTransformResults=function(baseDoc,serverTransformResults){var transformResults=[];assert(this.fieldTransforms.length===serverTransformResults.length,"server transform result count ("+serverTransformResults.length+") "+("should match field transform count ("+this.fieldTransforms.length+")"));for(var i=0;i<serverTransformResults.length;i++){var fieldTransform=this.fieldTransforms[i],transform=fieldTransform.transform,
previousValue=null;baseDoc instanceof Document$jscomp$0&&(previousValue=baseDoc.field(fieldTransform.field)||null);transformResults.push(transform.applyToRemoteDocument(previousValue,serverTransformResults[i]))}return transformResults};TransformMutation.prototype.localTransformResults=function(localWriteTime,baseDoc){for(var transformResults=[],_i=0,_a=this.fieldTransforms;_i<_a.length;_i++){var fieldTransform=_a[_i],transform=fieldTransform.transform,previousValue=null;baseDoc instanceof Document$jscomp$0&&
(previousValue=baseDoc.field(fieldTransform.field)||null);transformResults.push(transform.applyToLocalView(previousValue,localWriteTime))}return transformResults};TransformMutation.prototype.transformObject=function(data,transformResults){assert(transformResults.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var i=0;i<this.fieldTransforms.length;i++)data=data.set(this.fieldTransforms[i].field,transformResults[i]);return data};return TransformMutation}(Mutation),DeleteMutation=
function(_super){function DeleteMutation(key,precondition){var _this=_super.call(this)||this;_this.key=key;_this.precondition=precondition;_this.type=MutationType.Delete;return _this}tslib_1.__extends(DeleteMutation,_super);DeleteMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(null==mutationResult.transformResults,"Transform results received by DeleteMutation.");return new NoDocument(this.key,mutationResult.version,{hasCommittedMutations:!0})};
DeleteMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;maybeDoc&&assert(maybeDoc.key.isEqual(this.key),"Can only apply mutation to document with same key");return new NoDocument(this.key,SnapshotVersion.forDeletedDoc())};DeleteMutation.prototype.isEqual=function(other){return other instanceof DeleteMutation&&this.key.isEqual(other.key)&&this.precondition.isEqual(other.precondition)};
Object.defineProperty(DeleteMutation.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0});Object.defineProperty(DeleteMutation.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0});return DeleteMutation}(Mutation),ServerTimestampTransform=function(){function ServerTimestampTransform(){this.isIdempotent=!0}ServerTimestampTransform.prototype.applyToLocalView=function(previousValue,localWriteTime){return new ServerTimestampValue(localWriteTime,
previousValue)};ServerTimestampTransform.prototype.applyToRemoteDocument=function(previousValue,transformResult){return transformResult};ServerTimestampTransform.prototype.isEqual=function(other){return other instanceof ServerTimestampTransform};ServerTimestampTransform.instance=new ServerTimestampTransform;return ServerTimestampTransform}(),ArrayUnionTransformOperation=function(){function ArrayUnionTransformOperation(elements){this.elements=elements;this.isIdempotent=!0}ArrayUnionTransformOperation.prototype.applyToLocalView=
function(previousValue,localWriteTime){return this.apply(previousValue)};ArrayUnionTransformOperation.prototype.applyToRemoteDocument=function(previousValue,transformResult){return this.apply(previousValue)};ArrayUnionTransformOperation.prototype.apply=function(previousValue){var result=previousValue instanceof ArrayValue?previousValue.internalValue.slice():[];previousValue=function(toUnion){result.find(function(element){return element.isEqual(toUnion)})||result.push(toUnion)};for(var _i=0,_a=this.elements;_i<
_a.length;_i++)previousValue(_a[_i]);return new ArrayValue(result)};ArrayUnionTransformOperation.prototype.isEqual=function(other){return other instanceof ArrayUnionTransformOperation&&arrayEquals(other.elements,this.elements)};return ArrayUnionTransformOperation}(),ArrayRemoveTransformOperation=function(){function ArrayRemoveTransformOperation(elements){this.elements=elements;this.isIdempotent=!0}ArrayRemoveTransformOperation.prototype.applyToLocalView=function(previousValue,localWriteTime){return this.apply(previousValue)};
ArrayRemoveTransformOperation.prototype.applyToRemoteDocument=function(previousValue,transformResult){return this.apply(previousValue)};ArrayRemoveTransformOperation.prototype.apply=function(previousValue){var result=previousValue instanceof ArrayValue?previousValue.internalValue.slice():[];previousValue=function(toRemove){result=result.filter(function(element){return!element.isEqual(toRemove)})};for(var _i=0,_a=this.elements;_i<_a.length;_i++)previousValue(_a[_i]);return new ArrayValue(result)};
ArrayRemoveTransformOperation.prototype.isEqual=function(other){return other instanceof ArrayRemoveTransformOperation&&arrayEquals(other.elements,this.elements)};return ArrayRemoveTransformOperation}(),NumericIncrementTransformOperation=function(){function NumericIncrementTransformOperation(operand){this.operand=operand;this.isIdempotent=!1}NumericIncrementTransformOperation.prototype.applyToLocalView=function(previousValue,localWriteTime){return previousValue instanceof IntegerValue&&this.operand instanceof
IntegerValue?(previousValue=previousValue.internalValue+this.operand.internalValue,new IntegerValue(previousValue)):previousValue instanceof NumberValue?(previousValue=previousValue.internalValue+this.operand.internalValue,new DoubleValue(previousValue)):this.operand};NumericIncrementTransformOperation.prototype.applyToRemoteDocument=function(previousValue,transformResult){assert(null!==transformResult,"Didn't receive transformResult for NUMERIC_ADD transform");return transformResult};NumericIncrementTransformOperation.prototype.isEqual=
function(other){return other instanceof NumericIncrementTransformOperation&&this.operand.isEqual(other.operand)};return NumericIncrementTransformOperation}(),ExistenceFilter=function(){function ExistenceFilter(count){this.count=count}ExistenceFilter.prototype.isEqual=function(other){return other&&other.count===this.count};return ExistenceFilter}(),RpcCode;(function(RpcCode){RpcCode[RpcCode.OK=0]="OK";RpcCode[RpcCode.CANCELLED=1]="CANCELLED";RpcCode[RpcCode.UNKNOWN=2]="UNKNOWN";RpcCode[RpcCode.INVALID_ARGUMENT=
3]="INVALID_ARGUMENT";RpcCode[RpcCode.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED";RpcCode[RpcCode.NOT_FOUND=5]="NOT_FOUND";RpcCode[RpcCode.ALREADY_EXISTS=6]="ALREADY_EXISTS";RpcCode[RpcCode.PERMISSION_DENIED=7]="PERMISSION_DENIED";RpcCode[RpcCode.UNAUTHENTICATED=16]="UNAUTHENTICATED";RpcCode[RpcCode.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED";RpcCode[RpcCode.FAILED_PRECONDITION=9]="FAILED_PRECONDITION";RpcCode[RpcCode.ABORTED=10]="ABORTED";RpcCode[RpcCode.OUT_OF_RANGE=11]="OUT_OF_RANGE";RpcCode[RpcCode.UNIMPLEMENTED=
12]="UNIMPLEMENTED";RpcCode[RpcCode.INTERNAL=13]="INTERNAL";RpcCode[RpcCode.UNAVAILABLE=14]="UNAVAILABLE";RpcCode[RpcCode.DATA_LOSS=15]="DATA_LOSS"})(RpcCode||(RpcCode={}));var EMPTY_MAYBE_DOCUMENT_MAP=new SortedMap$jscomp$0(DocumentKey.comparator),EMPTY_DOCUMENT_MAP=new SortedMap$jscomp$0(DocumentKey.comparator),EMPTY_DOCUMENT_VERSION_MAP=new SortedMap$jscomp$0(DocumentKey.comparator),EMPTY_DOCUMENT_KEY_SET=new SortedSet(DocumentKey.comparator),EMPTY_TARGET_ID_SET=new SortedSet(primitiveComparator),
DocumentSet=function(){function DocumentSet(comp){this.comparator=comp?function(d1,d2){return comp(d1,d2)||DocumentKey.comparator(d1.key,d2.key)}:function(d1,d2){return DocumentKey.comparator(d1.key,d2.key)};this.keyedMap=EMPTY_DOCUMENT_MAP;this.sortedSet=new SortedMap$jscomp$0(this.comparator)}DocumentSet.emptySet=function(oldSet){return new DocumentSet(oldSet.comparator)};DocumentSet.prototype.has=function(key){return null!=this.keyedMap.get(key)};DocumentSet.prototype.get=function(key){return this.keyedMap.get(key)};
DocumentSet.prototype.first=function(){return this.sortedSet.minKey()};DocumentSet.prototype.last=function(){return this.sortedSet.maxKey()};DocumentSet.prototype.isEmpty=function(){return this.sortedSet.isEmpty()};DocumentSet.prototype.indexOf=function(key){return(key=this.keyedMap.get(key))?this.sortedSet.indexOf(key):-1};Object.defineProperty(DocumentSet.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0});DocumentSet.prototype.forEach=function(cb){this.sortedSet.inorderTraversal(function(k,
v){cb(k);return!1})};DocumentSet.prototype.add=function(doc){var set=this.delete(doc.key);return set.copy(set.keyedMap.insert(doc.key,doc),set.sortedSet.insert(doc,null))};DocumentSet.prototype.delete=function(key){var doc=this.get(key);return doc?this.copy(this.keyedMap.remove(key),this.sortedSet.remove(doc)):this};DocumentSet.prototype.isEqual=function(other){if(!(other instanceof DocumentSet)||this.size!==other.size)return!1;var thisIt=this.sortedSet.getIterator();for(other=other.sortedSet.getIterator();thisIt.hasNext();){var thisDoc=
thisIt.getNext().key,otherDoc=other.getNext().key;if(!thisDoc.isEqual(otherDoc))return!1}return!0};DocumentSet.prototype.toString=function(){var docStrings=[];this.forEach(function(doc){docStrings.push(doc.toString())});return 0===docStrings.length?"DocumentSet ()":"DocumentSet (\n  "+docStrings.join("  \n")+"\n)"};DocumentSet.prototype.copy=function(keyedMap,sortedSet){var newSet=new DocumentSet;newSet.comparator=this.comparator;newSet.keyedMap=keyedMap;newSet.sortedSet=sortedSet;return newSet};
return DocumentSet}(),ChangeType;(function(ChangeType){ChangeType[ChangeType.Added=0]="Added";ChangeType[ChangeType.Removed=1]="Removed";ChangeType[ChangeType.Modified=2]="Modified";ChangeType[ChangeType.Metadata=3]="Metadata"})(ChangeType||(ChangeType={}));var SyncState;(function(SyncState){SyncState[SyncState.Local=0]="Local";SyncState[SyncState.Synced=1]="Synced"})(SyncState||(SyncState={}));var DocumentChangeSet=function(){function DocumentChangeSet(){this.changeMap=new SortedMap$jscomp$0(DocumentKey.comparator)}
DocumentChangeSet.prototype.track=function(change){var key=change.doc.key,oldChange=this.changeMap.get(key);oldChange?change.type!==ChangeType.Added&&oldChange.type===ChangeType.Metadata?this.changeMap=this.changeMap.insert(key,change):change.type===ChangeType.Metadata&&oldChange.type!==ChangeType.Removed?this.changeMap=this.changeMap.insert(key,{type:oldChange.type,doc:change.doc}):change.type===ChangeType.Modified&&oldChange.type===ChangeType.Modified?this.changeMap=this.changeMap.insert(key,{type:ChangeType.Modified,
doc:change.doc}):change.type===ChangeType.Modified&&oldChange.type===ChangeType.Added?this.changeMap=this.changeMap.insert(key,{type:ChangeType.Added,doc:change.doc}):change.type===ChangeType.Removed&&oldChange.type===ChangeType.Added?this.changeMap=this.changeMap.remove(key):change.type===ChangeType.Removed&&oldChange.type===ChangeType.Modified?this.changeMap=this.changeMap.insert(key,{type:ChangeType.Removed,doc:oldChange.doc}):change.type===ChangeType.Added&&oldChange.type===ChangeType.Removed?
this.changeMap=this.changeMap.insert(key,{type:ChangeType.Modified,doc:change.doc}):fail("unsupported combination of changes: "+JSON.stringify(change)+" after "+JSON.stringify(oldChange)):this.changeMap=this.changeMap.insert(key,change)};DocumentChangeSet.prototype.getChanges=function(){var changes=[];this.changeMap.inorderTraversal(function(key,change){changes.push(change)});return changes};return DocumentChangeSet}(),ViewSnapshot=function(){function ViewSnapshot(query,docs,oldDocs,docChanges,mutatedKeys,
fromCache,syncStateChanged,excludesMetadataChanges){this.query=query;this.docs=docs;this.oldDocs=oldDocs;this.docChanges=docChanges;this.mutatedKeys=mutatedKeys;this.fromCache=fromCache;this.syncStateChanged=syncStateChanged;this.excludesMetadataChanges=excludesMetadataChanges}ViewSnapshot.fromInitialDocuments=function(query,documents,mutatedKeys,fromCache){var changes=[];documents.forEach(function(doc){changes.push({type:ChangeType.Added,doc:doc})});return new ViewSnapshot(query,documents,DocumentSet.emptySet(documents),
changes,mutatedKeys,fromCache,!0,!1)};Object.defineProperty(ViewSnapshot.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0});ViewSnapshot.prototype.isEqual=function(other){if(!(this.fromCache===other.fromCache&&this.syncStateChanged===other.syncStateChanged&&this.mutatedKeys.isEqual(other.mutatedKeys)&&this.query.isEqual(other.query)&&this.docs.isEqual(other.docs)&&this.oldDocs.isEqual(other.oldDocs)))return!1;var changes=this.docChanges;
other=other.docChanges;if(changes.length!==other.length)return!1;for(var i=0;i<changes.length;i++)if(changes[i].type!==other[i].type||!changes[i].doc.isEqual(other[i].doc))return!1;return!0};return ViewSnapshot}(),RemoteEvent=function(){function RemoteEvent(snapshotVersion,targetChanges,targetMismatches,documentUpdates,resolvedLimboDocuments){this.snapshotVersion=snapshotVersion;this.targetChanges=targetChanges;this.targetMismatches=targetMismatches;this.documentUpdates=documentUpdates;this.resolvedLimboDocuments=
resolvedLimboDocuments}RemoteEvent.createSynthesizedRemoteEventForCurrentChange=function(targetId,current){var _a;targetId=(_a={},_a[targetId]=TargetChange.createSynthesizedTargetChangeForCurrentChange(targetId,current),_a);return new RemoteEvent(SnapshotVersion.MIN,targetId,EMPTY_TARGET_ID_SET,EMPTY_MAYBE_DOCUMENT_MAP,documentKeySet())};return RemoteEvent}(),TargetChange=function(){function TargetChange(resumeToken,current,addedDocuments,modifiedDocuments,removedDocuments){this.resumeToken=resumeToken;
this.current=current;this.addedDocuments=addedDocuments;this.modifiedDocuments=modifiedDocuments;this.removedDocuments=removedDocuments}TargetChange.createSynthesizedTargetChangeForCurrentChange=function(targetId,current){return new TargetChange(emptyByteString(),current,documentKeySet(),documentKeySet(),documentKeySet())};return TargetChange}(),DocumentWatchChange=function(){return function(updatedTargetIds,removedTargetIds,key,newDoc){this.updatedTargetIds=updatedTargetIds;this.removedTargetIds=
removedTargetIds;this.key=key;this.newDoc=newDoc}}(),ExistenceFilterChange=function(){return function(targetId,existenceFilter){this.targetId=targetId;this.existenceFilter=existenceFilter}}(),WatchTargetChangeState;(function(WatchTargetChangeState){WatchTargetChangeState[WatchTargetChangeState.NoChange=0]="NoChange";WatchTargetChangeState[WatchTargetChangeState.Added=1]="Added";WatchTargetChangeState[WatchTargetChangeState.Removed=2]="Removed";WatchTargetChangeState[WatchTargetChangeState.Current=
3]="Current";WatchTargetChangeState[WatchTargetChangeState.Reset=4]="Reset"})(WatchTargetChangeState||(WatchTargetChangeState={}));var WatchTargetChange=function(){return function(state,targetIds,resumeToken,cause){void 0===resumeToken&&(resumeToken=emptyByteString());void 0===cause&&(cause=null);this.state=state;this.targetIds=targetIds;this.resumeToken=resumeToken;this.cause=cause}}(),TargetState=function(){function TargetState(){this.pendingResponses=0;this.documentChanges=new SortedMap$jscomp$0(DocumentKey.comparator);
this._resumeToken=emptyByteString();this._current=!1;this._hasPendingChanges=!0}Object.defineProperty(TargetState.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0});Object.defineProperty(TargetState.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0});Object.defineProperty(TargetState.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0});Object.defineProperty(TargetState.prototype,
"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0});TargetState.prototype.updateResumeToken=function(resumeToken){0<resumeToken.length&&(this._hasPendingChanges=!0,this._resumeToken=resumeToken)};TargetState.prototype.toTargetChange=function(){var addedDocuments=documentKeySet(),modifiedDocuments=documentKeySet(),removedDocuments=documentKeySet();this.documentChanges.forEach(function(key,changeType){switch(changeType){case ChangeType.Added:addedDocuments=
addedDocuments.add(key);break;case ChangeType.Modified:modifiedDocuments=modifiedDocuments.add(key);break;case ChangeType.Removed:removedDocuments=removedDocuments.add(key);break;default:fail("Encountered invalid change type: "+changeType)}});return new TargetChange(this._resumeToken,this._current,addedDocuments,modifiedDocuments,removedDocuments)};TargetState.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1;this.documentChanges=new SortedMap$jscomp$0(DocumentKey.comparator)};TargetState.prototype.addDocumentChange=
function(key,changeType){this._hasPendingChanges=!0;this.documentChanges=this.documentChanges.insert(key,changeType)};TargetState.prototype.removeDocumentChange=function(key){this._hasPendingChanges=!0;this.documentChanges=this.documentChanges.remove(key)};TargetState.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1};TargetState.prototype.recordTargetResponse=function(){--this.pendingResponses};TargetState.prototype.markCurrent=function(){this._current=this._hasPendingChanges=
!0};return TargetState}(),WatchChangeAggregator=function(){function WatchChangeAggregator(metadataProvider){this.metadataProvider=metadataProvider;this.targetStates={};this.pendingDocumentUpdates=EMPTY_MAYBE_DOCUMENT_MAP;this.pendingDocumentTargetMapping=new SortedMap$jscomp$0(DocumentKey.comparator);this.pendingTargetResets=new SortedSet(primitiveComparator)}WatchChangeAggregator.prototype.handleDocumentChange=function(docChange){for(var _i=0,_a=docChange.updatedTargetIds;_i<_a.length;_i++){var targetId=
_a[_i];docChange.newDoc instanceof Document$jscomp$0?this.addDocumentToTarget(targetId,docChange.newDoc):docChange.newDoc instanceof NoDocument&&this.removeDocumentFromTarget(targetId,docChange.key,docChange.newDoc)}_i=0;for(_a=docChange.removedTargetIds;_i<_a.length;_i++)targetId=_a[_i],this.removeDocumentFromTarget(targetId,docChange.key,docChange.newDoc)};WatchChangeAggregator.prototype.handleTargetChange=function(targetChange){var _this=this;this.forEachTarget(targetChange,function(targetId){var targetState=
_this.ensureTargetState(targetId);switch(targetChange.state){case WatchTargetChangeState.NoChange:_this.isActiveTarget(targetId)&&targetState.updateResumeToken(targetChange.resumeToken);break;case WatchTargetChangeState.Added:targetState.recordTargetResponse();targetState.isPending||targetState.clearPendingChanges();targetState.updateResumeToken(targetChange.resumeToken);break;case WatchTargetChangeState.Removed:targetState.recordTargetResponse();targetState.isPending||_this.removeTarget(targetId);
assert(!targetChange.cause,"WatchChangeAggregator does not handle errored targets");break;case WatchTargetChangeState.Current:_this.isActiveTarget(targetId)&&(targetState.markCurrent(),targetState.updateResumeToken(targetChange.resumeToken));break;case WatchTargetChangeState.Reset:_this.isActiveTarget(targetId)&&(_this.resetTarget(targetId),targetState.updateResumeToken(targetChange.resumeToken));break;default:fail("Unknown target watch change state: "+targetChange.state)}})};WatchChangeAggregator.prototype.forEachTarget=
function(targetChange,fn){0<targetChange.targetIds.length?targetChange.targetIds.forEach(fn):forEachNumber(this.targetStates,fn)};WatchChangeAggregator.prototype.handleExistenceFilter=function(watchChange){var targetId=watchChange.targetId;watchChange=watchChange.existenceFilter.count;var queryData=this.queryDataForActiveTarget(targetId);queryData&&(queryData=queryData.query,queryData.isDocumentQuery()?0===watchChange?(watchChange=new DocumentKey(queryData.path),this.removeDocumentFromTarget(targetId,
watchChange,new NoDocument(watchChange,SnapshotVersion.forDeletedDoc()))):assert(1===watchChange,"Single document existence filter with count: "+watchChange):this.getCurrentDocumentCountForTarget(targetId)!==watchChange&&(this.resetTarget(targetId),this.pendingTargetResets=this.pendingTargetResets.add(targetId)))};WatchChangeAggregator.prototype.createRemoteEvent=function(snapshotVersion){var _this=this,targetChanges={};forEachNumber(this.targetStates,function(targetId,targetState){var queryData=
_this.queryDataForActiveTarget(targetId);queryData&&(targetState.current&&queryData.query.isDocumentQuery()&&(queryData=new DocumentKey(queryData.query.path),null!==_this.pendingDocumentUpdates.get(queryData)||_this.targetContainsDocument(targetId,queryData)||_this.removeDocumentFromTarget(targetId,queryData,new NoDocument(queryData,snapshotVersion))),targetState.hasPendingChanges&&(targetChanges[targetId]=targetState.toTargetChange(),targetState.clearPendingChanges()))});var resolvedLimboDocuments=
documentKeySet();this.pendingDocumentTargetMapping.forEach(function(key,targets){var isOnlyLimboTarget=!0;targets.forEachWhile(function(targetId){return(targetId=_this.queryDataForActiveTarget(targetId))&&targetId.purpose!==QueryPurpose.LimboResolution?isOnlyLimboTarget=!1:!0});isOnlyLimboTarget&&(resolvedLimboDocuments=resolvedLimboDocuments.add(key))});var remoteEvent=new RemoteEvent(snapshotVersion,targetChanges,this.pendingTargetResets,this.pendingDocumentUpdates,resolvedLimboDocuments);this.pendingDocumentUpdates=
EMPTY_MAYBE_DOCUMENT_MAP;this.pendingDocumentTargetMapping=new SortedMap$jscomp$0(DocumentKey.comparator);this.pendingTargetResets=new SortedSet(primitiveComparator);return remoteEvent};WatchChangeAggregator.prototype.addDocumentToTarget=function(targetId,document){if(this.isActiveTarget(targetId)){var changeType=this.targetContainsDocument(targetId,document.key)?ChangeType.Modified:ChangeType.Added;this.ensureTargetState(targetId).addDocumentChange(document.key,changeType);this.pendingDocumentUpdates=
this.pendingDocumentUpdates.insert(document.key,document);this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(document.key,this.ensureDocumentTargetMapping(document.key).add(targetId))}};WatchChangeAggregator.prototype.removeDocumentFromTarget=function(targetId,key,updatedDocument){if(this.isActiveTarget(targetId)){var targetState=this.ensureTargetState(targetId);this.targetContainsDocument(targetId,key)?targetState.addDocumentChange(key,ChangeType.Removed):targetState.removeDocumentChange(key);
this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(key,this.ensureDocumentTargetMapping(key).delete(targetId));updatedDocument&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(key,updatedDocument))}};WatchChangeAggregator.prototype.removeTarget=function(targetId){delete this.targetStates[targetId]};WatchChangeAggregator.prototype.getCurrentDocumentCountForTarget=function(targetId){var targetChange=this.ensureTargetState(targetId).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(targetId).size+
targetChange.addedDocuments.size-targetChange.removedDocuments.size};WatchChangeAggregator.prototype.recordPendingTargetRequest=function(targetId){this.ensureTargetState(targetId).recordPendingTargetRequest()};WatchChangeAggregator.prototype.ensureTargetState=function(targetId){this.targetStates[targetId]||(this.targetStates[targetId]=new TargetState);return this.targetStates[targetId]};WatchChangeAggregator.prototype.ensureDocumentTargetMapping=function(key){var targetMapping=this.pendingDocumentTargetMapping.get(key);
targetMapping||(targetMapping=new SortedSet(primitiveComparator),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(key,targetMapping));return targetMapping};WatchChangeAggregator.prototype.isActiveTarget=function(targetId){return null!==this.queryDataForActiveTarget(targetId)};WatchChangeAggregator.prototype.queryDataForActiveTarget=function(targetId){var targetState=this.targetStates[targetId];return targetState&&targetState.isPending?null:this.metadataProvider.getQueryDataForTarget(targetId)};
WatchChangeAggregator.prototype.resetTarget=function(targetId){var _this=this;assert(!this.targetStates[targetId].isPending,"Should only reset active targets");this.targetStates[targetId]=new TargetState;this.metadataProvider.getRemoteKeysForTarget(targetId).forEach(function(key){_this.removeDocumentFromTarget(targetId,key,null)})};WatchChangeAggregator.prototype.targetContainsDocument=function(targetId,key){return this.metadataProvider.getRemoteKeysForTarget(targetId).has(key)};return WatchChangeAggregator}(),
DIRECTIONS=function(){var dirs={};dirs[Direction.ASCENDING.name]="ASCENDING";dirs[Direction.DESCENDING.name]="DESCENDING";return dirs}(),OPERATORS=function(){var ops={};ops[RelationOp.LESS_THAN.name]="LESS_THAN";ops[RelationOp.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL";ops[RelationOp.GREATER_THAN.name]="GREATER_THAN";ops[RelationOp.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL";ops[RelationOp.EQUAL.name]="EQUAL";ops[RelationOp.ARRAY_CONTAINS.name]="ARRAY_CONTAINS";return ops}(),ISO_REG_EXP=
new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/),JsonProtoSerializer=function(){function JsonProtoSerializer(databaseId,options){this.databaseId=databaseId;this.options=options}JsonProtoSerializer.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)};JsonProtoSerializer.prototype.unsafeCastProtoByteString=function(byteString){return byteString};JsonProtoSerializer.prototype.fromRpcStatus=function(status){var code=void 0===status.code?Code.UNKNOWN:
mapCodeFromRpcCode(status.code);return new FirestoreError(code,status.message||"")};JsonProtoSerializer.prototype.toInt32Value=function(val){if(!isNullOrUndefined(val))return{value:val}};JsonProtoSerializer.prototype.fromInt32Value=function(val){val="object"===typeof val?val.value:val;return isNullOrUndefined(val)?null:val};JsonProtoSerializer.prototype.toTimestamp=function(timestamp){return{seconds:timestamp.seconds,nanos:timestamp.nanoseconds}};JsonProtoSerializer.prototype.fromTimestamp=function(date){if("string"===
typeof date)return this.fromIso8601String(date);assert(!!date,"Cannot deserialize null or undefined timestamp.");var seconds=parseInt64(date.seconds||"0");return new Timestamp(seconds,date.nanos||0)};JsonProtoSerializer.prototype.fromIso8601String=function(utc){var nanos=0,fraction=ISO_REG_EXP.exec(utc);assert(!!fraction,"invalid timestamp: "+utc);fraction[1]&&(nanos=fraction[1],nanos=(nanos+"000000000").substr(0,9),nanos=Number(nanos));utc=Math.floor((new Date(utc)).getTime()/1E3);return new Timestamp(utc,
nanos)};JsonProtoSerializer.prototype.toBytes=function(bytes){return this.options.useProto3Json?bytes.toBase64():this.unsafeCastProtoByteString(bytes.toUint8Array())};JsonProtoSerializer.prototype.fromBlob=function(blob){if("string"===typeof blob)return assert(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Blob$jscomp$0.fromBase64String(blob);assert(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead.");
return Blob$jscomp$0.fromUint8Array(blob)};JsonProtoSerializer.prototype.toVersion=function(version){return this.toTimestamp(version.toTimestamp())};JsonProtoSerializer.prototype.fromVersion=function(version){assert(!!version,"Trying to deserialize version that isn't set");return SnapshotVersion.fromTimestamp(this.fromTimestamp(version))};JsonProtoSerializer.prototype.toResourceName=function(databaseId,path){return this.fullyQualifiedPrefixPath(databaseId).child("documents").child(path).canonicalString()};
JsonProtoSerializer.prototype.fromResourceName=function(name){name=ResourcePath.fromString(name);assert(this.isValidResourceName(name),"Tried to deserialize invalid key "+name.toString());return name};JsonProtoSerializer.prototype.toName=function(key){return this.toResourceName(this.databaseId,key.path)};JsonProtoSerializer.prototype.fromName=function(name){name=this.fromResourceName(name);assert(name.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+name.get(1)+
" vs "+this.databaseId.projectId);assert(!name.get(3)&&!this.databaseId.database||name.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+name.get(3)+" vs "+this.databaseId.database);return new DocumentKey(this.extractLocalPathFromResourceName(name))};JsonProtoSerializer.prototype.toQueryPath=function(path){return this.toResourceName(this.databaseId,path)};JsonProtoSerializer.prototype.fromQueryPath=function(name){name=this.fromResourceName(name);return 4===name.length?
ResourcePath.EMPTY_PATH:this.extractLocalPathFromResourceName(name)};Object.defineProperty(JsonProtoSerializer.prototype,"encodedDatabaseId",{get:function(){return(new ResourcePath(["projects",this.databaseId.projectId,"databases",this.databaseId.database])).canonicalString()},enumerable:!0,configurable:!0});JsonProtoSerializer.prototype.fullyQualifiedPrefixPath=function(databaseId){return new ResourcePath(["projects",databaseId.projectId,"databases",databaseId.database])};JsonProtoSerializer.prototype.extractLocalPathFromResourceName=
function(resourceName){assert(4<resourceName.length&&"documents"===resourceName.get(4),"tried to deserialize invalid key "+resourceName.toString());return resourceName.popFirst(5)};JsonProtoSerializer.prototype.isValidResourceName=function(path){return 4<=path.length&&"projects"===path.get(0)&&"databases"===path.get(2)};JsonProtoSerializer.prototype.toValue=function(val){if(val instanceof NullValue)return{nullValue:"NULL_VALUE"};if(val instanceof BooleanValue)return{booleanValue:val.value()};if(val instanceof
IntegerValue)return{integerValue:""+val.value()};if(val instanceof DoubleValue){var doubleValue=val.value();if(this.options.useProto3Json){if(isNaN(doubleValue))return{doubleValue:"NaN"};if(Infinity===doubleValue)return{doubleValue:"Infinity"};if(-Infinity===doubleValue)return{doubleValue:"-Infinity"}}return{doubleValue:val.value()}}return val instanceof StringValue?{stringValue:val.value()}:val instanceof ObjectValue?{mapValue:this.toMapValue(val)}:val instanceof ArrayValue?{arrayValue:this.toArrayValue(val)}:
val instanceof TimestampValue?{timestampValue:this.toTimestamp(val.internalValue)}:val instanceof GeoPointValue?{geoPointValue:{latitude:val.value().latitude,longitude:val.value().longitude}}:val instanceof BlobValue?{bytesValue:this.toBytes(val.value())}:val instanceof RefValue?{referenceValue:this.toResourceName(val.databaseId,val.key.path)}:fail("Unknown FieldValue "+JSON.stringify(val))};JsonProtoSerializer.prototype.fromValue=function(obj){var _this=this,type=obj.value_type;if(hasTag(obj,type,
"nullValue"))return NullValue.INSTANCE;if(hasTag(obj,type,"booleanValue"))return BooleanValue.of(obj.booleanValue);if(hasTag(obj,type,"integerValue"))return new IntegerValue(parseInt64(obj.integerValue));if(hasTag(obj,type,"doubleValue")){if(this.options.useProto3Json){if("NaN"===obj.doubleValue)return DoubleValue.NAN;if("Infinity"===obj.doubleValue)return DoubleValue.POSITIVE_INFINITY;if("-Infinity"===obj.doubleValue)return DoubleValue.NEGATIVE_INFINITY}return new DoubleValue(obj.doubleValue)}return hasTag(obj,
type,"stringValue")?new StringValue(obj.stringValue):hasTag(obj,type,"mapValue")?this.fromFields(obj.mapValue.fields||{}):hasTag(obj,type,"arrayValue")?(assertPresent(obj.arrayValue,"arrayValue"),new ArrayValue((obj.arrayValue.values||[]).map(function(v){return _this.fromValue(v)}))):hasTag(obj,type,"timestampValue")?(assertPresent(obj.timestampValue,"timestampValue"),new TimestampValue(this.fromTimestamp(obj.timestampValue))):hasTag(obj,type,"geoPointValue")?(assertPresent(obj.geoPointValue,"geoPointValue"),
new GeoPointValue(new GeoPoint(obj.geoPointValue.latitude||0,obj.geoPointValue.longitude||0))):hasTag(obj,type,"bytesValue")?(assertPresent(obj.bytesValue,"bytesValue"),obj=this.fromBlob(obj.bytesValue),new BlobValue(obj)):hasTag(obj,type,"referenceValue")?(assertPresent(obj.referenceValue,"referenceValue"),type=this.fromResourceName(obj.referenceValue),obj=new DatabaseId(type.get(1),type.get(3)),type=new DocumentKey(this.extractLocalPathFromResourceName(type)),new RefValue(obj,type)):fail("Unknown Value proto "+
JSON.stringify(obj))};JsonProtoSerializer.prototype.toMutationDocument=function(key,fields){return{name:this.toName(key),fields:this.toFields(fields)}};JsonProtoSerializer.prototype.toDocument=function(document){assert(!document.hasLocalMutations,"Can't serialize documents with mutations.");return{name:this.toName(document.key),fields:this.toFields(document.data),updateTime:this.toTimestamp(document.version.toTimestamp())}};JsonProtoSerializer.prototype.fromDocument=function(document,hasCommittedMutations){return new Document$jscomp$0(this.fromName(document.name),
this.fromVersion(document.updateTime),this.fromFields(document.fields||{}),{hasCommittedMutations:!!hasCommittedMutations})};JsonProtoSerializer.prototype.toFields=function(fields){var _this=this,result={};fields.forEach(function(key,value){result[key]=_this.toValue(value)});return result};JsonProtoSerializer.prototype.fromFields=function(object){var _this=this,result=ObjectValue.EMPTY;forEach(object,function(key,value){result=result.set(new FieldPath([key]),_this.fromValue(value))});return result};
JsonProtoSerializer.prototype.toMapValue=function(map){return{fields:this.toFields(map)}};JsonProtoSerializer.prototype.toArrayValue=function(array){var _this=this,result=[];array.forEach(function(value){result.push(_this.toValue(value))});return{values:result}};JsonProtoSerializer.prototype.fromFound=function(doc){assert(!!doc.found,"Tried to deserialize a found document from a missing document.");assertPresent(doc.found.name,"doc.found.name");assertPresent(doc.found.updateTime,"doc.found.updateTime");
var key=this.fromName(doc.found.name),version=this.fromVersion(doc.found.updateTime),fields=this.fromFields(doc.found.fields||{});return new Document$jscomp$0(key,version,fields,{},doc.found)};JsonProtoSerializer.prototype.fromMissing=function(result){assert(!!result.missing,"Tried to deserialize a missing document from a found document.");assert(!!result.readTime,"Tried to deserialize a missing document without a read time.");var key=this.fromName(result.missing);result=this.fromVersion(result.readTime);
return new NoDocument(key,result)};JsonProtoSerializer.prototype.fromMaybeDocument=function(result){var type=result.result;return hasTag(result,type,"found")?this.fromFound(result):hasTag(result,type,"missing")?this.fromMissing(result):fail("invalid batch get response: "+JSON.stringify(result))};JsonProtoSerializer.prototype.toWatchTargetChangeState=function(state){switch(state){case WatchTargetChangeState.Added:return"ADD";case WatchTargetChangeState.Current:return"CURRENT";case WatchTargetChangeState.NoChange:return"NO_CHANGE";
case WatchTargetChangeState.Removed:return"REMOVE";case WatchTargetChangeState.Reset:return"RESET";default:return fail("Unknown WatchTargetChangeState: "+state)}};JsonProtoSerializer.prototype.toTestWatchChange=function(watchChange){if(watchChange instanceof ExistenceFilterChange)return{filter:{count:watchChange.existenceFilter.count,targetId:watchChange.targetId}};if(watchChange instanceof DocumentWatchChange){if(watchChange.newDoc instanceof Document$jscomp$0){var doc=watchChange.newDoc;return{documentChange:{document:{name:this.toName(doc.key),
fields:this.toFields(doc.data),updateTime:this.toVersion(doc.version)},targetIds:watchChange.updatedTargetIds,removedTargetIds:watchChange.removedTargetIds}}}if(watchChange.newDoc instanceof NoDocument)return doc=watchChange.newDoc,{documentDelete:{document:this.toName(doc.key),readTime:this.toVersion(doc.version),removedTargetIds:watchChange.removedTargetIds}};if(null===watchChange.newDoc)return{documentRemove:{document:this.toName(watchChange.key),removedTargetIds:watchChange.removedTargetIds}}}return watchChange instanceof
WatchTargetChange?(doc=void 0,watchChange.cause&&(doc={code:mapRpcCodeFromCode(watchChange.cause.code),message:watchChange.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(watchChange.state),targetIds:watchChange.targetIds,resumeToken:this.unsafeCastProtoByteString(watchChange.resumeToken),cause:doc}}):fail("Unrecognized watch change: "+JSON.stringify(watchChange))};JsonProtoSerializer.prototype.fromWatchChange=function(change){var type=change.response_type;if(hasTag(change,
type,"targetChange")){assertPresent(change.targetChange,"targetChange");type=this.fromWatchTargetChangeState(change.targetChange.targetChangeType||"NO_CHANGE");var targetIds=change.targetChange.targetIds||[],resumeToken=change.targetChange.resumeToken||this.emptyByteString();change=(change=change.targetChange.cause)&&this.fromRpcStatus(change);type=new WatchTargetChange(type,targetIds,resumeToken,change||null)}else if(hasTag(change,type,"documentChange"))assertPresent(change.documentChange,"documentChange"),
assertPresent(change.documentChange.document,"documentChange.name"),assertPresent(change.documentChange.document.name,"documentChange.document.name"),assertPresent(change.documentChange.document.updateTime,"documentChange.document.updateTime"),targetIds=change.documentChange,type=this.fromName(targetIds.document.name),resumeToken=this.fromVersion(targetIds.document.updateTime),change=this.fromFields(targetIds.document.fields||{}),type=new Document$jscomp$0(type,resumeToken,change,{},targetIds.document),
resumeToken=targetIds.removedTargetIds||[],type=new DocumentWatchChange(targetIds.targetIds||[],resumeToken,type.key,type);else if(hasTag(change,type,"documentDelete"))assertPresent(change.documentDelete,"documentDelete"),assertPresent(change.documentDelete.document,"documentDelete.document"),targetIds=change.documentDelete,type=this.fromName(targetIds.document),resumeToken=targetIds.readTime?this.fromVersion(targetIds.readTime):SnapshotVersion.forDeletedDoc(),type=new NoDocument(type,resumeToken),
resumeToken=targetIds.removedTargetIds||[],type=new DocumentWatchChange([],resumeToken,type.key,type);else if(hasTag(change,type,"documentRemove"))assertPresent(change.documentRemove,"documentRemove"),assertPresent(change.documentRemove.document,"documentRemove"),targetIds=change.documentRemove,type=this.fromName(targetIds.document),resumeToken=targetIds.removedTargetIds||[],type=new DocumentWatchChange([],resumeToken,type,null);else if(hasTag(change,type,"filter"))assertPresent(change.filter,"filter"),
assertPresent(change.filter.targetId,"filter.targetId"),type=change.filter,targetIds=new ExistenceFilter(type.count||0),type=new ExistenceFilterChange(type.targetId,targetIds);else return fail("Unknown change type "+JSON.stringify(change));return type};JsonProtoSerializer.prototype.fromWatchTargetChangeState=function(state){return"NO_CHANGE"===state?WatchTargetChangeState.NoChange:"ADD"===state?WatchTargetChangeState.Added:"REMOVE"===state?WatchTargetChangeState.Removed:"CURRENT"===state?WatchTargetChangeState.Current:
"RESET"===state?WatchTargetChangeState.Reset:fail("Got unexpected TargetChange.state: "+state)};JsonProtoSerializer.prototype.versionFromListenResponse=function(change){if(!hasTag(change,change.response_type,"targetChange"))return SnapshotVersion.MIN;change=change.targetChange;return change.targetIds&&change.targetIds.length||!change.readTime?SnapshotVersion.MIN:this.fromVersion(change.readTime)};JsonProtoSerializer.prototype.toMutation=function(mutation){var _this=this;if(mutation instanceof SetMutation)var result=
{update:this.toMutationDocument(mutation.key,mutation.value)};else if(mutation instanceof DeleteMutation)result={delete:this.toName(mutation.key)};else if(mutation instanceof PatchMutation)result={update:this.toMutationDocument(mutation.key,mutation.data),updateMask:this.toDocumentMask(mutation.fieldMask)};else if(mutation instanceof TransformMutation)result={transform:{document:this.toName(mutation.key),fieldTransforms:mutation.fieldTransforms.map(function(transform){return _this.toFieldTransform(transform)})}};
else return fail("Unknown mutation type "+mutation.type);mutation.precondition.isNone||(result.currentDocument=this.toPrecondition(mutation.precondition));return result};JsonProtoSerializer.prototype.fromMutation=function(proto){var _this=this,precondition=proto.currentDocument?this.fromPrecondition(proto.currentDocument):Precondition.NONE;if(proto.update){assertPresent(proto.update.name,"name");var key=this.fromName(proto.update.name),value=this.fromFields(proto.update.fields||{});return proto.updateMask?
(proto=this.fromDocumentMask(proto.updateMask),new PatchMutation(key,value,proto,precondition)):new SetMutation(key,value,precondition)}return proto.delete?(key=this.fromName(proto.delete),new DeleteMutation(key,precondition)):proto.transform?(key=this.fromName(proto.transform.document),value=proto.transform.fieldTransforms.map(function(transform){return _this.fromFieldTransform(transform)}),assert(!0===precondition.exists,'Transforms only support precondition "exists \x3d\x3d true"'),new TransformMutation(key,
value)):fail("unknown mutation proto: "+JSON.stringify(proto))};JsonProtoSerializer.prototype.toPrecondition=function(precondition){assert(!precondition.isNone,"Can't serialize an empty precondition");return void 0!==precondition.updateTime?{updateTime:this.toVersion(precondition.updateTime)}:void 0!==precondition.exists?{exists:precondition.exists}:fail("Unknown precondition")};JsonProtoSerializer.prototype.fromPrecondition=function(precondition){return void 0!==precondition.updateTime?Precondition.updateTime(this.fromVersion(precondition.updateTime)):
void 0!==precondition.exists?Precondition.exists(precondition.exists):Precondition.NONE};JsonProtoSerializer.prototype.fromWriteResult=function(proto,commitTime){var _this=this;commitTime=proto.updateTime?this.fromVersion(proto.updateTime):this.fromVersion(commitTime);var transformResults=null;proto.transformResults&&0<proto.transformResults.length&&(transformResults=proto.transformResults.map(function(result){return _this.fromValue(result)}));return new MutationResult(commitTime,transformResults)};
JsonProtoSerializer.prototype.fromWriteResults=function(protos,commitTime){var _this=this;return protos&&0<protos.length?(assert(void 0!==commitTime,"Received a write result without a commit time"),protos.map(function(proto){return _this.fromWriteResult(proto,commitTime)})):[]};JsonProtoSerializer.prototype.toFieldTransform=function(fieldTransform){var _this=this,transform=fieldTransform.transform;if(transform instanceof ServerTimestampTransform)return{fieldPath:fieldTransform.field.canonicalString(),
setToServerValue:"REQUEST_TIME"};if(transform instanceof ArrayUnionTransformOperation)return{fieldPath:fieldTransform.field.canonicalString(),appendMissingElements:{values:transform.elements.map(function(v){return _this.toValue(v)})}};if(transform instanceof ArrayRemoveTransformOperation)return{fieldPath:fieldTransform.field.canonicalString(),removeAllFromArray:{values:transform.elements.map(function(v){return _this.toValue(v)})}};if(transform instanceof NumericIncrementTransformOperation)return{fieldPath:fieldTransform.field.canonicalString(),
increment:this.toValue(transform.operand)};throw fail("Unknown transform: "+fieldTransform.transform);};JsonProtoSerializer.prototype.fromFieldTransform=function(proto){var _this=this,type=proto.transform_type,transform=null;hasTag(proto,type,"setToServerValue")?(assert("REQUEST_TIME"===proto.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(proto)),transform=ServerTimestampTransform.instance):hasTag(proto,type,"appendMissingElements")?(transform=proto.appendMissingElements.values||
[],transform=new ArrayUnionTransformOperation(transform.map(function(v){return _this.fromValue(v)}))):hasTag(proto,type,"removeAllFromArray")?(transform=proto.removeAllFromArray.values||[],transform=new ArrayRemoveTransformOperation(transform.map(function(v){return _this.fromValue(v)}))):hasTag(proto,type,"increment")?(transform=this.fromValue(proto.increment),assert(transform instanceof NumberValue,"NUMERIC_ADD transform requires a NumberValue"),transform=new NumericIncrementTransformOperation(transform)):
fail("Unknown transform proto: "+JSON.stringify(proto));proto=FieldPath.fromServerFormat(proto.fieldPath);return new FieldTransform(proto,transform)};JsonProtoSerializer.prototype.toDocumentsTarget=function(query){return{documents:[this.toQueryPath(query.path)]}};JsonProtoSerializer.prototype.fromDocumentsTarget=function(documentsTarget){var count=documentsTarget.documents.length;assert(1===count,"DocumentsTarget contained other than 1 document: "+count);return Query$jscomp$0.atPath(this.fromQueryPath(documentsTarget.documents[0]))};
JsonProtoSerializer.prototype.toQueryTarget=function(query){var result={structuredQuery:{}},path=query.path;null!==query.collectionGroup?(assert(0===path.length%2,"Collection Group queries should be within a document path or root."),result.parent=this.toQueryPath(path),result.structuredQuery.from=[{collectionId:query.collectionGroup,allDescendants:!0}]):(assert(0!==path.length%2,"Document queries with filters are not supported."),result.parent=this.toQueryPath(path.popLast()),result.structuredQuery.from=
[{collectionId:path.lastSegment()}]);if(path=this.toFilter(query.filters))result.structuredQuery.where=path;if(path=this.toOrder(query.orderBy))result.structuredQuery.orderBy=path;path=this.toInt32Value(query.limit);void 0!==path&&(result.structuredQuery.limit=path);query.startAt&&(result.structuredQuery.startAt=this.toCursor(query.startAt));query.endAt&&(result.structuredQuery.endAt=this.toCursor(query.endAt));return result};JsonProtoSerializer.prototype.fromQueryTarget=function(target){var path=
this.fromQueryPath(target.parent);target=target.structuredQuery;var fromCount=target.from?target.from.length:0,collectionGroup=null;0<fromCount&&(assert(1===fromCount,"StructuredQuery.from with more than one collection is not supported."),fromCount=target.from[0],fromCount.allDescendants?collectionGroup=fromCount.collectionId:path=path.child(fromCount.collectionId));fromCount=[];target.where&&(fromCount=this.fromFilter(target.where));var orderBy=[];target.orderBy&&(orderBy=this.fromOrder(target.orderBy));
var limit=null;target.limit&&(limit=this.fromInt32Value(target.limit));var startAt=null;target.startAt&&(startAt=this.fromCursor(target.startAt));var endAt=null;target.endAt&&(endAt=this.fromCursor(target.endAt));return new Query$jscomp$0(path,collectionGroup,orderBy,fromCount,limit,startAt,endAt)};JsonProtoSerializer.prototype.toListenRequestLabels=function(queryData){queryData=this.toLabel(queryData.purpose);return null==queryData?null:{"goog-listen-tags":queryData}};JsonProtoSerializer.prototype.toLabel=
function(purpose){switch(purpose){case QueryPurpose.Listen:return null;case QueryPurpose.ExistenceFilterMismatch:return"existence-filter-mismatch";case QueryPurpose.LimboResolution:return"limbo-document";default:return fail("Unrecognized query purpose: "+purpose)}};JsonProtoSerializer.prototype.toTarget=function(queryData){var result=queryData.query;result=result.isDocumentQuery()?{documents:this.toDocumentsTarget(result)}:{query:this.toQueryTarget(result)};result.targetId=queryData.targetId;0<queryData.resumeToken.length&&
(result.resumeToken=this.unsafeCastProtoByteString(queryData.resumeToken));return result};JsonProtoSerializer.prototype.toFilter=function(filters){var _this=this;if(0!==filters.length)return filters=filters.map(function(filter){return filter instanceof RelationFilter?_this.toRelationFilter(filter):_this.toUnaryFilter(filter)}),1===filters.length?filters[0]:{compositeFilter:{op:"AND",filters:filters}}};JsonProtoSerializer.prototype.fromFilter=function(filter){var _this=this;return filter?void 0!==
filter.unaryFilter?[this.fromUnaryFilter(filter)]:void 0!==filter.fieldFilter?[this.fromRelationFilter(filter)]:void 0!==filter.compositeFilter?filter.compositeFilter.filters.map(function(f){return _this.fromFilter(f)}).reduce(function(accum,current){return accum.concat(current)}):fail("Unknown filter: "+JSON.stringify(filter)):[]};JsonProtoSerializer.prototype.toOrder=function(orderBys){var _this=this;if(0!==orderBys.length)return orderBys.map(function(order){return _this.toPropertyOrder(order)})};
JsonProtoSerializer.prototype.fromOrder=function(orderBys){var _this=this;return orderBys.map(function(order){return _this.fromPropertyOrder(order)})};JsonProtoSerializer.prototype.toCursor=function(cursor){var _this=this;return{before:cursor.before,values:cursor.position.map(function(component){return _this.toValue(component)})}};JsonProtoSerializer.prototype.fromCursor=function(cursor){var _this=this,before=!!cursor.before;cursor=cursor.values.map(function(component){return _this.fromValue(component)});
return new Bound(cursor,before)};JsonProtoSerializer.prototype.toDirection=function(dir){return DIRECTIONS[dir.name]};JsonProtoSerializer.prototype.fromDirection=function(dir){switch(dir){case "ASCENDING":return Direction.ASCENDING;case "DESCENDING":return Direction.DESCENDING}};JsonProtoSerializer.prototype.toOperatorName=function(op){return OPERATORS[op.name]};JsonProtoSerializer.prototype.fromOperatorName=function(op){switch(op){case "EQUAL":return RelationOp.EQUAL;case "GREATER_THAN":return RelationOp.GREATER_THAN;
case "GREATER_THAN_OR_EQUAL":return RelationOp.GREATER_THAN_OR_EQUAL;case "LESS_THAN":return RelationOp.LESS_THAN;case "LESS_THAN_OR_EQUAL":return RelationOp.LESS_THAN_OR_EQUAL;case "ARRAY_CONTAINS":return RelationOp.ARRAY_CONTAINS;case "OPERATOR_UNSPECIFIED":return fail("Unspecified relation");default:return fail("Unknown relation")}};JsonProtoSerializer.prototype.toFieldPathReference=function(path){return{fieldPath:path.canonicalString()}};JsonProtoSerializer.prototype.fromFieldPathReference=function(fieldReference){return FieldPath.fromServerFormat(fieldReference.fieldPath)};
JsonProtoSerializer.prototype.toPropertyOrder=function(orderBy){return{field:this.toFieldPathReference(orderBy.field),direction:this.toDirection(orderBy.dir)}};JsonProtoSerializer.prototype.fromPropertyOrder=function(orderBy){return new OrderBy(this.fromFieldPathReference(orderBy.field),this.fromDirection(orderBy.direction))};JsonProtoSerializer.prototype.toRelationFilter=function(filter){return filter instanceof RelationFilter?{fieldFilter:{field:this.toFieldPathReference(filter.field),op:this.toOperatorName(filter.op),
value:this.toValue(filter.value)}}:fail("Unrecognized filter: "+JSON.stringify(filter))};JsonProtoSerializer.prototype.fromRelationFilter=function(filter){return new RelationFilter(this.fromFieldPathReference(filter.fieldFilter.field),this.fromOperatorName(filter.fieldFilter.op),this.fromValue(filter.fieldFilter.value))};JsonProtoSerializer.prototype.toUnaryFilter=function(filter){return filter instanceof NanFilter?{unaryFilter:{field:this.toFieldPathReference(filter.field),op:"IS_NAN"}}:filter instanceof
NullFilter?{unaryFilter:{field:this.toFieldPathReference(filter.field),op:"IS_NULL"}}:fail("Unrecognized filter: "+JSON.stringify(filter))};JsonProtoSerializer.prototype.fromUnaryFilter=function(filter){switch(filter.unaryFilter.op){case "IS_NAN":return filter=this.fromFieldPathReference(filter.unaryFilter.field),new NanFilter(filter);case "IS_NULL":return filter=this.fromFieldPathReference(filter.unaryFilter.field),new NullFilter(filter);case "OPERATOR_UNSPECIFIED":return fail("Unspecified filter");
default:return fail("Unknown filter")}};JsonProtoSerializer.prototype.toDocumentMask=function(fieldMask){var canonicalFields=[];fieldMask.fields.forEach(function(field){return canonicalFields.push(field.canonicalString())});return{fieldPaths:canonicalFields}};JsonProtoSerializer.prototype.fromDocumentMask=function(proto){proto=(proto.fieldPaths||[]).map(function(path){return FieldPath.fromServerFormat(path)});return FieldMask.fromArray(proto)};return JsonProtoSerializer}(),StreamBridge=function(){function StreamBridge(args){this.sendFn=
args.sendFn;this.closeFn=args.closeFn}StreamBridge.prototype.onOpen=function(callback){assert(!this.wrappedOnOpen,"Called onOpen on stream twice!");this.wrappedOnOpen=callback};StreamBridge.prototype.onClose=function(callback){assert(!this.wrappedOnClose,"Called onClose on stream twice!");this.wrappedOnClose=callback};StreamBridge.prototype.onMessage=function(callback){assert(!this.wrappedOnMessage,"Called onMessage on stream twice!");this.wrappedOnMessage=callback};StreamBridge.prototype.close=function(){this.closeFn()};
StreamBridge.prototype.send=function(msg){this.sendFn(msg)};StreamBridge.prototype.callOnOpen=function(){assert(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set");this.wrappedOnOpen()};StreamBridge.prototype.callOnClose=function(err){assert(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set");this.wrappedOnClose(err)};StreamBridge.prototype.callOnMessage=function(msg){assert(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set");
this.wrappedOnMessage(msg)};return StreamBridge}(),RPC_NAME_REST_MAPPING={BatchGetDocuments:"batchGet",Commit:"commit"},X_GOOG_API_CLIENT_VALUE="gl-js/ fire/"+SDK_VERSION,WebChannelConnection=function(){function WebChannelConnection(info){this.databaseId=info.databaseId;this.baseUrl=(info.ssl?"https":"http")+"://"+info.host}WebChannelConnection.prototype.modifyHeadersForRequest=function(headers,token){if(token)for(var header in token.authHeaders)token.authHeaders.hasOwnProperty(header)&&(headers[header]=
token.authHeaders[header]);headers["X-Goog-Api-Client"]=X_GOOG_API_CLIENT_VALUE};WebChannelConnection.prototype.invokeRPC=function(rpcName,request,token){var _this=this,url=this.makeUrl(rpcName);return new Promise(function(resolve,reject){var xhr=new webchannelWrapper.XhrIo;xhr.listenOnce(webchannelWrapper.EventType.COMPLETE,function(){try{switch(xhr.getLastErrorCode()){case webchannelWrapper.ErrorCode.NO_ERROR:var json=xhr.getResponseJson();debug("Connection","XHR received:",JSON.stringify(json));
resolve(json);break;case webchannelWrapper.ErrorCode.TIMEOUT:debug("Connection",'RPC "'+rpcName+'" timed out');reject(new FirestoreError(Code.DEADLINE_EXCEEDED,"Request time out"));break;case webchannelWrapper.ErrorCode.HTTP_ERROR:var status_1=xhr.getStatus();debug("Connection",'RPC "'+rpcName+'" failed with status:',status_1,"response text:",xhr.getResponseText());0<status_1?reject(new FirestoreError(mapCodeFromHttpStatus(status_1),"Server responded with status "+xhr.getStatusText())):(debug("Connection",
'RPC "'+rpcName+'" failed'),reject(new FirestoreError(Code.UNAVAILABLE,"Connection failed.")));break;default:fail('RPC "'+rpcName+'" failed with unanticipated webchannel error '+xhr.getLastErrorCode()+": "+xhr.getLastError()+", giving up.")}}finally{debug("Connection",'RPC "'+rpcName+'" completed.')}});var requestString=JSON.stringify(request);debug("Connection","XHR sending: ",url+" "+requestString);var headers={"Content-Type":"text/plain"};_this.modifyHeadersForRequest(headers,token);xhr.send(url,
"POST",requestString,headers,15)})};WebChannelConnection.prototype.invokeStreamingRPC=function(rpcName,request,token){return this.invokeRPC(rpcName,request,token)};WebChannelConnection.prototype.openStream=function(rpcName,token){var urlParts=[this.baseUrl,"/","google.firestore.v1.Firestore","/",rpcName,"/channel"];rpcName=webchannelWrapper.createWebChannelTransport();var request={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+
this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0};this.modifyHeadersForRequest(request.initMessageHeaders,token);util.isReactNative()||(request.httpHeadersOverwriteParam="$httpHeaders");token=urlParts.join("");debug("Connection","Creating WebChannel: "+token+" "+request);var channel=rpcName.createWebChannel(token,request),opened=!1,closed=!1,streamBridge=new StreamBridge({sendFn:function(msg){closed?debug("Connection","Not sending because WebChannel is closed:",
msg):(opened||(debug("Connection","Opening WebChannel transport."),channel.open(),opened=!0),debug("Connection","WebChannel sending:",msg),channel.send(msg))},closeFn:function(){return channel.close()}});token=function(type,fn){channel.listen(type,function(param){try{fn(param)}catch(e){setTimeout(function(){throw e;},0)}})};token(webchannelWrapper.WebChannel.EventType.OPEN,function(){closed||debug("Connection","WebChannel transport opened.")});token(webchannelWrapper.WebChannel.EventType.CLOSE,function(){closed||
(closed=!0,debug("Connection","WebChannel transport closed"),streamBridge.callOnClose())});token(webchannelWrapper.WebChannel.EventType.ERROR,function(err){closed||(closed=!0,debug("Connection","WebChannel transport errored:",err),streamBridge.callOnClose(new FirestoreError(Code.UNAVAILABLE,"The operation could not be completed")))});token(webchannelWrapper.WebChannel.EventType.MESSAGE,function(msg){if(!closed){var msgData=msg.data[0];assert(!!msgData,"Got a webchannel message without data.");if(msg=
msgData.error||msgData[0]&&msgData[0].error){debug("Connection","WebChannel received error:",msg);msgData=msg.status;var code=RpcCode[msgData];code=void 0===code?void 0:mapCodeFromRpcCode(code);var message=msg.message;void 0===code&&(code=Code.INTERNAL,message="Unknown error status: "+msgData+" with message "+msg.message);closed=!0;streamBridge.callOnClose(new FirestoreError(code,message));channel.close()}else debug("Connection","WebChannel received:",msgData),streamBridge.callOnMessage(msgData)}});
setTimeout(function(){streamBridge.callOnOpen()},0);return streamBridge};WebChannelConnection.prototype.makeUrl=function(rpcName){var urlRpcName=RPC_NAME_REST_MAPPING[rpcName];assert(void 0!==urlRpcName,"Unknown REST mapping for: "+rpcName);rpcName=[this.baseUrl,"/","v1"];rpcName.push("/projects/");rpcName.push(this.databaseId.projectId);rpcName.push("/databases/");rpcName.push(this.databaseId.database);rpcName.push("/documents");rpcName.push(":");rpcName.push(urlRpcName);return rpcName.join("")};
return WebChannelConnection}(),BrowserPlatform=function(){function BrowserPlatform(){this.emptyByteString="";this.base64Available="undefined"!==typeof atob}Object.defineProperty(BrowserPlatform.prototype,"document",{get:function(){return"undefined"!==typeof document?document:null},enumerable:!0,configurable:!0});Object.defineProperty(BrowserPlatform.prototype,"window",{get:function(){return"undefined"!==typeof window?window:null},enumerable:!0,configurable:!0});BrowserPlatform.prototype.loadConnection=
function(databaseInfo){return Promise.resolve(new WebChannelConnection(databaseInfo))};BrowserPlatform.prototype.newSerializer=function(databaseId){return new JsonProtoSerializer(databaseId,{useProto3Json:!0})};BrowserPlatform.prototype.formatJSON=function(value){return JSON.stringify(value)};BrowserPlatform.prototype.atob=function(encoded){return atob(encoded)};BrowserPlatform.prototype.btoa=function(raw){return btoa(raw)};return BrowserPlatform}();PlatformSupport.setPlatform(new BrowserPlatform);
var ListenSequence=function(){function ListenSequence(previousValue,sequenceNumberSyncer){var _this=this;this.previousValue=previousValue;sequenceNumberSyncer&&(sequenceNumberSyncer.sequenceNumberHandler=function(sequenceNumber){return _this.setPreviousValue(sequenceNumber)},this.writeNewSequenceNumber=function(sequenceNumber){return sequenceNumberSyncer.writeSequenceNumber(sequenceNumber)})}ListenSequence.prototype.setPreviousValue=function(externalPreviousValue){return this.previousValue=Math.max(externalPreviousValue,
this.previousValue)};ListenSequence.prototype.next=function(){var nextValue=++this.previousValue;this.writeNewSequenceNumber&&this.writeNewSequenceNumber(nextValue);return nextValue};ListenSequence.INVALID=-1;return ListenSequence}(),Deferred=function(){return function(){var _this=this;this.promise=new Promise(function(resolve,reject){_this.resolve=resolve;_this.reject=reject})}}(),TimerId;(function(TimerId){TimerId.All="all";TimerId.ListenStreamIdle="listen_stream_idle";TimerId.ListenStreamConnectionBackoff=
"listen_stream_connection_backoff";TimerId.WriteStreamIdle="write_stream_idle";TimerId.WriteStreamConnectionBackoff="write_stream_connection_backoff";TimerId.OnlineStateTimeout="online_state_timeout";TimerId.ClientMetadataRefresh="client_metadata_refresh";TimerId.LruGarbageCollection="lru_garbage_collection"})(TimerId||(TimerId={}));var DelayedOperation=function(){function DelayedOperation(asyncQueue,timerId,targetTimeMs,op,removalCallback){this.asyncQueue=asyncQueue;this.timerId=timerId;this.targetTimeMs=
targetTimeMs;this.op=op;this.removalCallback=removalCallback;this.deferred=new Deferred;this.then=this.deferred.promise.then.bind(this.deferred.promise);this.catch=this.deferred.promise.catch.bind(this.deferred.promise);this.deferred.promise.catch(function(err){})}DelayedOperation.createAndSchedule=function(asyncQueue,timerId,delayMs,op,removalCallback){var targetTime=Date.now()+delayMs;asyncQueue=new DelayedOperation(asyncQueue,timerId,targetTime,op,removalCallback);asyncQueue.start(delayMs);return asyncQueue};
DelayedOperation.prototype.start=function(delayMs){var _this=this;this.timerHandle=setTimeout(function(){return _this.handleDelayElapsed()},delayMs)};DelayedOperation.prototype.skipDelay=function(){return this.handleDelayElapsed()};DelayedOperation.prototype.cancel=function(reason){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new FirestoreError(Code.CANCELLED,"Operation cancelled"+(reason?": "+reason:""))))};DelayedOperation.prototype.handleDelayElapsed=function(){var _this=
this;this.asyncQueue.enqueueAndForget(function(){return null!==_this.timerHandle?(_this.clearTimeout(),_this.op().then(function(result){return _this.deferred.resolve(result)})):Promise.resolve()})};DelayedOperation.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)};return DelayedOperation}(),AsyncQueue=function(){function AsyncQueue(){this.tail=Promise.resolve();this.delayedOperations=[];this.operationInProgress=
!1}AsyncQueue.prototype.enqueueAndForget=function(op){this.enqueue(op)};AsyncQueue.prototype.enqueue=function(op){var _this=this;this.verifyNotFailed();var newTail=this.tail.then(function(){_this.operationInProgress=!0;return op().catch(function(error$1){_this.failure=error$1;_this.operationInProgress=!1;var message=error$1.stack||error$1.message||"";error$jscomp$0("INTERNAL UNHANDLED ERROR: ",message);0>message.indexOf("Firestore Test Simulated Error")&&setTimeout(function(){throw error$1;},0);throw error$1;
}).then(function(result){_this.operationInProgress=!1;return result})});return this.tail=newTail};AsyncQueue.prototype.enqueueAfterDelay=function(timerId,delayMs,op$jscomp$0){var _this=this;this.verifyNotFailed();assert(0<=delayMs,"Attempted to schedule an operation with a negative delay of "+delayMs);assert(!this.containsDelayedOperation(timerId),"Attempted to schedule multiple operations with timer id "+timerId+".");timerId=DelayedOperation.createAndSchedule(this,timerId,delayMs,op$jscomp$0,function(op){return _this.removeDelayedOperation(op)});
this.delayedOperations.push(timerId);return timerId};AsyncQueue.prototype.verifyNotFailed=function(){this.failure&&fail("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))};AsyncQueue.prototype.verifyOperationInProgress=function(){assert(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")};AsyncQueue.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})};AsyncQueue.prototype.containsDelayedOperation=
function(timerId){for(var _i=0,_a=this.delayedOperations;_i<_a.length;_i++)if(_a[_i].timerId===timerId)return!0;return!1};AsyncQueue.prototype.runDelayedOperationsEarly=function(lastTimerId){var _this=this;return this.drain().then(function(){assert(lastTimerId===TimerId.All||_this.containsDelayedOperation(lastTimerId),"Attempted to drain to missing operation "+lastTimerId);_this.delayedOperations.sort(function(a,b){return a.targetTimeMs-b.targetTimeMs});for(var _i=0,_a=_this.delayedOperations;_i<
_a.length;_i++){var op=_a[_i];op.skipDelay();if(lastTimerId!==TimerId.All&&op.timerId===lastTimerId)break}return _this.drain()})};AsyncQueue.prototype.removeDelayedOperation=function(op){op=this.delayedOperations.indexOf(op);assert(0<=op,"Delayed operation not found.");this.delayedOperations.splice(op,1)};return AsyncQueue}(),MutationBatch=function(){function MutationBatch(batchId,localWriteTime,baseMutations,mutations){this.batchId=batchId;this.localWriteTime=localWriteTime;this.baseMutations=baseMutations;
this.mutations=mutations;assert(0<mutations.length,"Cannot create an empty mutation batch")}MutationBatch.prototype.applyToRemoteDocument=function(docKey,maybeDoc,batchResult){maybeDoc&&assert(maybeDoc.key.isEqual(docKey),"applyToRemoteDocument: key "+docKey+" should match maybeDoc key\n        "+maybeDoc.key);batchResult=batchResult.mutationResults;assert(batchResult.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+
batchResult.length+").");for(var i=0;i<this.mutations.length;i++){var mutation=this.mutations[i];mutation.key.isEqual(docKey)&&(maybeDoc=mutation.applyToRemoteDocument(maybeDoc,batchResult[i]))}return maybeDoc};MutationBatch.prototype.applyToLocalView=function(docKey,maybeDoc){maybeDoc&&assert(maybeDoc.key.isEqual(docKey),"applyToLocalDocument: key "+docKey+" should match maybeDoc key\n        "+maybeDoc.key);for(var _i=0,_a=this.baseMutations;_i<_a.length;_i++){var mutation=_a[_i];mutation.key.isEqual(docKey)&&
(maybeDoc=mutation.applyToLocalView(maybeDoc,maybeDoc,this.localWriteTime))}_i=maybeDoc;_a=0;for(var _c=this.mutations;_a<_c.length;_a++)mutation=_c[_a],mutation.key.isEqual(docKey)&&(maybeDoc=mutation.applyToLocalView(maybeDoc,_i,this.localWriteTime));return maybeDoc};MutationBatch.prototype.applyToLocalDocumentSet=function(maybeDocs){var _this=this,mutatedDocuments=maybeDocs;this.mutations.forEach(function(m){var mutatedDocument=_this.applyToLocalView(m.key,maybeDocs.get(m.key));mutatedDocument&&
(mutatedDocuments=mutatedDocuments.insert(m.key,mutatedDocument))});return mutatedDocuments};MutationBatch.prototype.keys=function(){return this.mutations.reduce(function(keys,m){return keys.add(m.key)},documentKeySet())};MutationBatch.prototype.isEqual=function(other){return this.batchId===other.batchId&&arrayEquals(this.mutations,other.mutations)&&arrayEquals(this.baseMutations,other.baseMutations)};return MutationBatch}(),MutationBatchResult=function(){function MutationBatchResult(batch,commitVersion,
mutationResults,streamToken,docVersions){this.batch=batch;this.commitVersion=commitVersion;this.mutationResults=mutationResults;this.streamToken=streamToken;this.docVersions=docVersions}MutationBatchResult.from=function(batch,commitVersion,results,streamToken){assert(batch.mutations.length===results.length,"Mutations sent "+batch.mutations.length+" must equal results received "+results.length);for(var versionMap=EMPTY_DOCUMENT_VERSION_MAP,mutations=batch.mutations,i=0;i<mutations.length;i++)versionMap=
versionMap.insert(mutations[i].key,results[i].version);return new MutationBatchResult(batch,commitVersion,results,streamToken,versionMap)};return MutationBatchResult}(),PersistencePromise=function(){function PersistencePromise(callback){var _this=this;this.catchCallback=this.nextCallback=null;this.error=this.result=void 0;this.callbackAttached=this.isDone=!1;callback(function(value){_this.isDone=!0;_this.result=value;_this.nextCallback&&_this.nextCallback(value)},function(error){_this.isDone=!0;_this.error=
error;_this.catchCallback&&_this.catchCallback(error)})}PersistencePromise.prototype.catch=function(fn){return this.next(void 0,fn)};PersistencePromise.prototype.next=function(nextFn,catchFn){var _this=this;this.callbackAttached&&fail("Called next() or catch() twice for PersistencePromise");this.callbackAttached=!0;return this.isDone?this.error?this.wrapFailure(catchFn,this.error):this.wrapSuccess(nextFn,this.result):new PersistencePromise(function(resolve,reject){_this.nextCallback=function(value){_this.wrapSuccess(nextFn,
value).next(resolve,reject)};_this.catchCallback=function(error){_this.wrapFailure(catchFn,error).next(resolve,reject)}})};PersistencePromise.prototype.toPromise=function(){var _this=this;return new Promise(function(resolve,reject){_this.next(resolve,reject)})};PersistencePromise.prototype.wrapUserFunction=function(fn){try{var result=fn();return result instanceof PersistencePromise?result:PersistencePromise.resolve(result)}catch(e){return PersistencePromise.reject(e)}};PersistencePromise.prototype.wrapSuccess=
function(nextFn,value){return nextFn?this.wrapUserFunction(function(){return nextFn(value)}):PersistencePromise.resolve(value)};PersistencePromise.prototype.wrapFailure=function(catchFn,error){return catchFn?this.wrapUserFunction(function(){return catchFn(error)}):PersistencePromise.reject(error)};PersistencePromise.resolve=function(result){return new PersistencePromise(function(resolve,reject){resolve(result)})};PersistencePromise.reject=function(error){return new PersistencePromise(function(resolve,
reject){reject(error)})};PersistencePromise.waitFor=function(all){return new PersistencePromise(function(resolve,reject){var expectedCount=0,resolvedCount=0,done=!1;all.forEach(function(element){++expectedCount;element.next(function(){++resolvedCount;done&&resolvedCount===expectedCount&&resolve()},function(err){return reject(err)})});done=!0;resolvedCount===expectedCount&&resolve()})};PersistencePromise.or=function(predicates){for(var p=PersistencePromise.resolve(!1),_loop_1=function(predicate){p=
p.next(function(isTrue){return isTrue?PersistencePromise.resolve(isTrue):predicate()})},_i=0;_i<predicates.length;_i++)_loop_1(predicates[_i]);return p};PersistencePromise.forEach=function(collection,f){var _this=this,promises=[];collection.forEach(function(r,s){promises.push(f.call(_this,r,s))});return this.waitFor(promises)};return PersistencePromise}(),IndexedDbMutationQueue=function(){function IndexedDbMutationQueue(userId,serializer,indexManager,referenceDelegate){this.userId=userId;this.serializer=
serializer;this.indexManager=indexManager;this.referenceDelegate=referenceDelegate;this.documentKeysByBatchId={}}IndexedDbMutationQueue.forUser=function(user,serializer,indexManager,referenceDelegate){assert(""!==user.uid,"UserID must not be an empty string.");user=user.isAuthenticated()?user.uid:"";return new IndexedDbMutationQueue(user,serializer,indexManager,referenceDelegate)};IndexedDbMutationQueue.prototype.checkEmpty=function(transaction){var empty=!0,range=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],
[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(transaction).iterate({index:DbMutationBatch.userMutationsIndex,range:range},function(key,value,control){empty=!1;control.done()}).next(function(){return empty})};IndexedDbMutationQueue.prototype.acknowledgeBatch=function(transaction,batch,streamToken){return this.getMutationQueueMetadata(transaction).next(function(metadata){metadata.lastStreamToken=convertStreamToken(streamToken);return IndexedDbPersistence.getStore(transaction,DbMutationQueue.store).put(metadata)})};
IndexedDbMutationQueue.prototype.getLastStreamToken=function(transaction){return this.getMutationQueueMetadata(transaction).next(function(metadata){return metadata.lastStreamToken})};IndexedDbMutationQueue.prototype.setLastStreamToken=function(transaction,streamToken){return this.getMutationQueueMetadata(transaction).next(function(metadata){metadata.lastStreamToken=convertStreamToken(streamToken);return IndexedDbPersistence.getStore(transaction,DbMutationQueue.store).put(metadata)})};IndexedDbMutationQueue.prototype.addMutationBatch=
function(transaction,localWriteTime,baseMutations,mutations){var _this=this,documentStore=documentMutationsStore(transaction),mutationStore=mutationsStore(transaction);return mutationStore.add({}).next(function(batchId){assert("number"===typeof batchId,"Auto-generated key is not a number");var batch=new MutationBatch(batchId,localWriteTime,baseMutations,mutations),dbBatch=_this.serializer.toDbMutationBatch(_this.userId,batch);_this.documentKeysByBatchId[batchId]=batch.keys();for(var promises=[],_i=
0;_i<mutations.length;_i++){var mutation=mutations[_i],indexKey=DbDocumentMutation.key(_this.userId,mutation.key.path,batchId);promises.push(mutationStore.put(dbBatch));promises.push(documentStore.put(indexKey,DbDocumentMutation.PLACEHOLDER));promises.push(_this.indexManager.addToCollectionParentIndex(transaction,mutation.key.path.popLast()))}return PersistencePromise.waitFor(promises).next(function(){return batch})})};IndexedDbMutationQueue.prototype.lookupMutationBatch=function(transaction,batchId){var _this=
this;return mutationsStore(transaction).get(batchId).next(function(dbBatch){return dbBatch?(assert(dbBatch.userId===_this.userId,"Unexpected user '"+dbBatch.userId+"' for mutation batch "+batchId),_this.serializer.fromDbMutationBatch(dbBatch)):null})};IndexedDbMutationQueue.prototype.lookupMutationKeys=function(transaction,batchId){var _this=this;return this.documentKeysByBatchId[batchId]?PersistencePromise.resolve(this.documentKeysByBatchId[batchId]):this.lookupMutationBatch(transaction,batchId).next(function(batch){return batch?
(batch=batch.keys(),_this.documentKeysByBatchId[batchId]=batch):null})};IndexedDbMutationQueue.prototype.getNextMutationBatchAfterBatchId=function(transaction,batchId){var _this=this;return this.getMutationQueueMetadata(transaction).next(function(metadata){var nextBatchId=batchId+1;metadata=IDBKeyRange.lowerBound([_this.userId,nextBatchId]);var foundBatch=null;return mutationsStore(transaction).iterate({index:DbMutationBatch.userMutationsIndex,range:metadata},function(key,dbBatch,control){dbBatch.userId===
_this.userId&&(assert(dbBatch.batchId>=nextBatchId,"Should have found mutation after "+nextBatchId),foundBatch=_this.serializer.fromDbMutationBatch(dbBatch));control.done()}).next(function(){return foundBatch})})};IndexedDbMutationQueue.prototype.getAllMutationBatches=function(transaction){var _this=this,range=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(transaction).loadAll(DbMutationBatch.userMutationsIndex,range).next(function(dbBatches){return dbBatches.map(function(dbBatch){return _this.serializer.fromDbMutationBatch(dbBatch)})})};
IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(transaction,documentKey){var _this=this,indexPrefix=DbDocumentMutation.prefixForPath(this.userId,documentKey.path);indexPrefix=IDBKeyRange.lowerBound(indexPrefix);var results=[];return documentMutationsStore(transaction).iterate({range:indexPrefix},function(indexKey,_,control){_=indexKey[0];var batchId=indexKey[2],path=decode(indexKey[1]);if(_===_this.userId&&documentKey.path.isEqual(path))return mutationsStore(transaction).get(batchId).next(function(mutation){if(!mutation)throw fail("Dangling document-mutation reference found: "+
indexKey+" which points to "+batchId);assert(mutation.userId===_this.userId,"Unexpected user '"+mutation.userId+"' for mutation batch "+batchId);results.push(_this.serializer.fromDbMutationBatch(mutation))});control.done()}).next(function(){return results})};IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(transaction,documentKeys){var _this=this,uniqueBatchIDs=new SortedSet(primitiveComparator),promises=[];documentKeys.forEach(function(documentKey){var indexStart=
DbDocumentMutation.prefixForPath(_this.userId,documentKey.path);indexStart=IDBKeyRange.lowerBound(indexStart);indexStart=documentMutationsStore(transaction).iterate({range:indexStart},function(indexKey,_,control){_=indexKey[0];var batchID=indexKey[2];indexKey=decode(indexKey[1]);_===_this.userId&&documentKey.path.isEqual(indexKey)?uniqueBatchIDs=uniqueBatchIDs.add(batchID):control.done()});promises.push(indexStart)});return PersistencePromise.waitFor(promises).next(function(){return _this.lookupMutationBatches(transaction,
uniqueBatchIDs)})};IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(transaction,query){var _this=this;assert(!query.isDocumentQuery(),"Document queries shouldn't go down this path");assert(!query.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var queryPath=query.path,immediateChildrenLength=queryPath.length+1;query=DbDocumentMutation.prefixForPath(this.userId,queryPath);query=IDBKeyRange.lowerBound(query);var uniqueBatchIDs=
new SortedSet(primitiveComparator);return documentMutationsStore(transaction).iterate({range:query},function(indexKey,_,control){_=indexKey[0];var batchID=indexKey[2];indexKey=decode(indexKey[1]);_===_this.userId&&queryPath.isPrefixOf(indexKey)?indexKey.length===immediateChildrenLength&&(uniqueBatchIDs=uniqueBatchIDs.add(batchID)):control.done()}).next(function(){return _this.lookupMutationBatches(transaction,uniqueBatchIDs)})};IndexedDbMutationQueue.prototype.lookupMutationBatches=function(transaction,
batchIDs){var _this=this,results=[],promises=[];batchIDs.forEach(function(batchId){promises.push(mutationsStore(transaction).get(batchId).next(function(mutation){if(null===mutation)throw fail("Dangling document-mutation reference found, which points to "+batchId);assert(mutation.userId===_this.userId,"Unexpected user '"+mutation.userId+"' for mutation batch "+batchId);results.push(_this.serializer.fromDbMutationBatch(mutation))}))});return PersistencePromise.waitFor(promises).next(function(){return results})};
IndexedDbMutationQueue.prototype.removeMutationBatch=function(transaction,batch){var _this=this;return removeMutationBatch(transaction.simpleDbTransaction,this.userId,batch).next(function(removedDocuments){_this.removeCachedMutationKeys(batch.batchId);return PersistencePromise.forEach(removedDocuments,function(key){return _this.referenceDelegate.removeMutationReference(transaction,key)})})};IndexedDbMutationQueue.prototype.removeCachedMutationKeys=function(batchId){delete this.documentKeysByBatchId[batchId]};
IndexedDbMutationQueue.prototype.performConsistencyCheck=function(txn){var _this=this;return this.checkEmpty(txn).next(function(empty){if(!empty)return PersistencePromise.resolve();empty=IDBKeyRange.lowerBound(DbDocumentMutation.prefixForUser(_this.userId));var danglingMutationReferences=[];return documentMutationsStore(txn).iterate({range:empty},function(key,_,control){key[0]!==_this.userId?control.done():(key=decode(key[1]),danglingMutationReferences.push(key))}).next(function(){assert(0===danglingMutationReferences.length,
"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+danglingMutationReferences.map(function(p){return p.canonicalString()}))})})};IndexedDbMutationQueue.prototype.containsKey=function(txn,key){return mutationQueueContainsKey(txn,this.userId,key)};IndexedDbMutationQueue.prototype.getMutationQueueMetadata=function(transaction){var _this=this;return IndexedDbPersistence.getStore(transaction,DbMutationQueue.store).get(this.userId).next(function(metadata){return metadata||
new DbMutationQueue(_this.userId,-1,"")})};return IndexedDbMutationQueue}(),GeneratorIds;(function(GeneratorIds){GeneratorIds[GeneratorIds.QueryCache=0]="QueryCache";GeneratorIds[GeneratorIds.SyncEngine=1]="SyncEngine"})(GeneratorIds||(GeneratorIds={}));var TargetIdGenerator=function(){function TargetIdGenerator(generatorId,seed){this.generatorId=generatorId;assert((generatorId&1)===generatorId,"Generator ID "+generatorId+" contains more than 1 reserved bits");this.seek(void 0!==seed?seed:this.generatorId)}
TargetIdGenerator.prototype.next=function(){var nextId=this.nextId;this.nextId+=2;return nextId};TargetIdGenerator.prototype.after=function(targetId){this.seek(targetId+2);return this.next()};TargetIdGenerator.prototype.seek=function(targetId){assert((targetId&1)===this.generatorId,"Cannot supply target ID from different generator ID");this.nextId=targetId};TargetIdGenerator.forQueryCache=function(){return new TargetIdGenerator(GeneratorIds.QueryCache,2)};TargetIdGenerator.forSyncEngine=function(){return new TargetIdGenerator(GeneratorIds.SyncEngine)};
return TargetIdGenerator}(),SimpleDb=function(){function SimpleDb(db){this.db=db}SimpleDb.openOrCreate=function(name,version,schemaConverter){assert(SimpleDb.isAvailable(),"IndexedDB not supported in current environment.");debug("SimpleDb","Opening database:",name);return(new PersistencePromise(function(resolve,reject){var request=window.indexedDB.open(name,version);request.onsuccess=function(event){resolve(new SimpleDb(event.target.result))};request.onblocked=function(){reject(new FirestoreError(Code.FAILED_PRECONDITION,
"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))};request.onerror=function(event){event=event.target.error;"VersionError"===event.name?reject(new FirestoreError(Code.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):
reject(event)};request.onupgradeneeded=function(event){debug("SimpleDb",'Database "'+name+'" requires upgrade from version:',event.oldVersion);var db=event.target.result,txn=new SimpleDbTransaction(request.transaction);schemaConverter.createOrUpgrade(db,txn,event.oldVersion,SCHEMA_VERSION).next(function(){debug("SimpleDb","Database upgrade to version "+SCHEMA_VERSION+" complete")})}})).toPromise()};SimpleDb.delete=function(name){debug("SimpleDb","Removing database:",name);return wrapRequest(window.indexedDB.deleteDatabase(name)).toPromise()};
SimpleDb.isAvailable=function(){if("undefined"===typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var ua=window.navigator.userAgent;return 0<ua.indexOf("MSIE ")||0<ua.indexOf("Trident/")||0<ua.indexOf("Edge/")?!1:!0};SimpleDb.getStore=function(txn,store){return txn.store(store)};SimpleDb.prototype.runTransaction=function(mode,objectStores,transactionFn){var transaction=SimpleDbTransaction.open(this.db,mode,objectStores),transactionFnResult=
transactionFn(transaction).catch(function(error){transaction.abort(error);return PersistencePromise.reject(error)}).toPromise();transactionFnResult.catch(function(){});return transaction.completionPromise.then(function(){return transactionFnResult})};SimpleDb.prototype.close=function(){this.db.close()};return SimpleDb}(),IterationController=function(){function IterationController(dbCursor){this.dbCursor=dbCursor;this.shouldStop=!1;this.nextKey=null}Object.defineProperty(IterationController.prototype,
"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0});Object.defineProperty(IterationController.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0});Object.defineProperty(IterationController.prototype,"cursor",{set:function(value){this.dbCursor=value},enumerable:!0,configurable:!0});IterationController.prototype.done=function(){this.shouldStop=!0};IterationController.prototype.skip=function(key){this.nextKey=key};IterationController.prototype.delete=
function(){return wrapRequest(this.dbCursor.delete())};return IterationController}(),SimpleDbTransaction=function(){function SimpleDbTransaction(transaction){var _this=this;this.transaction=transaction;this.aborted=!1;this.completionDeferred=new Deferred;this.transaction.oncomplete=function(){_this.completionDeferred.resolve()};this.transaction.onabort=function(){transaction.error?_this.completionDeferred.reject(transaction.error):_this.completionDeferred.resolve()};this.transaction.onerror=function(event){_this.completionDeferred.reject(event.target.error)}}
SimpleDbTransaction.open=function(db,mode,objectStoreNames){return new SimpleDbTransaction(db.transaction(objectStoreNames,mode))};Object.defineProperty(SimpleDbTransaction.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0});SimpleDbTransaction.prototype.abort=function(error){error&&this.completionDeferred.reject(error);this.aborted||(debug("SimpleDb","Aborting transaction:",error?error.message:"Client-initiated abort"),this.aborted=
!0,this.transaction.abort())};SimpleDbTransaction.prototype.store=function(storeName){var store=this.transaction.objectStore(storeName);assert(!!store,"Object store not part of transaction: "+storeName);return new SimpleDbStore(store)};return SimpleDbTransaction}(),SimpleDbStore=function(){function SimpleDbStore(store){this.store=store}SimpleDbStore.prototype.put=function(keyOrValue,value){void 0!==value?(debug("SimpleDb","PUT",this.store.name,keyOrValue,value),keyOrValue=this.store.put(value,keyOrValue)):
(debug("SimpleDb","PUT",this.store.name,"\x3cauto-key\x3e",keyOrValue),keyOrValue=this.store.put(keyOrValue));return wrapRequest(keyOrValue)};SimpleDbStore.prototype.add=function(value){debug("SimpleDb","ADD",this.store.name,value,value);value=this.store.add(value);return wrapRequest(value)};SimpleDbStore.prototype.get=function(key){var _this=this,request=this.store.get(key);return wrapRequest(request).next(function(result){void 0===result&&(result=null);debug("SimpleDb","GET",_this.store.name,key,
result);return result})};SimpleDbStore.prototype.delete=function(key){debug("SimpleDb","DELETE",this.store.name,key);key=this.store.delete(key);return wrapRequest(key)};SimpleDbStore.prototype.count=function(){debug("SimpleDb","COUNT",this.store.name);var request=this.store.count();return wrapRequest(request)};SimpleDbStore.prototype.loadAll=function(indexOrRange,range){indexOrRange=this.cursor(this.options(indexOrRange,range));var results=[];return this.iterateCursor(indexOrRange,function(key,value){results.push(value)}).next(function(){return results})};
SimpleDbStore.prototype.deleteAll=function(indexOrRange,range){debug("SimpleDb","DELETE ALL",this.store.name);indexOrRange=this.options(indexOrRange,range);indexOrRange.keysOnly=!1;indexOrRange=this.cursor(indexOrRange);return this.iterateCursor(indexOrRange,function(key,value,control){return control.delete()})};SimpleDbStore.prototype.iterate=function(optionsOrCallback,callback){if(callback)var options=optionsOrCallback;else options={},callback=optionsOrCallback;optionsOrCallback=this.cursor(options);
return this.iterateCursor(optionsOrCallback,callback)};SimpleDbStore.prototype.iterateSerial=function(callback){var cursorRequest=this.cursor({});return new PersistencePromise(function(resolve,reject){cursorRequest.onerror=function(event){reject(event.target.error)};cursorRequest.onsuccess=function(event){var cursor=event.target.result;cursor?callback(cursor.primaryKey,cursor.value).next(function(shouldContinue){shouldContinue?cursor.continue():resolve()}):resolve()}})};SimpleDbStore.prototype.iterateCursor=
function(cursorRequest,fn){var results=[];return(new PersistencePromise(function(resolve,reject){cursorRequest.onerror=function(event){reject(event.target.error)};cursorRequest.onsuccess=function(event){if(event=event.target.result){var controller=new IterationController(event),userResult=fn(event.primaryKey,event.value,controller);userResult instanceof PersistencePromise&&(userResult=userResult.catch(function(err){controller.done();return PersistencePromise.reject(err)}),results.push(userResult));
controller.isDone?resolve():null===controller.skipToKey?event.continue():event.continue(controller.skipToKey)}else resolve()}})).next(function(){return PersistencePromise.waitFor(results)})};SimpleDbStore.prototype.options=function(indexOrRange,range){var indexName=void 0;void 0!==indexOrRange&&("string"===typeof indexOrRange?indexName=indexOrRange:(assert(void 0===range,"3rd argument must not be defined if 2nd is a range."),range=indexOrRange));return{index:indexName,range:range}};SimpleDbStore.prototype.cursor=
function(options){var direction="next";options.reverse&&(direction="prev");if(options.index){var index=this.store.index(options.index);return options.keysOnly?index.openKeyCursor(options.range,direction):index.openCursor(options.range,direction)}return this.store.openCursor(options.range,direction)};return SimpleDbStore}(),IndexedDbQueryCache=function(){function IndexedDbQueryCache(referenceDelegate,serializer){this.referenceDelegate=referenceDelegate;this.serializer=serializer;this.targetIdGenerator=
TargetIdGenerator.forQueryCache()}IndexedDbQueryCache.prototype.allocateTargetId=function(transaction){var _this=this;return this.retrieveMetadata(transaction).next(function(metadata){metadata.highestTargetId=_this.targetIdGenerator.after(metadata.highestTargetId);return _this.saveMetadata(transaction,metadata).next(function(){return metadata.highestTargetId})})};IndexedDbQueryCache.prototype.getLastRemoteSnapshotVersion=function(transaction){return this.retrieveMetadata(transaction).next(function(metadata){return SnapshotVersion.fromTimestamp(new Timestamp(metadata.lastRemoteSnapshotVersion.seconds,
metadata.lastRemoteSnapshotVersion.nanoseconds))})};IndexedDbQueryCache.prototype.getHighestSequenceNumber=function(transaction){return getHighestListenSequenceNumber(transaction.simpleDbTransaction)};IndexedDbQueryCache.prototype.setTargetsMetadata=function(transaction,highestListenSequenceNumber,lastRemoteSnapshotVersion){var _this=this;return this.retrieveMetadata(transaction).next(function(metadata){metadata.highestListenSequenceNumber=highestListenSequenceNumber;lastRemoteSnapshotVersion&&(metadata.lastRemoteSnapshotVersion=
lastRemoteSnapshotVersion.toTimestamp());highestListenSequenceNumber>metadata.highestListenSequenceNumber&&(metadata.highestListenSequenceNumber=highestListenSequenceNumber);return _this.saveMetadata(transaction,metadata)})};IndexedDbQueryCache.prototype.addQueryData=function(transaction,queryData){var _this=this;return this.saveQueryData(transaction,queryData).next(function(){return _this.retrieveMetadata(transaction).next(function(metadata){metadata.targetCount+=1;_this.updateMetadataFromQueryData(queryData,
metadata);return _this.saveMetadata(transaction,metadata)})})};IndexedDbQueryCache.prototype.updateQueryData=function(transaction,queryData){return this.saveQueryData(transaction,queryData)};IndexedDbQueryCache.prototype.removeQueryData=function(transaction,queryData){var _this=this;return this.removeMatchingKeysForTargetId(transaction,queryData.targetId).next(function(){return targetsStore(transaction).delete(queryData.targetId)}).next(function(){return _this.retrieveMetadata(transaction)}).next(function(metadata){assert(0<
metadata.targetCount,"Removing from an empty query cache");--metadata.targetCount;return _this.saveMetadata(transaction,metadata)})};IndexedDbQueryCache.prototype.removeTargets=function(txn,upperBound,activeTargetIds){var _this=this,count=0,promises=[];return targetsStore(txn).iterate(function(key,value){key=_this.serializer.fromDbTarget(value);key.sequenceNumber<=upperBound&&void 0===activeTargetIds[key.targetId]&&(count++,promises.push(_this.removeQueryData(txn,key)))}).next(function(){return PersistencePromise.waitFor(promises)}).next(function(){return count})};
IndexedDbQueryCache.prototype.forEachTarget=function(txn,f){var _this=this;return targetsStore(txn).iterate(function(key,value){key=_this.serializer.fromDbTarget(value);f(key)})};IndexedDbQueryCache.prototype.retrieveMetadata=function(transaction){return retrieveMetadata(transaction.simpleDbTransaction)};IndexedDbQueryCache.prototype.saveMetadata=function(transaction,metadata){return IndexedDbPersistence.getStore(transaction,DbTargetGlobal.store).put(DbTargetGlobal.key,metadata)};IndexedDbQueryCache.prototype.saveQueryData=
function(transaction,queryData){return targetsStore(transaction).put(this.serializer.toDbTarget(queryData))};IndexedDbQueryCache.prototype.updateMetadataFromQueryData=function(queryData,metadata){var updated=!1;queryData.targetId>metadata.highestTargetId&&(metadata.highestTargetId=queryData.targetId,updated=!0);queryData.sequenceNumber>metadata.highestListenSequenceNumber&&(metadata.highestListenSequenceNumber=queryData.sequenceNumber,updated=!0);return updated};IndexedDbQueryCache.prototype.getQueryCount=
function(transaction){return this.retrieveMetadata(transaction).next(function(metadata){return metadata.targetCount})};IndexedDbQueryCache.prototype.getQueryData=function(transaction,query){var _this=this,canonicalId=query.canonicalId();canonicalId=IDBKeyRange.bound([canonicalId,Number.NEGATIVE_INFINITY],[canonicalId,Number.POSITIVE_INFINITY]);var result=null;return targetsStore(transaction).iterate({range:canonicalId,index:DbTarget.queryTargetsIndexName},function(key,value,control){key=_this.serializer.fromDbTarget(value);
query.isEqual(key.query)&&(result=key,control.done())}).next(function(){return result})};IndexedDbQueryCache.prototype.addMatchingKeys=function(txn,keys,targetId){var _this=this,promises=[],store=documentTargetStore(txn);keys.forEach(function(key){var path=encode(key.path);promises.push(store.put(new DbTargetDocument(targetId,path)));promises.push(_this.referenceDelegate.addReference(txn,key))});return PersistencePromise.waitFor(promises)};IndexedDbQueryCache.prototype.removeMatchingKeys=function(txn,
keys,targetId){var _this=this,store=documentTargetStore(txn);return PersistencePromise.forEach(keys,function(key){var path=encode(key.path);return PersistencePromise.waitFor([store.delete([targetId,path]),_this.referenceDelegate.removeReference(txn,key)])})};IndexedDbQueryCache.prototype.removeMatchingKeysForTargetId=function(txn,targetId){txn=documentTargetStore(txn);targetId=IDBKeyRange.bound([targetId],[targetId+1],!1,!0);return txn.delete(targetId)};IndexedDbQueryCache.prototype.getMatchingKeysForTargetId=
function(txn,targetId){targetId=IDBKeyRange.bound([targetId],[targetId+1],!1,!0);txn=documentTargetStore(txn);var result=documentKeySet();return txn.iterate({range:targetId,keysOnly:!0},function(key,_,control){key=decode(key[1]);key=new DocumentKey(key);result=result.add(key)}).next(function(){return result})};IndexedDbQueryCache.prototype.containsKey=function(txn,key){key=encode(key.path);key=IDBKeyRange.bound([key],[key+"\x00"],!1,!0);var count=0;return documentTargetStore(txn).iterate({index:DbTargetDocument.documentTargetsIndex,
keysOnly:!0,range:key},function(_a,_,control){0!==_a[0]&&(count++,control.done())}).next(function(){return 0<count})};IndexedDbQueryCache.prototype.getQueryDataForTarget=function(transaction,targetId){var _this=this;return targetsStore(transaction).get(targetId).next(function(found){return found?_this.serializer.fromDbTarget(found):null})};return IndexedDbQueryCache}(),ObjectMap=function(){function ObjectMap(mapKeyFn){this.mapKeyFn=mapKeyFn;this.inner={}}ObjectMap.prototype.get=function(key){var id=
this.mapKeyFn(key);id=this.inner[id];if(void 0!==id)for(var _i=0;_i<id.length;_i++){var _a=id[_i],value=_a[1];if(_a[0].isEqual(key))return value}};ObjectMap.prototype.has=function(key){return void 0!==this.get(key)};ObjectMap.prototype.set=function(key,value){var id=this.mapKeyFn(key),matches=this.inner[id];if(void 0===matches)this.inner[id]=[[key,value]];else{for(id=0;id<matches.length;id++)if(matches[id][0].isEqual(key)){matches[id]=[key,value];return}matches.push([key,value])}};ObjectMap.prototype.delete=
function(key){var id=this.mapKeyFn(key),matches=this.inner[id];if(void 0===matches)return!1;for(var i=0;i<matches.length;i++)if(matches[i][0].isEqual(key))return 1===matches.length?delete this.inner[id]:matches.splice(i,1),!0;return!1};ObjectMap.prototype.forEach=function(fn){forEach(this.inner,function(_,entries){for(_=0;_<entries.length;_++){var _a=entries[_];fn(_a[0],_a[1])}})};ObjectMap.prototype.isEmpty=function(){return isEmpty(this.inner)};return ObjectMap}(),RemoteDocumentChangeBuffer=function(){function RemoteDocumentChangeBuffer(){this.changes=
EMPTY_MAYBE_DOCUMENT_MAP;this.documentSizes=new ObjectMap(function(key){return key.toString()})}RemoteDocumentChangeBuffer.prototype.addEntry=function(maybeDocument){this.changes=this.assertChanges().insert(maybeDocument.key,maybeDocument)};RemoteDocumentChangeBuffer.prototype.getEntry=function(transaction,documentKey){var _this=this,bufferedEntry=this.assertChanges().get(documentKey);return bufferedEntry?PersistencePromise.resolve(bufferedEntry):this.getFromCache(transaction,documentKey).next(function(getResult){if(null===
getResult)return _this.documentSizes.set(documentKey,0),null;_this.documentSizes.set(documentKey,getResult.size);return getResult.maybeDocument})};RemoteDocumentChangeBuffer.prototype.getEntries=function(transaction,documentKeys){var _this=this;return this.getAllFromCache(transaction,documentKeys).next(function(_a){var maybeDocuments=_a.maybeDocuments;_a.sizeMap.forEach(function(documentKey,size){_this.documentSizes.set(documentKey,size)});return maybeDocuments})};RemoteDocumentChangeBuffer.prototype.apply=
function(transaction){transaction=this.applyChanges(transaction);this.changes=null;return transaction};RemoteDocumentChangeBuffer.prototype.assertChanges=function(){assert(null!==this.changes,"Changes have already been applied.");return this.changes};return RemoteDocumentChangeBuffer}(),IndexedDbRemoteDocumentCache=function(){function IndexedDbRemoteDocumentCache(serializer,indexManager,keepDocumentChangeLog){this.serializer=serializer;this.indexManager=indexManager;this.keepDocumentChangeLog=keepDocumentChangeLog;
this._lastProcessedDocumentChangeId=0}Object.defineProperty(IndexedDbRemoteDocumentCache.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0});IndexedDbRemoteDocumentCache.prototype.start=function(transaction){transaction=SimpleDb.getStore(transaction,DbRemoteDocumentChanges.store);return this.synchronizeLastDocumentChangeId(transaction)};IndexedDbRemoteDocumentCache.prototype.addEntries=function(transaction,entries,sizeDelta){var promises=
[];if(0<entries.length){for(var documentStore=remoteDocumentsStore(transaction),changedKeys=documentKeySet(),_i=0;_i<entries.length;_i++){var _a=entries[_i],key=_a.key;_a=_a.doc;promises.push(documentStore.put(key.path.toArray(),_a));changedKeys=changedKeys.add(key);promises.push(this.indexManager.addToCollectionParentIndex(transaction,key.path.popLast()))}this.keepDocumentChangeLog&&promises.push(IndexedDbPersistence.getStore(transaction,DbRemoteDocumentChanges.store).put({changes:this.serializer.toDbResourcePaths(changedKeys)}));
promises.push(this.updateSize(transaction,sizeDelta))}return PersistencePromise.waitFor(promises)};IndexedDbRemoteDocumentCache.prototype.removeEntry=function(transaction,documentKey){var store=remoteDocumentsStore(transaction),key=documentKey.path.toArray();return store.get(key).next(function(document){return document?store.delete(key).next(function(){return dbDocumentSize(document)}):PersistencePromise.resolve(0)})};IndexedDbRemoteDocumentCache.prototype.getEntry=function(transaction,documentKey){var _this=
this;return remoteDocumentsStore(transaction).get(documentKey.path.toArray()).next(function(dbRemoteDoc){return dbRemoteDoc?_this.serializer.fromDbRemoteDocument(dbRemoteDoc):null})};IndexedDbRemoteDocumentCache.prototype.getSizedEntry=function(transaction,documentKey){var _this=this;return remoteDocumentsStore(transaction).get(documentKey.path.toArray()).next(function(dbRemoteDoc){return dbRemoteDoc?{maybeDocument:_this.serializer.fromDbRemoteDocument(dbRemoteDoc),size:dbDocumentSize(dbRemoteDoc)}:
null})};IndexedDbRemoteDocumentCache.prototype.getEntries=function(transaction,documentKeys){var _this=this,results=EMPTY_MAYBE_DOCUMENT_MAP;return this.forEachDbEntry(transaction,documentKeys,function(key,dbRemoteDoc){results=dbRemoteDoc?results.insert(key,_this.serializer.fromDbRemoteDocument(dbRemoteDoc)):results.insert(key,null)}).next(function(){return results})};IndexedDbRemoteDocumentCache.prototype.getSizedEntries=function(transaction,documentKeys){var _this=this,results=EMPTY_MAYBE_DOCUMENT_MAP,
sizeMap=new SortedMap$jscomp$0(DocumentKey.comparator);return this.forEachDbEntry(transaction,documentKeys,function(key,dbRemoteDoc){dbRemoteDoc?(results=results.insert(key,_this.serializer.fromDbRemoteDocument(dbRemoteDoc)),sizeMap=sizeMap.insert(key,dbDocumentSize(dbRemoteDoc))):(results=results.insert(key,null),sizeMap=sizeMap.insert(key,0))}).next(function(){return{maybeDocuments:results,sizeMap:sizeMap}})};IndexedDbRemoteDocumentCache.prototype.forEachDbEntry=function(transaction,documentKeys,
callback){if(documentKeys.isEmpty())return PersistencePromise.resolve();var range=IDBKeyRange.bound(documentKeys.first().path.toArray(),documentKeys.last().path.toArray()),keyIter=documentKeys.getIterator(),nextKey=keyIter.getNext();return remoteDocumentsStore(transaction).iterate({range:range},function(potentialKeyRaw,dbRemoteDoc,control){for(potentialKeyRaw=DocumentKey.fromSegments(potentialKeyRaw);nextKey&&0>DocumentKey.comparator(nextKey,potentialKeyRaw);)callback(nextKey,null),nextKey=keyIter.getNext();
nextKey&&nextKey.isEqual(potentialKeyRaw)&&(callback(nextKey,dbRemoteDoc),nextKey=keyIter.hasNext()?keyIter.getNext():null);nextKey?control.skip(nextKey.path.toArray()):control.done()}).next(function(){for(;nextKey;)callback(nextKey,null),nextKey=keyIter.hasNext()?keyIter.getNext():null})};IndexedDbRemoteDocumentCache.prototype.getDocumentsMatchingQuery=function(transaction,query){var _this=this;assert(!query.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");
var results=EMPTY_DOCUMENT_MAP,immediateChildrenPathLength=query.path.length+1,startKey=query.path.toArray();startKey=IDBKeyRange.lowerBound(startKey);return remoteDocumentsStore(transaction).iterate({range:startKey},function(key,dbRemoteDoc,control){key.length===immediateChildrenPathLength&&(key=_this.serializer.fromDbRemoteDocument(dbRemoteDoc),query.path.isPrefixOf(key.key.path)?key instanceof Document$jscomp$0&&query.matches(key)&&(results=results.insert(key.key,key)):control.done())}).next(function(){return results})};
IndexedDbRemoteDocumentCache.prototype.getNewDocumentChanges=function(transaction){var _this=this;assert(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var changedKeys=documentKeySet(),changedDocs=EMPTY_MAYBE_DOCUMENT_MAP,range=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),firstIteration=!0,changesStore=IndexedDbPersistence.getStore(transaction,DbRemoteDocumentChanges.store);return changesStore.iterate({range:range},function(_,
documentChange){if(firstIteration&&(firstIteration=!1,_this._lastProcessedDocumentChangeId+1!==documentChange.id))return _this.synchronizeLastDocumentChangeId(changesStore).next(function(){return PersistencePromise.reject(new FirestoreError(Code.DATA_LOSS,"The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views."))});changedKeys=changedKeys.unionWith(_this.serializer.fromDbResourcePaths(documentChange.changes));_this._lastProcessedDocumentChangeId=
documentChange.id}).next(function(){var documentPromises=[];changedKeys.forEach(function(key){documentPromises.push(_this.getEntry(transaction,key).next(function(maybeDocument){maybeDocument=maybeDocument||new NoDocument(key,SnapshotVersion.forDeletedDoc());changedDocs=changedDocs.insert(key,maybeDocument)}))});return PersistencePromise.waitFor(documentPromises)}).next(function(){return changedDocs})};IndexedDbRemoteDocumentCache.prototype.removeDocumentChangesThroughChangeId=function(transaction,
changeId){changeId=IDBKeyRange.upperBound(changeId);return IndexedDbPersistence.getStore(transaction,DbRemoteDocumentChanges.store).delete(changeId)};IndexedDbRemoteDocumentCache.prototype.synchronizeLastDocumentChangeId=function(documentChangesStore){var _this=this;this._lastProcessedDocumentChangeId=0;return documentChangesStore.iterate({keysOnly:!0,reverse:!0},function(key,value,control){_this._lastProcessedDocumentChangeId=key;control.done()})};IndexedDbRemoteDocumentCache.prototype.newChangeBuffer=
function(){return new IndexedDbRemoteDocumentChangeBuffer(this)};IndexedDbRemoteDocumentCache.prototype.getSize=function(txn){return this.getMetadata(txn).next(function(metadata){return metadata.byteSize})};IndexedDbRemoteDocumentCache.prototype.getMetadata=function(txn){return IndexedDbPersistence.getStore(txn,DbRemoteDocumentGlobal.store).get(DbRemoteDocumentGlobal.key).next(function(metadata){assert(!!metadata,"Missing document cache metadata");return metadata})};IndexedDbRemoteDocumentCache.prototype.setMetadata=
function(txn,metadata){return IndexedDbPersistence.getStore(txn,DbRemoteDocumentGlobal.store).put(DbRemoteDocumentGlobal.key,metadata)};IndexedDbRemoteDocumentCache.prototype.updateSize=function(txn,sizeDelta){var _this=this;return this.getMetadata(txn).next(function(metadata){metadata.byteSize+=sizeDelta;return _this.setMetadata(txn,metadata)})};return IndexedDbRemoteDocumentCache}(),IndexedDbRemoteDocumentChangeBuffer=function(_super){function IndexedDbRemoteDocumentChangeBuffer(documentCache){var _this=
_super.call(this)||this;_this.documentCache=documentCache;return _this}tslib_1.__extends(IndexedDbRemoteDocumentChangeBuffer,_super);IndexedDbRemoteDocumentChangeBuffer.prototype.applyChanges=function(transaction){var _this=this,delta=0,toApply=[];this.assertChanges().forEach(function(key,maybeDocument){maybeDocument=_this.documentCache.serializer.toDbRemoteDocument(maybeDocument);var previousSize=_this.documentSizes.get(key);assert(void 0!==previousSize,"Attempting to change document "+key.toString()+
" without having read it first");var size=dbDocumentSize(maybeDocument);delta+=size-previousSize;toApply.push({key:key,doc:maybeDocument})});return this.documentCache.addEntries(transaction,toApply,delta)};IndexedDbRemoteDocumentChangeBuffer.prototype.getFromCache=function(transaction,documentKey){return this.documentCache.getSizedEntry(transaction,documentKey)};IndexedDbRemoteDocumentChangeBuffer.prototype.getAllFromCache=function(transaction,documentKeys){return this.documentCache.getSizedEntries(transaction,
documentKeys)};return IndexedDbRemoteDocumentChangeBuffer}(RemoteDocumentChangeBuffer),MemoryIndexManager=function(){function MemoryIndexManager(){this.collectionParentIndex=new MemoryCollectionParentIndex}MemoryIndexManager.prototype.addToCollectionParentIndex=function(transaction,collectionPath){this.collectionParentIndex.add(collectionPath);return PersistencePromise.resolve()};MemoryIndexManager.prototype.getCollectionParents=function(transaction,collectionId){return PersistencePromise.resolve(this.collectionParentIndex.getEntries(collectionId))};
return MemoryIndexManager}(),MemoryCollectionParentIndex=function(){function MemoryCollectionParentIndex(){this.index={}}MemoryCollectionParentIndex.prototype.add=function(collectionPath){assert(1===collectionPath.length%2,"Expected a collection path.");var collectionId=collectionPath.lastSegment();collectionPath=collectionPath.popLast();var existingParents=this.index[collectionId]||new SortedSet(ResourcePath.comparator),added=!existingParents.has(collectionPath);this.index[collectionId]=existingParents.add(collectionPath);
return added};MemoryCollectionParentIndex.prototype.getEntries=function(collectionId){return(this.index[collectionId]||new SortedSet(ResourcePath.comparator)).toArray()};return MemoryCollectionParentIndex}(),SCHEMA_VERSION=8,SchemaConverter=function(){function SchemaConverter(serializer){this.serializer=serializer}SchemaConverter.prototype.createOrUpgrade=function(db,txn,fromVersion,toVersion){var _this=this;assert(fromVersion<toVersion&&0<=fromVersion&&toVersion<=SCHEMA_VERSION,"Unexpected schema upgrade from v"+
fromVersion+" to v{toVersion}.");1>fromVersion&&1<=toVersion&&(db.createObjectStore(DbPrimaryClient.store),createMutationQueue(db),createQueryCache(db),db.createObjectStore(DbRemoteDocument.store));var p=PersistencePromise.resolve();3>fromVersion&&3<=toVersion&&(0!==fromVersion&&(dropQueryCache(db),createQueryCache(db)),p=p.next(function(){var globalStore=txn.store(DbTargetGlobal.store),metadata=new DbTargetGlobal(0,0,SnapshotVersion.MIN.toTimestamp(),0);return globalStore.put(DbTargetGlobal.key,
metadata)}));4>fromVersion&&4<=toVersion&&(0!==fromVersion&&(p=p.next(function(){return upgradeMutationBatchSchemaAndMigrateData(db,txn)})),p=p.next(function(){db.createObjectStore(DbClientMetadata.store,{keyPath:DbClientMetadata.keyPath});db.createObjectStore(DbRemoteDocumentChanges.store,{keyPath:"id",autoIncrement:!0})}));5>fromVersion&&5<=toVersion&&(p=p.next(function(){return _this.removeAcknowledgedMutations(txn)}));6>fromVersion&&6<=toVersion&&(p=p.next(function(){db.createObjectStore(DbRemoteDocumentGlobal.store);
return _this.addDocumentGlobal(txn)}));7>fromVersion&&7<=toVersion&&(p=p.next(function(){return _this.ensureSequenceNumbers(txn)}));8>fromVersion&&8<=toVersion&&(p=p.next(function(){return _this.createCollectionParentIndex(db,txn)}));return p};SchemaConverter.prototype.addDocumentGlobal=function(txn){var byteCount=0;return txn.store(DbRemoteDocument.store).iterate(function(_,doc){byteCount+=dbDocumentSize(doc)}).next(function(){var metadata=new DbRemoteDocumentGlobal(byteCount);return txn.store(DbRemoteDocumentGlobal.store).put(DbRemoteDocumentGlobal.key,
metadata)})};SchemaConverter.prototype.removeAcknowledgedMutations=function(txn){var _this=this,queuesStore=txn.store(DbMutationQueue.store),mutationsStore=txn.store(DbMutationBatch.store);return queuesStore.loadAll().next(function(queues){return PersistencePromise.forEach(queues,function(queue){var range=IDBKeyRange.bound([queue.userId,-1],[queue.userId,queue.lastAcknowledgedBatchId]);return mutationsStore.loadAll(DbMutationBatch.userMutationsIndex,range).next(function(dbBatches){return PersistencePromise.forEach(dbBatches,
function(dbBatch){assert(dbBatch.userId===queue.userId,"Cannot process batch "+dbBatch.batchId+" from unexpected user");dbBatch=_this.serializer.fromDbMutationBatch(dbBatch);return removeMutationBatch(txn,queue.userId,dbBatch).next(function(){})})})})})};SchemaConverter.prototype.ensureSequenceNumbers=function(txn){var documentTargetStore=txn.store(DbTargetDocument.store),documentsStore=txn.store(DbRemoteDocument.store);return getHighestListenSequenceNumber(txn).next(function(currentSequenceNumber){var promises=
[];return documentsStore.iterate(function(key,doc){var path=new ResourcePath(key);key=[0,encode(path)];promises.push(documentTargetStore.get(key).next(function(maybeSentinel){return maybeSentinel?PersistencePromise.resolve():documentTargetStore.put(new DbTargetDocument(0,encode(path),currentSequenceNumber))}))}).next(function(){return PersistencePromise.waitFor(promises)})})};SchemaConverter.prototype.createCollectionParentIndex=function(db,txn){db.createObjectStore(DbCollectionParent.store,{keyPath:DbCollectionParent.keyPath});
var collectionParentsStore=txn.store(DbCollectionParent.store),cache=new MemoryCollectionParentIndex,addEntry=function(collectionPath){if(cache.add(collectionPath)){var collectionId=collectionPath.lastSegment();collectionPath=collectionPath.popLast();return collectionParentsStore.put({collectionId:collectionId,parent:encode(collectionPath)})}};return txn.store(DbRemoteDocument.store).iterate({keysOnly:!0},function(pathSegments,_){pathSegments=new ResourcePath(pathSegments);return addEntry(pathSegments.popLast())}).next(function(){return txn.store(DbDocumentMutation.store).iterate({keysOnly:!0},
function(_a,_){_a=decode(_a[1]);return addEntry(_a.popLast())})})};return SchemaConverter}(),DbTimestamp=function(){return function(seconds,nanoseconds){this.seconds=seconds;this.nanoseconds=nanoseconds}}(),DbPrimaryClient=function(){function DbPrimaryClient(ownerId,allowTabSynchronization,leaseTimestampMs){this.ownerId=ownerId;this.allowTabSynchronization=allowTabSynchronization;this.leaseTimestampMs=leaseTimestampMs}DbPrimaryClient.store="owner";DbPrimaryClient.key="owner";return DbPrimaryClient}(),
DbMutationQueue=function(){function DbMutationQueue(userId,lastAcknowledgedBatchId,lastStreamToken){this.userId=userId;this.lastAcknowledgedBatchId=lastAcknowledgedBatchId;this.lastStreamToken=lastStreamToken}DbMutationQueue.store="mutationQueues";DbMutationQueue.keyPath="userId";return DbMutationQueue}(),DbMutationBatch=function(){function DbMutationBatch(userId,batchId,localWriteTimeMs,baseMutations,mutations){this.userId=userId;this.batchId=batchId;this.localWriteTimeMs=localWriteTimeMs;this.baseMutations=
baseMutations;this.mutations=mutations}DbMutationBatch.store="mutations";DbMutationBatch.keyPath="batchId";DbMutationBatch.userMutationsIndex="userMutationsIndex";DbMutationBatch.userMutationsKeyPath=["userId","batchId"];return DbMutationBatch}(),DbDocumentMutation=function(){function DbDocumentMutation(){}DbDocumentMutation.prefixForUser=function(userId){return[userId]};DbDocumentMutation.prefixForPath=function(userId,path){return[userId,encode(path)]};DbDocumentMutation.key=function(userId,path,
batchId){return[userId,encode(path),batchId]};DbDocumentMutation.store="documentMutations";DbDocumentMutation.PLACEHOLDER=new DbDocumentMutation;return DbDocumentMutation}(),DbNoDocument=function(){return function(path,readTime){this.path=path;this.readTime=readTime}}(),DbUnknownDocument=function(){return function(path,version){this.path=path;this.version=version}}(),DbRemoteDocument=function(){function DbRemoteDocument(unknownDocument,noDocument,document,hasCommittedMutations){this.unknownDocument=
unknownDocument;this.noDocument=noDocument;this.document=document;this.hasCommittedMutations=hasCommittedMutations}DbRemoteDocument.store="remoteDocuments";return DbRemoteDocument}(),DbRemoteDocumentGlobal=function(){function DbRemoteDocumentGlobal(byteSize){this.byteSize=byteSize}DbRemoteDocumentGlobal.store="remoteDocumentGlobal";DbRemoteDocumentGlobal.key="remoteDocumentGlobalKey";return DbRemoteDocumentGlobal}(),DbTarget=function(){function DbTarget(targetId,canonicalId,readTime,resumeToken,lastListenSequenceNumber,
query){this.targetId=targetId;this.canonicalId=canonicalId;this.readTime=readTime;this.resumeToken=resumeToken;this.lastListenSequenceNumber=lastListenSequenceNumber;this.query=query}DbTarget.store="targets";DbTarget.keyPath="targetId";DbTarget.queryTargetsIndexName="queryTargetsIndex";DbTarget.queryTargetsKeyPath=["canonicalId","targetId"];return DbTarget}(),DbTargetDocument=function(){function DbTargetDocument(targetId,path,sequenceNumber){this.targetId=targetId;this.path=path;this.sequenceNumber=
sequenceNumber;assert(0===targetId===(void 0!==sequenceNumber),"A target-document row must either have targetId \x3d\x3d 0 and a defined sequence number, or a non-zero targetId and no sequence number")}DbTargetDocument.store="targetDocuments";DbTargetDocument.keyPath=["targetId","path"];DbTargetDocument.documentTargetsIndex="documentTargetsIndex";DbTargetDocument.documentTargetsKeyPath=["path","targetId"];return DbTargetDocument}(),DbTargetGlobal=function(){function DbTargetGlobal(highestTargetId,
highestListenSequenceNumber,lastRemoteSnapshotVersion,targetCount){this.highestTargetId=highestTargetId;this.highestListenSequenceNumber=highestListenSequenceNumber;this.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion;this.targetCount=targetCount}DbTargetGlobal.key="targetGlobalKey";DbTargetGlobal.store="targetGlobal";return DbTargetGlobal}(),DbCollectionParent=function(){function DbCollectionParent(collectionId,parent){this.collectionId=collectionId;this.parent=parent}DbCollectionParent.store=
"collectionParents";DbCollectionParent.keyPath=["collectionId","parent"];return DbCollectionParent}(),DbRemoteDocumentChanges=function(){function DbRemoteDocumentChanges(changes){this.changes=changes}DbRemoteDocumentChanges.store="remoteDocumentChanges";DbRemoteDocumentChanges.keyPath="id";return DbRemoteDocumentChanges}(),DbClientMetadata=function(){function DbClientMetadata(clientId,updateTimeMs,networkEnabled,inForeground,lastProcessedDocumentChangeId){this.clientId=clientId;this.updateTimeMs=
updateTimeMs;this.networkEnabled=networkEnabled;this.inForeground=inForeground;this.lastProcessedDocumentChangeId=lastProcessedDocumentChangeId}DbClientMetadata.store="clientMetadata";DbClientMetadata.keyPath="clientId";return DbClientMetadata}(),ALL_STORES=[DbMutationQueue.store,DbMutationBatch.store,DbDocumentMutation.store,DbRemoteDocument.store,DbTarget.store,DbPrimaryClient.store,DbTargetGlobal.store,DbTargetDocument.store].concat([DbClientMetadata.store,DbRemoteDocumentChanges.store]).concat([DbRemoteDocumentGlobal.store]).concat([DbCollectionParent.store]),
IndexedDbIndexManager=function(){function IndexedDbIndexManager(){this.collectionParentsCache=new MemoryCollectionParentIndex}IndexedDbIndexManager.prototype.addToCollectionParentIndex=function(transaction,collectionPath){assert(1===collectionPath.length%2,"Expected a collection path.");if(this.collectionParentsCache.add(collectionPath)){assert(1<=collectionPath.length,"Invalid collection path.");var collectionId=collectionPath.lastSegment();collectionPath=collectionPath.popLast();return IndexedDbPersistence.getStore(transaction,
DbCollectionParent.store).put({collectionId:collectionId,parent:encode(collectionPath)})}return PersistencePromise.resolve()};IndexedDbIndexManager.prototype.getCollectionParents=function(transaction,collectionId){var parentPaths=[],range=IDBKeyRange.bound([collectionId,""],[collectionId+"\x00",""],!1,!0);return IndexedDbPersistence.getStore(transaction,DbCollectionParent.store).loadAll(range).next(function(entries){for(var _i=0;_i<entries.length;_i++){var entry=entries[_i];if(entry.collectionId!==
collectionId)break;parentPaths.push(decode(entry.parent))}return parentPaths})};return IndexedDbIndexManager}(),LocalSerializer=function(){function LocalSerializer(remoteSerializer){this.remoteSerializer=remoteSerializer}LocalSerializer.prototype.fromDbRemoteDocument=function(remoteDoc){if(remoteDoc.document)return this.remoteSerializer.fromDocument(remoteDoc.document,!!remoteDoc.hasCommittedMutations);if(remoteDoc.noDocument){var key=DocumentKey.fromSegments(remoteDoc.noDocument.path),version=this.fromDbTimestamp(remoteDoc.noDocument.readTime);
return new NoDocument(key,version,{hasCommittedMutations:!!remoteDoc.hasCommittedMutations})}return remoteDoc.unknownDocument?(key=DocumentKey.fromSegments(remoteDoc.unknownDocument.path),version=this.fromDbTimestamp(remoteDoc.unknownDocument.version),new UnknownDocument(key,version)):fail("Unexpected DbRemoteDocument")};LocalSerializer.prototype.toDbRemoteDocument=function(maybeDoc){if(maybeDoc instanceof Document$jscomp$0){var doc=maybeDoc.proto?maybeDoc.proto:this.remoteSerializer.toDocument(maybeDoc);
maybeDoc=maybeDoc.hasCommittedMutations;return new DbRemoteDocument(null,null,doc,maybeDoc)}if(maybeDoc instanceof NoDocument){doc=maybeDoc.key.path.toArray();var readTime=this.toDbTimestamp(maybeDoc.version);maybeDoc=maybeDoc.hasCommittedMutations;return new DbRemoteDocument(null,new DbNoDocument(doc,readTime),null,maybeDoc)}return maybeDoc instanceof UnknownDocument?(doc=maybeDoc.key.path.toArray(),readTime=this.toDbTimestamp(maybeDoc.version),new DbRemoteDocument(new DbUnknownDocument(doc,readTime),
null,null,!0)):fail("Unexpected MaybeDocumment")};LocalSerializer.prototype.toDbTimestamp=function(snapshotVersion){snapshotVersion=snapshotVersion.toTimestamp();return new DbTimestamp(snapshotVersion.seconds,snapshotVersion.nanoseconds)};LocalSerializer.prototype.fromDbTimestamp=function(dbTimestamp){dbTimestamp=new Timestamp(dbTimestamp.seconds,dbTimestamp.nanoseconds);return SnapshotVersion.fromTimestamp(dbTimestamp)};LocalSerializer.prototype.toDbMutationBatch=function(userId,batch){var _this=
this,serializedBaseMutations=batch.baseMutations.map(function(m){return _this.remoteSerializer.toMutation(m)}),serializedMutations=batch.mutations.map(function(m){return _this.remoteSerializer.toMutation(m)});return new DbMutationBatch(userId,batch.batchId,batch.localWriteTime.toMillis(),serializedBaseMutations,serializedMutations)};LocalSerializer.prototype.fromDbMutationBatch=function(dbBatch){var _this=this,baseMutations=(dbBatch.baseMutations||[]).map(function(m){return _this.remoteSerializer.fromMutation(m)}),
mutations=dbBatch.mutations.map(function(m){return _this.remoteSerializer.fromMutation(m)}),timestamp=Timestamp.fromMillis(dbBatch.localWriteTimeMs);return new MutationBatch(dbBatch.batchId,timestamp,baseMutations,mutations)};LocalSerializer.prototype.toDbResourcePaths=function(keys){var encodedKeys=[];keys.forEach(function(key){encodedKeys.push(encode(key.path))});return encodedKeys};LocalSerializer.prototype.fromDbResourcePaths=function(encodedPaths){for(var keys=documentKeySet(),_i=0;_i<encodedPaths.length;_i++)keys=
keys.add(new DocumentKey(decode(encodedPaths[_i])));return keys};LocalSerializer.prototype.fromDbTarget=function(dbTarget){var version=this.fromDbTimestamp(dbTarget.readTime);var query=void 0!==dbTarget.query.documents?this.remoteSerializer.fromDocumentsTarget(dbTarget.query):this.remoteSerializer.fromQueryTarget(dbTarget.query);return new QueryData(query,dbTarget.targetId,QueryPurpose.Listen,dbTarget.lastListenSequenceNumber,version,dbTarget.resumeToken)};LocalSerializer.prototype.toDbTarget=function(queryData){assert(QueryPurpose.Listen===
queryData.purpose,"Only queries with purpose "+QueryPurpose.Listen+" may be stored, got "+queryData.purpose);var dbTimestamp=this.toDbTimestamp(queryData.snapshotVersion);var queryProto=queryData.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(queryData.query):this.remoteSerializer.toQueryTarget(queryData.query);if(queryData.resumeToken instanceof Uint8Array){assert("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence .");
var resumeToken=queryData.resumeToken.toString()}else resumeToken=queryData.resumeToken;return new DbTarget(queryData.targetId,queryData.query.canonicalId(),dbTimestamp,resumeToken,queryData.sequenceNumber,queryProto)};return LocalSerializer}(),RollingSequenceNumberBuffer=function(){function RollingSequenceNumberBuffer(maxElements){this.maxElements=maxElements;this.buffer=new SortedSet(bufferEntryComparator);this.previousIndex=0}RollingSequenceNumberBuffer.prototype.nextIndex=function(){return++this.previousIndex};
RollingSequenceNumberBuffer.prototype.addElement=function(sequenceNumber){sequenceNumber=[sequenceNumber,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(sequenceNumber);else{var highestValue=this.buffer.last();0>bufferEntryComparator(sequenceNumber,highestValue)&&(this.buffer=this.buffer.delete(highestValue).add(sequenceNumber))}};Object.defineProperty(RollingSequenceNumberBuffer.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0});
return RollingSequenceNumberBuffer}(),GC_DID_NOT_RUN={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},LruParams=function(){function LruParams(cacheSizeCollectionThreshold,percentileToCollect,maximumSequenceNumbersToCollect){this.cacheSizeCollectionThreshold=cacheSizeCollectionThreshold;this.percentileToCollect=percentileToCollect;this.maximumSequenceNumbersToCollect=maximumSequenceNumbersToCollect}LruParams.withCacheSize=function(cacheSize){return new LruParams(cacheSize,
LruParams.DEFAULT_COLLECTION_PERCENTILE,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)};LruParams.COLLECTION_DISABLED=-1;LruParams.MINIMUM_CACHE_SIZE_BYTES=1048576;LruParams.DEFAULT_CACHE_SIZE_BYTES=41943040;LruParams.DEFAULT_COLLECTION_PERCENTILE=10;LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1E3;LruParams.DEFAULT=new LruParams(LruParams.DEFAULT_CACHE_SIZE_BYTES,LruParams.DEFAULT_COLLECTION_PERCENTILE,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT);LruParams.DISABLED=new LruParams(LruParams.COLLECTION_DISABLED,
0,0);return LruParams}(),LruScheduler=function(){function LruScheduler(garbageCollector,asyncQueue,localStore){this.garbageCollector=garbageCollector;this.asyncQueue=asyncQueue;this.localStore=localStore;this.gcTask=null}LruScheduler.prototype.start=function(){assert(null===this.gcTask,"Cannot start an already started LruScheduler");this.garbageCollector.params.cacheSizeCollectionThreshold!==LruParams.COLLECTION_DISABLED&&this.scheduleGC()};LruScheduler.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),
this.gcTask=null)};Object.defineProperty(LruScheduler.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0});LruScheduler.prototype.scheduleGC=function(){var _this=this;assert(null===this.gcTask,"Cannot schedule GC while a task is pending");var delay=this.hasRun?3E5:6E4;debug("LruGarbageCollector","Garbage collection scheduled in "+delay+"ms");this.gcTask=this.asyncQueue.enqueueAfterDelay(TimerId.LruGarbageCollection,delay,function(){_this.gcTask=null;_this.hasRun=
!0;return _this.localStore.collectGarbage(_this.garbageCollector).then(function(){return _this.scheduleGC()}).catch(ignoreIfPrimaryLeaseLoss)})};return LruScheduler}(),LruGarbageCollector=function(){function LruGarbageCollector(delegate,params){this.delegate=delegate;this.params=params}LruGarbageCollector.prototype.calculateTargetCount=function(txn,percentile){return this.delegate.getSequenceNumberCount(txn).next(function(targetCount){return Math.floor(percentile/100*targetCount)})};LruGarbageCollector.prototype.nthSequenceNumber=
function(txn,n){var _this=this;if(0===n)return PersistencePromise.resolve(ListenSequence.INVALID);var buffer=new RollingSequenceNumberBuffer(n);return this.delegate.forEachTarget(txn,function(target){return buffer.addElement(target.sequenceNumber)}).next(function(){return _this.delegate.forEachOrphanedDocumentSequenceNumber(txn,function(sequenceNumber){return buffer.addElement(sequenceNumber)})}).next(function(){return buffer.maxValue})};LruGarbageCollector.prototype.removeTargets=function(txn,upperBound,
activeTargetIds){return this.delegate.removeTargets(txn,upperBound,activeTargetIds)};LruGarbageCollector.prototype.removeOrphanedDocuments=function(txn,upperBound){return this.delegate.removeOrphanedDocuments(txn,upperBound)};LruGarbageCollector.prototype.collect=function(txn,activeTargetIds){var _this=this;return this.params.cacheSizeCollectionThreshold===LruParams.COLLECTION_DISABLED?(debug("LruGarbageCollector","Garbage collection skipped; disabled"),PersistencePromise.resolve(GC_DID_NOT_RUN)):
this.getCacheSize(txn).next(function(cacheSize){return cacheSize<_this.params.cacheSizeCollectionThreshold?(debug("LruGarbageCollector","Garbage collection skipped; Cache size "+cacheSize+" "+("is lower than threshold "+_this.params.cacheSizeCollectionThreshold)),GC_DID_NOT_RUN):_this.runGarbageCollection(txn,activeTargetIds)})};LruGarbageCollector.prototype.getCacheSize=function(txn){return this.delegate.getCacheSize(txn)};LruGarbageCollector.prototype.runGarbageCollection=function(txn,activeTargetIds){var _this=
this,upperBoundSequenceNumber,sequenceNumbersToCollect,targetsRemoved,countedTargetsTs,foundUpperBoundTs,removedTargetsTs,removedDocumentsTs;var startTs=Date.now();return this.calculateTargetCount(txn,this.params.percentileToCollect).next(function(sequenceNumbers){sequenceNumbers>_this.params.maximumSequenceNumbersToCollect?(debug("LruGarbageCollector","Capping sequence numbers to collect down "+("to the maximum of "+_this.params.maximumSequenceNumbersToCollect+" ")+("from "+sequenceNumbers)),sequenceNumbersToCollect=
_this.params.maximumSequenceNumbersToCollect):sequenceNumbersToCollect=sequenceNumbers;countedTargetsTs=Date.now();return _this.nthSequenceNumber(txn,sequenceNumbersToCollect)}).next(function(upperBound){upperBoundSequenceNumber=upperBound;foundUpperBoundTs=Date.now();return _this.removeTargets(txn,upperBoundSequenceNumber,activeTargetIds)}).next(function(numTargetsRemoved){targetsRemoved=numTargetsRemoved;removedTargetsTs=Date.now();return _this.removeOrphanedDocuments(txn,upperBoundSequenceNumber)}).next(function(documentsRemoved){removedDocumentsTs=
Date.now();getLogLevel()<=LogLevel$jscomp$0.DEBUG&&debug("LruGarbageCollector","LRU Garbage Collection\n"+("\tCounted targets in "+(countedTargetsTs-startTs)+"ms\n")+("\tDetermined least recently used "+sequenceNumbersToCollect+" in ")+(foundUpperBoundTs-countedTargetsTs+"ms\n")+("\tRemoved "+targetsRemoved+" targets in ")+(removedTargetsTs-foundUpperBoundTs+"ms\n")+("\tRemoved "+documentsRemoved+" documents in ")+(removedDocumentsTs-removedTargetsTs+"ms\n")+("Total Duration: "+(removedDocumentsTs-
startTs)+"ms"));return PersistencePromise.resolve({didRun:!0,sequenceNumbersCollected:sequenceNumbersToCollect,targetsRemoved:targetsRemoved,documentsRemoved:documentsRemoved})})};return LruGarbageCollector}(),LOG_TAG$2="IndexedDbPersistence",PRIMARY_LEASE_LOST_ERROR_MSG="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",IndexedDbTransaction=function(_super){function IndexedDbTransaction(simpleDbTransaction,currentSequenceNumber){var _this=
_super.call(this)||this;_this.simpleDbTransaction=simpleDbTransaction;_this.currentSequenceNumber=currentSequenceNumber;return _this}tslib_1.__extends(IndexedDbTransaction,_super);return IndexedDbTransaction}(function(){return function(){}}()),IndexedDbPersistence=function(){function IndexedDbPersistence(persistenceKey,clientId,platform,queue,serializer,lruParams,multiClientParams){this.persistenceKey=persistenceKey;this.clientId=clientId;this.queue=queue;this.multiClientParams=multiClientParams;
this.isPrimary=this._started=!1;this.networkEnabled=!0;this.inForeground=!1;this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY;this.primaryStateListener=function(_){return Promise.resolve()};if(!IndexedDbPersistence.isAvailable())throw new FirestoreError(Code.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new IndexedDbLruDelegate(this,lruParams);this.dbName=persistenceKey+
IndexedDbPersistence.MAIN_DATABASE;this.serializer=new LocalSerializer(serializer);this.document=platform.document;this.allowTabSynchronization=void 0!==multiClientParams;this.queryCache=new IndexedDbQueryCache(this.referenceDelegate,this.serializer);this.indexManager=new IndexedDbIndexManager;this.remoteDocumentCache=new IndexedDbRemoteDocumentCache(this.serializer,this.indexManager,this.allowTabSynchronization);if(platform.window&&platform.window.localStorage)this.window=platform.window,this.webStorage=
this.window.localStorage;else throw new FirestoreError(Code.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");}IndexedDbPersistence.getStore=function(txn,store){if(txn instanceof IndexedDbTransaction)return SimpleDb.getStore(txn.simpleDbTransaction,store);throw fail("IndexedDbPersistence must use instances of IndexedDbTransaction");};IndexedDbPersistence.createIndexedDbPersistence=function(persistenceKey,clientId,platform,queue,serializer,lruParams){return tslib_1.__awaiter(this,
void 0,void 0,function(){var persistence;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return persistence=new IndexedDbPersistence(persistenceKey,clientId,platform,queue,serializer,lruParams),[4,persistence.start()];case 1:return _a.sent(),[2,persistence]}})})};IndexedDbPersistence.createMultiClientIndexedDbPersistence=function(persistenceKey,clientId,platform,queue,serializer,lruParams,multiClientParams){return tslib_1.__awaiter(this,void 0,void 0,function(){var persistence;
return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return persistence=new IndexedDbPersistence(persistenceKey,clientId,platform,queue,serializer,lruParams,multiClientParams),[4,persistence.start()];case 1:return _a.sent(),[2,persistence]}})})};IndexedDbPersistence.prototype.start=function(){var _this=this;assert(!this.started,"IndexedDbPersistence double-started!");assert(null!==this.window,"Expected 'window' to be defined");return SimpleDb.openOrCreate(this.dbName,SCHEMA_VERSION,
new SchemaConverter(this.serializer)).then(function(db){_this.simpleDb=db;return _this.updateClientMetadataAndTryBecomePrimary()}).then(function(){_this.attachVisibilityHandler();_this.attachWindowUnloadHook();_this.scheduleClientMetadataAndPrimaryLeaseRefreshes();return _this.startRemoteDocumentCache()}).then(function(){return _this.simpleDb.runTransaction("readonly",[DbTargetGlobal.store],function(txn){return getHighestListenSequenceNumber(txn).next(function(highestListenSequenceNumber){_this.listenSequence=
new ListenSequence(highestListenSequenceNumber,_this.multiClientParams?_this.multiClientParams.sequenceNumberSyncer:void 0)})})}).then(function(){_this._started=!0}).catch(function(reason){_this.simpleDb&&_this.simpleDb.close();return Promise.reject(reason)})};IndexedDbPersistence.prototype.startRemoteDocumentCache=function(){var _this=this;return this.simpleDb.runTransaction("readonly",ALL_STORES,function(txn){return _this.remoteDocumentCache.start(txn)})};IndexedDbPersistence.prototype.setPrimaryStateListener=
function(primaryStateListener){var _this=this;this.primaryStateListener=function(primaryState){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return this.started?[2,primaryStateListener(primaryState)]:[2]})})};return primaryStateListener(this.isPrimary)};IndexedDbPersistence.prototype.setNetworkEnabled=function(networkEnabled){var _this=this;this.networkEnabled!==networkEnabled&&(this.networkEnabled=networkEnabled,this.queue.enqueueAndForget(function(){return tslib_1.__awaiter(_this,
void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:_a.sent(),_a.label=2;case 2:return[2]}})})}))};IndexedDbPersistence.prototype.updateClientMetadataAndTryBecomePrimary=function(){var _this=this;return this.simpleDb.runTransaction("readwrite",ALL_STORES,function(txn){return txn.store(DbClientMetadata.store).put(new DbClientMetadata(_this.clientId,Date.now(),_this.networkEnabled,
_this.inForeground,_this.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(_this.isPrimary)return _this.verifyPrimaryLease(txn).next(function(success){success||(_this.isPrimary=!1,_this.queue.enqueueAndForget(function(){return _this.primaryStateListener(!1)}))})}).next(function(){return _this.canActAsPrimary(txn)}).next(function(canActAsPrimary){var wasPrimary=_this.isPrimary;_this.isPrimary=canActAsPrimary;wasPrimary!==_this.isPrimary&&_this.queue.enqueueAndForget(function(){return _this.primaryStateListener(_this.isPrimary)});
if(wasPrimary&&!_this.isPrimary)return _this.releasePrimaryLeaseIfHeld(txn);if(_this.isPrimary)return _this.acquireOrExtendPrimaryLease(txn)})})};IndexedDbPersistence.prototype.verifyPrimaryLease=function(txn){var _this=this;return txn.store(DbPrimaryClient.store).get(DbPrimaryClient.key).next(function(primaryClient){return PersistencePromise.resolve(_this.isLocalClient(primaryClient))})};IndexedDbPersistence.prototype.removeClientMetadata=function(txn){return txn.store(DbClientMetadata.store).delete(this.clientId)};
IndexedDbPersistence.prototype.maybeGarbageCollectMultiClientState=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var activeClients_1,inactiveClients_1,_this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18E5))return[3,2];this.lastGarbageCollectionTime=Date.now();inactiveClients_1=[];return[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(txn){var metadataStore=
IndexedDbPersistence.getStore(txn,DbClientMetadata.store);return metadataStore.loadAll().next(function(existingClients){activeClients_1=_this.filterActiveClients(existingClients,18E5);inactiveClients_1=existingClients.filter(function(client){return-1===activeClients_1.indexOf(client)})}).next(function(){return PersistencePromise.forEach(inactiveClients_1,function(inactiveClient){return metadataStore.delete(inactiveClient.clientId)})}).next(function(){activeClients_1=activeClients_1.filter(function(client){return client.clientId!==
_this.clientId});if(0<activeClients_1.length){var processedChangeIds=activeClients_1.map(function(client){return client.lastProcessedDocumentChangeId||0});processedChangeIds=Math.min.apply(Math,processedChangeIds);return _this.remoteDocumentCache.removeDocumentChangesThroughChangeId(txn,processedChangeIds)}})})];case 1:_a.sent(),inactiveClients_1.forEach(function(inactiveClient){_this.window.localStorage.removeItem(_this.zombiedClientLocalStorageKey(inactiveClient.clientId))}),_a.label=2;case 2:return[2]}})})};
IndexedDbPersistence.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var _this=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(TimerId.ClientMetadataRefresh,4E3,function(){return _this.updateClientMetadataAndTryBecomePrimary().then(function(){return _this.maybeGarbageCollectMultiClientState()}).then(function(){return _this.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})};IndexedDbPersistence.prototype.isLocalClient=function(client){return client?client.ownerId===
this.clientId:!1};IndexedDbPersistence.prototype.canActAsPrimary=function(txn){var _this=this;return txn.store(DbPrimaryClient.store).get(DbPrimaryClient.key).next(function(currentPrimary){if(null!==currentPrimary&&_this.isWithinAge(currentPrimary.leaseTimestampMs,5E3)&&!_this.isClientZombied(currentPrimary.ownerId)){if(_this.isLocalClient(currentPrimary)&&_this.networkEnabled)return!0;if(!_this.isLocalClient(currentPrimary)){if(!currentPrimary.allowTabSynchronization)throw new FirestoreError(Code.FAILED_PRECONDITION,
"Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.");return!1}}return _this.networkEnabled&&_this.inForeground?!0:txn.store(DbClientMetadata.store).loadAll().next(function(existingClients){return void 0===_this.filterActiveClients(existingClients,5E3).find(function(otherClient){if(_this.clientId!==otherClient.clientId){var otherClientHasBetterVisibility=!_this.inForeground&&
otherClient.inForeground,otherClientHasSameNetworkState=_this.networkEnabled===otherClient.networkEnabled;if(!_this.networkEnabled&&otherClient.networkEnabled||otherClientHasBetterVisibility&&otherClientHasSameNetworkState)return!0}return!1})})}).next(function(canActAsPrimary){_this.isPrimary!==canActAsPrimary&&debug(LOG_TAG$2,"Client "+(canActAsPrimary?"is":"is not")+" eligible for a primary lease.");return canActAsPrimary})};IndexedDbPersistence.prototype.shutdown=function(deleteData){return tslib_1.__awaiter(this,
void 0,void 0,function(){var _this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[DbPrimaryClient.store,DbClientMetadata.store],function(txn){return _this.releasePrimaryLeaseIfHeld(txn).next(function(){return _this.removeClientMetadata(txn)})})];case 1:return _a.sent(),
this.simpleDb.close(),this.removeClientZombiedEntry(),deleteData?[4,SimpleDb.delete(this.dbName)]:[3,3];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})};IndexedDbPersistence.prototype.filterActiveClients=function(clients,activityThresholdMs){var _this=this;return clients.filter(function(client){return _this.isWithinAge(client.updateTimeMs,activityThresholdMs)&&!_this.isClientZombied(client.clientId)})};IndexedDbPersistence.prototype.getActiveClients=function(){var _this=this;return this.simpleDb.runTransaction("readonly",
[DbClientMetadata.store],function(txn){return txn.store(DbClientMetadata.store).loadAll().next(function(clients){return _this.filterActiveClients(clients,18E5).map(function(clientMetadata){return clientMetadata.clientId})})})};Object.defineProperty(IndexedDbPersistence.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0});IndexedDbPersistence.prototype.getMutationQueue=function(user){assert(this.started,"Cannot initialize MutationQueue before persistence is started.");
return IndexedDbMutationQueue.forUser(user,this.serializer,this.indexManager,this.referenceDelegate)};IndexedDbPersistence.prototype.getQueryCache=function(){assert(this.started,"Cannot initialize QueryCache before persistence is started.");return this.queryCache};IndexedDbPersistence.prototype.getRemoteDocumentCache=function(){assert(this.started,"Cannot initialize RemoteDocumentCache before persistence is started.");return this.remoteDocumentCache};IndexedDbPersistence.prototype.getIndexManager=
function(){assert(this.started,"Cannot initialize IndexManager before persistence is started.");return this.indexManager};IndexedDbPersistence.prototype.runTransaction=function(action,mode,transactionOperation){var _this=this;debug(LOG_TAG$2,"Starting transaction:",action);return this.simpleDb.runTransaction("readonly"===mode?"readonly":"readwrite",ALL_STORES,function(simpleDbTxn){return"readwrite-primary"===mode?_this.verifyPrimaryLease(simpleDbTxn).next(function(success){if(!success)throw error$jscomp$0("Failed to obtain primary lease for action '"+
action+"'."),_this.isPrimary=!1,_this.queue.enqueueAndForget(function(){return _this.primaryStateListener(!1)}),new FirestoreError(Code.FAILED_PRECONDITION,PRIMARY_LEASE_LOST_ERROR_MSG);return transactionOperation(new IndexedDbTransaction(simpleDbTxn,_this.listenSequence.next()))}).next(function(result){return _this.acquireOrExtendPrimaryLease(simpleDbTxn).next(function(){return result})}):_this.verifyAllowTabSynchronization(simpleDbTxn).next(function(){return transactionOperation(new IndexedDbTransaction(simpleDbTxn,
_this.listenSequence.next()))})})};IndexedDbPersistence.prototype.verifyAllowTabSynchronization=function(txn){var _this=this;return txn.store(DbPrimaryClient.store).get(DbPrimaryClient.key).next(function(currentPrimary){if(null!==currentPrimary&&_this.isWithinAge(currentPrimary.leaseTimestampMs,5E3)&&!_this.isClientZombied(currentPrimary.ownerId)&&!_this.isLocalClient(currentPrimary)&&!currentPrimary.allowTabSynchronization)throw new FirestoreError(Code.FAILED_PRECONDITION,"Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.");
})};IndexedDbPersistence.prototype.acquireOrExtendPrimaryLease=function(txn){var newPrimary=new DbPrimaryClient(this.clientId,this.allowTabSynchronization,Date.now());return txn.store(DbPrimaryClient.store).put(DbPrimaryClient.key,newPrimary)};IndexedDbPersistence.isAvailable=function(){return SimpleDb.isAvailable()};IndexedDbPersistence.buildStoragePrefix=function(databaseInfo){var database=databaseInfo.databaseId.projectId;databaseInfo.databaseId.isDefaultDatabase||(database+="."+databaseInfo.databaseId.database);
return"firestore/"+databaseInfo.persistenceKey+"/"+database+"/"};IndexedDbPersistence.prototype.releasePrimaryLeaseIfHeld=function(txn){var _this=this,store=txn.store(DbPrimaryClient.store);return store.get(DbPrimaryClient.key).next(function(primaryClient){return _this.isLocalClient(primaryClient)?(debug(LOG_TAG$2,"Releasing primary lease."),store.delete(DbPrimaryClient.key)):PersistencePromise.resolve()})};IndexedDbPersistence.prototype.isWithinAge=function(updateTimeMs,maxAgeMs){var now=Date.now();
return updateTimeMs<now-maxAgeMs?!1:updateTimeMs>now?(error$jscomp$0("Detected an update time that is in the future: "+updateTimeMs+" \x3e "+now),!1):!0};IndexedDbPersistence.prototype.attachVisibilityHandler=function(){var _this=this;null!==this.document&&"function"===typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){_this.queue.enqueueAndForget(function(){_this.inForeground="visible"===_this.document.visibilityState;return _this.updateClientMetadataAndTryBecomePrimary()})},
this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)};IndexedDbPersistence.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(assert(null!==this.document&&"function"===typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)};
IndexedDbPersistence.prototype.attachWindowUnloadHook=function(){var _this=this;"function"===typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){_this.markClientZombied();_this.queue.enqueueAndForget(function(){return _this.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))};IndexedDbPersistence.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(assert("function"===typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),
this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)};IndexedDbPersistence.prototype.isClientZombied=function(clientId){try{var isZombied=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(clientId));debug(LOG_TAG$2,"Client '"+clientId+"' "+(isZombied?"is":"is not")+" zombied in LocalStorage");return isZombied}catch(e){return error$jscomp$0(LOG_TAG$2,"Failed to get zombied client id.",e),!1}};IndexedDbPersistence.prototype.markClientZombied=
function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(e){error$jscomp$0("Failed to set zombie client id.",e)}};IndexedDbPersistence.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(e){}};IndexedDbPersistence.prototype.zombiedClientLocalStorageKey=function(clientId){return"firestore_zombie_"+this.persistenceKey+"_"+clientId};IndexedDbPersistence.MAIN_DATABASE=
"main";return IndexedDbPersistence}(),IndexedDbLruDelegate=function(){function IndexedDbLruDelegate(db,params){this.db=db;this.garbageCollector=new LruGarbageCollector(this,params)}IndexedDbLruDelegate.prototype.getSequenceNumberCount=function(txn){var docCountPromise=this.orphanedDocmentCount(txn);return this.db.getQueryCache().getQueryCount(txn).next(function(targetCount){return docCountPromise.next(function(docCount){return targetCount+docCount})})};IndexedDbLruDelegate.prototype.orphanedDocmentCount=
function(txn){var orphanedCount=0;return this.forEachOrphanedDocumentSequenceNumber(txn,function(_){orphanedCount++}).next(function(){return orphanedCount})};IndexedDbLruDelegate.prototype.forEachTarget=function(txn,f){return this.db.getQueryCache().forEachTarget(txn,f)};IndexedDbLruDelegate.prototype.forEachOrphanedDocumentSequenceNumber=function(txn,f){return this.forEachOrphanedDocument(txn,function(docKey,sequenceNumber){return f(sequenceNumber)})};IndexedDbLruDelegate.prototype.setInMemoryPins=
function(inMemoryPins){this.inMemoryPins=inMemoryPins};IndexedDbLruDelegate.prototype.addReference=function(txn,key){return writeSentinelKey(txn,key)};IndexedDbLruDelegate.prototype.removeReference=function(txn,key){return writeSentinelKey(txn,key)};IndexedDbLruDelegate.prototype.removeTargets=function(txn,upperBound,activeTargetIds){return this.db.getQueryCache().removeTargets(txn,upperBound,activeTargetIds)};IndexedDbLruDelegate.prototype.removeMutationReference=function(txn,key){return writeSentinelKey(txn,
key)};IndexedDbLruDelegate.prototype.isPinned=function(txn,docKey){return this.inMemoryPins.containsKey(docKey)?PersistencePromise.resolve(!0):mutationQueuesContainKey(txn,docKey)};IndexedDbLruDelegate.prototype.removeOrphanedDocuments=function(txn,upperBound){var _this=this,count=0,bytesRemoved=0,promises=[];return this.forEachOrphanedDocument(txn,function(docKey,sequenceNumber){sequenceNumber<=upperBound&&(sequenceNumber=_this.isPinned(txn,docKey).next(function(isPinned){if(!isPinned)return count++,
_this.removeOrphanedDocument(txn,docKey).next(function(documentBytes){bytesRemoved+=documentBytes})}),promises.push(sequenceNumber))}).next(function(){return PersistencePromise.waitFor(promises)}).next(function(){return _this.db.getRemoteDocumentCache().updateSize(txn,-bytesRemoved)}).next(function(){return count})};IndexedDbLruDelegate.prototype.removeOrphanedDocument=function(txn,docKey){var totalBytesRemoved=0,documentCache=this.db.getRemoteDocumentCache();return PersistencePromise.waitFor([documentTargetStore(txn).delete([0,
encode(docKey.path)]),documentCache.removeEntry(txn,docKey).next(function(bytesRemoved){totalBytesRemoved+=bytesRemoved})]).next(function(){return totalBytesRemoved})};IndexedDbLruDelegate.prototype.removeTarget=function(txn,queryData){queryData=queryData.copy({sequenceNumber:txn.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(txn,queryData)};IndexedDbLruDelegate.prototype.updateLimboDocument=function(txn,key){return writeSentinelKey(txn,key)};IndexedDbLruDelegate.prototype.forEachOrphanedDocument=
function(txn,f){txn=documentTargetStore(txn);var nextToReport=ListenSequence.INVALID,nextPath;return txn.iterate({index:DbTargetDocument.documentTargetsIndex},function(_a,_b){var path=_b.path;_b=_b.sequenceNumber;0===_a[0]?(nextToReport!==ListenSequence.INVALID&&f(new DocumentKey(decode(nextPath)),nextToReport),nextToReport=_b,nextPath=path):nextToReport=ListenSequence.INVALID}).next(function(){nextToReport!==ListenSequence.INVALID&&f(new DocumentKey(decode(nextPath)),nextToReport)})};IndexedDbLruDelegate.prototype.getCacheSize=
function(txn){return this.db.getRemoteDocumentCache().getSize(txn)};return IndexedDbLruDelegate}(),LocalDocumentsView=function(){function LocalDocumentsView(remoteDocumentCache,mutationQueue,indexManager){this.remoteDocumentCache=remoteDocumentCache;this.mutationQueue=mutationQueue;this.indexManager=indexManager}LocalDocumentsView.prototype.getDocument=function(transaction,key){var _this=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(transaction,key).next(function(batches){return _this.getDocumentInternal(transaction,
key,batches)})};LocalDocumentsView.prototype.getDocumentInternal=function(transaction,key,inBatches){return this.remoteDocumentCache.getEntry(transaction,key).next(function(doc){for(var _i=0;_i<inBatches.length;_i++)doc=inBatches[_i].applyToLocalView(key,doc);return doc})};LocalDocumentsView.prototype.applyLocalMutationsToDocuments=function(transaction,docs,batches){var results=EMPTY_MAYBE_DOCUMENT_MAP;docs.forEach(function(key,localView){for(var _i=0;_i<batches.length;_i++)localView=batches[_i].applyToLocalView(key,
localView);results=results.insert(key,localView)});return results};LocalDocumentsView.prototype.getDocuments=function(transaction,keys){var _this=this;return this.remoteDocumentCache.getEntries(transaction,keys).next(function(docs){return _this.getLocalViewOfDocuments(transaction,docs)})};LocalDocumentsView.prototype.getLocalViewOfDocuments=function(transaction,baseDocs){var _this=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(transaction,baseDocs).next(function(batches){batches=
_this.applyLocalMutationsToDocuments(transaction,baseDocs,batches);var results=EMPTY_MAYBE_DOCUMENT_MAP;batches.forEach(function(key,maybeDoc){maybeDoc||(maybeDoc=new NoDocument(key,SnapshotVersion.forDeletedDoc()));results=results.insert(key,maybeDoc)});return results})};LocalDocumentsView.prototype.getDocumentsMatchingQuery=function(transaction,query){return query.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(transaction,query.path):query.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(transaction,
query):this.getDocumentsMatchingCollectionQuery(transaction,query)};LocalDocumentsView.prototype.getDocumentsMatchingDocumentQuery=function(transaction,docPath){return this.getDocument(transaction,new DocumentKey(docPath)).next(function(maybeDoc){var result=EMPTY_DOCUMENT_MAP;maybeDoc instanceof Document$jscomp$0&&(result=result.insert(maybeDoc.key,maybeDoc));return result})};LocalDocumentsView.prototype.getDocumentsMatchingCollectionGroupQuery=function(transaction,query){var _this=this;assert(query.path.isEmpty(),
"Currently we only support collection group queries at the root.");var collectionId=query.collectionGroup,results=EMPTY_DOCUMENT_MAP;return this.indexManager.getCollectionParents(transaction,collectionId).next(function(parents){return PersistencePromise.forEach(parents,function(parent){parent=query.asCollectionQueryAtPath(parent.child(collectionId));return _this.getDocumentsMatchingCollectionQuery(transaction,parent).next(function(r){r.forEach(function(key,doc){results=results.insert(key,doc)})})}).next(function(){return results})})};
LocalDocumentsView.prototype.getDocumentsMatchingCollectionQuery=function(transaction,query){var _this=this,results;return this.remoteDocumentCache.getDocumentsMatchingQuery(transaction,query).next(function(queryResults){results=queryResults;return _this.mutationQueue.getAllMutationBatchesAffectingQuery(transaction,query)}).next(function(matchingMutationBatches){for(var _i=0;_i<matchingMutationBatches.length;_i++)for(var batch=matchingMutationBatches[_i],_a=0,_b=batch.mutations;_a<_b.length;_a++){var mutation=
_b[_a],key=mutation.key;if(query.path.isImmediateParentOf(key.path)){var baseDoc=results.get(key);mutation=mutation.applyToLocalView(baseDoc,baseDoc,batch.localWriteTime);results=mutation instanceof Document$jscomp$0?results.insert(key,mutation):results.remove(key)}}}).next(function(){results.forEach(function(key,doc){query.matches(doc)||(results=results.remove(key))});return results})};return LocalDocumentsView}(),ReferenceSet=function(){function ReferenceSet(){this.refsByKey=new SortedSet(DocReference.compareByKey);
this.refsByTarget=new SortedSet(DocReference.compareByTargetId)}ReferenceSet.prototype.isEmpty=function(){return this.refsByKey.isEmpty()};ReferenceSet.prototype.addReference=function(key,id){key=new DocReference(key,id);this.refsByKey=this.refsByKey.add(key);this.refsByTarget=this.refsByTarget.add(key)};ReferenceSet.prototype.addReferences=function(keys,id){var _this=this;keys.forEach(function(key){return _this.addReference(key,id)})};ReferenceSet.prototype.removeReference=function(key,id){this.removeRef(new DocReference(key,
id))};ReferenceSet.prototype.removeReferences=function(keys,id){var _this=this;keys.forEach(function(key){return _this.removeReference(key,id)})};ReferenceSet.prototype.removeReferencesForId=function(id){var _this=this,emptyKey=DocumentKey.EMPTY,startRef=new DocReference(emptyKey,id);id=new DocReference(emptyKey,id+1);var keys=[];this.refsByTarget.forEachInRange([startRef,id],function(ref){_this.removeRef(ref);keys.push(ref.key)});return keys};ReferenceSet.prototype.removeAllReferences=function(){var _this=
this;this.refsByKey.forEach(function(ref){return _this.removeRef(ref)})};ReferenceSet.prototype.removeRef=function(ref){this.refsByKey=this.refsByKey.delete(ref);this.refsByTarget=this.refsByTarget.delete(ref)};ReferenceSet.prototype.referencesForId=function(id){var emptyKey=DocumentKey.EMPTY,startRef=new DocReference(emptyKey,id);id=new DocReference(emptyKey,id+1);var keys=documentKeySet();this.refsByTarget.forEachInRange([startRef,id],function(ref){keys=keys.add(ref.key)});return keys};ReferenceSet.prototype.containsKey=
function(key){var ref=new DocReference(key,0);ref=this.refsByKey.firstAfterOrEqual(ref);return null!==ref&&key.isEqual(ref.key)};return ReferenceSet}(),DocReference=function(){function DocReference(key,targetOrBatchId){this.key=key;this.targetOrBatchId=targetOrBatchId}DocReference.compareByKey=function(left,right){return DocumentKey.comparator(left.key,right.key)||primitiveComparator(left.targetOrBatchId,right.targetOrBatchId)};DocReference.compareByTargetId=function(left,right){return primitiveComparator(left.targetOrBatchId,
right.targetOrBatchId)||DocumentKey.comparator(left.key,right.key)};return DocReference}(),LocalStore=function(){function LocalStore(persistence,initialUser){this.persistence=persistence;this.localViewReferences=new ReferenceSet;this.queryDataByTarget={};assert(persistence.started,"LocalStore was passed an unstarted persistence implementation");this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences);this.mutationQueue=persistence.getMutationQueue(initialUser);this.remoteDocuments=
persistence.getRemoteDocumentCache();this.queryCache=persistence.getQueryCache();this.localDocuments=new LocalDocumentsView(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}LocalStore.prototype.handleUserChange=function(user){var _this=this;return this.persistence.runTransaction("Handle user change","readonly",function(txn){var oldBatches;return _this.mutationQueue.getAllMutationBatches(txn).next(function(promisedOldBatches){oldBatches=promisedOldBatches;_this.mutationQueue=
_this.persistence.getMutationQueue(user);_this.localDocuments=new LocalDocumentsView(_this.remoteDocuments,_this.mutationQueue,_this.persistence.getIndexManager());return _this.mutationQueue.getAllMutationBatches(txn)}).next(function(newBatches){for(var removedBatchIds=[],addedBatchIds=[],changedKeys=documentKeySet(),_i=0,oldBatches_1=oldBatches;_i<oldBatches_1.length;_i++){var batch=oldBatches_1[_i];removedBatchIds.push(batch.batchId);for(var _a=0,_b=batch.mutations;_a<_b.length;_a++)batch=_b[_a],
changedKeys=changedKeys.add(batch.key)}for(_i=0;_i<newBatches.length;_i++)for(batch=newBatches[_i],addedBatchIds.push(batch.batchId),oldBatches_1=0,_a=batch.mutations;oldBatches_1<_a.length;oldBatches_1++)batch=_a[oldBatches_1],changedKeys=changedKeys.add(batch.key);return _this.localDocuments.getDocuments(txn,changedKeys).next(function(affectedDocuments){return{affectedDocuments:affectedDocuments,removedBatchIds:removedBatchIds,addedBatchIds:addedBatchIds}})})})};LocalStore.prototype.localWrite=
function(mutations){var _this=this,localWriteTime=Timestamp.now(),keys$jscomp$0=mutations.reduce(function(keys,m){return keys.add(m.key)},documentKeySet());return this.persistence.runTransaction("Locally write mutations","readwrite",function(txn){return _this.localDocuments.getDocuments(txn,keys$jscomp$0).next(function(existingDocs){for(var baseMutations=[],_i=0;_i<mutations.length;_i++){var mutation=mutations[_i],maybeDoc=existingDocs.get(mutation.key);if(!mutation.isIdempotent){var fieldMask=mutation.fieldMask;
fieldMask&&(maybeDoc=maybeDoc instanceof Document$jscomp$0?fieldMask.applyTo(maybeDoc.data):ObjectValue.EMPTY,baseMutations.push(new PatchMutation(mutation.key,maybeDoc,fieldMask,Precondition.exists(!0))))}}return _this.mutationQueue.addMutationBatch(txn,localWriteTime,baseMutations,mutations).next(function(batch){var changes=batch.applyToLocalDocumentSet(existingDocs);return{batchId:batch.batchId,changes:changes}})})})};LocalStore.prototype.lookupMutationDocuments=function(batchId){var _this=this;
return this.persistence.runTransaction("Lookup mutation documents","readonly",function(txn){return _this.mutationQueue.lookupMutationKeys(txn,batchId).next(function(keys){return keys?_this.localDocuments.getDocuments(txn,keys):PersistencePromise.resolve(null)})})};LocalStore.prototype.acknowledgeBatch=function(batchResult){var _this=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(txn){var affected=batchResult.batch.keys(),documentBuffer=_this.remoteDocuments.newChangeBuffer();
return _this.mutationQueue.acknowledgeBatch(txn,batchResult.batch,batchResult.streamToken).next(function(){return _this.applyWriteToRemoteDocuments(txn,batchResult,documentBuffer)}).next(function(){return documentBuffer.apply(txn)}).next(function(){return _this.mutationQueue.performConsistencyCheck(txn)}).next(function(){return _this.localDocuments.getDocuments(txn,affected)})})};LocalStore.prototype.rejectBatch=function(batchId){var _this=this;return this.persistence.runTransaction("Reject batch",
"readwrite-primary",function(txn){var affectedKeys;return _this.mutationQueue.lookupMutationBatch(txn,batchId).next(function(batch){assert(null!==batch,"Attempt to reject nonexistent batch!");affectedKeys=batch.keys();return _this.mutationQueue.removeMutationBatch(txn,batch)}).next(function(){return _this.mutationQueue.performConsistencyCheck(txn)}).next(function(){return _this.localDocuments.getDocuments(txn,affectedKeys)})})};LocalStore.prototype.getLastStreamToken=function(){var _this=this;return this.persistence.runTransaction("Get last stream token",
"readonly",function(txn){return _this.mutationQueue.getLastStreamToken(txn)})};LocalStore.prototype.setLastStreamToken=function(streamToken){var _this=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(txn){return _this.mutationQueue.setLastStreamToken(txn,streamToken)})};LocalStore.prototype.getLastRemoteSnapshotVersion=function(){var _this=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(txn){return _this.queryCache.getLastRemoteSnapshotVersion(txn)})};
LocalStore.prototype.applyRemoteEvent=function(remoteEvent){var _this=this,documentBuffer=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(txn){var promises=[],authoritativeUpdates=documentKeySet();forEachNumber(remoteEvent.targetChanges,function(targetId,change){var queryData=_this.queryDataByTarget[targetId];if(queryData){change.addedDocuments.forEach(function(key){authoritativeUpdates=authoritativeUpdates.add(key)});
change.modifiedDocuments.forEach(function(key){authoritativeUpdates=authoritativeUpdates.add(key)});promises.push(_this.queryCache.removeMatchingKeys(txn,change.removedDocuments,targetId).next(function(){return _this.queryCache.addMatchingKeys(txn,change.addedDocuments,targetId)}));var resumeToken=change.resumeToken;if(0<resumeToken.length){var oldQueryData=queryData;queryData=queryData.copy({resumeToken:resumeToken,snapshotVersion:remoteEvent.snapshotVersion});_this.queryDataByTarget[targetId]=queryData;
LocalStore.shouldPersistQueryData(oldQueryData,queryData,change)&&promises.push(_this.queryCache.updateQueryData(txn,queryData))}}});var changedDocs=EMPTY_MAYBE_DOCUMENT_MAP,updatedKeys=documentKeySet();remoteEvent.documentUpdates.forEach(function(key,doc){updatedKeys=updatedKeys.add(key)});promises.push(documentBuffer.getEntries(txn,updatedKeys).next(function(existingDocs){remoteEvent.documentUpdates.forEach(function(key,doc){var existingDoc=existingDocs.get(key);null==existingDoc||doc.version.isEqual(SnapshotVersion.MIN)||
authoritativeUpdates.has(doc.key)&&!existingDoc.hasPendingWrites||0<=doc.version.compareTo(existingDoc.version)?(documentBuffer.addEntry(doc),changedDocs=changedDocs.insert(key,doc)):debug("LocalStore","Ignoring outdated watch update for ",key,". Current version:",existingDoc.version," Watch version:",doc.version);remoteEvent.resolvedLimboDocuments.has(key)&&promises.push(_this.persistence.referenceDelegate.updateLimboDocument(txn,key))})}));var remoteVersion=remoteEvent.snapshotVersion;if(!remoteVersion.isEqual(SnapshotVersion.MIN)){var updateRemoteVersion=
_this.queryCache.getLastRemoteSnapshotVersion(txn).next(function(lastRemoteVersion){assert(0<=remoteVersion.compareTo(lastRemoteVersion),"Watch stream reverted to previous snapshot?? "+remoteVersion+" \x3c "+lastRemoteVersion);return _this.queryCache.setTargetsMetadata(txn,txn.currentSequenceNumber,remoteVersion)});promises.push(updateRemoteVersion)}return PersistencePromise.waitFor(promises).next(function(){return documentBuffer.apply(txn)}).next(function(){return _this.localDocuments.getLocalViewOfDocuments(txn,
changedDocs)})})};LocalStore.shouldPersistQueryData=function(oldQueryData,newQueryData,change){return 0===newQueryData.resumeToken.length?!1:0===oldQueryData.resumeToken.length||newQueryData.snapshotVersion.toMicroseconds()-oldQueryData.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS?!0:0<change.addedDocuments.size+change.modifiedDocuments.size+change.removedDocuments.size};LocalStore.prototype.notifyLocalViewChanges=function(viewChanges){var _this=this;return this.persistence.runTransaction("notifyLocalViewChanges",
"readwrite",function(txn){return PersistencePromise.forEach(viewChanges,function(viewChange){_this.localViewReferences.addReferences(viewChange.addedKeys,viewChange.targetId);_this.localViewReferences.removeReferences(viewChange.removedKeys,viewChange.targetId);return PersistencePromise.forEach(viewChange.removedKeys,function(key){return _this.persistence.referenceDelegate.removeReference(txn,key)})})})};LocalStore.prototype.nextMutationBatch=function(afterBatchId){var _this=this;return this.persistence.runTransaction("Get next mutation batch",
"readonly",function(txn){void 0===afterBatchId&&(afterBatchId=-1);return _this.mutationQueue.getNextMutationBatchAfterBatchId(txn,afterBatchId)})};LocalStore.prototype.readDocument=function(key){var _this=this;return this.persistence.runTransaction("read document","readonly",function(txn){return _this.localDocuments.getDocument(txn,key)})};LocalStore.prototype.allocateQuery=function(query){var _this=this;return this.persistence.runTransaction("Allocate query","readwrite",function(txn){var queryData;
return _this.queryCache.getQueryData(txn,query).next(function(cached){return cached?(queryData=cached,PersistencePromise.resolve()):_this.queryCache.allocateTargetId(txn).next(function(targetId){queryData=new QueryData(query,targetId,QueryPurpose.Listen,txn.currentSequenceNumber);return _this.queryCache.addQueryData(txn,queryData)})}).next(function(){assert(!_this.queryDataByTarget[queryData.targetId],"Tried to allocate an already allocated query: "+query);return _this.queryDataByTarget[queryData.targetId]=
queryData})})};LocalStore.prototype.releaseQuery=function(query,keepPersistedQueryData){var _this=this;return this.persistence.runTransaction("Release query",keepPersistedQueryData?"readwrite":"readwrite-primary",function(txn){return _this.queryCache.getQueryData(txn,query).next(function(queryData){assert(null!=queryData,"Tried to release nonexistent query: "+query);queryData=queryData.targetId;var cachedQueryData=_this.queryDataByTarget[queryData],removed=_this.localViewReferences.removeReferencesForId(queryData);
delete _this.queryDataByTarget[queryData];return keepPersistedQueryData?PersistencePromise.resolve():PersistencePromise.forEach(removed,function(key){return _this.persistence.referenceDelegate.removeReference(txn,key)}).next(function(){return _this.persistence.referenceDelegate.removeTarget(txn,cachedQueryData)})})})};LocalStore.prototype.executeQuery=function(query){var _this=this;return this.persistence.runTransaction("Execute query","readonly",function(txn){return _this.localDocuments.getDocumentsMatchingQuery(txn,
query)})};LocalStore.prototype.remoteDocumentKeys=function(targetId){var _this=this;return this.persistence.runTransaction("Remote document keys","readonly",function(txn){return _this.queryCache.getMatchingKeysForTargetId(txn,targetId)})};LocalStore.prototype.getActiveClients=function(){return this.persistence.getActiveClients()};LocalStore.prototype.removeCachedMutationBatchMetadata=function(batchId){this.mutationQueue.removeCachedMutationKeys(batchId)};LocalStore.prototype.setNetworkEnabled=function(networkEnabled){this.persistence.setNetworkEnabled(networkEnabled)};
LocalStore.prototype.applyWriteToRemoteDocuments=function(txn,batchResult,documentBuffer){var _this=this,batch=batchResult.batch,docKeys=batch.keys(),promiseChain=PersistencePromise.resolve();docKeys.forEach(function(docKey){promiseChain=promiseChain.next(function(){return documentBuffer.getEntry(txn,docKey)}).next(function(remoteDoc){var doc=remoteDoc,ackVersion=batchResult.docVersions.get(docKey);assert(null!==ackVersion,"ackVersions should contain every doc in the write.");if(!doc||0>doc.version.compareTo(ackVersion))(doc=
batch.applyToRemoteDocument(docKey,doc,batchResult))?documentBuffer.addEntry(doc):assert(!remoteDoc,"Mutation batch "+batch+" applied to document "+remoteDoc+" resulted in null")})});return promiseChain.next(function(){return _this.mutationQueue.removeMutationBatch(txn,batch)})};LocalStore.prototype.collectGarbage=function(garbageCollector){var _this=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(txn){return garbageCollector.collect(txn,_this.queryDataByTarget)})};
LocalStore.prototype.getQueryForTarget=function(targetId){var _this=this;return this.queryDataByTarget[targetId]?Promise.resolve(this.queryDataByTarget[targetId].query):this.persistence.runTransaction("Get query data","readonly",function(txn){return _this.queryCache.getQueryDataForTarget(txn,targetId).next(function(queryData){return queryData?queryData.query:null})})};LocalStore.prototype.getNewDocumentChanges=function(){var _this=this;return this.persistence.runTransaction("Get new document changes",
"readonly",function(txn){return _this.remoteDocuments.getNewDocumentChanges(txn)})};LocalStore.RESUME_TOKEN_MAX_AGE_MICROS=3E8;return LocalStore}(),MemoryMutationQueue=function(){function MemoryMutationQueue(indexManager,referenceDelegate){this.indexManager=indexManager;this.referenceDelegate=referenceDelegate;this.mutationQueue=[];this.nextBatchId=1;this.lastStreamToken=emptyByteString();this.batchesByDocumentKey=new SortedSet(DocReference.compareByKey)}MemoryMutationQueue.prototype.checkEmpty=function(transaction){return PersistencePromise.resolve(0===
this.mutationQueue.length)};MemoryMutationQueue.prototype.acknowledgeBatch=function(transaction,batch,streamToken){transaction=batch.batchId;batch=this.indexOfExistingBatchId(transaction,"acknowledged");assert(0===batch,"Can only acknowledge the first batch in the mutation queue");batch=this.mutationQueue[batch];assert(transaction===batch.batchId,"Queue ordering failure: expected batch "+transaction+", got batch "+batch.batchId);this.lastStreamToken=streamToken;return PersistencePromise.resolve()};
MemoryMutationQueue.prototype.getLastStreamToken=function(transaction){return PersistencePromise.resolve(this.lastStreamToken)};MemoryMutationQueue.prototype.setLastStreamToken=function(transaction,streamToken){this.lastStreamToken=streamToken;return PersistencePromise.resolve()};MemoryMutationQueue.prototype.addMutationBatch=function(transaction,localWriteTime,baseMutations,mutations){assert(0!==mutations.length,"Mutation batches should not be empty");var batchId=this.nextBatchId;this.nextBatchId++;
0<this.mutationQueue.length&&assert(this.mutationQueue[this.mutationQueue.length-1].batchId<batchId,"Mutation batchIDs must be monotonically increasing order");localWriteTime=new MutationBatch(batchId,localWriteTime,baseMutations,mutations);this.mutationQueue.push(localWriteTime);for(baseMutations=0;baseMutations<mutations.length;baseMutations++){var mutation=mutations[baseMutations];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new DocReference(mutation.key,batchId));this.indexManager.addToCollectionParentIndex(transaction,
mutation.key.path.popLast())}return PersistencePromise.resolve(localWriteTime)};MemoryMutationQueue.prototype.lookupMutationBatch=function(transaction,batchId){return PersistencePromise.resolve(this.findMutationBatch(batchId))};MemoryMutationQueue.prototype.lookupMutationKeys=function(transaction,batchId){transaction=this.findMutationBatch(batchId);assert(null!=transaction,"Failed to find local mutation batch.");return PersistencePromise.resolve(transaction.keys())};MemoryMutationQueue.prototype.getNextMutationBatchAfterBatchId=
function(transaction,batchId){transaction=this.indexOfBatchId(batchId+1);transaction=0>transaction?0:transaction;return PersistencePromise.resolve(this.mutationQueue.length>transaction?this.mutationQueue[transaction]:null)};MemoryMutationQueue.prototype.getAllMutationBatches=function(transaction){return PersistencePromise.resolve(this.mutationQueue.slice())};MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(transaction,documentKey){var _this=this;transaction=new DocReference(documentKey,
0);var end=new DocReference(documentKey,Number.POSITIVE_INFINITY),result=[];this.batchesByDocumentKey.forEachInRange([transaction,end],function(ref){assert(documentKey.isEqual(ref.key),"Should only iterate over a single key's batches");ref=_this.findMutationBatch(ref.targetOrBatchId);assert(null!==ref,"Batches in the index must exist in the main table");result.push(ref)});return PersistencePromise.resolve(result)};MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(transaction,
documentKeys){var _this=this,uniqueBatchIDs=new SortedSet(primitiveComparator);documentKeys.forEach(function(documentKey){var start=new DocReference(documentKey,0),end=new DocReference(documentKey,Number.POSITIVE_INFINITY);_this.batchesByDocumentKey.forEachInRange([start,end],function(ref){assert(documentKey.isEqual(ref.key),"For each key, should only iterate over a single key's batches");uniqueBatchIDs=uniqueBatchIDs.add(ref.targetOrBatchId)})});return PersistencePromise.resolve(this.findMutationBatches(uniqueBatchIDs))};
MemoryMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(transaction,query){assert(!query.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var prefix=query.path,immediateChildrenPathLength=prefix.length+1;transaction=prefix;DocumentKey.isDocumentKey(transaction)||(transaction=transaction.child(""));transaction=new DocReference(new DocumentKey(transaction),0);var uniqueBatchIDs=new SortedSet(primitiveComparator);this.batchesByDocumentKey.forEachWhile(function(ref){var rowKeyPath=
ref.key.path;return prefix.isPrefixOf(rowKeyPath)?(rowKeyPath.length===immediateChildrenPathLength&&(uniqueBatchIDs=uniqueBatchIDs.add(ref.targetOrBatchId)),!0):!1},transaction);return PersistencePromise.resolve(this.findMutationBatches(uniqueBatchIDs))};MemoryMutationQueue.prototype.findMutationBatches=function(batchIDs){var _this=this,result=[];batchIDs.forEach(function(batchId){batchId=_this.findMutationBatch(batchId);null!==batchId&&result.push(batchId)});return result};MemoryMutationQueue.prototype.removeMutationBatch=
function(transaction,batch){var _this=this,batchIndex=this.indexOfExistingBatchId(batch.batchId,"removed");assert(0===batchIndex,"Can only remove the first entry of the mutation queue");this.mutationQueue.shift();var references=this.batchesByDocumentKey;return PersistencePromise.forEach(batch.mutations,function(mutation){var ref=new DocReference(mutation.key,batch.batchId);references=references.delete(ref);return _this.referenceDelegate.removeMutationReference(transaction,mutation.key)}).next(function(){_this.batchesByDocumentKey=
references})};MemoryMutationQueue.prototype.removeCachedMutationKeys=function(batchId){};MemoryMutationQueue.prototype.containsKey=function(txn,key){txn=new DocReference(key,0);txn=this.batchesByDocumentKey.firstAfterOrEqual(txn);return PersistencePromise.resolve(key.isEqual(txn&&txn.key))};MemoryMutationQueue.prototype.performConsistencyCheck=function(txn){0===this.mutationQueue.length&&assert(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty.");
return PersistencePromise.resolve()};MemoryMutationQueue.prototype.indexOfExistingBatchId=function(batchId,action){batchId=this.indexOfBatchId(batchId);assert(0<=batchId&&batchId<this.mutationQueue.length,"Batches must exist to be "+action);return batchId};MemoryMutationQueue.prototype.indexOfBatchId=function(batchId){return 0===this.mutationQueue.length?0:batchId-this.mutationQueue[0].batchId};MemoryMutationQueue.prototype.findMutationBatch=function(batchId){var index=this.indexOfBatchId(batchId);
if(0>index||index>=this.mutationQueue.length)return null;index=this.mutationQueue[index];assert(index.batchId===batchId,"If found batch must match");return index};return MemoryMutationQueue}(),MemoryQueryCache=function(){function MemoryQueryCache(persistence){this.persistence=persistence;this.queries=new ObjectMap(function(q){return q.canonicalId()});this.lastRemoteSnapshotVersion=SnapshotVersion.MIN;this.highestSequenceNumber=this.highestTargetId=0;this.references=new ReferenceSet;this.targetCount=
0;this.targetIdGenerator=TargetIdGenerator.forQueryCache()}MemoryQueryCache.prototype.getTargetCount=function(txn){return PersistencePromise.resolve(this.targetCount)};MemoryQueryCache.prototype.forEachTarget=function(txn,f){this.queries.forEach(function(_,queryData){return f(queryData)});return PersistencePromise.resolve()};MemoryQueryCache.prototype.getLastRemoteSnapshotVersion=function(transaction){return PersistencePromise.resolve(this.lastRemoteSnapshotVersion)};MemoryQueryCache.prototype.getHighestSequenceNumber=
function(transaction){return PersistencePromise.resolve(this.highestSequenceNumber)};MemoryQueryCache.prototype.allocateTargetId=function(transaction){this.highestTargetId=transaction=this.targetIdGenerator.after(this.highestTargetId);return PersistencePromise.resolve(transaction)};MemoryQueryCache.prototype.setTargetsMetadata=function(transaction,highestListenSequenceNumber,lastRemoteSnapshotVersion){lastRemoteSnapshotVersion&&(this.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion);highestListenSequenceNumber>
this.highestSequenceNumber&&(this.highestSequenceNumber=highestListenSequenceNumber);return PersistencePromise.resolve()};MemoryQueryCache.prototype.saveQueryData=function(queryData){this.queries.set(queryData.query,queryData);var targetId=queryData.targetId;targetId>this.highestTargetId&&(this.highestTargetId=targetId);queryData.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=queryData.sequenceNumber)};MemoryQueryCache.prototype.addQueryData=function(transaction,queryData){assert(!this.queries.has(queryData.query),
"Adding a query that already exists");this.saveQueryData(queryData);this.targetCount+=1;return PersistencePromise.resolve()};MemoryQueryCache.prototype.updateQueryData=function(transaction,queryData){assert(this.queries.has(queryData.query),"Updating a non-existent query");this.saveQueryData(queryData);return PersistencePromise.resolve()};MemoryQueryCache.prototype.removeQueryData=function(transaction,queryData){assert(0<this.targetCount,"Removing a target from an empty cache");assert(this.queries.has(queryData.query),
"Removing a non-existent target from the cache");this.queries.delete(queryData.query);this.references.removeReferencesForId(queryData.targetId);--this.targetCount;return PersistencePromise.resolve()};MemoryQueryCache.prototype.removeTargets=function(transaction,upperBound,activeTargetIds){var _this=this,count=0,removals=[];this.queries.forEach(function(key,queryData){queryData.sequenceNumber<=upperBound&&!activeTargetIds[queryData.targetId]&&(_this.queries.delete(key),removals.push(_this.removeMatchingKeysForTargetId(transaction,
queryData.targetId)),count++)});return PersistencePromise.waitFor(removals).next(function(){return count})};MemoryQueryCache.prototype.getQueryCount=function(transaction){return PersistencePromise.resolve(this.targetCount)};MemoryQueryCache.prototype.getQueryData=function(transaction,query){transaction=this.queries.get(query)||null;return PersistencePromise.resolve(transaction)};MemoryQueryCache.prototype.getQueryDataForTarget=function(transaction,targetId){return fail("Not yet implemented.")};MemoryQueryCache.prototype.addMatchingKeys=
function(txn,keys,targetId){this.references.addReferences(keys,targetId);var referenceDelegate=this.persistence.referenceDelegate,promises=[];referenceDelegate&&keys.forEach(function(key){promises.push(referenceDelegate.addReference(txn,key))});return PersistencePromise.waitFor(promises)};MemoryQueryCache.prototype.removeMatchingKeys=function(txn,keys,targetId){this.references.removeReferences(keys,targetId);var referenceDelegate=this.persistence.referenceDelegate,promises=[];referenceDelegate&&keys.forEach(function(key){promises.push(referenceDelegate.removeReference(txn,
key))});return PersistencePromise.waitFor(promises)};MemoryQueryCache.prototype.removeMatchingKeysForTargetId=function(txn,targetId){this.references.removeReferencesForId(targetId);return PersistencePromise.resolve()};MemoryQueryCache.prototype.getMatchingKeysForTargetId=function(txn,targetId){txn=this.references.referencesForId(targetId);return PersistencePromise.resolve(txn)};MemoryQueryCache.prototype.containsKey=function(txn,key){return PersistencePromise.resolve(this.references.containsKey(key))};
return MemoryQueryCache}(),MemoryRemoteDocumentCache=function(){function MemoryRemoteDocumentCache(indexManager,sizer){this.indexManager=indexManager;this.sizer=sizer;this.docs=new SortedMap$jscomp$0(DocumentKey.comparator);this.newDocumentChanges=documentKeySet();this.size=0}MemoryRemoteDocumentCache.prototype.addEntries=function(transaction,entries,sizeDelta){for(var promises=[],_i=0;_i<entries.length;_i++){var entry=entries[_i],key=entry.maybeDocument.key;this.docs=this.docs.insert(key,entry);
this.newDocumentChanges=this.newDocumentChanges.add(key);promises.push(this.indexManager.addToCollectionParentIndex(transaction,key.path.popLast()))}this.size+=sizeDelta;return PersistencePromise.waitFor(promises)};MemoryRemoteDocumentCache.prototype.removeEntry=function(transaction,documentKey){return(transaction=this.docs.get(documentKey))?(this.docs=this.docs.remove(documentKey),this.size-=transaction.size,PersistencePromise.resolve(transaction.size)):PersistencePromise.resolve(0)};MemoryRemoteDocumentCache.prototype.getEntry=
function(transaction,documentKey){transaction=this.docs.get(documentKey);return PersistencePromise.resolve(transaction?transaction.maybeDocument:null)};MemoryRemoteDocumentCache.prototype.getSizedEntry=function(transaction,documentKey){return PersistencePromise.resolve(this.docs.get(documentKey))};MemoryRemoteDocumentCache.prototype.getEntries=function(transaction,documentKeys){var _this=this,results=EMPTY_MAYBE_DOCUMENT_MAP;documentKeys.forEach(function(documentKey){var entry=_this.docs.get(documentKey);
results=results.insert(documentKey,entry?entry.maybeDocument:null)});return PersistencePromise.resolve(results)};MemoryRemoteDocumentCache.prototype.getSizedEntries=function(transaction,documentKeys){var _this=this,results=EMPTY_MAYBE_DOCUMENT_MAP,sizeMap=new SortedMap$jscomp$0(DocumentKey.comparator);documentKeys.forEach(function(documentKey){var entry=_this.docs.get(documentKey);results=results.insert(documentKey,entry?entry.maybeDocument:null);sizeMap=sizeMap.insert(documentKey,entry?entry.size:
0)});return PersistencePromise.resolve({maybeDocuments:results,sizeMap:sizeMap})};MemoryRemoteDocumentCache.prototype.getDocumentsMatchingQuery=function(transaction,query){assert(!query.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");transaction=EMPTY_DOCUMENT_MAP;var prefix=new DocumentKey(query.path.child(""));for(prefix=this.docs.getIteratorFrom(prefix);prefix.hasNext();){var _a=prefix.getNext(),maybeDocument=_a.value.maybeDocument;if(!query.path.isPrefixOf(_a.key.path))break;
maybeDocument instanceof Document$jscomp$0&&query.matches(maybeDocument)&&(transaction=transaction.insert(maybeDocument.key,maybeDocument))}return PersistencePromise.resolve(transaction)};MemoryRemoteDocumentCache.prototype.forEachDocumentKey=function(transaction,f){return PersistencePromise.forEach(this.docs,function(key){return f(key)})};MemoryRemoteDocumentCache.prototype.getNewDocumentChanges=function(transaction){var _this=this,changedDocs=EMPTY_MAYBE_DOCUMENT_MAP;this.newDocumentChanges.forEach(function(key){var entry=
_this.docs.get(key);entry=entry?entry.maybeDocument:new NoDocument(key,SnapshotVersion.forDeletedDoc());changedDocs=changedDocs.insert(key,entry)});this.newDocumentChanges=documentKeySet();return PersistencePromise.resolve(changedDocs)};MemoryRemoteDocumentCache.prototype.newChangeBuffer=function(){return new MemoryRemoteDocumentChangeBuffer(this.sizer,this)};MemoryRemoteDocumentCache.prototype.getSize=function(txn){return PersistencePromise.resolve(this.size)};return MemoryRemoteDocumentCache}(),
MemoryRemoteDocumentChangeBuffer=function(_super){function MemoryRemoteDocumentChangeBuffer(sizer,documentCache){var _this=_super.call(this)||this;_this.sizer=sizer;_this.documentCache=documentCache;return _this}tslib_1.__extends(MemoryRemoteDocumentChangeBuffer,_super);MemoryRemoteDocumentChangeBuffer.prototype.applyChanges=function(transaction){var _this=this,delta=0,docs=[];this.assertChanges().forEach(function(key,maybeDocument){var previousSize=_this.documentSizes.get(key);assert(void 0!==previousSize,
"Attempting to change document "+key.toString()+" without having read it first");key=_this.sizer(maybeDocument);delta+=key-previousSize;docs.push({maybeDocument:maybeDocument,size:key})});return this.documentCache.addEntries(transaction,docs,delta)};MemoryRemoteDocumentChangeBuffer.prototype.getFromCache=function(transaction,documentKey){return this.documentCache.getSizedEntry(transaction,documentKey)};MemoryRemoteDocumentChangeBuffer.prototype.getAllFromCache=function(transaction,documentKeys){return this.documentCache.getSizedEntries(transaction,
documentKeys)};return MemoryRemoteDocumentChangeBuffer}(RemoteDocumentChangeBuffer),MemoryPersistence=function(){function MemoryPersistence(clientId,referenceDelegateFactory){var _this=this;this.clientId=clientId;this.mutationQueues={};this.listenSequence=new ListenSequence(0);this._started=!1;this._started=!0;this.referenceDelegate=referenceDelegateFactory(this);this.queryCache=new MemoryQueryCache(this);this.indexManager=new MemoryIndexManager;this.remoteDocumentCache=new MemoryRemoteDocumentCache(this.indexManager,
function(doc){return _this.referenceDelegate.documentSize(doc)})}MemoryPersistence.createLruPersistence=function(clientId,serializer,params){return new MemoryPersistence(clientId,function(p){return new MemoryLruDelegate(p,new LocalSerializer(serializer),params)})};MemoryPersistence.createEagerPersistence=function(clientId){return new MemoryPersistence(clientId,function(p){return new MemoryEagerDelegate(p)})};MemoryPersistence.prototype.shutdown=function(deleteData){this._started=!1;return Promise.resolve()};
Object.defineProperty(MemoryPersistence.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0});MemoryPersistence.prototype.getActiveClients=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return[2,[this.clientId]]})})};MemoryPersistence.prototype.setPrimaryStateListener=function(primaryStateListener){return primaryStateListener(!0)};MemoryPersistence.prototype.setNetworkEnabled=function(networkEnabled){};
MemoryPersistence.prototype.getIndexManager=function(){return this.indexManager};MemoryPersistence.prototype.getMutationQueue=function(user){var queue=this.mutationQueues[user.toKey()];queue||(queue=new MemoryMutationQueue(this.indexManager,this.referenceDelegate),this.mutationQueues[user.toKey()]=queue);return queue};MemoryPersistence.prototype.getQueryCache=function(){return this.queryCache};MemoryPersistence.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache};MemoryPersistence.prototype.runTransaction=
function(action,mode,transactionOperation){var _this=this;debug("MemoryPersistence","Starting transaction:",action);var txn=new MemoryTransaction(this.listenSequence.next());this.referenceDelegate.onTransactionStarted();return transactionOperation(txn).next(function(result){return _this.referenceDelegate.onTransactionCommitted(txn).next(function(){return result})}).toPromise()};MemoryPersistence.prototype.mutationQueuesContainKey=function(transaction,key){return PersistencePromise.or(values$jscomp$0(this.mutationQueues).map(function(queue){return function(){return queue.containsKey(transaction,
key)}}))};return MemoryPersistence}(),MemoryTransaction=function(){return function(currentSequenceNumber){this.currentSequenceNumber=currentSequenceNumber}}(),MemoryEagerDelegate=function(){function MemoryEagerDelegate(persistence){this.persistence=persistence}MemoryEagerDelegate.prototype.setInMemoryPins=function(inMemoryPins){this.inMemoryPins=inMemoryPins};MemoryEagerDelegate.prototype.addReference=function(txn,key){this.orphanedDocuments.delete(key);return PersistencePromise.resolve()};MemoryEagerDelegate.prototype.removeReference=
function(txn,key){this.orphanedDocuments.add(key);return PersistencePromise.resolve()};MemoryEagerDelegate.prototype.removeMutationReference=function(txn,key){this.orphanedDocuments.add(key);return PersistencePromise.resolve()};MemoryEagerDelegate.prototype.removeTarget=function(txn,queryData){var _this=this,cache=this.persistence.getQueryCache();return cache.getMatchingKeysForTargetId(txn,queryData.targetId).next(function(keys){keys.forEach(function(key){return _this.orphanedDocuments.add(key)})}).next(function(){return cache.removeQueryData(txn,
queryData)})};MemoryEagerDelegate.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set};MemoryEagerDelegate.prototype.onTransactionCommitted=function(txn){var _this=this,cache=this.persistence.getRemoteDocumentCache();return PersistencePromise.forEach(this.orphanedDocuments,function(key){return _this.isReferenced(txn,key).next(function(isReferenced){return isReferenced?PersistencePromise.resolve():cache.removeEntry(txn,key).next(function(){})})})};MemoryEagerDelegate.prototype.updateLimboDocument=
function(txn,key){var _this=this;return this.isReferenced(txn,key).next(function(isReferenced){isReferenced?_this.orphanedDocuments.delete(key):_this.orphanedDocuments.add(key)})};MemoryEagerDelegate.prototype.documentSize=function(doc){return 0};MemoryEagerDelegate.prototype.isReferenced=function(txn,key){var _this=this;return PersistencePromise.or([function(){return _this.persistence.getQueryCache().containsKey(txn,key)},function(){return _this.persistence.mutationQueuesContainKey(txn,key)},function(){return PersistencePromise.resolve(_this.inMemoryPins.containsKey(key))}])};
return MemoryEagerDelegate}(),MemoryLruDelegate=function(){function MemoryLruDelegate(persistence,serializer,lruParams){this.persistence=persistence;this.serializer=serializer;this.orphanedSequenceNumbers=new ObjectMap(function(k){return encode(k.path)});this.garbageCollector=new LruGarbageCollector(this,lruParams)}MemoryLruDelegate.prototype.onTransactionStarted=function(){};MemoryLruDelegate.prototype.onTransactionCommitted=function(txn){return PersistencePromise.resolve()};MemoryLruDelegate.prototype.forEachTarget=
function(txn,f){return this.persistence.getQueryCache().forEachTarget(txn,f)};MemoryLruDelegate.prototype.getSequenceNumberCount=function(txn){var docCountPromise=this.orphanedDocumentCount(txn);return this.persistence.getQueryCache().getTargetCount(txn).next(function(targetCount){return docCountPromise.next(function(docCount){return targetCount+docCount})})};MemoryLruDelegate.prototype.orphanedDocumentCount=function(txn){var orphanedCount=0;return this.forEachOrphanedDocumentSequenceNumber(txn,function(_){orphanedCount++}).next(function(){return orphanedCount})};
MemoryLruDelegate.prototype.forEachOrphanedDocumentSequenceNumber=function(txn,f){var _this=this;return PersistencePromise.forEach(this.orphanedSequenceNumbers,function(key,sequenceNumber){return _this.isPinned(txn,key,sequenceNumber).next(function(isPinned){return isPinned?PersistencePromise.resolve():f(sequenceNumber)})})};MemoryLruDelegate.prototype.setInMemoryPins=function(inMemoryPins){this.inMemoryPins=inMemoryPins};MemoryLruDelegate.prototype.removeTargets=function(txn,upperBound,activeTargetIds){return this.persistence.getQueryCache().removeTargets(txn,
upperBound,activeTargetIds)};MemoryLruDelegate.prototype.removeOrphanedDocuments=function(txn,upperBound){var _this=this,count=0,cache=this.persistence.getRemoteDocumentCache();return cache.forEachDocumentKey(txn,function(key){return _this.isPinned(txn,key,upperBound).next(function(isPinned){if(isPinned)return PersistencePromise.resolve();count++;return cache.removeEntry(txn,key).next()})}).next(function(){return count})};MemoryLruDelegate.prototype.removeMutationReference=function(txn,key){this.orphanedSequenceNumbers.set(key,
txn.currentSequenceNumber);return PersistencePromise.resolve()};MemoryLruDelegate.prototype.removeTarget=function(txn,queryData){queryData=queryData.copy({sequenceNumber:txn.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(txn,queryData)};MemoryLruDelegate.prototype.addReference=function(txn,key){this.orphanedSequenceNumbers.set(key,txn.currentSequenceNumber);return PersistencePromise.resolve()};MemoryLruDelegate.prototype.removeReference=function(txn,key){this.orphanedSequenceNumbers.set(key,
txn.currentSequenceNumber);return PersistencePromise.resolve()};MemoryLruDelegate.prototype.updateLimboDocument=function(txn,key){this.orphanedSequenceNumbers.set(key,txn.currentSequenceNumber);return PersistencePromise.resolve()};MemoryLruDelegate.prototype.documentSize=function(maybeDoc){maybeDoc=this.serializer.toDbRemoteDocument(maybeDoc);if(maybeDoc.document)maybeDoc=maybeDoc.document;else if(maybeDoc.unknownDocument)maybeDoc=maybeDoc.unknownDocument;else if(maybeDoc.noDocument)maybeDoc=maybeDoc.noDocument;
else throw fail("Unknown remote document type");return JSON.stringify(maybeDoc).length};MemoryLruDelegate.prototype.isPinned=function(txn,key,upperBound){var _this=this;return PersistencePromise.or([function(){return _this.persistence.mutationQueuesContainKey(txn,key)},function(){return PersistencePromise.resolve(_this.inMemoryPins.containsKey(key))},function(){return _this.persistence.getQueryCache().containsKey(txn,key)},function(){var orphanedAt=_this.orphanedSequenceNumbers.get(key);return PersistencePromise.resolve(void 0!==
orphanedAt&&orphanedAt>upperBound)}])};MemoryLruDelegate.prototype.getCacheSize=function(txn){return this.persistence.getRemoteDocumentCache().getSize(txn)};return MemoryLruDelegate}(),ExponentialBackoff=function(){function ExponentialBackoff(queue,timerId,initialDelayMs,backoffFactor,maxDelayMs){this.queue=queue;this.timerId=timerId;this.initialDelayMs=initialDelayMs;this.backoffFactor=backoffFactor;this.maxDelayMs=maxDelayMs;this.timerPromise=null;this.lastAttemptTime=Date.now();this.reset()}ExponentialBackoff.prototype.reset=
function(){this.currentBaseMs=0};ExponentialBackoff.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs};ExponentialBackoff.prototype.backoffAndRun=function(op){var _this=this;this.cancel();var desiredDelayWithJitterMs=Math.floor(this.currentBaseMs+this.jitterDelayMs()),delaySoFarMs=Math.max(0,Date.now()-this.lastAttemptTime),remainingDelayMs=Math.max(0,desiredDelayWithJitterMs-delaySoFarMs);0<this.currentBaseMs&&debug("ExponentialBackoff","Backing off for "+remainingDelayMs+" ms "+
("(base delay: "+this.currentBaseMs+" ms, ")+("delay with jitter: "+desiredDelayWithJitterMs+" ms, ")+("last attempt: "+delaySoFarMs+" ms ago)"));this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,remainingDelayMs,function(){_this.lastAttemptTime=Date.now();return op()});this.currentBaseMs*=this.backoffFactor;this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs);this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)};ExponentialBackoff.prototype.cancel=
function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)};ExponentialBackoff.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs};return ExponentialBackoff}(),PersistentStreamState;(function(PersistentStreamState){PersistentStreamState[PersistentStreamState.Initial=0]="Initial";PersistentStreamState[PersistentStreamState.Starting=1]="Starting";PersistentStreamState[PersistentStreamState.Open=2]="Open";PersistentStreamState[PersistentStreamState.Error=
3]="Error";PersistentStreamState[PersistentStreamState.Backoff=4]="Backoff"})(PersistentStreamState||(PersistentStreamState={}));var PersistentStream=function(){function PersistentStream(queue,connectionTimerId,idleTimerId,connection,credentialsProvider,listener){this.queue=queue;this.idleTimerId=idleTimerId;this.connection=connection;this.credentialsProvider=credentialsProvider;this.listener=listener;this.state=PersistentStreamState.Initial;this.closeCount=0;this.stream=this.idleTimer=null;this.backoff=
new ExponentialBackoff(queue,connectionTimerId,1E3,1.5,6E4)}PersistentStream.prototype.isStarted=function(){return this.state===PersistentStreamState.Starting||this.state===PersistentStreamState.Open||this.state===PersistentStreamState.Backoff};PersistentStream.prototype.isOpen=function(){return this.state===PersistentStreamState.Open};PersistentStream.prototype.start=function(){this.state===PersistentStreamState.Error?this.performBackoff():(assert(this.state===PersistentStreamState.Initial,"Already started"),
this.auth())};PersistentStream.prototype.stop=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return this.isStarted()?[4,this.close(PersistentStreamState.Initial)]:[3,2];case 1:_a.sent(),_a.label=2;case 2:return[2]}})})};PersistentStream.prototype.inhibitBackoff=function(){assert(!this.isStarted(),"Can only inhibit backoff in a stopped state");this.state=PersistentStreamState.Initial;this.backoff.reset()};PersistentStream.prototype.markIdle=
function(){var _this=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6E4,function(){return _this.handleIdleCloseTimer()}))};PersistentStream.prototype.sendRequest=function(msg){this.cancelIdleCheck();this.stream.send(msg)};PersistentStream.prototype.handleIdleCloseTimer=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return this.isOpen()?[2,this.close(PersistentStreamState.Initial)]:
[2]})})};PersistentStream.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)};PersistentStream.prototype.close=function(finalState,error$1){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return assert(this.isStarted(),"Only started streams should be closed."),assert(finalState===PersistentStreamState.Error||isNullOrUndefined(error$1),"Can't provide an error when not in an error state."),
this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,finalState!==PersistentStreamState.Error?this.backoff.reset():error$1&&error$1.code===Code.RESOURCE_EXHAUSTED?(error$jscomp$0(error$1.toString()),error$jscomp$0("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):error$1&&error$1.code===Code.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=finalState,
[4,this.listener.onClose(error$1)];case 1:return _a.sent(),[2]}})})};PersistentStream.prototype.tearDown=function(){};PersistentStream.prototype.auth=function(){var _this=this;assert(this.state===PersistentStreamState.Initial,"Must be in initial state to auth");this.state=PersistentStreamState.Starting;var dispatchIfNotClosed=this.getCloseGuardedDispatcher(this.closeCount),closeCount=this.closeCount;this.credentialsProvider.getToken().then(function(token){_this.closeCount===closeCount&&_this.startStream(token)},
function(error){dispatchIfNotClosed(function(){var rpcError=new FirestoreError(Code.UNKNOWN,"Fetching auth token failed: "+error.message);return _this.handleStreamClose(rpcError)})})};PersistentStream.prototype.startStream=function(token){var _this=this;assert(this.state===PersistentStreamState.Starting,"Trying to start stream in a non-starting state");var dispatchIfNotClosed=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(token);this.stream.onOpen(function(){dispatchIfNotClosed(function(){assert(_this.state===
PersistentStreamState.Starting,"Expected stream to be in state Starting, but was "+_this.state);_this.state=PersistentStreamState.Open;return _this.listener.onOpen()})});this.stream.onClose(function(error){dispatchIfNotClosed(function(){return _this.handleStreamClose(error)})});this.stream.onMessage(function(msg){dispatchIfNotClosed(function(){return _this.onMessage(msg)})})};PersistentStream.prototype.performBackoff=function(){var _this=this;assert(this.state===PersistentStreamState.Error,"Should only perform backoff when in Error state");
this.state=PersistentStreamState.Backoff;this.backoff.backoffAndRun(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){assert(this.state===PersistentStreamState.Backoff,"Backoff elapsed but state is now: "+this.state);this.state=PersistentStreamState.Initial;this.start();assert(this.isStarted(),"PersistentStream should have started");return[2]})})})};PersistentStream.prototype.handleStreamClose=function(error){assert(this.isStarted(),"Can't handle server close on non-started stream");
debug("PersistentStream","close with error: "+error);this.stream=null;return this.close(PersistentStreamState.Error,error)};PersistentStream.prototype.getCloseGuardedDispatcher=function(startCloseCount){var _this=this;return function(fn){_this.queue.enqueueAndForget(function(){if(_this.closeCount===startCloseCount)return fn();debug("PersistentStream","stream callback skipped by getCloseGuardedDispatcher.");return Promise.resolve()})}};return PersistentStream}(),PersistentListenStream=function(_super){function PersistentListenStream(queue,
connection,credentials,serializer,listener){queue=_super.call(this,queue,TimerId.ListenStreamConnectionBackoff,TimerId.ListenStreamIdle,connection,credentials,listener)||this;queue.serializer=serializer;return queue}tslib_1.__extends(PersistentListenStream,_super);PersistentListenStream.prototype.startRpc=function(token){return this.connection.openStream("Listen",token)};PersistentListenStream.prototype.onMessage=function(watchChangeProto){this.backoff.reset();var watchChange=this.serializer.fromWatchChange(watchChangeProto);
watchChangeProto=this.serializer.versionFromListenResponse(watchChangeProto);return this.listener.onWatchChange(watchChange,watchChangeProto)};PersistentListenStream.prototype.watch=function(queryData){var request={};request.database=this.serializer.encodedDatabaseId;request.addTarget=this.serializer.toTarget(queryData);if(queryData=this.serializer.toListenRequestLabels(queryData))request.labels=queryData;this.sendRequest(request)};PersistentListenStream.prototype.unwatch=function(targetId){var request=
{};request.database=this.serializer.encodedDatabaseId;request.removeTarget=targetId;this.sendRequest(request)};return PersistentListenStream}(PersistentStream),PersistentWriteStream=function(_super){function PersistentWriteStream(queue,connection,credentials,serializer,listener){queue=_super.call(this,queue,TimerId.WriteStreamConnectionBackoff,TimerId.WriteStreamIdle,connection,credentials,listener)||this;queue.serializer=serializer;queue.handshakeComplete_=!1;return queue}tslib_1.__extends(PersistentWriteStream,
_super);Object.defineProperty(PersistentWriteStream.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0});PersistentWriteStream.prototype.start=function(){this.handshakeComplete_=!1;_super.prototype.start.call(this)};PersistentWriteStream.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])};PersistentWriteStream.prototype.startRpc=function(token){return this.connection.openStream("Write",token)};PersistentWriteStream.prototype.onMessage=
function(responseProto){assert(!!responseProto.streamToken,"Got a write response without a stream token");this.lastStreamToken=responseProto.streamToken;if(this.handshakeComplete_){this.backoff.reset();var results=this.serializer.fromWriteResults(responseProto.writeResults,responseProto.commitTime);responseProto=this.serializer.fromVersion(responseProto.commitTime);return this.listener.onMutationResult(responseProto,results)}assert(!responseProto.writeResults||0===responseProto.writeResults.length,
"Got mutation results for handshake");this.handshakeComplete_=!0;return this.listener.onHandshakeComplete()};PersistentWriteStream.prototype.writeHandshake=function(){assert(this.isOpen(),"Writing handshake requires an opened stream");assert(!this.handshakeComplete_,"Handshake already completed");var request={};request.database=this.serializer.encodedDatabaseId;this.sendRequest(request)};PersistentWriteStream.prototype.writeMutations=function(mutations){var _this=this;assert(this.isOpen(),"Writing mutations requires an opened stream");
assert(this.handshakeComplete_,"Handshake must be complete before writing mutations");assert(0<this.lastStreamToken.length,"Trying to write mutation without a token");mutations={streamToken:this.lastStreamToken,writes:mutations.map(function(mutation){return _this.serializer.toMutation(mutation)})};this.sendRequest(mutations)};return PersistentWriteStream}(PersistentStream),Datastore=function(){function Datastore(queue,connection,credentials,serializer){this.queue=queue;this.connection=connection;
this.credentials=credentials;this.serializer=serializer}Datastore.prototype.newPersistentWriteStream=function(listener){return new PersistentWriteStream(this.queue,this.connection,this.credentials,this.serializer,listener)};Datastore.prototype.newPersistentWatchStream=function(listener){return new PersistentListenStream(this.queue,this.connection,this.credentials,this.serializer,listener)};Datastore.prototype.commit=function(mutations){var _this=this;mutations={database:this.serializer.encodedDatabaseId,
writes:mutations.map(function(m){return _this.serializer.toMutation(m)})};return this.invokeRPC("Commit",mutations).then(function(response){return _this.serializer.fromWriteResults(response.writeResults,response.commitTime)})};Datastore.prototype.lookup=function(keys){var _this=this,params={database:this.serializer.encodedDatabaseId,documents:keys.map(function(k){return _this.serializer.toName(k)})};return this.invokeStreamingRPC("BatchGetDocuments",params).then(function(response){var docs=EMPTY_MAYBE_DOCUMENT_MAP;
response.forEach(function(proto){proto=_this.serializer.fromMaybeDocument(proto);docs=docs.insert(proto.key,proto)});var result=[];keys.forEach(function(key){var doc=docs.get(key);assert(!!doc,"Missing entity in write response for "+key);result.push(doc)});return result})};Datastore.prototype.invokeRPC=function(rpcName,request){var _this=this;return this.credentials.getToken().then(function(token){return _this.connection.invokeRPC(rpcName,request,token)}).catch(function(error){error.code===Code.UNAUTHENTICATED&&
_this.credentials.invalidateToken();throw error;})};Datastore.prototype.invokeStreamingRPC=function(rpcName,request){var _this=this;return this.credentials.getToken().then(function(token){return _this.connection.invokeStreamingRPC(rpcName,request,token)}).catch(function(error){error.code===Code.UNAUTHENTICATED&&_this.credentials.invalidateToken();throw error;})};return Datastore}(),Transaction=function(){function Transaction(datastore){this.datastore=datastore;this.readVersions=EMPTY_DOCUMENT_VERSION_MAP;
this.mutations=[];this.committed=!1}Transaction.prototype.recordVersion=function(doc){if(doc instanceof Document$jscomp$0)var docVersion=doc.version;else if(doc instanceof NoDocument)docVersion=SnapshotVersion.forDeletedDoc();else throw fail("Document in a transaction was a "+doc.constructor.name);var existingVersion=this.readVersions.get(doc.key);if(null!==existingVersion){if(!docVersion.isEqual(existingVersion))throw new FirestoreError(Code.ABORTED,"Document version changed between two reads.");
}else this.readVersions=this.readVersions.insert(doc.key,docVersion)};Transaction.prototype.lookup=function(keys){var _this=this;return this.committed?Promise.reject("Transaction has already completed."):0<this.mutations.length?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(keys).then(function(docs){docs.forEach(function(doc){doc instanceof NoDocument||doc instanceof Document$jscomp$0?_this.recordVersion(doc):fail("Document in a transaction was a "+doc.constructor.name)});
return docs})};Transaction.prototype.write=function(mutations){if(this.committed)throw new FirestoreError(Code.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(mutations)};Transaction.prototype.precondition=function(key){return(key=this.readVersions.get(key))?Precondition.updateTime(key):Precondition.NONE};Transaction.prototype.preconditionForUpdate=function(key){if((key=this.readVersions.get(key))&&key.isEqual(SnapshotVersion.forDeletedDoc()))throw new FirestoreError(Code.FAILED_PRECONDITION,
"Can't update a document that doesn't exist.");return key?Precondition.updateTime(key):Precondition.exists(!0)};Transaction.prototype.set=function(key,data){this.write(data.toMutations(key,this.precondition(key)))};Transaction.prototype.update=function(key,data){this.write(data.toMutations(key,this.preconditionForUpdate(key)))};Transaction.prototype.delete=function(key){this.write([new DeleteMutation(key,this.precondition(key))]);this.readVersions=this.readVersions.insert(key,SnapshotVersion.forDeletedDoc())};
Transaction.prototype.commit=function(){var _this=this,unwritten=this.readVersions;this.mutations.forEach(function(mutation){unwritten=unwritten.remove(mutation.key)});return unwritten.isEmpty()?this.datastore.commit(this.mutations).then(function(){_this.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))};return Transaction}(),OnlineState;(function(OnlineState){OnlineState[OnlineState.Unknown=0]="Unknown";OnlineState[OnlineState.Online=1]="Online";OnlineState[OnlineState.Offline=
2]="Offline"})(OnlineState||(OnlineState={}));var OnlineStateSource;(function(OnlineStateSource){OnlineStateSource[OnlineStateSource.RemoteStore=0]="RemoteStore";OnlineStateSource[OnlineStateSource.SharedClientState=1]="SharedClientState"})(OnlineStateSource||(OnlineStateSource={}));var OnlineStateTracker=function(){function OnlineStateTracker(asyncQueue,onlineStateHandler){this.asyncQueue=asyncQueue;this.onlineStateHandler=onlineStateHandler;this.state=OnlineState.Unknown;this.watchStreamFailures=
0;this.onlineStateTimer=null;this.shouldWarnClientIsOffline=!0}OnlineStateTracker.prototype.handleWatchStreamStart=function(){var _this=this;0===this.watchStreamFailures&&(this.setAndBroadcast(OnlineState.Unknown),assert(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(TimerId.OnlineStateTimeout,1E4,function(){_this.onlineStateTimer=null;assert(_this.state===OnlineState.Unknown,"Timer should be canceled if we transitioned to a different state.");
_this.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds.");_this.setAndBroadcast(OnlineState.Offline);return Promise.resolve()}))};OnlineStateTracker.prototype.handleWatchStreamFailure=function(error){this.state===OnlineState.Online?(this.setAndBroadcast(OnlineState.Unknown),assert(0===this.watchStreamFailures,"watchStreamFailures must be 0"),assert(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),
this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+error.toString()),this.setAndBroadcast(OnlineState.Offline)))};OnlineStateTracker.prototype.set=function(newState){this.clearOnlineStateTimer();this.watchStreamFailures=0;newState===OnlineState.Online&&(this.shouldWarnClientIsOffline=!1);this.setAndBroadcast(newState)};OnlineStateTracker.prototype.setAndBroadcast=function(newState){newState!==this.state&&(this.state=newState,this.onlineStateHandler(newState))};
OnlineStateTracker.prototype.logClientOfflineWarningIfNecessary=function(details){details="Could not reach Cloud Firestore backend. "+details+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(error$jscomp$0(details),this.shouldWarnClientIsOffline=!1):debug("OnlineStateTracker",details)};OnlineStateTracker.prototype.clearOnlineStateTimer=
function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)};return OnlineStateTracker}(),RemoteStore=function(){function RemoteStore(localStore,datastore,asyncQueue,onlineStateHandler){this.localStore=localStore;this.datastore=datastore;this.writePipeline=[];this.listenTargets={};this.watchChangeAggregator=null;this.isPrimary=this.networkEnabled=!1;this.onlineStateTracker=new OnlineStateTracker(asyncQueue,onlineStateHandler);this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),
onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)});this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}RemoteStore.prototype.start=function(){return this.enableNetwork()};RemoteStore.prototype.enableNetwork=function(){return tslib_1.__awaiter(this,void 0,
void 0,function(){var _a;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:this.networkEnabled=!0;if(!this.canUseNetwork())return[3,3];_a=this.writeStream;return[4,this.localStore.getLastStreamToken()];case 1:return _a.lastStreamToken=_b.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(OnlineState.Unknown),[4,this.fillWritePipeline()];case 2:_b.sent(),_b.label=3;case 3:return[2]}})})};RemoteStore.prototype.disableNetwork=function(){return tslib_1.__awaiter(this,
void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return _a.sent(),this.onlineStateTracker.set(OnlineState.Offline),[2]}})})};RemoteStore.prototype.disableNetworkInternal=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.writeStream.stop()];case 1:return _a.sent(),[4,this.watchStream.stop()];
case 2:return _a.sent(),0<this.writePipeline.length&&(debug("RemoteStore","Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})};RemoteStore.prototype.shutdown=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return debug("RemoteStore","RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return _a.sent(),
this.onlineStateTracker.set(OnlineState.Unknown),[2]}})})};RemoteStore.prototype.listen=function(queryData){assert(!Object.prototype.hasOwnProperty.call(this.listenTargets,queryData.targetId),"listen called with duplicate targetId!");this.listenTargets[queryData.targetId]=queryData;this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(queryData)};RemoteStore.prototype.unlisten=function(targetId){assert(Object.prototype.hasOwnProperty.call(this.listenTargets,
targetId),"unlisten called without assigned target ID!");delete this.listenTargets[targetId];this.watchStream.isOpen()&&this.sendUnwatchRequest(targetId);isEmpty(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(OnlineState.Unknown))};RemoteStore.prototype.getQueryDataForTarget=function(targetId){return this.listenTargets[targetId]||null};RemoteStore.prototype.getRemoteKeysForTarget=function(targetId){return this.syncEngine.getRemoteKeysForTarget(targetId)};
RemoteStore.prototype.sendWatchRequest=function(queryData){this.watchChangeAggregator.recordPendingTargetRequest(queryData.targetId);this.watchStream.watch(queryData)};RemoteStore.prototype.sendUnwatchRequest=function(targetId){this.watchChangeAggregator.recordPendingTargetRequest(targetId);this.watchStream.unwatch(targetId)};RemoteStore.prototype.startWatchStream=function(){assert(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false.");this.watchChangeAggregator=
new WatchChangeAggregator(this);this.watchStream.start();this.onlineStateTracker.handleWatchStreamStart()};RemoteStore.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!isEmpty(this.listenTargets)};RemoteStore.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled};RemoteStore.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null};RemoteStore.prototype.onWatchStreamOpen=function(){return tslib_1.__awaiter(this,
void 0,void 0,function(){var _this=this;return tslib_1.__generator(this,function(_a){forEachNumber(this.listenTargets,function(targetId,queryData){_this.sendWatchRequest(queryData)});return[2]})})};RemoteStore.prototype.onWatchStreamClose=function(error){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){void 0===error&&assert(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed.");this.cleanUpWatchStreamState();this.shouldStartWatchStream()?
(this.onlineStateTracker.handleWatchStreamFailure(error),this.startWatchStream()):this.onlineStateTracker.set(OnlineState.Unknown);return[2]})})};RemoteStore.prototype.onWatchStreamChange=function(watchChange,snapshotVersion){return tslib_1.__awaiter(this,void 0,void 0,function(){var lastRemoteSnapshotVersion;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.onlineStateTracker.set(OnlineState.Online);if(watchChange instanceof WatchTargetChange&&watchChange.state===WatchTargetChangeState.Removed&&
watchChange.cause)return[2,this.handleTargetError(watchChange)];watchChange instanceof DocumentWatchChange?this.watchChangeAggregator.handleDocumentChange(watchChange):watchChange instanceof ExistenceFilterChange?this.watchChangeAggregator.handleExistenceFilter(watchChange):(assert(watchChange instanceof WatchTargetChange,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(watchChange));return snapshotVersion.isEqual(SnapshotVersion.MIN)?[3,
3]:[4,this.localStore.getLastRemoteSnapshotVersion()];case 1:return lastRemoteSnapshotVersion=_a.sent(),0<=snapshotVersion.compareTo(lastRemoteSnapshotVersion)?[4,this.raiseWatchSnapshot(snapshotVersion)]:[3,3];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})};RemoteStore.prototype.raiseWatchSnapshot=function(snapshotVersion){var _this=this;assert(!snapshotVersion.isEqual(SnapshotVersion.MIN),"Can't raise event for unknown SnapshotVersion");var remoteEvent=this.watchChangeAggregator.createRemoteEvent(snapshotVersion);
forEachNumber(remoteEvent.targetChanges,function(targetId,change){if(0<change.resumeToken.length){var queryData=_this.listenTargets[targetId];queryData&&(_this.listenTargets[targetId]=queryData.copy({resumeToken:change.resumeToken,snapshotVersion:snapshotVersion}))}});remoteEvent.targetMismatches.forEach(function(targetId){var queryData=_this.listenTargets[targetId];queryData&&(_this.listenTargets[targetId]=queryData.copy({resumeToken:emptyByteString()}),_this.sendUnwatchRequest(targetId),targetId=
new QueryData(queryData.query,targetId,QueryPurpose.ExistenceFilterMismatch,queryData.sequenceNumber),_this.sendWatchRequest(targetId))});return this.syncEngine.applyRemoteEvent(remoteEvent)};RemoteStore.prototype.handleTargetError=function(watchChange){var _this=this;assert(!!watchChange.cause,"Handling target error without a cause");var error=watchChange.cause,promiseChain=Promise.resolve();watchChange.targetIds.forEach(function(targetId){promiseChain=promiseChain.then(function(){return tslib_1.__awaiter(_this,
void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return Object.prototype.hasOwnProperty.call(this.listenTargets,targetId)?(delete this.listenTargets[targetId],this.watchChangeAggregator.removeTarget(targetId),[2,this.syncEngine.rejectListen(targetId,error)]):[2]})})})});return promiseChain};RemoteStore.prototype.fillWritePipeline=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var lastBatchIdRetrieved,batch;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!this.canAddToWritePipeline())return[3,
4];lastBatchIdRetrieved=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1;return[4,this.localStore.nextMutationBatch(lastBatchIdRetrieved)];case 1:batch=_a.sent();if(null!==batch)return[3,2];0===this.writePipeline.length&&this.writeStream.markIdle();return[3,4];case 2:return this.addToWritePipeline(batch),[4,this.fillWritePipeline()];case 3:_a.sent(),_a.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})};RemoteStore.prototype.canAddToWritePipeline=
function(){return this.canUseNetwork()&&10>this.writePipeline.length};RemoteStore.prototype.outstandingWrites=function(){return this.writePipeline.length};RemoteStore.prototype.addToWritePipeline=function(batch){assert(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full");this.writePipeline.push(batch);this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(batch.mutations)};RemoteStore.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&
!this.writeStream.isStarted()&&0<this.writePipeline.length};RemoteStore.prototype.startWriteStream=function(){assert(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false.");this.writeStream.start()};RemoteStore.prototype.onWriteStreamOpen=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){this.writeStream.writeHandshake();return[2]})})};RemoteStore.prototype.onWriteHandshakeComplete=function(){var _this=
this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var _i=0,_a=_this.writePipeline;_i<_a.length;_i++)_this.writeStream.writeMutations(_a[_i].mutations)}).catch(ignoreIfPrimaryLeaseLoss)};RemoteStore.prototype.onMutationResult=function(commitVersion,results){var _this=this;assert(0<this.writePipeline.length,"Got result for empty write pipeline");var batch=this.writePipeline.shift();commitVersion=MutationBatchResult.from(batch,commitVersion,results,
this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(commitVersion).then(function(){return _this.fillWritePipeline()})};RemoteStore.prototype.onWriteStreamClose=function(error){return tslib_1.__awaiter(this,void 0,void 0,function(){var errorHandling,_this=this;return tslib_1.__generator(this,function(_a){void 0===error&&assert(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed.");return error&&0<this.writePipeline.length?(errorHandling=
void 0,errorHandling=this.writeStream.handshakeComplete?this.handleWriteError(error):this.handleHandshakeError(error),[2,errorHandling.then(function(){_this.shouldStartWriteStream()&&_this.startWriteStream()})]):[2]})})};RemoteStore.prototype.handleHandshakeError=function(error){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return isPermanentError(error.code)?(debug("RemoteStore","RemoteStore error before completed handshake; resetting stream token: ",
this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=emptyByteString(),[2,this.localStore.setLastStreamToken(emptyByteString()).catch(ignoreIfPrimaryLeaseLoss)]):[2]})})};RemoteStore.prototype.handleWriteError=function(error){return tslib_1.__awaiter(this,void 0,void 0,function(){var batch,_this=this;return tslib_1.__generator(this,function(_a){return isPermanentWriteError(error.code)?(batch=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(batch.batchId,
error).then(function(){return _this.fillWritePipeline()})]):[2]})})};RemoteStore.prototype.createTransaction=function(){return new Transaction(this.datastore)};RemoteStore.prototype.handleCredentialChange=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!this.canUseNetwork())return[3,3];debug("RemoteStore","RemoteStore restarting streams for new credential");this.networkEnabled=!1;return[4,this.disableNetworkInternal()];
case 1:return _a.sent(),this.onlineStateTracker.set(OnlineState.Unknown),[4,this.enableNetwork()];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})};RemoteStore.prototype.applyPrimaryState=function(isPrimary){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return(this.isPrimary=isPrimary)&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return _a.sent(),[3,4];case 2:return isPrimary?[3,4]:[4,this.disableNetworkInternal()];
case 3:_a.sent(),this.onlineStateTracker.set(OnlineState.Unknown),_a.label=4;case 4:return[2]}})})};return RemoteStore}(),QueryListenersInfo=function(){return function(){this.listeners=[]}}(),EventManager=function(){function EventManager(syncEngine){this.syncEngine=syncEngine;this.queries=new ObjectMap(function(q){return q.canonicalId()});this.onlineState=OnlineState.Unknown;this.syncEngine.subscribe(this)}EventManager.prototype.listen=function(listener){var query=listener.query,firstListen=!1,queryInfo=
this.queries.get(query);queryInfo||(firstListen=!0,queryInfo=new QueryListenersInfo,this.queries.set(query,queryInfo));queryInfo.listeners.push(listener);listener.applyOnlineStateChange(this.onlineState);if(queryInfo.viewSnap)listener.onViewSnapshot(queryInfo.viewSnap);return firstListen?this.syncEngine.listen(query).then(function(targetId){return queryInfo.targetId=targetId}):Promise.resolve(queryInfo.targetId)};EventManager.prototype.unlisten=function(listener){return tslib_1.__awaiter(this,void 0,
void 0,function(){var query,lastListen,queryInfo,i;return tslib_1.__generator(this,function(_a){query=listener.query;lastListen=!1;if(queryInfo=this.queries.get(query))i=queryInfo.listeners.indexOf(listener),0<=i&&(queryInfo.listeners.splice(i,1),lastListen=0===queryInfo.listeners.length);return lastListen?(this.queries.delete(query),[2,this.syncEngine.unlisten(query)]):[2]})})};EventManager.prototype.onWatchChange=function(viewSnaps){for(var _i=0;_i<viewSnaps.length;_i++){var viewSnap=viewSnaps[_i],
queryInfo=this.queries.get(viewSnap.query);if(queryInfo){for(var _a=0,_b=queryInfo.listeners;_a<_b.length;_a++)_b[_a].onViewSnapshot(viewSnap);queryInfo.viewSnap=viewSnap}}};EventManager.prototype.onWatchError=function(query,error){var queryInfo=this.queries.get(query);if(queryInfo){var _i=0;for(queryInfo=queryInfo.listeners;_i<queryInfo.length;_i++)queryInfo[_i].onError(error)}this.queries.delete(query)};EventManager.prototype.onOnlineStateChange=function(onlineState){this.onlineState=onlineState;
this.queries.forEach(function(_,queryInfo){_=0;for(queryInfo=queryInfo.listeners;_<queryInfo.length;_++)queryInfo[_].applyOnlineStateChange(onlineState)})};return EventManager}(),QueryListener=function(){function QueryListener(query,queryObserver,options){this.query=query;this.queryObserver=queryObserver;this.raisedInitialEvent=!1;this.onlineState=OnlineState.Unknown;this.options=options||{}}QueryListener.prototype.onViewSnapshot=function(snap){assert(0<snap.docChanges.length||snap.syncStateChanged,
"We got a new snapshot with no changes?");if(!this.options.includeMetadataChanges){for(var docChanges=[],_i=0,_a=snap.docChanges;_i<_a.length;_i++){var docChange=_a[_i];docChange.type!==ChangeType.Metadata&&docChanges.push(docChange)}snap=new ViewSnapshot(snap.query,snap.docs,snap.oldDocs,docChanges,snap.mutatedKeys,snap.fromCache,snap.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(snap)&&this.queryObserver.next(snap):this.shouldRaiseInitialEvent(snap,this.onlineState)&&this.raiseInitialEvent(snap);
this.snap=snap};QueryListener.prototype.onError=function(error){this.queryObserver.error(error)};QueryListener.prototype.applyOnlineStateChange=function(onlineState){this.onlineState=onlineState;this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,onlineState)&&this.raiseInitialEvent(this.snap)};QueryListener.prototype.shouldRaiseInitialEvent=function(snap,onlineState){assert(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event");if(!snap.fromCache)return!0;
var maybeOnline=onlineState!==OnlineState.Offline;return this.options.waitForSyncWhenOnline&&maybeOnline?(assert(snap.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!snap.docs.isEmpty()||onlineState===OnlineState.Offline};QueryListener.prototype.shouldRaiseEvent=function(snap){if(0<snap.docChanges.length)return!0;var hasPendingWritesChanged=this.snap&&this.snap.hasPendingWrites!==snap.hasPendingWrites;return snap.syncStateChanged||hasPendingWritesChanged?!0===this.options.includeMetadataChanges:
!1};QueryListener.prototype.raiseInitialEvent=function(snap){assert(!this.raisedInitialEvent,"Trying to raise initial events for second time");snap=ViewSnapshot.fromInitialDocuments(snap.query,snap.docs,snap.mutatedKeys,snap.fromCache);this.raisedInitialEvent=!0;this.queryObserver.next(snap)};return QueryListener}(),LocalViewChanges=function(){function LocalViewChanges(targetId,addedKeys,removedKeys){this.targetId=targetId;this.addedKeys=addedKeys;this.removedKeys=removedKeys}LocalViewChanges.fromSnapshot=
function(targetId,viewSnapshot){var addedKeys=documentKeySet(),removedKeys=documentKeySet(),_i=0;for(viewSnapshot=viewSnapshot.docChanges;_i<viewSnapshot.length;_i++){var docChange=viewSnapshot[_i];switch(docChange.type){case ChangeType.Added:addedKeys=addedKeys.add(docChange.doc.key);break;case ChangeType.Removed:removedKeys=removedKeys.add(docChange.doc.key)}}return new LocalViewChanges(targetId,addedKeys,removedKeys)};return LocalViewChanges}(),AddedLimboDocument=function(){return function(key){this.key=
key}}(),RemovedLimboDocument=function(){return function(key){this.key=key}}(),View$jscomp$0=function(){function View(query,_syncedDocuments){this.query=query;this._syncedDocuments=_syncedDocuments;this.syncState=null;this.current=!1;this.limboDocuments=documentKeySet();this.mutatedKeys=documentKeySet();this.documentSet=new DocumentSet(query.docComparator.bind(query))}Object.defineProperty(View.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0});
View.prototype.computeDocChanges=function(docChanges,previousChanges){var _this=this,changeSet=previousChanges?previousChanges.changeSet:new DocumentChangeSet,oldDocumentSet=previousChanges?previousChanges.documentSet:this.documentSet,newMutatedKeys=previousChanges?previousChanges.mutatedKeys:this.mutatedKeys,newDocumentSet=oldDocumentSet,needsRefill=!1,lastDocInLimit=this.query.hasLimit()&&oldDocumentSet.size===this.query.limit?oldDocumentSet.last():null;docChanges.inorderTraversal(function(key,
newMaybeDoc){var oldDoc=oldDocumentSet.get(key);if(newMaybeDoc=newMaybeDoc instanceof Document$jscomp$0?newMaybeDoc:null)assert(key.isEqual(newMaybeDoc.key),"Mismatching keys found in document changes: "+key+" !\x3d "+newMaybeDoc.key),newMaybeDoc=_this.query.matches(newMaybeDoc)?newMaybeDoc:null;var oldDocHadPendingMutations=oldDoc?_this.mutatedKeys.has(oldDoc.key):!1,newDocHasPendingMutations=newMaybeDoc?newMaybeDoc.hasLocalMutations||_this.mutatedKeys.has(newMaybeDoc.key)&&newMaybeDoc.hasCommittedMutations:
!1,changeApplied=!1;oldDoc&&newMaybeDoc?oldDoc.data.isEqual(newMaybeDoc.data)?oldDocHadPendingMutations!==newDocHasPendingMutations&&(changeSet.track({type:ChangeType.Metadata,doc:newMaybeDoc}),changeApplied=!0):_this.shouldWaitForSyncedDocument(oldDoc,newMaybeDoc)||(changeSet.track({type:ChangeType.Modified,doc:newMaybeDoc}),changeApplied=!0,lastDocInLimit&&0<_this.query.docComparator(newMaybeDoc,lastDocInLimit)&&(needsRefill=!0)):!oldDoc&&newMaybeDoc?(changeSet.track({type:ChangeType.Added,doc:newMaybeDoc}),
changeApplied=!0):oldDoc&&!newMaybeDoc&&(changeSet.track({type:ChangeType.Removed,doc:oldDoc}),changeApplied=!0,lastDocInLimit&&(needsRefill=!0));changeApplied&&(newMaybeDoc?(newDocumentSet=newDocumentSet.add(newMaybeDoc),newMutatedKeys=newDocHasPendingMutations?newMutatedKeys.add(key):newMutatedKeys.delete(key)):(newDocumentSet=newDocumentSet.delete(key),newMutatedKeys=newMutatedKeys.delete(key)))});if(this.query.hasLimit())for(;newDocumentSet.size>this.query.limit;)docChanges=newDocumentSet.last(),
newDocumentSet=newDocumentSet.delete(docChanges.key),newMutatedKeys=newMutatedKeys.delete(docChanges.key),changeSet.track({type:ChangeType.Removed,doc:docChanges});assert(!needsRefill||!previousChanges,"View was refilled using docs that themselves needed refilling.");return{documentSet:newDocumentSet,changeSet:changeSet,needsRefill:needsRefill,mutatedKeys:newMutatedKeys}};View.prototype.shouldWaitForSyncedDocument=function(oldDoc,newDoc){return oldDoc.hasLocalMutations&&newDoc.hasCommittedMutations&&
!newDoc.hasLocalMutations};View.prototype.applyChanges=function(docChanges,updateLimboDocuments,targetChange){var _this=this;assert(!docChanges.needsRefill,"Cannot apply changes that need a refill");var oldDocs=this.documentSet;this.documentSet=docChanges.documentSet;this.mutatedKeys=docChanges.mutatedKeys;var changes=docChanges.changeSet.getChanges();changes.sort(function(c1,c2){return compareChangeType(c1.type,c2.type)||_this.query.docComparator(c1.doc,c2.doc)});this.applyTargetChange(targetChange);
updateLimboDocuments=updateLimboDocuments?this.updateLimboDocuments():[];targetChange=0===this.limboDocuments.size&&this.current?SyncState.Synced:SyncState.Local;var syncStateChanged=targetChange!==this.syncState;this.syncState=targetChange;return 0!==changes.length||syncStateChanged?{snapshot:new ViewSnapshot(this.query,docChanges.documentSet,oldDocs,changes,docChanges.mutatedKeys,targetChange===SyncState.Local,syncStateChanged,!1),limboChanges:updateLimboDocuments}:{limboChanges:updateLimboDocuments}};
View.prototype.applyOnlineStateChange=function(onlineState){return this.current&&onlineState===OnlineState.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new DocumentChangeSet,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}};View.prototype.shouldBeInLimbo=function(key){return this._syncedDocuments.has(key)||!this.documentSet.has(key)||this.documentSet.get(key).hasLocalMutations?!1:!0};View.prototype.applyTargetChange=function(targetChange){var _this=
this;targetChange&&(targetChange.addedDocuments.forEach(function(key){return _this._syncedDocuments=_this._syncedDocuments.add(key)}),targetChange.modifiedDocuments.forEach(function(key){return assert(_this._syncedDocuments.has(key),"Modified document "+key+" not found in view.")}),targetChange.removedDocuments.forEach(function(key){return _this._syncedDocuments=_this._syncedDocuments.delete(key)}),this.current=targetChange.current)};View.prototype.updateLimboDocuments=function(){var _this=this;if(!this.current)return[];
var oldLimboDocuments=this.limboDocuments;this.limboDocuments=documentKeySet();this.documentSet.forEach(function(doc){_this.shouldBeInLimbo(doc.key)&&(_this.limboDocuments=_this.limboDocuments.add(doc.key))});var changes=[];oldLimboDocuments.forEach(function(key){_this.limboDocuments.has(key)||changes.push(new RemovedLimboDocument(key))});this.limboDocuments.forEach(function(key){oldLimboDocuments.has(key)||changes.push(new AddedLimboDocument(key))});return changes};View.prototype.synchronizeWithPersistedState=
function(localDocs,remoteKeys){this._syncedDocuments=remoteKeys;this.limboDocuments=documentKeySet();localDocs=this.computeDocChanges(localDocs);return this.applyChanges(localDocs,!0)};View.prototype.computeInitialSnapshot=function(){return ViewSnapshot.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===SyncState.Local)};return View}(),QueryView=function(){return function(query,targetId,view){this.query=query;this.targetId=targetId;this.view=view}}(),LimboResolution=
function(){return function(key){this.key=key}}(),SyncEngine=function(){function SyncEngine(localStore,remoteStore,sharedClientState,currentUser){this.localStore=localStore;this.remoteStore=remoteStore;this.sharedClientState=sharedClientState;this.currentUser=currentUser;this.syncEngineListener=null;this.queryViewsByQuery=new ObjectMap(function(q){return q.canonicalId()});this.queryViewsByTarget={};this.limboTargetsByKey=new SortedMap$jscomp$0(DocumentKey.comparator);this.limboResolutionsByTarget=
{};this.limboDocumentRefs=new ReferenceSet;this.mutationUserCallbacks={};this.limboTargetIdGenerator=TargetIdGenerator.forSyncEngine();this.isPrimary=void 0;this.onlineState=OnlineState.Unknown}Object.defineProperty(SyncEngine.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0});SyncEngine.prototype.subscribe=function(syncEngineListener){assert(null!==syncEngineListener,"SyncEngine listener cannot be null");assert(null===this.syncEngineListener,"SyncEngine already has a subscriber.");
this.syncEngineListener=syncEngineListener};SyncEngine.prototype.listen=function(query){return tslib_1.__awaiter(this,void 0,void 0,function(){var targetId,viewSnapshot,queryView,queryData,status_1;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.assertSubscribed("listen()");queryView=this.queryViewsByQuery.get(query);if(!queryView)return[3,1];targetId=queryView.targetId;this.sharedClientState.addLocalQueryTarget(targetId);viewSnapshot=queryView.view.computeInitialSnapshot();
return[3,4];case 1:return[4,this.localStore.allocateQuery(query)];case 2:return queryData=_a.sent(),status_1=this.sharedClientState.addLocalQueryTarget(queryData.targetId),targetId=queryData.targetId,[4,this.initializeViewAndComputeSnapshot(queryData,"current"===status_1)];case 3:viewSnapshot=_a.sent(),this.isPrimary&&this.remoteStore.listen(queryData),_a.label=4;case 4:return this.syncEngineListener.onWatchChange([viewSnapshot]),[2,targetId]}})})};SyncEngine.prototype.initializeViewAndComputeSnapshot=
function(queryData,current){var _this=this,query=queryData.query;return this.localStore.executeQuery(query).then(function(docs){return _this.localStore.remoteDocumentKeys(queryData.targetId).then(function(remoteKeys){remoteKeys=new View$jscomp$0(query,remoteKeys);var viewDocChanges=remoteKeys.computeDocChanges(docs),synthesizedTargetChange=TargetChange.createSynthesizedTargetChangeForCurrentChange(queryData.targetId,current&&_this.onlineState!==OnlineState.Offline);viewDocChanges=remoteKeys.applyChanges(viewDocChanges,
!0===_this.isPrimary,synthesizedTargetChange);assert(0===viewDocChanges.limboChanges.length,"View returned limbo docs before target ack from the server.");assert(!!viewDocChanges.snapshot,"applyChanges for new view should always return a snapshot");remoteKeys=new QueryView(query,queryData.targetId,remoteKeys);_this.queryViewsByQuery.set(query,remoteKeys);_this.queryViewsByTarget[queryData.targetId]=remoteKeys;return viewDocChanges.snapshot})})};SyncEngine.prototype.synchronizeViewAndComputeSnapshot=
function(queryView){var _this=this;return this.localStore.executeQuery(queryView.query).then(function(docs){return _this.localStore.remoteDocumentKeys(queryView.targetId).then(function(remoteKeys){return tslib_1.__awaiter(_this,void 0,void 0,function(){var viewSnapshot;return tslib_1.__generator(this,function(_a){viewSnapshot=queryView.view.synchronizeWithPersistedState(docs,remoteKeys);this.isPrimary&&this.updateTrackedLimbos(queryView.targetId,viewSnapshot.limboChanges);return[2,viewSnapshot]})})})})};
SyncEngine.prototype.unlisten=function(query){return tslib_1.__awaiter(this,void 0,void 0,function(){var queryView,targetRemainsActive,_this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.assertSubscribed("unlisten()");queryView=this.queryViewsByQuery.get(query);assert(!!queryView,"Trying to unlisten on query not found:"+query);if(!this.isPrimary)return[3,3];this.sharedClientState.removeLocalQueryTarget(queryView.targetId);return(targetRemainsActive=this.sharedClientState.isActiveQueryTarget(queryView.targetId))?
[3,2]:[4,this.localStore.releaseQuery(query,!1).then(function(){_this.sharedClientState.clearQueryState(queryView.targetId);_this.remoteStore.unlisten(queryView.targetId);_this.removeAndCleanupQuery(queryView)}).catch(ignoreIfPrimaryLeaseLoss)];case 1:_a.sent(),_a.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(queryView),[4,this.localStore.releaseQuery(query,!0)];case 4:_a.sent(),_a.label=5;case 5:return[2]}})})};SyncEngine.prototype.write=function(batch,userCallback){var _this=
this;this.assertSubscribed("write()");return this.localStore.localWrite(batch).then(function(result){_this.sharedClientState.addPendingMutation(result.batchId);_this.addMutationCallback(result.batchId,userCallback);return _this.emitNewSnapsAndNotifyLocalStore(result.changes)}).then(function(){return _this.remoteStore.fillWritePipeline()})};SyncEngine.prototype.wrapUpdateFunctionError=function(error){return error};SyncEngine.prototype.runTransaction=function(updateFunction,retries){var _this=this;
void 0===retries&&(retries=5);assert(0<=retries,"Got negative number of retries for transaction.");var transaction=this.remoteStore.createTransaction();return function(){try{var userPromise=updateFunction(transaction);return!isNullOrUndefined(userPromise)&&userPromise.catch&&userPromise.then?userPromise.catch(function(e){return Promise.reject(_this.wrapUpdateFunctionError(e))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(e){return Promise.reject(_this.wrapUpdateFunctionError(e))}}().then(function(result){return transaction.commit().then(function(){return result}).catch(function(error){return 0===
retries?Promise.reject(error):_this.runTransaction(updateFunction,retries-1)})})};SyncEngine.prototype.applyRemoteEvent=function(remoteEvent){var _this=this;this.assertSubscribed("applyRemoteEvent()");return this.localStore.applyRemoteEvent(remoteEvent).then(function(changes){forEach(remoteEvent.targetChanges,function(targetId,targetChange){if(targetId=_this.limboResolutionsByTarget[targetId])assert(1>=targetChange.addedDocuments.size+targetChange.modifiedDocuments.size+targetChange.removedDocuments.size,
"Limbo resolution for single document contains multiple changes."),0<targetChange.addedDocuments.size?targetId.receivedDocument=!0:0<targetChange.modifiedDocuments.size?assert(targetId.receivedDocument,"Received change for limbo target document without add."):0<targetChange.removedDocuments.size&&(assert(targetId.receivedDocument,"Received remove for limbo target document without add."),targetId.receivedDocument=!1)});return _this.emitNewSnapsAndNotifyLocalStore(changes,remoteEvent)}).catch(ignoreIfPrimaryLeaseLoss)};
SyncEngine.prototype.applyOnlineStateChange=function(onlineState,source){if(this.isPrimary&&source===OnlineStateSource.RemoteStore||!this.isPrimary&&source===OnlineStateSource.SharedClientState){var newViewSnapshots_1=[];this.queryViewsByQuery.forEach(function(query,queryView){query=queryView.view.applyOnlineStateChange(onlineState);assert(0===query.limboChanges.length,"OnlineState should not affect limbo documents.");query.snapshot&&newViewSnapshots_1.push(query.snapshot)});this.syncEngineListener.onOnlineStateChange(onlineState);
this.syncEngineListener.onWatchChange(newViewSnapshots_1);this.onlineState=onlineState;this.isPrimary&&this.sharedClientState.setOnlineState(onlineState)}};SyncEngine.prototype.rejectListen=function(targetId,err){return tslib_1.__awaiter(this,void 0,void 0,function(){var limboResolution,limboKey,documentUpdates,resolvedLimboDocuments,event_1,queryView_1,_this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.assertSubscribed("rejectListens()");this.sharedClientState.updateQueryState(targetId,
"rejected",err);limboKey=(limboResolution=this.limboResolutionsByTarget[targetId])&&limboResolution.key;if(!limboKey)return[3,1];this.limboTargetsByKey=this.limboTargetsByKey.remove(limboKey);delete this.limboResolutionsByTarget[targetId];documentUpdates=new SortedMap$jscomp$0(DocumentKey.comparator);documentUpdates=documentUpdates.insert(limboKey,new NoDocument(limboKey,SnapshotVersion.forDeletedDoc()));resolvedLimboDocuments=documentKeySet().add(limboKey);event_1=new RemoteEvent(SnapshotVersion.MIN,
{},new SortedSet(primitiveComparator),documentUpdates,resolvedLimboDocuments);return[2,this.applyRemoteEvent(event_1)];case 1:return queryView_1=this.queryViewsByTarget[targetId],assert(!!queryView_1,"Unknown targetId: "+targetId),[4,this.localStore.releaseQuery(queryView_1.query,!1).then(function(){return _this.removeAndCleanupQuery(queryView_1)}).catch(ignoreIfPrimaryLeaseLoss)];case 2:_a.sent(),this.syncEngineListener.onWatchError(queryView_1.query,err),_a.label=3;case 3:return[2]}})})};SyncEngine.prototype.applyBatchState=
function(batchId,batchState,error){return tslib_1.__awaiter(this,void 0,void 0,function(){var documents;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(batchId)];case 1:return documents=_a.sent(),null===documents?(debug("SyncEngine","Cannot apply mutation batch with id: "+batchId),[2]):"pending"!==batchState?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return _a.sent(),[3,4];
case 3:"acknowledged"===batchState||"rejected"===batchState?(this.processUserCallback(batchId,error?error:null),this.localStore.removeCachedMutationBatchMetadata(batchId)):fail("Unknown batchState: "+batchState),_a.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(documents)];case 5:return _a.sent(),[2]}})})};SyncEngine.prototype.applySuccessfulWrite=function(mutationBatchResult){var _this=this;this.assertSubscribed("applySuccessfulWrite()");var batchId=mutationBatchResult.batch.batchId;
this.processUserCallback(batchId,null);return this.localStore.acknowledgeBatch(mutationBatchResult).then(function(changes){_this.sharedClientState.updateMutationState(batchId,"acknowledged");return _this.emitNewSnapsAndNotifyLocalStore(changes)}).catch(ignoreIfPrimaryLeaseLoss)};SyncEngine.prototype.rejectFailedWrite=function(batchId,error){var _this=this;this.assertSubscribed("rejectFailedWrite()");this.processUserCallback(batchId,error);return this.localStore.rejectBatch(batchId).then(function(changes){_this.sharedClientState.updateMutationState(batchId,
"rejected",error);return _this.emitNewSnapsAndNotifyLocalStore(changes)}).catch(ignoreIfPrimaryLeaseLoss)};SyncEngine.prototype.addMutationCallback=function(batchId,callback){var newCallbacks=this.mutationUserCallbacks[this.currentUser.toKey()];newCallbacks||(newCallbacks=new SortedMap$jscomp$0(primitiveComparator));newCallbacks=newCallbacks.insert(batchId,callback);this.mutationUserCallbacks[this.currentUser.toKey()]=newCallbacks};SyncEngine.prototype.processUserCallback=function(batchId,error){var newCallbacks=
this.mutationUserCallbacks[this.currentUser.toKey()];if(newCallbacks){var callback=newCallbacks.get(batchId);callback&&(assert(batchId===newCallbacks.minKey(),"Mutation callbacks processed out-of-order?"),error?callback.reject(error):callback.resolve(),newCallbacks=newCallbacks.remove(batchId));this.mutationUserCallbacks[this.currentUser.toKey()]=newCallbacks}};SyncEngine.prototype.removeAndCleanupQuery=function(queryView){var _this=this;this.sharedClientState.removeLocalQueryTarget(queryView.targetId);
this.queryViewsByQuery.delete(queryView.query);delete this.queryViewsByTarget[queryView.targetId];if(this.isPrimary){var limboKeys=this.limboDocumentRefs.referencesForId(queryView.targetId);this.limboDocumentRefs.removeReferencesForId(queryView.targetId);limboKeys.forEach(function(limboKey){_this.limboDocumentRefs.containsKey(limboKey)||_this.removeLimboTarget(limboKey)})}};SyncEngine.prototype.removeLimboTarget=function(key){var limboTargetId=this.limboTargetsByKey.get(key);null!==limboTargetId&&
(this.remoteStore.unlisten(limboTargetId),this.limboTargetsByKey=this.limboTargetsByKey.remove(key),delete this.limboResolutionsByTarget[limboTargetId])};SyncEngine.prototype.updateTrackedLimbos=function(targetId,limboChanges){for(var _i=0;_i<limboChanges.length;_i++){var limboChange=limboChanges[_i];limboChange instanceof AddedLimboDocument?(this.limboDocumentRefs.addReference(limboChange.key,targetId),this.trackLimboChange(limboChange)):limboChange instanceof RemovedLimboDocument?(debug("SyncEngine",
"Document no longer in limbo: "+limboChange.key),this.limboDocumentRefs.removeReference(limboChange.key,targetId),this.limboDocumentRefs.containsKey(limboChange.key)||this.removeLimboTarget(limboChange.key)):fail("Unknown limbo change: "+JSON.stringify(limboChange))}};SyncEngine.prototype.trackLimboChange=function(limboChange){limboChange=limboChange.key;if(!this.limboTargetsByKey.get(limboChange)){debug("SyncEngine","New document in limbo: "+limboChange);var limboTargetId=this.limboTargetIdGenerator.next(),
query=Query$jscomp$0.atPath(limboChange.path);this.limboResolutionsByTarget[limboTargetId]=new LimboResolution(limboChange);this.remoteStore.listen(new QueryData(query,limboTargetId,QueryPurpose.LimboResolution,ListenSequence.INVALID));this.limboTargetsByKey=this.limboTargetsByKey.insert(limboChange,limboTargetId)}};SyncEngine.prototype.currentLimboDocs=function(){return this.limboTargetsByKey};SyncEngine.prototype.emitNewSnapsAndNotifyLocalStore=function(changes,remoteEvent){return tslib_1.__awaiter(this,
void 0,void 0,function(){var newSnaps,docChangesInAllViews,queriesProcessed,_this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return newSnaps=[],docChangesInAllViews=[],queriesProcessed=[],this.queryViewsByQuery.forEach(function(_,queryView){queriesProcessed.push(Promise.resolve().then(function(){var viewDocChanges=queryView.view.computeDocChanges(changes);return viewDocChanges.needsRefill?_this.localStore.executeQuery(queryView.query).then(function(docs){return queryView.view.computeDocChanges(docs,
viewDocChanges)}):viewDocChanges}).then(function(viewDocChanges){viewDocChanges=queryView.view.applyChanges(viewDocChanges,!0===_this.isPrimary,remoteEvent&&remoteEvent.targetChanges[queryView.targetId]);_this.updateTrackedLimbos(queryView.targetId,viewDocChanges.limboChanges);viewDocChanges.snapshot&&(_this.isPrimary&&_this.sharedClientState.updateQueryState(queryView.targetId,viewDocChanges.snapshot.fromCache?"not-current":"current"),newSnaps.push(viewDocChanges.snapshot),viewDocChanges=LocalViewChanges.fromSnapshot(queryView.targetId,
viewDocChanges.snapshot),docChangesInAllViews.push(viewDocChanges))}))}),[4,Promise.all(queriesProcessed)];case 1:return _a.sent(),this.syncEngineListener.onWatchChange(newSnaps),[4,this.localStore.notifyLocalViewChanges(docChangesInAllViews)];case 2:return _a.sent(),[2]}})})};SyncEngine.prototype.assertSubscribed=function(fnName){assert(null!==this.syncEngineListener,"Trying to call "+fnName+" before calling subscribe().")};SyncEngine.prototype.handleCredentialChange=function(user){return tslib_1.__awaiter(this,
void 0,void 0,function(){var userChanged,result;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return userChanged=!this.currentUser.isEqual(user),this.currentUser=user,userChanged?[4,this.localStore.handleUserChange(user)]:[3,3];case 1:return result=_a.sent(),this.sharedClientState.handleUserChange(user,result.removedBatchIds,result.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(result.affectedDocuments)];case 2:_a.sent(),_a.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];
case 4:return _a.sent(),[2]}})})};SyncEngine.prototype.applyPrimaryState=function(isPrimary){return tslib_1.__awaiter(this,void 0,void 0,function(){var activeTargets,activeQueries,_i,activeQueries_1,queryData,activeTargets_1,p_1,_this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!0!==isPrimary||!0===this.isPrimary)return[3,3];this.isPrimary=!0;return[4,this.remoteStore.applyPrimaryState(!0)];case 1:return _a.sent(),activeTargets=this.sharedClientState.getAllActiveQueryTargets(),
[4,this.synchronizeQueryViewsAndRaiseSnapshots(activeTargets.toArray())];case 2:activeQueries=_a.sent();_i=0;for(activeQueries_1=activeQueries;_i<activeQueries_1.length;_i++)queryData=activeQueries_1[_i],this.remoteStore.listen(queryData);return[3,7];case 3:if(!1!==isPrimary||!1===this.isPrimary)return[3,7];this.isPrimary=!1;activeTargets_1=[];p_1=Promise.resolve();forEachNumber(this.queryViewsByTarget,function(targetId,queryView){_this.sharedClientState.isLocalQueryTarget(targetId)?activeTargets_1.push(targetId):
p_1=p_1.then(function(){return _this.unlisten(queryView.query)});_this.remoteStore.unlisten(queryView.targetId)});return[4,p_1];case 4:return _a.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(activeTargets_1)];case 5:return _a.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:_a.sent(),_a.label=7;case 7:return[2]}})})};SyncEngine.prototype.resetLimboDocuments=function(){var _this=this;forEachNumber(this.limboResolutionsByTarget,function(targetId){_this.remoteStore.unlisten(targetId)});
this.limboDocumentRefs.removeAllReferences();this.limboResolutionsByTarget=[];this.limboTargetsByKey=new SortedMap$jscomp$0(DocumentKey.comparator)};SyncEngine.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(targets){for(var _this=this,p=Promise.resolve(),activeQueries=[],newViewSnapshots=[],_loop_1=function(targetId){p=p.then(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var queryData,queryView,viewChange,query;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return(queryView=
this.queryViewsByTarget[targetId])?[4,this.localStore.releaseQuery(queryView.query,!0)]:[3,4];case 1:return _a.sent(),[4,this.localStore.allocateQuery(queryView.query)];case 2:return queryData=_a.sent(),[4,this.synchronizeViewAndComputeSnapshot(queryView)];case 3:return viewChange=_a.sent(),viewChange.snapshot&&newViewSnapshots.push(viewChange.snapshot),[3,8];case 4:return assert(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(targetId)];
case 5:return query=_a.sent(),assert(!!query,"Query data for target "+targetId+" not found"),[4,this.localStore.allocateQuery(query)];case 6:return queryData=_a.sent(),[4,this.initializeViewAndComputeSnapshot(queryData,!1)];case 7:_a.sent(),_a.label=8;case 8:return activeQueries.push(queryData),[2]}})})})},_i=0;_i<targets.length;_i++)_loop_1(targets[_i]);return p.then(function(){_this.syncEngineListener.onWatchChange(newViewSnapshots);return activeQueries})};SyncEngine.prototype.getActiveClients=
function(){return this.localStore.getActiveClients()};SyncEngine.prototype.applyTargetState=function(targetId,state,error){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a$jscomp$0,queryView,_this=this;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:if(this.isPrimary)return debug("SyncEngine","Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[targetId])return[3,5];_a$jscomp$0=state;switch(_a$jscomp$0){case "current":return[3,1];case "not-current":return[3,
1];case "rejected":return[3,2]}return[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(changes){return tslib_1.__awaiter(_this,void 0,void 0,function(){var synthesizedRemoteEvent;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return synthesizedRemoteEvent=RemoteEvent.createSynthesizedRemoteEventForCurrentChange(targetId,"current"===state),[4,this.emitNewSnapsAndNotifyLocalStore(changes,synthesizedRemoteEvent)];case 1:return _a.sent(),[2]}})})},function(err){return tslib_1.__awaiter(_this,
void 0,void 0,function(){var activeTargets_2;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(err.code!==Code.DATA_LOSS||"The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views."!==err.message)return[3,2];activeTargets_2=[];forEachNumber(this.queryViewsByTarget,function(target){return activeTargets_2.push(target)});return[4,this.synchronizeQueryViewsAndRaiseSnapshots(activeTargets_2)];case 1:return _a.sent(),
[3,3];case 2:throw err;case 3:return[2]}})})})];case 2:return queryView=this.queryViewsByTarget[targetId],this.removeAndCleanupQuery(queryView),[4,this.localStore.releaseQuery(queryView.query,!0)];case 3:return _b.sent(),this.syncEngineListener.onWatchError(queryView.query,error),[3,5];case 4:fail("Unexpected target state: "+state),_b.label=5;case 5:return[2]}})})};SyncEngine.prototype.applyActiveTargetsChange=function(added,removed){return tslib_1.__awaiter(this,void 0,void 0,function(){var _i,added_1,
targetId$jscomp$0,query,queryData,_loop_2,this_1,_a$jscomp$0,removed_1,_this=this;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:if(!this.isPrimary)return[2];_i=0;added_1=added;_b.label=1;case 1:if(!(_i<added_1.length))return[3,6];targetId$jscomp$0=added_1[_i];assert(!this.queryViewsByTarget[targetId$jscomp$0],"Trying to add an already active target");return[4,this.localStore.getQueryForTarget(targetId$jscomp$0)];case 2:return query=_b.sent(),assert(!!query,"Query data for active target "+
targetId$jscomp$0+" not found"),[4,this.localStore.allocateQuery(query)];case 3:return queryData=_b.sent(),[4,this.initializeViewAndComputeSnapshot(queryData,!1)];case 4:_b.sent(),this.remoteStore.listen(queryData),_b.label=5;case 5:return _i++,[3,1];case 6:_loop_2=function(targetId){var queryView;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return(queryView=this_1.queryViewsByTarget[targetId])?[4,this_1.localStore.releaseQuery(queryView.query,!1).then(function(){_this.remoteStore.unlisten(targetId);
_this.removeAndCleanupQuery(queryView)}).catch(ignoreIfPrimaryLeaseLoss)]:[3,2];case 1:_a.sent(),_a.label=2;case 2:return[2]}})},this_1=this,_a$jscomp$0=0,removed_1=removed,_b.label=7;case 7:if(!(_a$jscomp$0<removed_1.length))return[3,10];targetId$jscomp$0=removed_1[_a$jscomp$0];return[5,_loop_2(targetId$jscomp$0)];case 8:_b.sent(),_b.label=9;case 9:return _a$jscomp$0++,[3,7];case 10:return[2]}})})};SyncEngine.prototype.enableNetwork=function(){this.localStore.setNetworkEnabled(!0);return this.remoteStore.enableNetwork()};
SyncEngine.prototype.disableNetwork=function(){this.localStore.setNetworkEnabled(!1);return this.remoteStore.disableNetwork()};SyncEngine.prototype.getRemoteKeysForTarget=function(targetId){var limboResolution=this.limboResolutionsByTarget[targetId];return limboResolution&&limboResolution.receivedDocument?documentKeySet().add(limboResolution.key):this.queryViewsByTarget[targetId]?this.queryViewsByTarget[targetId].view.syncedDocuments:documentKeySet()};return SyncEngine}(),User=function(){function User(uid){this.uid=
uid}User.prototype.isAuthenticated=function(){return null!=this.uid};User.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"};User.prototype.isEqual=function(otherUser){return otherUser.uid===this.uid};User.UNAUTHENTICATED=new User(null);User.GOOGLE_CREDENTIALS=new User("google-credentials-uid");User.FIRST_PARTY=new User("first-party-uid");return User}(),MutationMetadata=function(){function MutationMetadata(user,batchId,state,error){this.user=user;this.batchId=
batchId;this.state=state;this.error=error;assert(void 0!==error===("rejected"===state),"MutationMetadata must contain an error iff state is 'rejected'")}MutationMetadata.fromWebStorageEntry=function(user,batchId,value){var mutationBatch=JSON.parse(value),validData="object"===typeof mutationBatch&&-1!==["pending","acknowledged","rejected"].indexOf(mutationBatch.state)&&(void 0===mutationBatch.error||"object"===typeof mutationBatch.error),firestoreError=void 0;validData&&mutationBatch.error&&(validData=
"string"===typeof mutationBatch.error.message&&"string"===typeof mutationBatch.error.code)&&(firestoreError=new FirestoreError(mutationBatch.error.code,mutationBatch.error.message));if(validData)return new MutationMetadata(user,batchId,mutationBatch.state,firestoreError);error$jscomp$0("SharedClientState","Failed to parse mutation state for ID '"+batchId+"': "+value);return null};MutationMetadata.prototype.toWebStorageJSON=function(){var batchMetadata={state:this.state,updateTimeMs:Date.now()};this.error&&
(batchMetadata.error={code:this.error.code,message:this.error.message});return JSON.stringify(batchMetadata)};return MutationMetadata}(),QueryTargetMetadata=function(){function QueryTargetMetadata(targetId,state,error){this.targetId=targetId;this.state=state;this.error=error;assert(void 0!==error===("rejected"===state),"QueryTargetMetadata must contain an error iff state is 'rejected'")}QueryTargetMetadata.fromWebStorageEntry=function(targetId,value){var targetState=JSON.parse(value),validData="object"===
typeof targetState&&-1!==["not-current","current","rejected"].indexOf(targetState.state)&&(void 0===targetState.error||"object"===typeof targetState.error),firestoreError=void 0;validData&&targetState.error&&(validData="string"===typeof targetState.error.message&&"string"===typeof targetState.error.code)&&(firestoreError=new FirestoreError(targetState.error.code,targetState.error.message));if(validData)return new QueryTargetMetadata(targetId,targetState.state,firestoreError);error$jscomp$0("SharedClientState",
"Failed to parse target state for ID '"+targetId+"': "+value);return null};QueryTargetMetadata.prototype.toWebStorageJSON=function(){var targetState={state:this.state,updateTimeMs:Date.now()};this.error&&(targetState.error={code:this.error.code,message:this.error.message});return JSON.stringify(targetState)};return QueryTargetMetadata}(),RemoteClientState=function(){function RemoteClientState(clientId,activeTargetIds){this.clientId=clientId;this.activeTargetIds=activeTargetIds}RemoteClientState.fromWebStorageEntry=
function(clientId,value){for(var clientState=JSON.parse(value),validData="object"===typeof clientState&&clientState.activeTargetIds instanceof Array,activeTargetIdsSet=EMPTY_TARGET_ID_SET,i=0;validData&&i<clientState.activeTargetIds.length;++i)validData=isSafeInteger(clientState.activeTargetIds[i]),activeTargetIdsSet=activeTargetIdsSet.add(clientState.activeTargetIds[i]);if(validData)return new RemoteClientState(clientId,activeTargetIdsSet);error$jscomp$0("SharedClientState","Failed to parse client data for instance '"+
clientId+"': "+value);return null};return RemoteClientState}(),SharedOnlineState=function(){function SharedOnlineState(clientId,onlineState){this.clientId=clientId;this.onlineState=onlineState}SharedOnlineState.fromWebStorageEntry=function(value){var onlineState=JSON.parse(value);if("object"===typeof onlineState&&void 0!==OnlineState[onlineState.onlineState]&&"string"===typeof onlineState.clientId)return new SharedOnlineState(onlineState.clientId,OnlineState[onlineState.onlineState]);error$jscomp$0("SharedClientState",
"Failed to parse online state: "+value);return null};return SharedOnlineState}(),LocalClientState=function(){function LocalClientState(){this.activeTargetIds=EMPTY_TARGET_ID_SET}LocalClientState.prototype.addQueryTarget=function(targetId){assert(!this.activeTargetIds.has(targetId),"Target with ID '"+targetId+"' already active.");this.activeTargetIds=this.activeTargetIds.add(targetId)};LocalClientState.prototype.removeQueryTarget=function(targetId){this.activeTargetIds=this.activeTargetIds.delete(targetId)};
LocalClientState.prototype.toWebStorageJSON=function(){var data={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(data)};return LocalClientState}(),WebStorageSharedClientState=function(){function WebStorageSharedClientState(queue,platform,persistenceKey,localClientId,initialUser){this.queue=queue;this.platform=platform;this.persistenceKey=persistenceKey;this.localClientId=localClientId;this.sequenceNumberHandler=this.onlineStateHandler=this.syncEngine=
null;this.activeClients={};this.storageListener=this.handleWebStorageEvent.bind(this);this.started=!1;this.earlyEvents=[];if(!WebStorageSharedClientState.isAvailable(this.platform))throw new FirestoreError(Code.UNIMPLEMENTED,"LocalStorage is not available on this platform.");queue=persistenceKey.replace(/[.*+?^${}()|[\]\\]/g,"\\$\x26");this.storage=this.platform.window.localStorage;this.currentUser=initialUser;this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId);this.sequenceNumberKey=
"firestore_sequence_number_"+persistenceKey;this.activeClients[this.localClientId]=new LocalClientState;this.clientStateKeyRe=new RegExp("^firestore_clients_"+queue+"_([^_]*)$");this.mutationBatchKeyRe=new RegExp("^firestore_mutations_"+queue+"_(\\d+)(?:_(.*))?$");this.queryTargetKeyRe=new RegExp("^firestore_targets_"+queue+"_(\\d+)$");this.onlineStateKey="firestore_online_state_"+persistenceKey;this.platform.window.addEventListener("storage",this.storageListener)}WebStorageSharedClientState.isAvailable=
function(platform){return!(!platform.window||null==platform.window.localStorage)};WebStorageSharedClientState.prototype.start=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var existingClients,_i,existingClients_1,clientId,storageItem,clientState,onlineStateJSON,onlineState,_a,_b,event_1,_this=this;return tslib_1.__generator(this,function(_c){switch(_c.label){case 0:return assert(!this.started,"WebStorageSharedClientState already started"),assert(null!==this.syncEngine,"syncEngine property must be set before calling start()"),
assert(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:existingClients=_c.sent();_i=0;for(existingClients_1=existingClients;_i<existingClients_1.length;_i++)clientId=existingClients_1[_i],clientId!==this.localClientId&&(storageItem=this.getItem(this.toWebStorageClientStateKey(clientId)))&&(clientState=RemoteClientState.fromWebStorageEntry(clientId,storageItem))&&(this.activeClients[clientState.clientId]=
clientState);this.persistClientState();(onlineStateJSON=this.storage.getItem(this.onlineStateKey))&&(onlineState=this.fromWebStorageOnlineState(onlineStateJSON))&&this.handleOnlineStateEvent(onlineState);_a=0;for(_b=this.earlyEvents;_a<_b.length;_a++)event_1=_b[_a],this.handleWebStorageEvent(event_1);this.earlyEvents=[];this.platform.window.addEventListener("unload",function(){return _this.shutdown()});this.started=!0;return[2]}})})};WebStorageSharedClientState.prototype.writeSequenceNumber=function(sequenceNumber){this.setItem(this.sequenceNumberKey,
JSON.stringify(sequenceNumber))};WebStorageSharedClientState.prototype.getAllActiveQueryTargets=function(){var activeTargets=EMPTY_TARGET_ID_SET;forEach(this.activeClients,function(key,value){activeTargets=activeTargets.unionWith(value.activeTargetIds)});return activeTargets};WebStorageSharedClientState.prototype.isActiveQueryTarget=function(targetId){for(var clientId in this.activeClients)if(this.activeClients.hasOwnProperty(clientId)&&this.activeClients[clientId].activeTargetIds.has(targetId))return!0;
return!1};WebStorageSharedClientState.prototype.addPendingMutation=function(batchId){this.persistMutationState(batchId,"pending")};WebStorageSharedClientState.prototype.updateMutationState=function(batchId,state,error){this.persistMutationState(batchId,state,error);this.removeMutationState(batchId)};WebStorageSharedClientState.prototype.addLocalQueryTarget=function(targetId){var queryState="not-current";if(this.isActiveQueryTarget(targetId)){var storageItem=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(targetId));
storageItem&&(storageItem=QueryTargetMetadata.fromWebStorageEntry(targetId,storageItem))&&(queryState=storageItem.state)}this.localClientState.addQueryTarget(targetId);this.persistClientState();return queryState};WebStorageSharedClientState.prototype.removeLocalQueryTarget=function(targetId){this.localClientState.removeQueryTarget(targetId);this.persistClientState()};WebStorageSharedClientState.prototype.isLocalQueryTarget=function(targetId){return this.localClientState.activeTargetIds.has(targetId)};
WebStorageSharedClientState.prototype.clearQueryState=function(targetId){this.removeItem(this.toWebStorageQueryTargetMetadataKey(targetId))};WebStorageSharedClientState.prototype.updateQueryState=function(targetId,state,error){this.persistQueryTargetState(targetId,state,error)};WebStorageSharedClientState.prototype.handleUserChange=function(user,removedBatchIds,addedBatchIds){var _this=this;removedBatchIds.forEach(function(batchId){_this.removeMutationState(batchId)});this.currentUser=user;addedBatchIds.forEach(function(batchId){_this.addPendingMutation(batchId)})};
WebStorageSharedClientState.prototype.setOnlineState=function(onlineState){this.persistOnlineState(onlineState)};WebStorageSharedClientState.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)};WebStorageSharedClientState.prototype.getItem=function(key){var value=this.storage.getItem(key);debug("SharedClientState","READ",key,value);return value};WebStorageSharedClientState.prototype.setItem=
function(key,value){debug("SharedClientState","SET",key,value);this.storage.setItem(key,value)};WebStorageSharedClientState.prototype.removeItem=function(key){debug("SharedClientState","REMOVE",key);this.storage.removeItem(key)};WebStorageSharedClientState.prototype.handleWebStorageEvent=function(event){var _this=this;event.storageArea===this.storage&&(debug("SharedClientState","EVENT",event.key,event.newValue),event.key===this.localClientStorageKey?error$jscomp$0("Received WebStorage notification for local change. Another client might have garbage-collected our state"):
this.queue.enqueueAndForget(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var clientState,clientId,mutationMetadata,queryTargetMetadata,onlineState,sequenceNumber$jscomp$0;return tslib_1.__generator(this,function(_a){if(!this.started)return this.earlyEvents.push(event),[2];if(null===event.key)return[2];if(this.clientStateKeyRe.test(event.key))if(null!=event.newValue){if(clientState=this.fromWebStorageClientState(event.key,event.newValue))return[2,this.handleClientStateEvent(clientState.clientId,
clientState)]}else return clientId=this.fromWebStorageClientStateKey(event.key),[2,this.handleClientStateEvent(clientId,null)];else if(this.mutationBatchKeyRe.test(event.key)){if(null!==event.newValue&&(mutationMetadata=this.fromWebStorageMutationMetadata(event.key,event.newValue)))return[2,this.handleMutationBatchEvent(mutationMetadata)]}else if(this.queryTargetKeyRe.test(event.key)){if(null!==event.newValue&&(queryTargetMetadata=this.fromWebStorageQueryTargetMetadata(event.key,event.newValue)))return[2,
this.handleQueryTargetEvent(queryTargetMetadata)]}else if(event.key===this.onlineStateKey){if(null!==event.newValue&&(onlineState=this.fromWebStorageOnlineState(event.newValue)))return[2,this.handleOnlineStateEvent(onlineState)]}else if(event.key===this.sequenceNumberKey){assert(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler");_a=event.newValue;var sequenceNumber=ListenSequence.INVALID;if(null!=_a)try{var parsed=JSON.parse(_a);assert("number"===typeof parsed,"Found non-numeric sequence number");
sequenceNumber=parsed}catch(e){error$jscomp$0("SharedClientState","Failed to read sequence number from WebStorage",e)}sequenceNumber$jscomp$0=sequenceNumber;sequenceNumber$jscomp$0!==ListenSequence.INVALID&&this.sequenceNumberHandler(sequenceNumber$jscomp$0)}return[2]})})}))};Object.defineProperty(WebStorageSharedClientState.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0});WebStorageSharedClientState.prototype.persistClientState=
function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())};WebStorageSharedClientState.prototype.persistMutationState=function(batchId,state,error){state=new MutationMetadata(this.currentUser,batchId,state,error);batchId=this.toWebStorageMutationBatchKey(batchId);this.setItem(batchId,state.toWebStorageJSON())};WebStorageSharedClientState.prototype.removeMutationState=function(batchId){batchId=this.toWebStorageMutationBatchKey(batchId);this.removeItem(batchId)};WebStorageSharedClientState.prototype.persistOnlineState=
function(onlineState){this.storage.setItem(this.onlineStateKey,JSON.stringify({clientId:this.localClientId,onlineState:OnlineState[onlineState]}))};WebStorageSharedClientState.prototype.persistQueryTargetState=function(targetId,state,error){var targetKey=this.toWebStorageQueryTargetMetadataKey(targetId);targetId=new QueryTargetMetadata(targetId,state,error);this.setItem(targetKey,targetId.toWebStorageJSON())};WebStorageSharedClientState.prototype.toWebStorageClientStateKey=function(clientId){assert(-1===
clientId.indexOf("_"),"Client key cannot contain '_', but was '"+clientId+"'");return"firestore_clients_"+this.persistenceKey+"_"+clientId};WebStorageSharedClientState.prototype.toWebStorageQueryTargetMetadataKey=function(targetId){return"firestore_targets_"+this.persistenceKey+"_"+targetId};WebStorageSharedClientState.prototype.toWebStorageMutationBatchKey=function(batchId){batchId="firestore_mutations_"+this.persistenceKey+"_"+batchId;this.currentUser.isAuthenticated()&&(batchId+="_"+this.currentUser.uid);
return batchId};WebStorageSharedClientState.prototype.fromWebStorageClientStateKey=function(key){return(key=this.clientStateKeyRe.exec(key))?key[1]:null};WebStorageSharedClientState.prototype.fromWebStorageClientState=function(key,value){var clientId=this.fromWebStorageClientStateKey(key);assert(null!==clientId,"Cannot parse client state key '"+key+"'");return RemoteClientState.fromWebStorageEntry(clientId,value)};WebStorageSharedClientState.prototype.fromWebStorageMutationMetadata=function(key,value){var match=
this.mutationBatchKeyRe.exec(key);assert(null!==match,"Cannot parse mutation batch key '"+key+"'");key=Number(match[1]);return MutationMetadata.fromWebStorageEntry(new User(void 0!==match[2]?match[2]:null),key,value)};WebStorageSharedClientState.prototype.fromWebStorageQueryTargetMetadata=function(key,value){var match=this.queryTargetKeyRe.exec(key);assert(null!==match,"Cannot parse query target key '"+key+"'");return QueryTargetMetadata.fromWebStorageEntry(Number(match[1]),value)};WebStorageSharedClientState.prototype.fromWebStorageOnlineState=
function(value){return SharedOnlineState.fromWebStorageEntry(value)};WebStorageSharedClientState.prototype.handleMutationBatchEvent=function(mutationBatch){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return mutationBatch.user.uid!==this.currentUser.uid?(debug("SharedClientState","Ignoring mutation for non-active user "+mutationBatch.user.uid),[2]):[2,this.syncEngine.applyBatchState(mutationBatch.batchId,mutationBatch.state,mutationBatch.error)]})})};
WebStorageSharedClientState.prototype.handleQueryTargetEvent=function(targetMetadata){return this.syncEngine.applyTargetState(targetMetadata.targetId,targetMetadata.state,targetMetadata.error)};WebStorageSharedClientState.prototype.handleClientStateEvent=function(clientId,clientState){var _this=this,existingTargets=this.getAllActiveQueryTargets();clientState?this.activeClients[clientId]=clientState:delete this.activeClients[clientId];var newTargets=this.getAllActiveQueryTargets(),addedTargets=[],
removedTargets=[];newTargets.forEach(function(targetId){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){existingTargets.has(targetId)||addedTargets.push(targetId);return[2]})})});existingTargets.forEach(function(targetId){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){newTargets.has(targetId)||removedTargets.push(targetId);return[2]})})});return this.syncEngine.applyActiveTargetsChange(addedTargets,
removedTargets)};WebStorageSharedClientState.prototype.handleOnlineStateEvent=function(onlineState){if(this.activeClients[onlineState.clientId])this.onlineStateHandler(onlineState.onlineState)};return WebStorageSharedClientState}(),MemorySharedClientState=function(){function MemorySharedClientState(){this.localState=new LocalClientState;this.queryState={};this.sequenceNumberHandler=this.onlineStateHandler=this.syncEngine=null}MemorySharedClientState.prototype.addPendingMutation=function(batchId){};
MemorySharedClientState.prototype.updateMutationState=function(batchId,state,error){};MemorySharedClientState.prototype.addLocalQueryTarget=function(targetId){this.localState.addQueryTarget(targetId);return this.queryState[targetId]||"not-current"};MemorySharedClientState.prototype.updateQueryState=function(targetId,state,error){this.queryState[targetId]=state};MemorySharedClientState.prototype.removeLocalQueryTarget=function(targetId){this.localState.removeQueryTarget(targetId)};MemorySharedClientState.prototype.isLocalQueryTarget=
function(targetId){return this.localState.activeTargetIds.has(targetId)};MemorySharedClientState.prototype.clearQueryState=function(targetId){delete this.queryState[targetId]};MemorySharedClientState.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds};MemorySharedClientState.prototype.isActiveQueryTarget=function(targetId){return this.localState.activeTargetIds.has(targetId)};MemorySharedClientState.prototype.start=function(){this.localState=new LocalClientState;
return Promise.resolve()};MemorySharedClientState.prototype.handleUserChange=function(user,removedBatchIds,addedBatchIds){};MemorySharedClientState.prototype.setOnlineState=function(onlineState){};MemorySharedClientState.prototype.shutdown=function(){};MemorySharedClientState.prototype.writeSequenceNumber=function(sequenceNumber){};return MemorySharedClientState}(),IndexedDbPersistenceSettings=function(){function IndexedDbPersistenceSettings(cacheSizeBytes,experimentalTabSynchronization){this.cacheSizeBytes=
cacheSizeBytes;this.experimentalTabSynchronization=experimentalTabSynchronization}IndexedDbPersistenceSettings.prototype.lruParams=function(){return LruParams.withCacheSize(this.cacheSizeBytes)};return IndexedDbPersistenceSettings}(),MemoryPersistenceSettings=function(){return function(){}}(),FirestoreClient=function(){function FirestoreClient(platform,databaseInfo,credentials,asyncQueue){this.platform=platform;this.databaseInfo=databaseInfo;this.credentials=credentials;this.asyncQueue=asyncQueue;
this.clientId=AutoId.newId()}FirestoreClient.prototype.start=function(persistenceSettings){var _this=this,initializationDone=new Deferred,persistenceResult=new Deferred,initialized=!1;this.credentials.setChangeListener(function(user){initialized?_this.asyncQueue.enqueueAndForget(function(){return _this.handleCredentialChange(user)}):(initialized=!0,_this.initializePersistence(persistenceSettings,persistenceResult,user).then(function(maybeLruGc){return _this.initializeRest(user,maybeLruGc)}).then(initializationDone.resolve,
initializationDone.reject))});this.asyncQueue.enqueueAndForget(function(){return initializationDone.promise});return persistenceResult.promise};FirestoreClient.prototype.enableNetwork=function(){var _this=this;return this.asyncQueue.enqueue(function(){return _this.syncEngine.enableNetwork()})};FirestoreClient.prototype.initializePersistence=function(persistenceSettings,persistenceResult,user){var _this=this;if(persistenceSettings instanceof IndexedDbPersistenceSettings)return this.startIndexedDbPersistence(user,
persistenceSettings).then(function(maybeLruGc){persistenceResult.resolve();return maybeLruGc}).catch(function(error){persistenceResult.reject(error);if(!_this.canFallback(error))throw error;console.warn("Error enabling offline storage. Falling back to storage disabled: "+error);return _this.startMemoryPersistence()});persistenceResult.resolve();return this.startMemoryPersistence()};FirestoreClient.prototype.canFallback=function(error){return error instanceof FirestoreError?error.code===Code.FAILED_PRECONDITION||
error.code===Code.UNIMPLEMENTED:"undefined"!==typeof DOMException&&error instanceof DOMException?22===error.code||20===error.code:!0};FirestoreClient.prototype.startIndexedDbPersistence=function(user,settings){var _this=this,storagePrefix=IndexedDbPersistence.buildStoragePrefix(this.databaseInfo),serializer=new JsonProtoSerializer(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var persistence,lruParams;
return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(settings.experimentalTabSynchronization&&!WebStorageSharedClientState.isAvailable(this.platform))throw new FirestoreError(Code.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");lruParams=settings.lruParams();if(!settings.experimentalTabSynchronization)return[3,2];this.sharedClientState=new WebStorageSharedClientState(this.asyncQueue,this.platform,storagePrefix,this.clientId,user);
return[4,IndexedDbPersistence.createMultiClientIndexedDbPersistence(storagePrefix,this.clientId,this.platform,this.asyncQueue,serializer,lruParams,{sequenceNumberSyncer:this.sharedClientState})];case 1:return persistence=_a.sent(),[3,4];case 2:return this.sharedClientState=new MemorySharedClientState,[4,IndexedDbPersistence.createIndexedDbPersistence(storagePrefix,this.clientId,this.platform,this.asyncQueue,serializer,lruParams)];case 3:persistence=_a.sent(),_a.label=4;case 4:return this.persistence=
persistence,[2,persistence.referenceDelegate.garbageCollector]}})})})};FirestoreClient.prototype.startMemoryPersistence=function(){this.persistence=MemoryPersistence.createEagerPersistence(this.clientId);this.sharedClientState=new MemorySharedClientState;return Promise.resolve(null)};FirestoreClient.prototype.initializeRest=function(user,maybeLruGc){var _this$jscomp$0=this;debug("FirestoreClient","Initializing. user\x3d",user.uid);return this.platform.loadConnection(this.databaseInfo).then(function(connection){return tslib_1.__awaiter(_this$jscomp$0,
void 0,void 0,function(){var serializer,datastore,remoteStoreOnlineStateChangedHandler,sharedClientStateOnlineStateChangedHandler,_this=this;return tslib_1.__generator(this,function(_a$jscomp$0){switch(_a$jscomp$0.label){case 0:return this.localStore=new LocalStore(this.persistence,user),maybeLruGc&&(this.lruScheduler=new LruScheduler(maybeLruGc,this.asyncQueue,this.localStore)),serializer=this.platform.newSerializer(this.databaseInfo.databaseId),datastore=new Datastore(this.asyncQueue,connection,
this.credentials,serializer),remoteStoreOnlineStateChangedHandler=function(onlineState){return _this.syncEngine.applyOnlineStateChange(onlineState,OnlineStateSource.RemoteStore)},sharedClientStateOnlineStateChangedHandler=function(onlineState){return _this.syncEngine.applyOnlineStateChange(onlineState,OnlineStateSource.SharedClientState)},this.remoteStore=new RemoteStore(this.localStore,datastore,this.asyncQueue,remoteStoreOnlineStateChangedHandler),this.syncEngine=new SyncEngine(this.localStore,
this.remoteStore,this.sharedClientState,user),this.sharedClientState.onlineStateHandler=sharedClientStateOnlineStateChangedHandler,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new EventManager(this.syncEngine),[4,this.sharedClientState.start()];case 1:return _a$jscomp$0.sent(),[4,this.remoteStore.start()];case 2:return _a$jscomp$0.sent(),[4,this.persistence.setPrimaryStateListener(function(isPrimary){return tslib_1.__awaiter(_this,void 0,
void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.syncEngine.applyPrimaryState(isPrimary)];case 1:return _a.sent(),this.lruScheduler&&(isPrimary&&!this.lruScheduler.started?this.lruScheduler.start():isPrimary||this.lruScheduler.stop()),[2]}})})})];case 3:return _a$jscomp$0.sent(),[2]}})})})};FirestoreClient.prototype.handleCredentialChange=function(user){this.asyncQueue.verifyOperationInProgress();debug("FirestoreClient","Credential Changed. Current user: "+
user.uid);return this.syncEngine.handleCredentialChange(user)};FirestoreClient.prototype.disableNetwork=function(){var _this=this;return this.asyncQueue.enqueue(function(){return _this.syncEngine.disableNetwork()})};FirestoreClient.prototype.shutdown=function(options){var _this=this;return this.asyncQueue.enqueue(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),
[4,this.remoteStore.shutdown()];case 1:return _a.sent(),[4,this.sharedClientState.shutdown()];case 2:return _a.sent(),[4,this.persistence.shutdown(options&&options.purgePersistenceWithDataLoss)];case 3:return _a.sent(),this.credentials.removeChangeListener(),[2]}})})})};FirestoreClient.prototype.listen=function(query,observer,options){var _this=this,listener=new QueryListener(query,observer,options);this.asyncQueue.enqueueAndForget(function(){return _this.eventMgr.listen(listener)});return listener};
FirestoreClient.prototype.unlisten=function(listener){var _this=this;this.asyncQueue.enqueueAndForget(function(){return _this.eventMgr.unlisten(listener)})};FirestoreClient.prototype.getDocumentFromLocalCache=function(docKey){var _this=this;return this.asyncQueue.enqueue(function(){return _this.localStore.readDocument(docKey)}).then(function(maybeDoc){if(maybeDoc instanceof Document$jscomp$0)return maybeDoc;if(maybeDoc instanceof NoDocument)return null;throw new FirestoreError(Code.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)");
})};FirestoreClient.prototype.getDocumentsFromLocalCache=function(query){var _this=this;return this.asyncQueue.enqueue(function(){return _this.localStore.executeQuery(query)}).then(function(docs){var remoteKeys=documentKeySet();remoteKeys=new View$jscomp$0(query,remoteKeys);docs=remoteKeys.computeDocChanges(docs);return remoteKeys.applyChanges(docs,!1).snapshot})};FirestoreClient.prototype.write=function(mutations){var _this=this,deferred=new Deferred;this.asyncQueue.enqueueAndForget(function(){return _this.syncEngine.write(mutations,
deferred)});return deferred.promise};FirestoreClient.prototype.databaseId=function(){return this.databaseInfo.databaseId};FirestoreClient.prototype.transaction=function(updateFunction){var _this=this;return this.asyncQueue.enqueue(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return[2]})})}).then(function(){return _this.syncEngine.runTransaction(updateFunction)})};return FirestoreClient}(),AsyncObserver=function(){function AsyncObserver(observer){this.observer=
observer;this.muted=!1}AsyncObserver.prototype.next=function(value){this.scheduleEvent(this.observer.next,value)};AsyncObserver.prototype.error=function(error){this.scheduleEvent(this.observer.error,error)};AsyncObserver.prototype.mute=function(){this.muted=!0};AsyncObserver.prototype.scheduleEvent=function(eventHandler,event){var _this=this;this.muted||setTimeout(function(){_this.muted||eventHandler(event)},0)};return AsyncObserver}(),FieldPath$1=function(){function FieldPath$1(){for(var fieldNames=
[],_i=0;_i<arguments.length;_i++)fieldNames[_i]=arguments[_i];if(!(fieldNames instanceof Array)||1>fieldNames.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function FieldPath() requires its fieldNames argument to be an array with at least "+(formatPlural(1,"element")+"."));for(_i=0;_i<fieldNames.length;++_i)if(validateArgType("FieldPath","string",_i,fieldNames[_i]),0===fieldNames[_i].length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");
this._internalPath=new FieldPath(fieldNames)}FieldPath$1.documentId=function(){return FieldPath$1._DOCUMENT_ID};FieldPath$1.prototype.isEqual=function(other){if(!(other instanceof FieldPath$1))throw invalidClassError("isEqual","FieldPath",1,other);return this._internalPath.isEqual(other._internalPath)};FieldPath$1._DOCUMENT_ID=new FieldPath$1(FieldPath.keyField().canonicalString());return FieldPath$1}(),RESERVED=/[~\*/\[\]]/,OAuthToken=function(){return function(value,user){this.user=user;this.type=
"OAuth";this.authHeaders={Authorization:"Bearer "+value}}}(),EmptyCredentialsProvider=function(){function EmptyCredentialsProvider(){this.changeListener=null}EmptyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(null)};EmptyCredentialsProvider.prototype.invalidateToken=function(){};EmptyCredentialsProvider.prototype.setChangeListener=function(changeListener){assert(!this.changeListener,"Can only call setChangeListener() once.");this.changeListener=changeListener;changeListener(User.UNAUTHENTICATED)};
EmptyCredentialsProvider.prototype.removeChangeListener=function(){assert(null!==this.changeListener,"removeChangeListener() when no listener registered");this.changeListener=null};return EmptyCredentialsProvider}(),FirebaseCredentialsProvider=function(){function FirebaseCredentialsProvider(app){var _this=this;this.app=app;this.tokenListener=null;this.tokenCounter=0;this.changeListener=null;this.forceRefresh=!1;this.tokenListener=function(){_this.tokenCounter++;_this.currentUser=_this.getUser();_this.changeListener&&
_this.changeListener(_this.currentUser)};this.tokenCounter=0;this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}FirebaseCredentialsProvider.prototype.getToken=function(){var _this=this;assert(null!=this.tokenListener,"getToken cannot be called after listener removed.");var initialTokenCounter=this.tokenCounter,forceRefresh=this.forceRefresh;this.forceRefresh=!1;return this.app.INTERNAL.getToken(forceRefresh).then(function(tokenData){if(_this.tokenCounter!==initialTokenCounter)throw new FirestoreError(Code.ABORTED,
"getToken aborted due to token change.");return tokenData?(assert("string"===typeof tokenData.accessToken,"Invalid tokenData returned from getToken():"+tokenData),new OAuthToken(tokenData.accessToken,_this.currentUser)):null})};FirebaseCredentialsProvider.prototype.invalidateToken=function(){this.forceRefresh=!0};FirebaseCredentialsProvider.prototype.setChangeListener=function(changeListener){assert(!this.changeListener,"Can only call setChangeListener() once.");this.changeListener=changeListener;
this.currentUser&&changeListener(this.currentUser)};FirebaseCredentialsProvider.prototype.removeChangeListener=function(){assert(null!=this.tokenListener,"removeChangeListener() called twice");assert(null!==this.changeListener,"removeChangeListener() called when no listener registered");this.app.INTERNAL.removeAuthTokenListener(this.tokenListener);this.changeListener=this.tokenListener=null};FirebaseCredentialsProvider.prototype.getUser=function(){var currentUid=this.app.INTERNAL.getUid();assert(null===
currentUid||"string"===typeof currentUid,"Received invalid UID: "+currentUid);return new User(currentUid)};return FirebaseCredentialsProvider}(),FirstPartyToken=function(){function FirstPartyToken(gapi,sessionIndex){this.gapi=gapi;this.sessionIndex=sessionIndex;this.type="FirstParty";this.user=User.FIRST_PARTY;assert(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}Object.defineProperty(FirstPartyToken.prototype,"authHeaders",{get:function(){return{Authorization:this.gapi.auth.getAuthHeaderValueForFirstParty([]),
"X-Goog-AuthUser":this.sessionIndex}},enumerable:!0,configurable:!0});return FirstPartyToken}(),FirstPartyCredentialsProvider=function(){function FirstPartyCredentialsProvider(gapi,sessionIndex){this.gapi=gapi;this.sessionIndex=sessionIndex;assert(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}FirstPartyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(new FirstPartyToken(this.gapi,this.sessionIndex))};FirstPartyCredentialsProvider.prototype.setChangeListener=
function(changeListener){changeListener(User.FIRST_PARTY)};FirstPartyCredentialsProvider.prototype.removeChangeListener=function(){};FirstPartyCredentialsProvider.prototype.invalidateToken=function(){};return FirstPartyCredentialsProvider}(),FieldValueImpl=function(){function FieldValueImpl(_methodName){this._methodName=_methodName}FieldValueImpl.delete=function(){validateNoArgs("FieldValue.delete",arguments);return DeleteFieldValueImpl.instance};FieldValueImpl.serverTimestamp=function(){validateNoArgs("FieldValue.serverTimestamp",
arguments);return ServerTimestampFieldValueImpl.instance};FieldValueImpl.arrayUnion=function(){for(var elements=[],_i=0;_i<arguments.length;_i++)elements[_i]=arguments[_i];validateAtLeastNumberOfArgs("FieldValue.arrayUnion",arguments,1);return new ArrayUnionFieldValueImpl(elements)};FieldValueImpl.arrayRemove=function(){for(var elements=[],_i=0;_i<arguments.length;_i++)elements[_i]=arguments[_i];validateAtLeastNumberOfArgs("FieldValue.arrayRemove",arguments,1);return new ArrayRemoveFieldValueImpl(elements)};
FieldValueImpl.increment=function(n){validateArgType("FieldValue.increment","number",1,n);validateExactNumberOfArgs("FieldValue.increment",arguments,1);return new NumericIncrementFieldValueImpl(n)};FieldValueImpl.prototype.isEqual=function(other){return this===other};return FieldValueImpl}(),DeleteFieldValueImpl=function(_super){function DeleteFieldValueImpl(){return _super.call(this,"FieldValue.delete")||this}tslib_1.__extends(DeleteFieldValueImpl,_super);DeleteFieldValueImpl.instance=new DeleteFieldValueImpl;
return DeleteFieldValueImpl}(FieldValueImpl),ServerTimestampFieldValueImpl=function(_super){function ServerTimestampFieldValueImpl(){return _super.call(this,"FieldValue.serverTimestamp")||this}tslib_1.__extends(ServerTimestampFieldValueImpl,_super);ServerTimestampFieldValueImpl.instance=new ServerTimestampFieldValueImpl;return ServerTimestampFieldValueImpl}(FieldValueImpl),ArrayUnionFieldValueImpl=function(_super){function ArrayUnionFieldValueImpl(_elements){var _this=_super.call(this,"FieldValue.arrayUnion")||
this;_this._elements=_elements;return _this}tslib_1.__extends(ArrayUnionFieldValueImpl,_super);return ArrayUnionFieldValueImpl}(FieldValueImpl),ArrayRemoveFieldValueImpl=function(_super){function ArrayRemoveFieldValueImpl(_elements){var _this=_super.call(this,"FieldValue.arrayRemove")||this;_this._elements=_elements;return _this}tslib_1.__extends(ArrayRemoveFieldValueImpl,_super);return ArrayRemoveFieldValueImpl}(FieldValueImpl),NumericIncrementFieldValueImpl=function(_super){function NumericIncrementFieldValueImpl(_operand){var _this=
_super.call(this,"FieldValue.increment")||this;_this._operand=_operand;return _this}tslib_1.__extends(NumericIncrementFieldValueImpl,_super);return NumericIncrementFieldValueImpl}(FieldValueImpl),PublicFieldValue=makeConstructorPrivate(FieldValueImpl,"Use FieldValue.\x3cfield\x3e() instead."),RESERVED_FIELD_REGEX=/^__.*__$/,ParsedSetData=function(){function ParsedSetData(data,fieldMask,fieldTransforms){this.data=data;this.fieldMask=fieldMask;this.fieldTransforms=fieldTransforms}ParsedSetData.prototype.toMutations=
function(key,precondition){var mutations=[];null!==this.fieldMask?mutations.push(new PatchMutation(key,this.data,this.fieldMask,precondition)):mutations.push(new SetMutation(key,this.data,precondition));0<this.fieldTransforms.length&&mutations.push(new TransformMutation(key,this.fieldTransforms));return mutations};return ParsedSetData}(),ParsedUpdateData=function(){function ParsedUpdateData(data,fieldMask,fieldTransforms){this.data=data;this.fieldMask=fieldMask;this.fieldTransforms=fieldTransforms}
ParsedUpdateData.prototype.toMutations=function(key,precondition){precondition=[new PatchMutation(key,this.data,this.fieldMask,precondition)];0<this.fieldTransforms.length&&precondition.push(new TransformMutation(key,this.fieldTransforms));return precondition};return ParsedUpdateData}(),UserDataSource;(function(UserDataSource){UserDataSource[UserDataSource.Set=0]="Set";UserDataSource[UserDataSource.Update=1]="Update";UserDataSource[UserDataSource.MergeSet=2]="MergeSet";UserDataSource[UserDataSource.Argument=
3]="Argument"})(UserDataSource||(UserDataSource={}));var ParseContext=function(){function ParseContext(dataSource,methodName,path,arrayElement,fieldTransforms,fieldMask){this.dataSource=dataSource;this.methodName=methodName;this.path=path;this.arrayElement=arrayElement;void 0===fieldTransforms&&this.validatePath();this.arrayElement=void 0!==arrayElement?arrayElement:!1;this.fieldTransforms=fieldTransforms||[];this.fieldMask=fieldMask||[]}ParseContext.prototype.childContextForField=function(field){var childPath=
null==this.path?null:this.path.child(field);childPath=new ParseContext(this.dataSource,this.methodName,childPath,!1,this.fieldTransforms,this.fieldMask);childPath.validatePathSegment(field);return childPath};ParseContext.prototype.childContextForFieldPath=function(field){field=null==this.path?null:this.path.child(field);field=new ParseContext(this.dataSource,this.methodName,field,!1,this.fieldTransforms,this.fieldMask);field.validatePath();return field};ParseContext.prototype.childContextForArray=
function(index){return new ParseContext(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)};ParseContext.prototype.createError=function(reason){var fieldDescription=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+reason+fieldDescription)};ParseContext.prototype.contains=function(fieldPath){return void 0!==this.fieldMask.find(function(field){return fieldPath.isPrefixOf(field)})||
void 0!==this.fieldTransforms.find(function(transform){return fieldPath.isPrefixOf(transform.field)})};ParseContext.prototype.validatePath=function(){if(null!==this.path)for(var i=0;i<this.path.length;i++)this.validatePathSegment(this.path.get(i))};ParseContext.prototype.validatePathSegment=function(segment){if(isWrite(this.dataSource)&&RESERVED_FIELD_REGEX.test(segment))throw this.createError("Document fields cannot begin and end with __");};return ParseContext}(),DocumentKeyReference=function(){return function(databaseId,
key){this.databaseId=databaseId;this.key=key}}(),UserDataConverter=function(){function UserDataConverter(preConverter){this.preConverter=preConverter}UserDataConverter.prototype.parseSetData=function(methodName,input){methodName=new ParseContext(UserDataSource.Set,methodName,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",methodName,input);input=this.parseData(input,methodName);return new ParsedSetData(input,null,methodName.fieldTransforms)};UserDataConverter.prototype.parseMergeData=
function(methodName,input,fieldPaths){var context=new ParseContext(UserDataSource.MergeSet,methodName,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",context,input);input=this.parseData(input,context);if(fieldPaths){for(var validatedFieldPaths=new SortedSet(FieldPath.comparator),_i=0;_i<fieldPaths.length;_i++){var stringOrFieldPath=fieldPaths[_i],fieldPath=void 0;if(stringOrFieldPath instanceof FieldPath$1)fieldPath=stringOrFieldPath._internalPath;else if("string"===
typeof stringOrFieldPath)fieldPath=fieldPathFromDotSeparatedString(methodName,stringOrFieldPath);else throw fail("Expected stringOrFieldPath to be a string or a FieldPath");if(!context.contains(fieldPath))throw new FirestoreError(Code.INVALID_ARGUMENT,"Field '"+fieldPath+"' is specified in your field mask but missing from your input data.");validatedFieldPaths=validatedFieldPaths.add(fieldPath)}var fieldMask=FieldMask.fromSet(validatedFieldPaths);methodName=context.fieldTransforms.filter(function(transform){return fieldMask.covers(transform.field)})}else fieldMask=
FieldMask.fromArray(context.fieldMask),methodName=context.fieldTransforms;return new ParsedSetData(input,fieldMask,methodName)};UserDataConverter.prototype.parseUpdateData=function(methodName,input){var _this=this,context=new ParseContext(UserDataSource.Update,methodName,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",context,input);var fieldMaskPaths=new SortedSet(FieldPath.comparator),updateData=ObjectValue.EMPTY;forEach(input,function(key,value){key=fieldPathFromDotSeparatedString(methodName,
key);var childContext=context.childContextForFieldPath(key);value=_this.runPreConverter(value,childContext);value instanceof DeleteFieldValueImpl?fieldMaskPaths=fieldMaskPaths.add(key):(value=_this.parseData(value,childContext),null!=value&&(fieldMaskPaths=fieldMaskPaths.add(key),updateData=updateData.set(key,value)))});input=FieldMask.fromSet(fieldMaskPaths);return new ParsedUpdateData(updateData,input,context.fieldTransforms)};UserDataConverter.prototype.parseUpdateVarargs=function(methodName,field,
value,moreFieldsAndValues){var context=new ParseContext(UserDataSource.Update,methodName,FieldPath.EMPTY_PATH);field=[fieldPathFromArgument(methodName,field)];value=[value];if(0!==moreFieldsAndValues.length%2)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+methodName+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var i=0;i<moreFieldsAndValues.length;i+=2)field.push(fieldPathFromArgument(methodName,moreFieldsAndValues[i])),value.push(moreFieldsAndValues[i+
1]);moreFieldsAndValues=new SortedSet(FieldPath.comparator);methodName=ObjectValue.EMPTY;for(i=0;i<field.length;++i){var path=field[i],childContext=context.childContextForFieldPath(path),value_1=this.runPreConverter(value[i],childContext);value_1 instanceof DeleteFieldValueImpl?moreFieldsAndValues=moreFieldsAndValues.add(path):(childContext=this.parseData(value_1,childContext),null!=childContext&&(moreFieldsAndValues=moreFieldsAndValues.add(path),methodName=methodName.set(path,childContext)))}field=
FieldMask.fromSet(moreFieldsAndValues);return new ParsedUpdateData(methodName,field,context.fieldTransforms)};UserDataConverter.prototype.parseQueryValue=function(methodName,input){methodName=new ParseContext(UserDataSource.Argument,methodName,FieldPath.EMPTY_PATH);input=this.parseData(input,methodName);assert(null!=input,"Parsed data should not be null.");assert(0===methodName.fieldTransforms.length,"Field transforms should have been disallowed.");return input};UserDataConverter.prototype.runPreConverter=
function(input,context){try{return this.preConverter(input)}catch(e){throw context.createError(e instanceof Error?e.message:e.toString());}};UserDataConverter.prototype.parseData=function(input,context){input=this.runPreConverter(input,context);if(looksLikeJsonObject(input))return validatePlainObject("Unsupported field value:",context,input),this.parseObject(input,context);if(input instanceof FieldValueImpl)return this.parseSentinelFieldValue(input,context),null;context.path&&context.fieldMask.push(context.path);
if(input instanceof Array){if(context.arrayElement)throw context.createError("Nested arrays are not supported");return this.parseArray(input,context)}return this.parseScalarValue(input,context)};UserDataConverter.prototype.parseObject=function(obj,context){var _this=this,result=new SortedMap$jscomp$0(primitiveComparator);isEmpty(obj)?context.path&&0<context.path.length&&context.fieldMask.push(context.path):forEach(obj,function(key,val){val=_this.parseData(val,context.childContextForField(key));null!=
val&&(result=result.insert(key,val))});return new ObjectValue(result)};UserDataConverter.prototype.parseArray=function(array,context){for(var result=[],entryIndex=0,_i=0;_i<array.length;_i++){var parsedEntry=this.parseData(array[_i],context.childContextForArray(entryIndex));null==parsedEntry&&(parsedEntry=NullValue.INSTANCE);result.push(parsedEntry);entryIndex++}return new ArrayValue(result)};UserDataConverter.prototype.parseSentinelFieldValue=function(value,context){if(!isWrite(context.dataSource))throw context.createError(value._methodName+
"() can only be used with update() and set()");if(null===context.path)throw context.createError(value._methodName+"() is not currently supported inside arrays");if(value instanceof DeleteFieldValueImpl)if(context.dataSource===UserDataSource.MergeSet)context.fieldMask.push(context.path);else{if(context.dataSource===UserDataSource.Update)throw assert(0<context.path.length,"FieldValue.delete() at the top level should have already been handled."),context.createError("FieldValue.delete() can only appear at the top level of your update data");
throw context.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");}else value instanceof ServerTimestampFieldValueImpl?context.fieldTransforms.push(new FieldTransform(context.path,ServerTimestampTransform.instance)):value instanceof ArrayUnionFieldValueImpl?(value=this.parseArrayTransformElements(value._methodName,value._elements),value=new ArrayUnionTransformOperation(value),context.fieldTransforms.push(new FieldTransform(context.path,value))):value instanceof
ArrayRemoveFieldValueImpl?(value=this.parseArrayTransformElements(value._methodName,value._elements),value=new ArrayRemoveTransformOperation(value),context.fieldTransforms.push(new FieldTransform(context.path,value))):value instanceof NumericIncrementFieldValueImpl?(value=this.parseQueryValue("FieldValue.increment",value._operand),value=new NumericIncrementTransformOperation(value),context.fieldTransforms.push(new FieldTransform(context.path,value))):fail("Unknown FieldValue type: "+value)};UserDataConverter.prototype.parseScalarValue=
function(value,context){if(null===value)return NullValue.INSTANCE;if("number"===typeof value)return isSafeInteger(value)?new IntegerValue(value):new DoubleValue(value);if("boolean"===typeof value)return BooleanValue.of(value);if("string"===typeof value)return new StringValue(value);if(value instanceof Date)return new TimestampValue(Timestamp.fromDate(value));if(value instanceof Timestamp)return new TimestampValue(new Timestamp(value.seconds,1E3*Math.floor(value.nanoseconds/1E3)));if(value instanceof
GeoPoint)return new GeoPointValue(value);if(value instanceof Blob$jscomp$0)return new BlobValue(value);if(value instanceof DocumentKeyReference)return new RefValue(value.databaseId,value.key);throw context.createError("Unsupported field value: "+valueDescription(value));};UserDataConverter.prototype.parseArrayTransformElements=function(methodName,elements){var _this=this;return elements.map(function(element,i){var context=new ParseContext(UserDataSource.Argument,methodName,FieldPath.EMPTY_PATH);return _this.parseData(element,
context.childContextForArray(i))})};return UserDataConverter}(),CACHE_SIZE_UNLIMITED=LruParams.COLLECTION_DISABLED,FirestoreSettings=function(){function FirestoreSettings(settings){if(void 0===settings.host){if(void 0!==settings.ssl)throw new FirestoreError(Code.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com";this.ssl=!0}else validateType("settings","non-empty string","host option",settings.host),this.host=settings.host,validateNamedOptionalType("settings",
"boolean","ssl",settings.ssl),this.ssl=defaulted(settings.ssl,!0);validateOptionNames("settings",settings,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes"]);validateNamedOptionalType("settings","object","credentials",settings.credentials);this.credentials=settings.credentials;validateNamedOptionalType("settings","boolean","timestampsInSnapshots",settings.timestampsInSnapshots);!0===settings.timestampsInSnapshots?error$jscomp$0("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):
!1===settings.timestampsInSnapshots&&error$jscomp$0("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date \x3d snapshot.get('created_at');\n  // New:\n  const timestamp \x3d snapshot.get('created_at'); const date \x3d\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior.");
this.timestampsInSnapshots=defaulted(settings.timestampsInSnapshots,!0);validateNamedOptionalType("settings","number","cacheSizeBytes",settings.cacheSizeBytes);if(void 0===settings.cacheSizeBytes)this.cacheSizeBytes=LruParams.DEFAULT_CACHE_SIZE_BYTES;else{if(settings.cacheSizeBytes!==CACHE_SIZE_UNLIMITED&&settings.cacheSizeBytes<LruParams.MINIMUM_CACHE_SIZE_BYTES)throw new FirestoreError(Code.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+LruParams.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=
settings.cacheSizeBytes}}FirestoreSettings.prototype.isEqual=function(other){return this.host===other.host&&this.ssl===other.ssl&&this.timestampsInSnapshots===other.timestampsInSnapshots&&this.credentials===other.credentials&&this.cacheSizeBytes===other.cacheSizeBytes};return FirestoreSettings}(),FirestoreConfig=function(){return function(){}}(),Firestore=function(){function Firestore(databaseIdOrApp){var _this=this;this._queue=new AsyncQueue;this.INTERNAL={delete:function(options){return tslib_1.__awaiter(_this,
void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return this._firestoreClient?[2,this._firestoreClient.shutdown(options)]:[2]})})}};var config=new FirestoreConfig;if("object"===typeof databaseIdOrApp.options)config.firebaseApp=databaseIdOrApp,config.databaseId=Firestore.databaseIdFromApp(databaseIdOrApp),config.persistenceKey=config.firebaseApp.name,config.credentials=new FirebaseCredentialsProvider(databaseIdOrApp);else{if(!databaseIdOrApp.projectId)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Must provide projectId");config.databaseId=new DatabaseId(databaseIdOrApp.projectId,databaseIdOrApp.database);config.persistenceKey="[DEFAULT]";config.credentials=new EmptyCredentialsProvider}config.settings=new FirestoreSettings({});this._config=config;this._databaseId=config.databaseId}Firestore.prototype.settings=function(settingsLiteral){validateExactNumberOfArgs("Firestore.settings",arguments,1);validateArgType("Firestore.settings","object",1,settingsLiteral);if(Object.prototype.hasOwnProperty.call(settingsLiteral,
"persistence"))throw new FirestoreError(Code.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var newSettings=new FirestoreSettings(settingsLiteral);if(this._firestoreClient&&!this._config.settings.isEqual(newSettings))throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._config.settings=
newSettings;if(void 0!==newSettings.credentials){var JSCompiler_temp_const=this._config;a:if(newSettings=newSettings.credentials)switch(newSettings.type){case "gapi":newSettings=new FirstPartyCredentialsProvider(newSettings.client,newSettings.sessionIndex||"0");break a;case "provider":newSettings=newSettings.client;break a;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type");}else newSettings=new EmptyCredentialsProvider;JSCompiler_temp_const.credentials=
newSettings}};Firestore.prototype.enableNetwork=function(){this.ensureClientConfigured();return this._firestoreClient.enableNetwork()};Firestore.prototype.disableNetwork=function(){this.ensureClientConfigured();return this._firestoreClient.disableNetwork()};Firestore.prototype.enablePersistence=function(settings){if(this._firestoreClient)throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");
return this.configureClient(new IndexedDbPersistenceSettings(this._config.settings.cacheSizeBytes,void 0!==settings&&defaulted(settings.experimentalTabSynchronization,!1)))};Firestore.prototype.ensureClientConfigured=function(){this._firestoreClient||this.configureClient(new MemoryPersistenceSettings);return this._firestoreClient};Firestore.prototype.configureClient=function(persistenceSettings){var _this=this;assert(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey");assert(!this._firestoreClient,
"configureClient() called multiple times");var databaseInfo=new DatabaseInfo(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl);this._dataConverter=new UserDataConverter(function(value){if(value instanceof DocumentReference){var thisDb=_this._config.databaseId,otherDb=value.firestore._config.databaseId;if(!otherDb.isEqual(thisDb))throw new FirestoreError(Code.INVALID_ARGUMENT,"Document reference is for database "+(otherDb.projectId+"/"+otherDb.database+
" but should be ")+("for database "+thisDb.projectId+"/"+thisDb.database));return new DocumentKeyReference(_this._config.databaseId,value._key)}return value});this._firestoreClient=new FirestoreClient(PlatformSupport.getPlatform(),databaseInfo,this._config.credentials,this._queue);return this._firestoreClient.start(persistenceSettings)};Firestore.databaseIdFromApp=function(app){app=app.options;if(!Object.prototype.hasOwnProperty.call(app,"projectId"))throw new FirestoreError(Code.INVALID_ARGUMENT,
'"projectId" not provided in firebase.initializeApp.');app=app.projectId;if(!app||"string"!==typeof app)throw new FirestoreError(Code.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new DatabaseId(app)};Object.defineProperty(Firestore.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,
configurable:!0});Firestore.prototype.collection=function(pathString){validateExactNumberOfArgs("Firestore.collection",arguments,1);validateArgType("Firestore.collection","non-empty string",1,pathString);this.ensureClientConfigured();return new CollectionReference(ResourcePath.fromString(pathString),this)};Firestore.prototype.doc=function(pathString){validateExactNumberOfArgs("Firestore.doc",arguments,1);validateArgType("Firestore.doc","non-empty string",1,pathString);this.ensureClientConfigured();
return DocumentReference.forPath(ResourcePath.fromString(pathString),this)};Firestore.prototype._collectionGroup=function(collectionId){validateExactNumberOfArgs("Firestore.collectionGroup",arguments,1);validateArgType("Firestore.collectionGroup","non-empty string",1,collectionId);if(0<=collectionId.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid collection ID '"+collectionId+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");this.ensureClientConfigured();
return new Query$1(new Query$jscomp$0(ResourcePath.EMPTY_PATH,collectionId),this)};Firestore.prototype.runTransaction=function(updateFunction){var _this=this;validateExactNumberOfArgs("Firestore.runTransaction",arguments,1);validateArgType("Firestore.runTransaction","function",1,updateFunction);return this.ensureClientConfigured().transaction(function(transaction){return updateFunction(new Transaction$1(_this,transaction))})};Firestore.prototype.batch=function(){this.ensureClientConfigured();return new WriteBatch(this)};
Object.defineProperty(Firestore,"logLevel",{get:function(){switch(getLogLevel()){case LogLevel$jscomp$0.DEBUG:return"debug";case LogLevel$jscomp$0.ERROR:return"error";case LogLevel$jscomp$0.SILENT:return"silent";default:return fail("Unknown log level: "+getLogLevel())}},enumerable:!0,configurable:!0});Firestore.setLogLevel=function(level){validateExactNumberOfArgs("Firestore.setLogLevel",arguments,1);validateArgType("Firestore.setLogLevel","non-empty string",1,level);switch(level){case "debug":setLogLevel(LogLevel$jscomp$0.DEBUG);
break;case "error":setLogLevel(LogLevel$jscomp$0.ERROR);break;case "silent":setLogLevel(LogLevel$jscomp$0.SILENT);break;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid log level: "+level);}};Firestore.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots};return Firestore}(),Transaction$1=function(){function Transaction(_firestore,_transaction){this._firestore=_firestore;this._transaction=_transaction}Transaction.prototype.get=function(documentRef){var _this=
this;validateExactNumberOfArgs("Transaction.get",arguments,1);var ref=validateReference("Transaction.get",documentRef,this._firestore);return this._transaction.lookup([ref._key]).then(function(docs){if(!docs||1!==docs.length)return fail("Mismatch in docs returned from document lookup.");docs=docs[0];if(docs instanceof NoDocument)return new DocumentSnapshot(_this._firestore,ref._key,null,!1,!1);if(docs instanceof Document$jscomp$0)return new DocumentSnapshot(_this._firestore,ref._key,docs,!1,!1);throw fail("BatchGetDocumentsRequest returned unexpected document type: "+
docs.constructor.name);})};Transaction.prototype.set=function(documentRef,value,options){validateBetweenNumberOfArgs("Transaction.set",arguments,2,3);var ref=validateReference("Transaction.set",documentRef,this._firestore);options=validateSetOptions("Transaction.set",options);var parsed=options.merge||options.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",value,options.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",value);this._transaction.set(ref._key,
parsed);return this};Transaction.prototype.update=function(documentRef,fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=arguments[_i];"string"===typeof fieldOrUpdateData||fieldOrUpdateData instanceof FieldPath$1?(validateAtLeastNumberOfArgs("Transaction.update",arguments,3),_i=validateReference("Transaction.update",documentRef,this._firestore),moreFieldsAndValues=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",fieldOrUpdateData,
value,moreFieldsAndValues)):(validateExactNumberOfArgs("Transaction.update",arguments,2),_i=validateReference("Transaction.update",documentRef,this._firestore),moreFieldsAndValues=this._firestore._dataConverter.parseUpdateData("Transaction.update",fieldOrUpdateData));this._transaction.update(_i._key,moreFieldsAndValues);return this};Transaction.prototype.delete=function(documentRef){validateExactNumberOfArgs("Transaction.delete",arguments,1);var ref=validateReference("Transaction.delete",documentRef,
this._firestore);this._transaction.delete(ref._key);return this};return Transaction}(),WriteBatch=function(){function WriteBatch(_firestore){this._firestore=_firestore;this._mutations=[];this._committed=!1}WriteBatch.prototype.set=function(documentRef,value,options){validateBetweenNumberOfArgs("WriteBatch.set",arguments,2,3);this.verifyNotCommitted();var ref=validateReference("WriteBatch.set",documentRef,this._firestore);options=validateSetOptions("WriteBatch.set",options);var parsed=options.merge||
options.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",value,options.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",value);this._mutations=this._mutations.concat(parsed.toMutations(ref._key,Precondition.NONE));return this};WriteBatch.prototype.update=function(documentRef,fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=arguments[_i];this.verifyNotCommitted();"string"===typeof fieldOrUpdateData||
fieldOrUpdateData instanceof FieldPath$1?(validateAtLeastNumberOfArgs("WriteBatch.update",arguments,3),_i=validateReference("WriteBatch.update",documentRef,this._firestore),moreFieldsAndValues=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",fieldOrUpdateData,value,moreFieldsAndValues)):(validateExactNumberOfArgs("WriteBatch.update",arguments,2),_i=validateReference("WriteBatch.update",documentRef,this._firestore),moreFieldsAndValues=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",
fieldOrUpdateData));this._mutations=this._mutations.concat(moreFieldsAndValues.toMutations(_i._key,Precondition.exists(!0)));return this};WriteBatch.prototype.delete=function(documentRef){validateExactNumberOfArgs("WriteBatch.delete",arguments,1);this.verifyNotCommitted();var ref=validateReference("WriteBatch.delete",documentRef,this._firestore);this._mutations=this._mutations.concat(new DeleteMutation(ref._key,Precondition.NONE));return this};WriteBatch.prototype.commit=function(){return tslib_1.__awaiter(this,
void 0,void 0,function(){return tslib_1.__generator(this,function(_a){this.verifyNotCommitted();this._committed=!0;return 0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})};WriteBatch.prototype.verifyNotCommitted=function(){if(this._committed)throw new FirestoreError(Code.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.");};return WriteBatch}(),DocumentReference=function(){function DocumentReference(_key,firestore){this._key=
_key;this.firestore=firestore;this._firestoreClient=this.firestore.ensureClientConfigured()}DocumentReference.forPath=function(path,firestore){if(0!==path.length%2)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+(path.canonicalString()+" has "+path.length));return new DocumentReference(new DocumentKey(path),firestore)};Object.defineProperty(DocumentReference.prototype,"id",{get:function(){return this._key.path.lastSegment()},
enumerable:!0,configurable:!0});Object.defineProperty(DocumentReference.prototype,"parent",{get:function(){return new CollectionReference(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0});Object.defineProperty(DocumentReference.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0});DocumentReference.prototype.collection=function(pathString){validateExactNumberOfArgs("DocumentReference.collection",arguments,1);validateArgType("DocumentReference.collection",
"non-empty string",1,pathString);if(!pathString)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var path=ResourcePath.fromString(pathString);return new CollectionReference(this._key.path.child(path),this.firestore)};DocumentReference.prototype.isEqual=function(other){if(!(other instanceof DocumentReference))throw invalidClassError("isEqual","DocumentReference",1,other);return this.firestore===other.firestore&&this._key.isEqual(other._key)};
DocumentReference.prototype.set=function(value,options){validateBetweenNumberOfArgs("DocumentReference.set",arguments,1,2);options=validateSetOptions("DocumentReference.set",options);var parsed=options.merge||options.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",value,options.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",value);return this._firestoreClient.write(parsed.toMutations(this._key,Precondition.NONE))};DocumentReference.prototype.update=
function(fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=2;_i<arguments.length;_i++)moreFieldsAndValues[_i-2]=arguments[_i];"string"===typeof fieldOrUpdateData||fieldOrUpdateData instanceof FieldPath$1?(validateAtLeastNumberOfArgs("DocumentReference.update",arguments,2),moreFieldsAndValues=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",fieldOrUpdateData,value,moreFieldsAndValues)):(validateExactNumberOfArgs("DocumentReference.update",arguments,1),moreFieldsAndValues=
this.firestore._dataConverter.parseUpdateData("DocumentReference.update",fieldOrUpdateData));return this._firestoreClient.write(moreFieldsAndValues.toMutations(this._key,Precondition.exists(!0)))};DocumentReference.prototype.delete=function(){validateExactNumberOfArgs("DocumentReference.delete",arguments,0);return this._firestoreClient.write([new DeleteMutation(this._key,Precondition.NONE)])};DocumentReference.prototype.onSnapshot=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=
arguments[_i];validateBetweenNumberOfArgs("DocumentReference.onSnapshot",arguments,1,4);var options={includeMetadataChanges:!1};_i=0;"object"!==typeof args[_i]||isPartialObserver(args[_i])||(options=args[_i],validateOptionNames("DocumentReference.onSnapshot",options,["includeMetadataChanges"]),validateNamedOptionalType("DocumentReference.onSnapshot","boolean","includeMetadataChanges",options.includeMetadataChanges),_i++);options={includeMetadataChanges:options.includeMetadataChanges};isPartialObserver(args[_i])?
args=args[_i]:(validateArgType("DocumentReference.onSnapshot","function",_i,args[_i]),validateOptionalArgType("DocumentReference.onSnapshot","function",_i+1,args[_i+1]),validateOptionalArgType("DocumentReference.onSnapshot","function",_i+2,args[_i+2]),args={next:args[_i],error:args[_i+1],complete:args[_i+2]});return this.onSnapshotInternal(options,args)};DocumentReference.prototype.onSnapshotInternal=function(options,observer){var _this=this,errHandler=function(err){console.error("Uncaught Error in onSnapshot:",
err)};observer.error&&(errHandler=observer.error.bind(observer));var asyncObserver=new AsyncObserver({next:function(snapshot){if(observer.next){assert(1>=snapshot.docs.size,"Too many documents returned on a document query");var doc=snapshot.docs.get(_this._key);observer.next(new DocumentSnapshot(_this.firestore,_this._key,doc,snapshot.fromCache,snapshot.hasPendingWrites))}},error:errHandler}),internalListener=this._firestoreClient.listen(Query$jscomp$0.atPath(this._key.path),asyncObserver,options);
return function(){asyncObserver.mute();_this._firestoreClient.unlisten(internalListener)}};DocumentReference.prototype.get=function(options){var _this=this;validateBetweenNumberOfArgs("DocumentReference.get",arguments,0,1);validateGetOptions("DocumentReference.get",options);return new Promise(function(resolve,reject){options&&"cache"===options.source?_this.firestore.ensureClientConfigured().getDocumentFromLocalCache(_this._key).then(function(doc){resolve(new DocumentSnapshot(_this.firestore,_this._key,
doc,!0,doc instanceof Document$jscomp$0?doc.hasLocalMutations:!1))},reject):_this.getViaSnapshotListener(resolve,reject,options)})};DocumentReference.prototype.getViaSnapshotListener=function(resolve,reject,options){var unlisten=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(snap){unlisten();!snap.exists&&snap.metadata.fromCache?reject(new FirestoreError(Code.UNAVAILABLE,"Failed to get document because the client is offline.")):snap.exists&&snap.metadata.fromCache&&
options&&"server"===options.source?reject(new FirestoreError(Code.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):resolve(snap)},error:reject})};return DocumentReference}(),SnapshotMetadata=function(){function SnapshotMetadata(hasPendingWrites,fromCache){this.hasPendingWrites=hasPendingWrites;this.fromCache=fromCache}SnapshotMetadata.prototype.isEqual=function(other){return this.hasPendingWrites===
other.hasPendingWrites&&this.fromCache===other.fromCache};return SnapshotMetadata}(),DocumentSnapshot=function(){function DocumentSnapshot(_firestore,_key,_document,_fromCache,_hasPendingWrites){this._firestore=_firestore;this._key=_key;this._document=_document;this._fromCache=_fromCache;this._hasPendingWrites=_hasPendingWrites}DocumentSnapshot.prototype.data=function(options){validateBetweenNumberOfArgs("DocumentSnapshot.data",arguments,0,1);options=validateSnapshotOptions("DocumentSnapshot.data",
options);return this._document?this.convertObject(this._document.data,FieldValueOptions.fromSnapshotOptions(options,this._firestore._areTimestampsInSnapshotsEnabled())):void 0};DocumentSnapshot.prototype.get=function(fieldPath,options){validateBetweenNumberOfArgs("DocumentSnapshot.get",arguments,1,2);options=validateSnapshotOptions("DocumentSnapshot.get",options);if(this._document){var value=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",fieldPath));if(void 0!==value)return this.convertValue(value,
FieldValueOptions.fromSnapshotOptions(options,this._firestore._areTimestampsInSnapshotsEnabled()))}};Object.defineProperty(DocumentSnapshot.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0});Object.defineProperty(DocumentSnapshot.prototype,"ref",{get:function(){return new DocumentReference(this._key,this._firestore)},enumerable:!0,configurable:!0});Object.defineProperty(DocumentSnapshot.prototype,"exists",{get:function(){return null!==this._document},
enumerable:!0,configurable:!0});Object.defineProperty(DocumentSnapshot.prototype,"metadata",{get:function(){return new SnapshotMetadata(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0});DocumentSnapshot.prototype.isEqual=function(other){if(!(other instanceof DocumentSnapshot))throw invalidClassError("isEqual","DocumentSnapshot",1,other);return this._firestore===other._firestore&&this._fromCache===other._fromCache&&this._key.isEqual(other._key)&&(null===this._document?null===
other._document:this._document.isEqual(other._document))};DocumentSnapshot.prototype.convertObject=function(data,options){var _this=this,result={};data.forEach(function(key,value){result[key]=_this.convertValue(value,options)});return result};DocumentSnapshot.prototype.convertValue=function(value,options){if(value instanceof ObjectValue)return this.convertObject(value,options);if(value instanceof ArrayValue)return this.convertArray(value,options);if(value instanceof RefValue){options=value.value(options);
var database=this._firestore.ensureClientConfigured().databaseId();value.databaseId.isEqual(database)||error$jscomp$0("Document "+this._key.path+" contains a document reference within a different database ("+(value.databaseId.projectId+"/"+value.databaseId.database+") which is not ")+"supported. It will be treated as a reference in the current "+("database ("+database.projectId+"/"+database.database+") ")+"instead.");return new DocumentReference(options,this._firestore)}return value.value(options)};
DocumentSnapshot.prototype.convertArray=function(data,options){var _this=this;return data.internalValue.map(function(value){return _this.convertValue(value,options)})};return DocumentSnapshot}(),QueryDocumentSnapshot=function(_super){function QueryDocumentSnapshot(firestore,key,document,fromCache,hasPendingWrites){return _super.call(this,firestore,key,document,fromCache,hasPendingWrites)||this}tslib_1.__extends(QueryDocumentSnapshot,_super);QueryDocumentSnapshot.prototype.data=function(options){options=
_super.prototype.data.call(this,options);assert("object"===typeof options,"Document in a QueryDocumentSnapshot should exist");return options};return QueryDocumentSnapshot}(DocumentSnapshot),Query$1=function(){function Query(_query,firestore){this._query=_query;this.firestore=firestore}Query.prototype.where=function(field,opStr,value){validateExactNumberOfArgs("Query.where",arguments,3);validateArgType("Query.where","non-empty string",2,opStr);validateDefined("Query.where",3,value);var fieldPath=fieldPathFromArgument("Query.where",
field),relationOp=RelationOp.fromString(opStr);if(fieldPath.isKeyField()){if(relationOp===RelationOp.ARRAY_CONTAINS)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"===typeof value){if(""===value)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");
if(!this._query.isCollectionGroupQuery()&&-1!==value.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection by FieldPath.documentId(), the value provided must be a plain document ID, but "+("'"+value+"' contains a slash."));var fieldValue=this._query.path.child(ResourcePath.fromString(value));if(!DocumentKey.isDocumentKey(fieldValue))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, "+
("but '"+fieldValue+"' is not because it has an odd number of segments ("+fieldValue.length+")."));fieldValue=new RefValue(this.firestore._databaseId,new DocumentKey(fieldValue))}else if(value instanceof DocumentReference)fieldValue=new RefValue(this.firestore._databaseId,value._key);else throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+(valueDescription(value)+
"."));}else fieldValue=this.firestore._dataConverter.parseQueryValue("Query.where",value);fieldPath=Filter.create(fieldPath,relationOp,fieldValue);this.validateNewFilter(fieldPath);return new Query(this._query.addFilter(fieldPath),this.firestore)};Query.prototype.orderBy=function(field,directionStr){validateBetweenNumberOfArgs("Query.orderBy",arguments,1,2);validateOptionalArgType("Query.orderBy","non-empty string",2,directionStr);if(void 0===directionStr||"asc"===directionStr)var direction=Direction.ASCENDING;
else if("desc"===directionStr)direction=Direction.DESCENDING;else throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+directionStr+"', expected 'asc' or 'desc'.");if(null!==this._query.startAt)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");
var fieldPath=fieldPathFromArgument("Query.orderBy",field);direction=new OrderBy(fieldPath,direction);this.validateNewOrderBy(direction);return new Query(this._query.addOrderBy(direction),this.firestore)};Query.prototype.limit=function(n){validateExactNumberOfArgs("Query.limit",arguments,1);validateArgType("Query.limit","number",1,n);if(0>=n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. Query limit ("+n+") is invalid. Limit must be positive.");return new Query(this._query.withLimit(n),
this.firestore)};Query.prototype.startAt=function(docOrField){for(var fields=[],_i=1;_i<arguments.length;_i++)fields[_i-1]=arguments[_i];validateAtLeastNumberOfArgs("Query.startAt",arguments,1);fields=this.boundFromDocOrFields("Query.startAt",docOrField,fields,!0);return new Query(this._query.withStartAt(fields),this.firestore)};Query.prototype.startAfter=function(docOrField){for(var fields=[],_i=1;_i<arguments.length;_i++)fields[_i-1]=arguments[_i];validateAtLeastNumberOfArgs("Query.startAfter",
arguments,1);fields=this.boundFromDocOrFields("Query.startAfter",docOrField,fields,!1);return new Query(this._query.withStartAt(fields),this.firestore)};Query.prototype.endBefore=function(docOrField){for(var fields=[],_i=1;_i<arguments.length;_i++)fields[_i-1]=arguments[_i];validateAtLeastNumberOfArgs("Query.endBefore",arguments,1);fields=this.boundFromDocOrFields("Query.endBefore",docOrField,fields,!0);return new Query(this._query.withEndAt(fields),this.firestore)};Query.prototype.endAt=function(docOrField){for(var fields=
[],_i=1;_i<arguments.length;_i++)fields[_i-1]=arguments[_i];validateAtLeastNumberOfArgs("Query.endAt",arguments,1);fields=this.boundFromDocOrFields("Query.endAt",docOrField,fields,!1);return new Query(this._query.withEndAt(fields),this.firestore)};Query.prototype.isEqual=function(other){if(!(other instanceof Query))throw invalidClassError("isEqual","Query",1,other);return this.firestore===other.firestore&&this._query.isEqual(other._query)};Query.prototype.boundFromDocOrFields=function(methodName,
docOrField,fields,before){validateDefined(methodName,1,docOrField);if(docOrField instanceof DocumentSnapshot){if(0<fields.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+methodName+"().");if(!docOrField.exists)throw new FirestoreError(Code.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+(methodName+"()."));return this.boundFromDocument(methodName,docOrField._document,before)}docOrField=[docOrField].concat(fields);return this.boundFromFields(methodName,
docOrField,before)};Query.prototype.boundFromDocument=function(methodName,doc,before){methodName=[];for(var _i=0,_a=this._query.orderBy;_i<_a.length;_i++){var orderBy=_a[_i];if(orderBy.field.isKeyField())methodName.push(new RefValue(this.firestore._databaseId,doc.key));else{var value=doc.field(orderBy.field);if(value instanceof ServerTimestampValue)throw new FirestoreError(Code.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+orderBy.field+
'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(void 0!==value)methodName.push(value);else throw doc=orderBy.field.canonicalString(),new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a "+("document for which the field '"+doc+"' (used as the ")+"orderBy) does not exist.");}}return new Bound(methodName,before)};Query.prototype.boundFromFields=function(methodName,values,before){var orderBy=
this._query.explicitOrderBy;if(values.length>orderBy.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+methodName+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var components=[],i=0;i<values.length;i++){var rawValue=values[i];if(orderBy[i].field.isKeyField()){if("string"!==typeof rawValue)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+(methodName+"(), but got a "+
typeof rawValue));if(!this._query.isCollectionGroupQuery()&&-1!==rawValue.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), "+("the value passed to "+methodName+"() must be a plain document ID, but ")+("'"+rawValue+"' contains a slash."));rawValue=this._query.path.child(ResourcePath.fromString(rawValue));if(!DocumentKey.isDocumentKey(rawValue))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by "+
("FieldPath.documentId(), the value passed to "+methodName+"() must result in a ")+("valid document path, but '"+rawValue+"' is not because it contains an odd number ")+"of segments.");rawValue=new DocumentKey(rawValue);components.push(new RefValue(this.firestore._databaseId,rawValue))}else rawValue=this.firestore._dataConverter.parseQueryValue(methodName,rawValue),components.push(rawValue)}return new Bound(components,before)};Query.prototype.onSnapshot=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=
arguments[_i];validateBetweenNumberOfArgs("Query.onSnapshot",arguments,1,4);_i={};var currArg=0;"object"!==typeof args[currArg]||isPartialObserver(args[currArg])||(_i=args[currArg],validateOptionNames("Query.onSnapshot",_i,["includeMetadataChanges"]),validateNamedOptionalType("Query.onSnapshot","boolean","includeMetadataChanges",_i.includeMetadataChanges),currArg++);isPartialObserver(args[currArg])?args=args[currArg]:(validateArgType("Query.onSnapshot","function",currArg,args[currArg]),validateOptionalArgType("Query.onSnapshot",
"function",currArg+1,args[currArg+1]),validateOptionalArgType("Query.onSnapshot","function",currArg+2,args[currArg+2]),args={next:args[currArg],error:args[currArg+1],complete:args[currArg+2]});return this.onSnapshotInternal(_i,args)};Query.prototype.onSnapshotInternal=function(options,observer){var _this=this,errHandler=function(err){console.error("Uncaught Error in onSnapshot:",err)};observer.error&&(errHandler=observer.error.bind(observer));var asyncObserver=new AsyncObserver({next:function(result){observer.next&&
observer.next(new QuerySnapshot(_this.firestore,_this._query,result))},error:errHandler}),firestoreClient=this.firestore.ensureClientConfigured(),internalListener=firestoreClient.listen(this._query,asyncObserver,options);return function(){asyncObserver.mute();firestoreClient.unlisten(internalListener)}};Query.prototype.get=function(options){var _this=this;validateBetweenNumberOfArgs("Query.get",arguments,0,1);validateGetOptions("Query.get",options);return new Promise(function(resolve,reject){options&&
"cache"===options.source?_this.firestore.ensureClientConfigured().getDocumentsFromLocalCache(_this._query).then(function(viewSnap){resolve(new QuerySnapshot(_this.firestore,_this._query,viewSnap))},reject):_this.getViaSnapshotListener(resolve,reject,options)})};Query.prototype.getViaSnapshotListener=function(resolve,reject,options){var unlisten=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(result){unlisten();result.metadata.fromCache&&options&&"server"===
options.source?reject(new FirestoreError(Code.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):resolve(result)},error:reject})};Query.prototype.validateNewFilter=function(filter){if(filter instanceof RelationFilter)if(filter.isInequality()){var existingField=this._query.getInequalityFilterField();if(null!==existingField&&!existingField.isEqual(filter.field))throw new FirestoreError(Code.INVALID_ARGUMENT,
"Invalid query. All where filters with an inequality (\x3c, \x3c\x3d, \x3e, or \x3e\x3d) must be on the same field. But you have"+(" inequality filters on '"+existingField.toString()+"'")+(" and '"+filter.field.toString()+"'"));existingField=this._query.getFirstOrderByField();null!==existingField&&this.validateOrderByAndInequalityMatch(filter.field,existingField)}else if(filter.op===RelationOp.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.");
};Query.prototype.validateNewOrderBy=function(orderBy){if(null===this._query.getFirstOrderByField()){var inequalityField=this._query.getInequalityFilterField();null!==inequalityField&&this.validateOrderByAndInequalityMatch(inequalityField,orderBy.field)}};Query.prototype.validateOrderByAndInequalityMatch=function(inequality,orderBy){if(!orderBy.isEqual(inequality))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality "+("(\x3c, \x3c\x3d, \x3e, or \x3e\x3d) on field '"+
inequality.toString()+"' ")+("and so you must also use '"+inequality.toString()+"' ")+"as your first Query.orderBy(), but your first Query.orderBy() "+("is on field '"+orderBy.toString()+"' instead."));};return Query}(),QuerySnapshot=function(){function QuerySnapshot(_firestore,_originalQuery,_snapshot){this._firestore=_firestore;this._originalQuery=_originalQuery;this._snapshot=_snapshot;this._cachedChangesIncludeMetadataChanges=this._cachedChanges=null;this.metadata=new SnapshotMetadata(_snapshot.hasPendingWrites,
_snapshot.fromCache)}Object.defineProperty(QuerySnapshot.prototype,"docs",{get:function(){var result=[];this.forEach(function(doc){return result.push(doc)});return result},enumerable:!0,configurable:!0});Object.defineProperty(QuerySnapshot.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0});Object.defineProperty(QuerySnapshot.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0});QuerySnapshot.prototype.forEach=
function(callback,thisArg){var _this=this;validateBetweenNumberOfArgs("QuerySnapshot.forEach",arguments,1,2);validateArgType("QuerySnapshot.forEach","function",1,callback);this._snapshot.docs.forEach(function(doc){callback.call(thisArg,_this.convertToDocumentImpl(doc))})};Object.defineProperty(QuerySnapshot.prototype,"query",{get:function(){return new Query$1(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0});QuerySnapshot.prototype.docChanges=function(options){options&&(validateOptionNames("QuerySnapshot.docChanges",
options,["includeMetadataChanges"]),validateNamedOptionalType("QuerySnapshot.docChanges","boolean","includeMetadataChanges",options.includeMetadataChanges));if((options=!(!options||!options.includeMetadataChanges))&&this._snapshot.excludesMetadataChanges)throw new FirestoreError(Code.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===options||
(this._cachedChanges=changesFromSnapshot(this._firestore,options,this._snapshot),this._cachedChangesIncludeMetadataChanges=options);return this._cachedChanges};QuerySnapshot.prototype.isEqual=function(other){if(!(other instanceof QuerySnapshot))throw invalidClassError("isEqual","QuerySnapshot",1,other);return this._firestore===other._firestore&&this._originalQuery.isEqual(other._originalQuery)&&this._snapshot.isEqual(other._snapshot)};QuerySnapshot.prototype.convertToDocumentImpl=function(doc){return new QueryDocumentSnapshot(this._firestore,
doc.key,doc,this.metadata.fromCache,this._snapshot.mutatedKeys.has(doc.key))};return QuerySnapshot}();["length","forEach","map"].concat("undefined"!==typeof Symbol?[Symbol.iterator]:[]).forEach(function(property){try{Object.defineProperty(QuerySnapshot.prototype.docChanges,property,{get:function(){throw new FirestoreError(Code.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"');
}})}catch(err){}});var CollectionReference=function(_super){function CollectionReference(path,firestore){firestore=_super.call(this,Query$jscomp$0.atPath(path),firestore)||this;if(1!==path.length%2)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+(path.canonicalString()+" has "+path.length));return firestore}tslib_1.__extends(CollectionReference,_super);Object.defineProperty(CollectionReference.prototype,
"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0});Object.defineProperty(CollectionReference.prototype,"parent",{get:function(){var parentPath=this._query.path.popLast();return parentPath.isEmpty()?null:new DocumentReference(new DocumentKey(parentPath),this.firestore)},enumerable:!0,configurable:!0});Object.defineProperty(CollectionReference.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0});CollectionReference.prototype.doc=
function(pathString){validateBetweenNumberOfArgs("CollectionReference.doc",arguments,0,1);0===arguments.length&&(pathString=AutoId.newId());validateArgType("CollectionReference.doc","non-empty string",1,pathString);if(""===pathString)throw new FirestoreError(Code.INVALID_ARGUMENT,"Document path must be a non-empty string");var path=ResourcePath.fromString(pathString);return DocumentReference.forPath(this._query.path.child(path),this.firestore)};CollectionReference.prototype.add=function(value){validateExactNumberOfArgs("CollectionReference.add",
arguments,1);validateArgType("CollectionReference.add","object",1,value);var docRef=this.doc();return docRef.set(value).then(function(){return docRef})};return CollectionReference}(Query$1),PublicFirestore=makeConstructorPrivate(Firestore,"Use firebase.firestore() instead."),PublicTransaction=makeConstructorPrivate(Transaction$1,"Use firebase.firestore().runTransaction() instead."),PublicWriteBatch=makeConstructorPrivate(WriteBatch,"Use firebase.firestore().batch() instead."),PublicDocumentReference=
makeConstructorPrivate(DocumentReference,"Use firebase.firestore().doc() instead."),PublicDocumentSnapshot=makeConstructorPrivate(DocumentSnapshot),PublicQueryDocumentSnapshot=makeConstructorPrivate(QueryDocumentSnapshot),PublicQuery=makeConstructorPrivate(Query$1),PublicQuerySnapshot=makeConstructorPrivate(QuerySnapshot),PublicCollectionReference=makeConstructorPrivate(CollectionReference,"Use firebase.firestore().collection() instead."),firestoreNamespace={Firestore:PublicFirestore,GeoPoint:GeoPoint,
Timestamp:Timestamp,Blob:PublicBlob,Transaction:PublicTransaction,WriteBatch:PublicWriteBatch,DocumentReference:PublicDocumentReference,DocumentSnapshot:PublicDocumentSnapshot,Query:PublicQuery,QueryDocumentSnapshot:PublicQueryDocumentSnapshot,QuerySnapshot:PublicQuerySnapshot,CollectionReference:PublicCollectionReference,FieldPath:FieldPath$1,FieldValue:PublicFieldValue,setLogLevel:Firestore.setLogLevel,CACHE_SIZE_UNLIMITED:CACHE_SIZE_UNLIMITED};configureForFirebase(firebase$jscomp$0);exports.registerFirestore=
function(instance){configureForFirebase(instance)}}
//# sourceMappingURL=module$node_modules$$firebase$firestore$dist$index_cjs.js.map
