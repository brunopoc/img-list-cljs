shadow$provide.module$node_modules$$firebase$messaging$dist$index_cjs=function(global,process,require,module,exports,shadow$shims){function isArrayBufferEqual(a,b){if(null==a||null==b)return!1;if(a===b)return!0;if(a.byteLength!==b.byteLength)return!1;var viewA=new DataView(a);b=new DataView(b);for(var i=0;i<a.byteLength;i++)if(viewA.getUint8(i)!==b.getUint8(i))return!1;return!0}function arrayBufferToBase64(arrayBuffer){arrayBuffer=new Uint8Array(arrayBuffer);return btoa(String.fromCharCode.apply(String,
tslib_1.__spread(arrayBuffer))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function base64ToArrayBuffer(base64String){var padding="\x3d".repeat((4-base64String.length%4)%4);base64String=(base64String+padding).replace(/\-/g,"+").replace(/_/g,"/");base64String=atob(base64String);padding=new Uint8Array(base64String.length);for(var i=0;i<base64String.length;++i)padding[i]=base64String.charCodeAt(i);return padding}function handleDb(db){if(db.objectStoreNames.contains("fcm_token_object_Store")){var objectStore=
db.transaction("fcm_token_object_Store").objectStore("fcm_token_object_Store"),iidModel=new IidModel,openCursorRequest=objectStore.openCursor();openCursorRequest.onerror=function(event){console.warn("Unable to cleanup old IDB.",event)};openCursorRequest.onsuccess=function(){var cursor=openCursorRequest.result;if(cursor){var tokenDetails=cursor.value;iidModel.deleteToken(tokenDetails.fcmSenderId,tokenDetails.fcmToken,tokenDetails.fcmPushSet);cursor.continue()}else db.close(),indexedDB.deleteDatabase("undefined")}}}
function cleanV1(){var request=indexedDB.open("undefined");request.onerror=function(event){};request.onsuccess=function(event){handleDb(request.result)}}function promisify(request){return new Promise(function(resolve,reject){request.onsuccess=function(){resolve(request.result)};request.onerror=function(){reject(request.error)}})}function validateInputs(input){if(input.fcmToken&&("string"!==typeof input.fcmToken||0===input.fcmToken.length))throw errorFactory.create(ERROR_CODES.BAD_TOKEN);if(input.swScope&&
("string"!==typeof input.swScope||0===input.swScope.length))throw errorFactory.create(ERROR_CODES.BAD_SCOPE);if(input.vapidKey&&!(input.vapidKey instanceof Uint8Array&&65===input.vapidKey.length))throw errorFactory.create(ERROR_CODES.BAD_VAPID_KEY);if(input.endpoint&&("string"!==typeof input.endpoint||0===input.endpoint.length))throw errorFactory.create(ERROR_CODES.BAD_SUBSCRIPTION);if(input.auth&&!(input.auth instanceof ArrayBuffer))throw errorFactory.create(ERROR_CODES.BAD_SUBSCRIPTION);if(input.p256dh&&
!(input.p256dh instanceof ArrayBuffer))throw errorFactory.create(ERROR_CODES.BAD_SUBSCRIPTION);if(input.fcmSenderId&&("string"!==typeof input.fcmSenderId||0===input.fcmSenderId.length))throw errorFactory.create(ERROR_CODES.BAD_SENDER_ID);if(input.fcmPushSet&&("string"!==typeof input.fcmPushSet||0===input.fcmPushSet.length))throw errorFactory.create(ERROR_CODES.BAD_PUSH_SET);}function getClientList(){return self.clients.matchAll({type:"window",includeUncontrolled:!0})}function createNewMsg(msgType,
msgData){var _a;return _a={},_a[MessageParameter.TYPE_OF_MSG]=msgType,_a[MessageParameter.DATA]=msgData,_a}function manifestCheck(){return tslib_1.__awaiter(this,void 0,void 0,function(){var manifestTag,manifestContent,response;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:manifestTag=document.querySelector('link[rel\x3d"manifest"]');if(!manifestTag)return[2];_a.label=1;case 1:return _a.trys.push([1,4,,5]),[4,fetch(manifestTag.href)];case 2:return response=_a.sent(),[4,response.json()];
case 3:return manifestContent=_a.sent(),[3,5];case 4:return _a.sent(),[2];case 5:if(!manifestContent||!manifestContent.gcm_sender_id)return[2];if("103953800507"!==manifestContent.gcm_sender_id)throw errorFactory.create(ERROR_CODES.INCORRECT_GCM_SENDER_ID);return[2]}})})}function registerMessaging(instance){instance.INTERNAL.registerService("messaging",function(app){if(!isSupported())throw errorFactory.create(ERROR_CODES.UNSUPPORTED_BROWSER);return self&&"ServiceWorkerGlobalScope"in self?new SwController(app):
new WindowController(app)},{isSupported:isSupported})}function isSupported(){return self&&"ServiceWorkerGlobalScope"in self?"PushManager"in self&&"Notification"in self&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey"):navigator.cookieEnabled&&"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&"fetch"in window&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey")}
Object.defineProperty(exports,"__esModule",{value:!0});global=function(ex){return ex&&"object"===typeof ex&&"default"in ex?ex["default"]:ex}(require("module$node_modules$$firebase$app$dist$index_cjs"));var tslib_1=require("module$node_modules$tslib$tslib"),util=require("module$node_modules$$firebase$util$dist$index_cjs"),_a$jscomp$0,ERROR_CODES={AVAILABLE_IN_WINDOW:"only-available-in-window",AVAILABLE_IN_SW:"only-available-in-sw",SHOULD_BE_INHERITED:"should-be-overriden",BAD_SENDER_ID:"bad-sender-id",
INCORRECT_GCM_SENDER_ID:"incorrect-gcm-sender-id",PERMISSION_DEFAULT:"permission-default",PERMISSION_BLOCKED:"permission-blocked",UNSUPPORTED_BROWSER:"unsupported-browser",NOTIFICATIONS_BLOCKED:"notifications-blocked",FAILED_DEFAULT_REGISTRATION:"failed-serviceworker-registration",SW_REGISTRATION_EXPECTED:"sw-registration-expected",GET_SUBSCRIPTION_FAILED:"get-subscription-failed",INVALID_SAVED_TOKEN:"invalid-saved-token",SW_REG_REDUNDANT:"sw-reg-redundant",TOKEN_SUBSCRIBE_FAILED:"token-subscribe-failed",
TOKEN_SUBSCRIBE_NO_TOKEN:"token-subscribe-no-token",TOKEN_SUBSCRIBE_NO_PUSH_SET:"token-subscribe-no-push-set",TOKEN_UNSUBSCRIBE_FAILED:"token-unsubscribe-failed",TOKEN_UPDATE_FAILED:"token-update-failed",TOKEN_UPDATE_NO_TOKEN:"token-update-no-token",USE_SW_BEFORE_GET_TOKEN:"use-sw-before-get-token",INVALID_DELETE_TOKEN:"invalid-delete-token",DELETE_TOKEN_NOT_FOUND:"delete-token-not-found",DELETE_SCOPE_NOT_FOUND:"delete-scope-not-found",BG_HANDLER_FUNCTION_EXPECTED:"bg-handler-function-expected",NO_WINDOW_CLIENT_TO_MSG:"no-window-client-to-msg",
UNABLE_TO_RESUBSCRIBE:"unable-to-resubscribe",NO_FCM_TOKEN_FOR_RESUBSCRIBE:"no-fcm-token-for-resubscribe",FAILED_TO_DELETE_TOKEN:"failed-to-delete-token",NO_SW_IN_REG:"no-sw-in-reg",BAD_SCOPE:"bad-scope",BAD_VAPID_KEY:"bad-vapid-key",BAD_SUBSCRIPTION:"bad-subscription",BAD_TOKEN:"bad-token",BAD_PUSH_SET:"bad-push-set",FAILED_DELETE_VAPID_KEY:"failed-delete-vapid-key",INVALID_PUBLIC_VAPID_KEY:"invalid-public-vapid-key",USE_PUBLIC_KEY_BEFORE_GET_TOKEN:"use-public-key-before-get-token",PUBLIC_KEY_DECRYPTION_FAILED:"public-vapid-key-decryption-failed"};
require=(_a$jscomp$0={},_a$jscomp$0[ERROR_CODES.AVAILABLE_IN_WINDOW]="This method is available in a Window context.",_a$jscomp$0[ERROR_CODES.AVAILABLE_IN_SW]="This method is available in a service worker context.",_a$jscomp$0[ERROR_CODES.SHOULD_BE_INHERITED]="This method should be overriden by extended classes.",_a$jscomp$0[ERROR_CODES.BAD_SENDER_ID]="Please ensure that 'messagingSenderId' is set correctly in the options passed into firebase.initializeApp().",_a$jscomp$0[ERROR_CODES.PERMISSION_DEFAULT]=
"The required permissions were not granted and dismissed instead.",_a$jscomp$0[ERROR_CODES.PERMISSION_BLOCKED]="The required permissions were not granted and blocked instead.",_a$jscomp$0[ERROR_CODES.UNSUPPORTED_BROWSER]="This browser doesn't support the API's required to use the firebase SDK.",_a$jscomp$0[ERROR_CODES.NOTIFICATIONS_BLOCKED]="Notifications have been blocked.",_a$jscomp$0[ERROR_CODES.FAILED_DEFAULT_REGISTRATION]="We are unable to register the default service worker. {$browserErrorMessage}",
_a$jscomp$0[ERROR_CODES.SW_REGISTRATION_EXPECTED]="A service worker registration was the expected input.",_a$jscomp$0[ERROR_CODES.GET_SUBSCRIPTION_FAILED]="There was an error when trying to get any existing Push Subscriptions.",_a$jscomp$0[ERROR_CODES.INVALID_SAVED_TOKEN]="Unable to access details of the saved token.",_a$jscomp$0[ERROR_CODES.SW_REG_REDUNDANT]="The service worker being used for push was made redundant.",_a$jscomp$0[ERROR_CODES.TOKEN_SUBSCRIBE_FAILED]="A problem occured while subscribing the user to FCM: {$message}",
_a$jscomp$0[ERROR_CODES.TOKEN_SUBSCRIBE_NO_TOKEN]="FCM returned no token when subscribing the user to push.",_a$jscomp$0[ERROR_CODES.TOKEN_SUBSCRIBE_NO_PUSH_SET]="FCM returned an invalid response when getting an FCM token.",_a$jscomp$0[ERROR_CODES.TOKEN_UNSUBSCRIBE_FAILED]="A problem occured while unsubscribing the user from FCM: {$message}",_a$jscomp$0[ERROR_CODES.TOKEN_UPDATE_FAILED]="A problem occured while updating the user from FCM: {$message}",_a$jscomp$0[ERROR_CODES.TOKEN_UPDATE_NO_TOKEN]=
"FCM returned no token when updating the user to push.",_a$jscomp$0[ERROR_CODES.USE_SW_BEFORE_GET_TOKEN]="The useServiceWorker() method may only be called once and must be called before calling getToken() to ensure your service worker is used.",_a$jscomp$0[ERROR_CODES.INVALID_DELETE_TOKEN]="You must pass a valid token into deleteToken(), i.e. the token from getToken().",_a$jscomp$0[ERROR_CODES.DELETE_TOKEN_NOT_FOUND]="The deletion attempt for token could not be performed as the token was not found.",
_a$jscomp$0[ERROR_CODES.DELETE_SCOPE_NOT_FOUND]="The deletion attempt for service worker scope could not be performed as the scope was not found.",_a$jscomp$0[ERROR_CODES.BG_HANDLER_FUNCTION_EXPECTED]="The input to setBackgroundMessageHandler() must be a function.",_a$jscomp$0[ERROR_CODES.NO_WINDOW_CLIENT_TO_MSG]="An attempt was made to message a non-existant window client.",_a$jscomp$0[ERROR_CODES.UNABLE_TO_RESUBSCRIBE]="There was an error while re-subscribing the FCM token for push messaging. Will have to resubscribe the user on next visit. {$message}",
_a$jscomp$0[ERROR_CODES.NO_FCM_TOKEN_FOR_RESUBSCRIBE]="Could not find an FCM token and as a result, unable to resubscribe. Will have to resubscribe the user on next visit.",_a$jscomp$0[ERROR_CODES.FAILED_TO_DELETE_TOKEN]="Unable to delete the currently saved token.",_a$jscomp$0[ERROR_CODES.NO_SW_IN_REG]="Even though the service worker registration was successful, there was a problem accessing the service worker itself.",_a$jscomp$0[ERROR_CODES.INCORRECT_GCM_SENDER_ID]="Please change your web app manifest's 'gcm_sender_id' value to '103953800507' to use Firebase messaging.",
_a$jscomp$0[ERROR_CODES.BAD_SCOPE]="The service worker scope must be a string with at least one character.",_a$jscomp$0[ERROR_CODES.BAD_VAPID_KEY]="The public VAPID key is not a Uint8Array with 65 bytes.",_a$jscomp$0[ERROR_CODES.BAD_SUBSCRIPTION]="The subscription must be a valid PushSubscription.",_a$jscomp$0[ERROR_CODES.BAD_TOKEN]="The FCM Token used for storage / lookup was not a valid token string.",_a$jscomp$0[ERROR_CODES.BAD_PUSH_SET]="The FCM push set used for storage / lookup was not not a valid push set string.",
_a$jscomp$0[ERROR_CODES.FAILED_DELETE_VAPID_KEY]="The VAPID key could not be deleted.",_a$jscomp$0[ERROR_CODES.INVALID_PUBLIC_VAPID_KEY]="The public VAPID key must be a string.",_a$jscomp$0[ERROR_CODES.PUBLIC_KEY_DECRYPTION_FAILED]="The public VAPID key did not equal 65 bytes when decrypted.",_a$jscomp$0);var errorFactory=new util.ErrorFactory("messaging","Messaging",require),DEFAULT_PUBLIC_VAPID_KEY=new Uint8Array([4,51,148,247,223,161,235,177,220,3,162,94,21,113,219,72,211,46,237,237,178,52,219,
183,71,58,12,143,196,204,225,111,60,140,132,223,171,182,102,62,242,12,212,139,254,227,249,118,47,20,28,99,8,106,111,45,177,26,149,176,206,55,192,156,110]),MessageParameter;(function(MessageParameter){MessageParameter.TYPE_OF_MSG="firebase-messaging-msg-type";MessageParameter.DATA="firebase-messaging-msg-data"})(MessageParameter||(MessageParameter={}));var MessageType;(function(MessageType){MessageType.PUSH_MSG_RECEIVED="push-msg-received";MessageType.NOTIFICATION_CLICKED="notification-clicked"})(MessageType||
(MessageType={}));var IidModel=function(){function IidModel(){}IidModel.prototype.getToken=function(senderId,subscription,publicVapidKey){return tslib_1.__awaiter(this,void 0,void 0,function(){var p256dh,auth,fcmSubscribeBody,applicationPubKey,headers,subscribeOptions,responseData,response,message;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:p256dh=arrayBufferToBase64(subscription.getKey("p256dh")),auth=arrayBufferToBase64(subscription.getKey("auth")),fcmSubscribeBody="authorized_entity\x3d"+
senderId+"\x26"+("endpoint\x3d"+subscription.endpoint+"\x26")+("encryption_key\x3d"+p256dh+"\x26")+("encryption_auth\x3d"+auth),isArrayBufferEqual(publicVapidKey.buffer,DEFAULT_PUBLIC_VAPID_KEY.buffer)||(applicationPubKey=arrayBufferToBase64(publicVapidKey),fcmSubscribeBody+="\x26application_pub_key\x3d"+applicationPubKey),headers=new Headers,headers.append("Content-Type","application/x-www-form-urlencoded"),subscribeOptions={method:"POST",headers:headers,body:fcmSubscribeBody},_a.label=1;case 1:return _a.trys.push([1,
4,,5]),[4,fetch("https://fcm.googleapis.com/fcm/connect/subscribe",subscribeOptions)];case 2:return response=_a.sent(),[4,response.json()];case 3:return responseData=_a.sent(),[3,5];case 4:throw _a.sent(),errorFactory.create(ERROR_CODES.TOKEN_SUBSCRIBE_FAILED);case 5:if(responseData.error)throw message=responseData.error.message,errorFactory.create(ERROR_CODES.TOKEN_SUBSCRIBE_FAILED,{message:message});if(!responseData.token)throw errorFactory.create(ERROR_CODES.TOKEN_SUBSCRIBE_NO_TOKEN);if(!responseData.pushSet)throw errorFactory.create(ERROR_CODES.TOKEN_SUBSCRIBE_NO_PUSH_SET);
return[2,{token:responseData.token,pushSet:responseData.pushSet}]}})})};IidModel.prototype.updateToken=function(senderId,fcmToken,fcmPushSet,subscription,publicVapidKey){return tslib_1.__awaiter(this,void 0,void 0,function(){var p256dh,auth,fcmUpdateBody,applicationPubKey,headers,updateOptions,responseData,response,message;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:p256dh=arrayBufferToBase64(subscription.getKey("p256dh")),auth=arrayBufferToBase64(subscription.getKey("auth")),
fcmUpdateBody="push_set\x3d"+fcmPushSet+"\x26"+("token\x3d"+fcmToken+"\x26")+("authorized_entity\x3d"+senderId+"\x26")+("endpoint\x3d"+subscription.endpoint+"\x26")+("encryption_key\x3d"+p256dh+"\x26")+("encryption_auth\x3d"+auth),isArrayBufferEqual(publicVapidKey.buffer,DEFAULT_PUBLIC_VAPID_KEY.buffer)||(applicationPubKey=arrayBufferToBase64(publicVapidKey),fcmUpdateBody+="\x26application_pub_key\x3d"+applicationPubKey),headers=new Headers,headers.append("Content-Type","application/x-www-form-urlencoded"),
updateOptions={method:"POST",headers:headers,body:fcmUpdateBody},_a.label=1;case 1:return _a.trys.push([1,4,,5]),[4,fetch("https://fcm.googleapis.com/fcm/connect/subscribe",updateOptions)];case 2:return response=_a.sent(),[4,response.json()];case 3:return responseData=_a.sent(),[3,5];case 4:throw _a.sent(),errorFactory.create(ERROR_CODES.TOKEN_UPDATE_FAILED);case 5:if(responseData.error)throw message=responseData.error.message,errorFactory.create(ERROR_CODES.TOKEN_UPDATE_FAILED,{message:message});
if(!responseData.token)throw errorFactory.create(ERROR_CODES.TOKEN_UPDATE_NO_TOKEN);return[2,responseData.token]}})})};IidModel.prototype.deleteToken=function(senderId,fcmToken,fcmPushSet){return tslib_1.__awaiter(this,void 0,void 0,function(){var fcmUnsubscribeBody,headers,unsubscribeOptions,response,responseData,message;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:fcmUnsubscribeBody="authorized_entity\x3d"+senderId+"\x26"+("token\x3d"+fcmToken+"\x26")+("pushSet\x3d"+fcmPushSet),
headers=new Headers,headers.append("Content-Type","application/x-www-form-urlencoded"),unsubscribeOptions={method:"POST",headers:headers,body:fcmUnsubscribeBody},_a.label=1;case 1:return _a.trys.push([1,4,,5]),[4,fetch("https://fcm.googleapis.com/fcm/connect/unsubscribe",unsubscribeOptions)];case 2:return response=_a.sent(),[4,response.json()];case 3:responseData=_a.sent();if(responseData.error)throw message=responseData.error.message,errorFactory.create(ERROR_CODES.TOKEN_UNSUBSCRIBE_FAILED,{message:message});
return[3,5];case 4:throw _a.sent(),errorFactory.create(ERROR_CODES.TOKEN_UNSUBSCRIBE_FAILED);case 5:return[2]}})})};return IidModel}();_a$jscomp$0=function(){function DbInterface(){this.dbPromise=null}DbInterface.prototype.get=function(key){return this.createTransaction(function(objectStore){return objectStore.get(key)})};DbInterface.prototype.getIndex=function(index,key){return this.createTransaction(function(objectStore){return objectStore.index(index).get(key)})};DbInterface.prototype.put=function(value){return this.createTransaction(function(objectStore){return objectStore.put(value)},
"readwrite")};DbInterface.prototype.delete=function(key){return this.createTransaction(function(objectStore){return objectStore.delete(key)},"readwrite")};DbInterface.prototype.closeDatabase=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var db;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return this.dbPromise?[4,this.dbPromise]:[3,2];case 1:db=_a.sent(),db.close(),this.dbPromise=null,_a.label=2;case 2:return[2]}})})};DbInterface.prototype.createTransaction=
function(runRequest,mode){void 0===mode&&(mode="readonly");return tslib_1.__awaiter(this,void 0,void 0,function(){var db,transaction,request,result;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.getDb()];case 1:return db=_a.sent(),transaction=db.transaction(this.objectStoreName,mode),request=transaction.objectStore(this.objectStoreName),[4,promisify(runRequest(request))];case 2:return result=_a.sent(),[2,new Promise(function(resolve,reject){transaction.oncomplete=
function(){resolve(result)};transaction.onerror=function(){reject(transaction.error)}})]}})})};DbInterface.prototype.getDb=function(){var _this=this;this.dbPromise||(this.dbPromise=new Promise(function(resolve,reject){var request=indexedDB.open(_this.dbName,_this.dbVersion);request.onsuccess=function(){resolve(request.result)};request.onerror=function(){_this.dbPromise=null;reject(request.error)};request.onupgradeneeded=function(event){return _this.onDbUpgrade(request,event)}}));return this.dbPromise};
return DbInterface}();var TokenDetailsModel=function(_super){function TokenDetailsModel(){var _this=null!==_super&&_super.apply(this,arguments)||this;_this.dbName="fcm_token_details_db";_this.dbVersion=3;_this.objectStoreName="fcm_token_object_Store";return _this}tslib_1.__extends(TokenDetailsModel,_super);TokenDetailsModel.prototype.onDbUpgrade=function(request,event){var db=request.result;switch(event.oldVersion){case 0:event=db.createObjectStore(this.objectStoreName,{keyPath:"swScope"}),event.createIndex("fcmSenderId",
"fcmSenderId",{unique:!1}),event.createIndex("fcmToken","fcmToken",{unique:!0});case 1:cleanV1();case 2:event=request.transaction.objectStore(this.objectStoreName);var cursorRequest_1=event.openCursor();cursorRequest_1.onsuccess=function(){var cursor=cursorRequest_1.result;if(cursor){var value=cursor.value,newValue=tslib_1.__assign({},value);value.createTime||(newValue.createTime=Date.now());"string"===typeof value.vapidKey&&(newValue.vapidKey=base64ToArrayBuffer(value.vapidKey));"string"===typeof value.auth&&
(newValue.auth=base64ToArrayBuffer(value.auth).buffer);"string"===typeof value.auth&&(newValue.p256dh=base64ToArrayBuffer(value.p256dh).buffer);cursor.update(newValue);cursor.continue()}}}};TokenDetailsModel.prototype.getTokenDetailsFromToken=function(fcmToken){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(!fcmToken)throw errorFactory.create(ERROR_CODES.BAD_TOKEN);validateInputs({fcmToken:fcmToken});return[2,this.getIndex("fcmToken",fcmToken)]})})};
TokenDetailsModel.prototype.getTokenDetailsFromSWScope=function(swScope){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(!swScope)throw errorFactory.create(ERROR_CODES.BAD_SCOPE);validateInputs({swScope:swScope});return[2,this.get(swScope)]})})};TokenDetailsModel.prototype.saveTokenDetails=function(tokenDetails){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(!tokenDetails.swScope)throw errorFactory.create(ERROR_CODES.BAD_SCOPE);
if(!tokenDetails.vapidKey)throw errorFactory.create(ERROR_CODES.BAD_VAPID_KEY);if(!tokenDetails.endpoint||!tokenDetails.auth||!tokenDetails.p256dh)throw errorFactory.create(ERROR_CODES.BAD_SUBSCRIPTION);if(!tokenDetails.fcmSenderId)throw errorFactory.create(ERROR_CODES.BAD_SENDER_ID);if(!tokenDetails.fcmToken)throw errorFactory.create(ERROR_CODES.BAD_TOKEN);if(!tokenDetails.fcmPushSet)throw errorFactory.create(ERROR_CODES.BAD_PUSH_SET);validateInputs(tokenDetails);return[2,this.put(tokenDetails)]})})};
TokenDetailsModel.prototype.deleteToken=function(token){return tslib_1.__awaiter(this,void 0,void 0,function(){var details;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return"string"!==typeof token||0===token.length?[2,Promise.reject(errorFactory.create(ERROR_CODES.INVALID_DELETE_TOKEN))]:[4,this.getTokenDetailsFromToken(token)];case 1:details=_a.sent();if(!details)throw errorFactory.create(ERROR_CODES.DELETE_TOKEN_NOT_FOUND);return[4,this.delete(details.swScope)];case 2:return _a.sent(),
[2,details]}})})};return TokenDetailsModel}(_a$jscomp$0),VapidDetailsModel=function(_super){function VapidDetailsModel(){var _this=null!==_super&&_super.apply(this,arguments)||this;_this.dbName="fcm_vapid_details_db";_this.dbVersion=1;_this.objectStoreName="fcm_vapid_object_Store";return _this}tslib_1.__extends(VapidDetailsModel,_super);VapidDetailsModel.prototype.onDbUpgrade=function(request){request.result.createObjectStore(this.objectStoreName,{keyPath:"swScope"})};VapidDetailsModel.prototype.getVapidFromSWScope=
function(swScope){return tslib_1.__awaiter(this,void 0,void 0,function(){var result;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if("string"!==typeof swScope||0===swScope.length)throw errorFactory.create(ERROR_CODES.BAD_SCOPE);return[4,this.get(swScope)];case 1:return result=_a.sent(),[2,result?result.vapidKey:void 0]}})})};VapidDetailsModel.prototype.saveVapidDetails=function(swScope,vapidKey){return tslib_1.__awaiter(this,void 0,void 0,function(){var details;return tslib_1.__generator(this,
function(_a){if("string"!==typeof swScope||0===swScope.length)throw errorFactory.create(ERROR_CODES.BAD_SCOPE);if(null===vapidKey||65!==vapidKey.length)throw errorFactory.create(ERROR_CODES.BAD_VAPID_KEY);details={swScope:swScope,vapidKey:vapidKey};return[2,this.put(details)]})})};VapidDetailsModel.prototype.deleteVapidDetails=function(swScope){return tslib_1.__awaiter(this,void 0,void 0,function(){var vapidKey;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.getVapidFromSWScope(swScope)];
case 1:vapidKey=_a.sent();if(!vapidKey)throw errorFactory.create(ERROR_CODES.DELETE_SCOPE_NOT_FOUND);return[4,this.delete(swScope)];case 2:return _a.sent(),[2,vapidKey]}})})};return VapidDetailsModel}(_a$jscomp$0);_a$jscomp$0=function(){function BaseController(app){var _this=this;if(!app.options.messagingSenderId||"string"!==typeof app.options.messagingSenderId)throw errorFactory.create(ERROR_CODES.BAD_SENDER_ID);this.messagingSenderId=app.options.messagingSenderId;this.tokenDetailsModel=new TokenDetailsModel;
this.vapidDetailsModel=new VapidDetailsModel;this.iidModel=new IidModel;this.app=app;this.INTERNAL={delete:function(){return _this.delete()}}}BaseController.prototype.getToken=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var currentPermission,swReg,publicVapidKey,pushSubscription,tokenDetails;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:currentPermission=this.getNotificationPermission_();if("denied"===currentPermission)throw errorFactory.create(ERROR_CODES.NOTIFICATIONS_BLOCKED);
return"granted"!==currentPermission?[2,null]:[4,this.getSWRegistration_()];case 1:return swReg=_a.sent(),[4,this.getPublicVapidKey_()];case 2:return publicVapidKey=_a.sent(),[4,this.getPushSubscription(swReg,publicVapidKey)];case 3:return pushSubscription=_a.sent(),[4,this.tokenDetailsModel.getTokenDetailsFromSWScope(swReg.scope)];case 4:return(tokenDetails=_a.sent())?[2,this.manageExistingToken(swReg,pushSubscription,publicVapidKey,tokenDetails)]:[2,this.getNewToken(swReg,pushSubscription,publicVapidKey)]}})})};
BaseController.prototype.manageExistingToken=function(swReg,pushSubscription,publicVapidKey,tokenDetails){return tslib_1.__awaiter(this,void 0,void 0,function(){var isTokenValid,now;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(tokenDetails.vapidKey&&isArrayBufferEqual(publicVapidKey.buffer,tokenDetails.vapidKey.buffer)){_a=pushSubscription.endpoint===tokenDetails.endpoint;var isAuthEqual=isArrayBufferEqual(pushSubscription.getKey("auth"),tokenDetails.auth),isP256dhEqual=
isArrayBufferEqual(pushSubscription.getKey("p256dh"),tokenDetails.p256dh);isTokenValid=_a&&isAuthEqual&&isP256dhEqual}else isTokenValid=!1;return isTokenValid?(now=Date.now(),now<tokenDetails.createTime+6048E5?[2,tokenDetails.fcmToken]:[2,this.updateToken(swReg,pushSubscription,publicVapidKey,tokenDetails)]):[4,this.deleteTokenFromDB(tokenDetails.fcmToken)];case 1:return _a.sent(),[2,this.getNewToken(swReg,pushSubscription,publicVapidKey)]}})})};BaseController.prototype.updateToken=function(swReg,
pushSubscription,publicVapidKey,tokenDetails){return tslib_1.__awaiter(this,void 0,void 0,function(){var updatedToken,allDetails,e_1;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,4,,6]),[4,this.iidModel.updateToken(this.messagingSenderId,tokenDetails.fcmToken,tokenDetails.fcmPushSet,pushSubscription,publicVapidKey)];case 1:return updatedToken=_a.sent(),allDetails={swScope:swReg.scope,vapidKey:publicVapidKey,fcmSenderId:this.messagingSenderId,fcmToken:updatedToken,
fcmPushSet:tokenDetails.fcmPushSet,createTime:Date.now(),endpoint:pushSubscription.endpoint,auth:pushSubscription.getKey("auth"),p256dh:pushSubscription.getKey("p256dh")},[4,this.tokenDetailsModel.saveTokenDetails(allDetails)];case 2:return _a.sent(),[4,this.vapidDetailsModel.saveVapidDetails(swReg.scope,publicVapidKey)];case 3:return _a.sent(),[2,updatedToken];case 4:return e_1=_a.sent(),[4,this.deleteToken(tokenDetails.fcmToken)];case 5:throw _a.sent(),e_1;case 6:return[2]}})})};BaseController.prototype.getNewToken=
function(swReg,pushSubscription,publicVapidKey){return tslib_1.__awaiter(this,void 0,void 0,function(){var tokenDetails,allDetails;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.iidModel.getToken(this.messagingSenderId,pushSubscription,publicVapidKey)];case 1:return tokenDetails=_a.sent(),allDetails={swScope:swReg.scope,vapidKey:publicVapidKey,fcmSenderId:this.messagingSenderId,fcmToken:tokenDetails.token,fcmPushSet:tokenDetails.pushSet,createTime:Date.now(),endpoint:pushSubscription.endpoint,
auth:pushSubscription.getKey("auth"),p256dh:pushSubscription.getKey("p256dh")},[4,this.tokenDetailsModel.saveTokenDetails(allDetails)];case 2:return _a.sent(),[4,this.vapidDetailsModel.saveVapidDetails(swReg.scope,publicVapidKey)];case 3:return _a.sent(),[2,tokenDetails.token]}})})};BaseController.prototype.deleteToken=function(token){return tslib_1.__awaiter(this,void 0,void 0,function(){var registration,pushSubscription;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,
this.deleteTokenFromDB(token)];case 1:return _a.sent(),[4,this.getSWRegistration_()];case 2:return(registration=_a.sent())?[4,registration.pushManager.getSubscription()]:[3,4];case 3:if(pushSubscription=_a.sent())return[2,pushSubscription.unsubscribe()];_a.label=4;case 4:return[2,!0]}})})};BaseController.prototype.deleteTokenFromDB=function(token){return tslib_1.__awaiter(this,void 0,void 0,function(){var details;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.tokenDetailsModel.deleteToken(token)];
case 1:return details=_a.sent(),[4,this.iidModel.deleteToken(details.fcmSenderId,details.fcmToken,details.fcmPushSet)];case 2:return _a.sent(),[2]}})})};BaseController.prototype.getPushSubscription=function(swRegistration,publicVapidKey){return swRegistration.pushManager.getSubscription().then(function(subscription){return subscription?subscription:swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:publicVapidKey})})};BaseController.prototype.requestPermission=function(){throw errorFactory.create(ERROR_CODES.AVAILABLE_IN_WINDOW);
};BaseController.prototype.useServiceWorker=function(registration){throw errorFactory.create(ERROR_CODES.AVAILABLE_IN_WINDOW);};BaseController.prototype.usePublicVapidKey=function(b64PublicKey){throw errorFactory.create(ERROR_CODES.AVAILABLE_IN_WINDOW);};BaseController.prototype.onMessage=function(nextOrObserver,error,completed){throw errorFactory.create(ERROR_CODES.AVAILABLE_IN_WINDOW);};BaseController.prototype.onTokenRefresh=function(nextOrObserver,error,completed){throw errorFactory.create(ERROR_CODES.AVAILABLE_IN_WINDOW);
};BaseController.prototype.setBackgroundMessageHandler=function(callback){throw errorFactory.create(ERROR_CODES.AVAILABLE_IN_SW);};BaseController.prototype.delete=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,Promise.all([this.tokenDetailsModel.closeDatabase(),this.vapidDetailsModel.closeDatabase()])];case 1:return _a.sent(),[2]}})})};BaseController.prototype.getNotificationPermission_=function(){return Notification.permission};
BaseController.prototype.getTokenDetailsModel=function(){return this.tokenDetailsModel};BaseController.prototype.getVapidDetailsModel=function(){return this.vapidDetailsModel};BaseController.prototype.getIidModel=function(){return this.iidModel};return BaseController}();var SwController=function(_super){function SwController(app){var _this=_super.call(this,app)||this;_this.bgMessageHandler=null;self.addEventListener("push",function(e){_this.onPush(e)});self.addEventListener("pushsubscriptionchange",
function(e){_this.onSubChange(e)});self.addEventListener("notificationclick",function(e){_this.onNotificationClick(e)});return _this}tslib_1.__extends(SwController,_super);SwController.prototype.onPush=function(event){event.waitUntil(this.onPush_(event))};SwController.prototype.onSubChange=function(event){event.waitUntil(this.onSubChange_(event))};SwController.prototype.onNotificationClick=function(event){event.waitUntil(this.onNotificationClick_(event))};SwController.prototype.onPush_=function(event){return tslib_1.__awaiter(this,
void 0,void 0,function(){var msgPayload,hasVisibleClients,notificationDetails,notificationTitle,reg,actions,maxActions;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!event.data)return[2];try{msgPayload=event.data.json()}catch(err){return[2]}return[4,this.hasVisibleClients_()];case 1:if(hasVisibleClients=_a.sent())return[2,this.sendMessageToWindowClients_(msgPayload)];notificationDetails=this.getNotificationData_(msgPayload);if(!notificationDetails)return[3,3];notificationTitle=
notificationDetails.title||"";return[4,this.getSWRegistration_()];case 2:return reg=_a.sent(),actions=notificationDetails.actions,maxActions=Notification.maxActions,actions&&maxActions&&actions.length>maxActions&&console.warn("This browser only supports "+maxActions+" actions.The remaining actions will not be displayed."),[2,reg.showNotification(notificationTitle,notificationDetails)];case 3:return this.bgMessageHandler?[4,this.bgMessageHandler(msgPayload)]:[3,5];case 4:return _a.sent(),[2];case 5:return[2]}})})};
SwController.prototype.onSubChange_=function(event){return tslib_1.__awaiter(this,void 0,void 0,function(){var registration,err_1,err_2,tokenDetailsModel,tokenDetails;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,2,,3]),[4,this.getSWRegistration_()];case 1:return registration=_a.sent(),[3,3];case 2:throw err_1=_a.sent(),errorFactory.create(ERROR_CODES.UNABLE_TO_RESUBSCRIBE,{message:err_1});case 3:return _a.trys.push([3,5,,8]),[4,registration.pushManager.getSubscription()];
case 4:return _a.sent(),[3,8];case 5:return err_2=_a.sent(),tokenDetailsModel=this.getTokenDetailsModel(),[4,tokenDetailsModel.getTokenDetailsFromSWScope(registration.scope)];case 6:tokenDetails=_a.sent();if(!tokenDetails)throw err_2;return[4,this.deleteToken(tokenDetails.fcmToken)];case 7:throw _a.sent(),err_2;case 8:return[2]}})})};SwController.prototype.onNotificationClick_=function(event){return tslib_1.__awaiter(this,void 0,void 0,function(){var msgPayload,link,windowClient,internalMsg;return tslib_1.__generator(this,
function(_a){switch(_a.label){case 0:if(!event.notification||!event.notification.data||!event.notification.data.FCM_MSG||event.action)return[2];event.stopImmediatePropagation();event.notification.close();msgPayload=event.notification.data.FCM_MSG;return msgPayload.notification?(link=msgPayload.fcmOptions&&msgPayload.fcmOptions.link||msgPayload.notification.click_action)?[4,this.getWindowClient_(link)]:[2]:[2];case 1:return(windowClient=_a.sent())?[3,3]:[4,self.clients.openWindow(link)];case 2:return windowClient=
_a.sent(),[3,5];case 3:return[4,windowClient.focus()];case 4:windowClient=_a.sent(),_a.label=5;case 5:if(!windowClient)return[2];delete msgPayload.notification;delete msgPayload.fcmOptions;internalMsg=createNewMsg(MessageType.NOTIFICATION_CLICKED,msgPayload);return[2,this.attemptToMessageClient_(windowClient,internalMsg)]}})})};SwController.prototype.getNotificationData_=function(msgPayload){var _a;if(msgPayload&&"object"===typeof msgPayload.notification){var notificationInformation=tslib_1.__assign({},
msgPayload.notification);notificationInformation.data=tslib_1.__assign({},msgPayload.notification.data,(_a={},_a.FCM_MSG=msgPayload,_a));return notificationInformation}};SwController.prototype.setBackgroundMessageHandler=function(callback){if(!callback||"function"!==typeof callback)throw errorFactory.create(ERROR_CODES.BG_HANDLER_FUNCTION_EXPECTED);this.bgMessageHandler=callback};SwController.prototype.getWindowClient_=function(url){return tslib_1.__awaiter(this,void 0,void 0,function(){var parsedURL,
clientList,suitableClient,i,parsedClientUrl;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return parsedURL=(new URL(url,self.location.href)).href,[4,getClientList()];case 1:clientList=_a.sent();suitableClient=null;for(i=0;i<clientList.length;i++)if(parsedClientUrl=(new URL(clientList[i].url,self.location.href)).href,parsedClientUrl===parsedURL){suitableClient=clientList[i];break}return[2,suitableClient]}})})};SwController.prototype.attemptToMessageClient_=function(client,message){return tslib_1.__awaiter(this,
void 0,void 0,function(){return tslib_1.__generator(this,function(_a){if(!client)throw errorFactory.create(ERROR_CODES.NO_WINDOW_CLIENT_TO_MSG);client.postMessage(message);return[2]})})};SwController.prototype.hasVisibleClients_=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var clientList;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,getClientList()];case 1:return clientList=_a.sent(),[2,clientList.some(function(client){return"visible"===client.visibilityState&&
!client.url.startsWith("chrome-extension://")})]}})})};SwController.prototype.sendMessageToWindowClients_=function(msgPayload){return tslib_1.__awaiter(this,void 0,void 0,function(){var clientList,internalMsg,_this=this;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,getClientList()];case 1:return clientList=_a.sent(),internalMsg=createNewMsg(MessageType.PUSH_MSG_RECEIVED,msgPayload),[4,Promise.all(clientList.map(function(client){return _this.attemptToMessageClient_(client,
internalMsg)}))];case 2:return _a.sent(),[2]}})})};SwController.prototype.getSWRegistration_=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return[2,self.registration]})})};SwController.prototype.getPublicVapidKey_=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var swReg,vapidKeyFromDatabase;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.getSWRegistration_()];case 1:swReg=_a.sent();
if(!swReg)throw errorFactory.create(ERROR_CODES.SW_REGISTRATION_EXPECTED);return[4,this.getVapidDetailsModel().getVapidFromSWScope(swReg.scope)];case 2:return vapidKeyFromDatabase=_a.sent(),null==vapidKeyFromDatabase?[2,DEFAULT_PUBLIC_VAPID_KEY]:[2,vapidKeyFromDatabase]}})})};return SwController}(_a$jscomp$0),WindowController=function(_super){function WindowController(app){var _this=_super.call(this,app)||this;_this.registrationToUse=null;_this.publicVapidKeyToUse=null;_this.manifestCheckPromise=
null;_this.messageObserver=null;_this.tokenRefreshObserver=null;_this.onMessageInternal=util.createSubscribe(function(observer){_this.messageObserver=observer});_this.onTokenRefreshInternal=util.createSubscribe(function(observer){_this.tokenRefreshObserver=observer});_this.setupSWMessageListener_();return _this}tslib_1.__extends(WindowController,_super);WindowController.prototype.getToken=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return this.manifestCheckPromise||
(this.manifestCheckPromise=manifestCheck()),[4,this.manifestCheckPromise];case 1:return _a.sent(),[2,_super.prototype.getToken.call(this)]}})})};WindowController.prototype.requestPermission=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var permissionResult;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return"granted"===this.getNotificationPermission_()?[2]:[4,Notification.requestPermission()];case 1:permissionResult=_a.sent();if("granted"!==permissionResult){if("denied"===
permissionResult)throw errorFactory.create(ERROR_CODES.PERMISSION_BLOCKED);throw errorFactory.create(ERROR_CODES.PERMISSION_DEFAULT);}return[2]}})})};WindowController.prototype.useServiceWorker=function(registration){if(!(registration instanceof ServiceWorkerRegistration))throw errorFactory.create(ERROR_CODES.SW_REGISTRATION_EXPECTED);if(null!=this.registrationToUse)throw errorFactory.create(ERROR_CODES.USE_SW_BEFORE_GET_TOKEN);this.registrationToUse=registration};WindowController.prototype.usePublicVapidKey=
function(publicKey){if("string"!==typeof publicKey)throw errorFactory.create(ERROR_CODES.INVALID_PUBLIC_VAPID_KEY);if(null!=this.publicVapidKeyToUse)throw errorFactory.create(ERROR_CODES.USE_PUBLIC_KEY_BEFORE_GET_TOKEN);publicKey=base64ToArrayBuffer(publicKey);if(65!==publicKey.length)throw errorFactory.create(ERROR_CODES.PUBLIC_KEY_DECRYPTION_FAILED);this.publicVapidKeyToUse=publicKey};WindowController.prototype.onMessage=function(nextOrObserver,error,completed){return"function"===typeof nextOrObserver?
this.onMessageInternal(nextOrObserver,error,completed):this.onMessageInternal(nextOrObserver)};WindowController.prototype.onTokenRefresh=function(nextOrObserver,error,completed){return"function"===typeof nextOrObserver?this.onTokenRefreshInternal(nextOrObserver,error,completed):this.onTokenRefreshInternal(nextOrObserver)};WindowController.prototype.waitForRegistrationToActivate_=function(registration){var serviceWorker=registration.installing||registration.waiting||registration.active;return new Promise(function(resolve,
reject){if(serviceWorker)if("activated"===serviceWorker.state)resolve(registration);else if("redundant"===serviceWorker.state)reject(errorFactory.create(ERROR_CODES.SW_REG_REDUNDANT));else{var stateChangeListener=function(){if("activated"===serviceWorker.state)resolve(registration);else if("redundant"===serviceWorker.state)reject(errorFactory.create(ERROR_CODES.SW_REG_REDUNDANT));else return;serviceWorker.removeEventListener("statechange",stateChangeListener)};serviceWorker.addEventListener("statechange",
stateChangeListener)}else reject(errorFactory.create(ERROR_CODES.NO_SW_IN_REG))})};WindowController.prototype.getSWRegistration_=function(){var _this=this;if(this.registrationToUse)return this.waitForRegistrationToActivate_(this.registrationToUse);this.registrationToUse=null;return navigator.serviceWorker.register("/firebase-messaging-sw.js",{scope:"/firebase-cloud-messaging-push-scope"}).catch(function(err){throw errorFactory.create(ERROR_CODES.FAILED_DEFAULT_REGISTRATION,{browserErrorMessage:err.message});
}).then(function(registration){return _this.waitForRegistrationToActivate_(registration).then(function(){_this.registrationToUse=registration;registration.update();return registration})})};WindowController.prototype.getPublicVapidKey_=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return this.publicVapidKeyToUse?[2,this.publicVapidKeyToUse]:[2,DEFAULT_PUBLIC_VAPID_KEY]})})};WindowController.prototype.setupSWMessageListener_=function(){var _this=
this;navigator.serviceWorker.addEventListener("message",function(event){if(event.data&&event.data[MessageParameter.TYPE_OF_MSG])switch(event=event.data,event[MessageParameter.TYPE_OF_MSG]){case MessageType.PUSH_MSG_RECEIVED:case MessageType.NOTIFICATION_CLICKED:event=event[MessageParameter.DATA],_this.messageObserver&&_this.messageObserver.next(event)}},!1)};return WindowController}(_a$jscomp$0);registerMessaging(global);exports.registerMessaging=registerMessaging;exports.isSupported=isSupported}
//# sourceMappingURL=module$node_modules$$firebase$messaging$dist$index_cjs.js.map
